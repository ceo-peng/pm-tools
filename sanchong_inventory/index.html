<!doctype html>
<html lang="zh-Hant">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>鉑翡斯 三重倉庫存更新系統 — Final</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  </head>
  <body class="bg-white text-gray-950">
    <div id="root"></div>

    <script type="text/babel">
      const {useState,useEffect,useMemo} = React;

      /* -------------------- Access code (simple gate) -------------------- */
      const ACCESS_CODE = "pm2025"; // 可自行更改

      /* -------------------- GitHub RAW URLs -------------------- */
      const URLS = {
        products : "https://raw.githubusercontent.com/ceo-peng/pm-tools/refs/heads/main/data/products.csv",
        nonsales : "https://raw.githubusercontent.com/ceo-peng/pm-tools/refs/heads/main/data/sanchong_customers.csv",
      };

      /* ----------------------------- CSV helpers ---------------------------- */
      const lines = (csv)=> csv.split(String.fromCharCode(13)).join('').split(String.fromCharCode(10)).map(s=>s.trim()).filter(Boolean);
      const maybeStripHeader=(arr,expect)=> {
        if(!arr.length) return arr;
        const first=arr[0].toLowerCase();
        return expect.some(k=>first.includes(k)) ? arr.slice(1) : arr;
      };
      function parseProducts(csv){
        let l=lines(csv); l=maybeStripHeader(l,["a,","b,","c","商品"]);
        return l.map(s=>{
          const [A,B,C]=s.split(",").map(x=>x?.trim());
          return {id:C,A,B,C};
        }).filter(x=>x?.id && x?.C);
      }
      function parsePairs(csv){
        let l=lines(csv); l=maybeStripHeader(l,["id,","name","分類"]);
        return l.map(s=>{
          const [id,name]=s.split(",").map(x=>x?.trim());
          return {id,name};
        }).filter(x=>x?.id && x?.name);
      }
      async function fetchCsv(url){
        const r=await fetch(url,{cache:"no-store"});
        if(!r.ok) throw new Error(url);
        return r.text();
      }

      /* -------------------------- Toast (tiny) -------------------------- */
      function useToast(){
        const [msg,setMsg]=useState("");
        useEffect(()=>{ if(!msg) return; const t=setTimeout(()=>setMsg(""),2200); return ()=>clearTimeout(t);},[msg]);
        const Toast = ()=> msg? <div className="fixed top-3 right-3 z-50 bg-black text-white text-xs px-3 py-2 rounded">{msg}</div>:null;
        return {setMsg,Toast};
      }

      /* -------------------- Stepper ------------------- */
      function Stepper({value,min=0,onChange,small=false}){
        const h = small ? 30 : 34;
        const t = small ? 12 : 13;
        return (
          <div className="inline-flex items-stretch border border-gray-300 rounded overflow-hidden" style={{height:`${h}px`}}>
            <button className="px-2 text-[16px] leading-none select-none" onClick={()=>onChange(Math.max(min,(value||0)-1))} aria-label="decrement">−</button>
            <input className="w-9 text-center outline-none border-l border-r border-gray-300" style={{fontSize:`${t}px`} }
                   value={value} onChange={(e)=>{const n=parseInt(e.target.value.replace(/[^0-9]/g,''),10); onChange(Number.isFinite(n)?n:0);}} inputMode="numeric" />
            <button className="px-2 text-[16px] leading-none select-none" onClick={()=>onChange((value||0)+1)} aria-label="increment">+</button>
          </div>
        );
      }

      /* --------------------------- Form-Date-ID --------------------------- */
      function genDocId(prefix){
        const d=new Date(); const p=n=>String(n).padStart(2,"0");
        return `${prefix||'待選'}-${d.getFullYear()}${p(d.getMonth()+1)}${p(d.getDate())}-${p(d.getHours())}${p(d.getMinutes())}`;
      }

      /* ---------------------------- Access Gate ---------------------------- */
      function AccessGate({onOk}){
        const [val,setVal]=useState("");
        function submit(){
          if(val.trim()===ACCESS_CODE) onOk();
          else alert("Access code 錯誤");
        }
        return (
          <div className="fixed inset-0 z-[100] flex items-center justify-center bg黑/30">
            <div className="w-full max-w-sm rounded-lg bg-white p-4 shadow-xl">
              <div className="text-sm font-semibold mb-2">輸入存取代碼</div>
              <input
                className="w-full h-10 border rounded px-3 text-sm"
                placeholder="Access code"
                value={val}
                onChange={(e)=>setVal(e.target.value)}
                onKeyDown={(e)=>{ if(e.key==='Enter') submit(); }}
                autoFocus
              />
              <div className="mt-3 flex justify-end">
                <button className="h-9 px-3 border border-gray-300 rounded text-sm" onClick={submit}>進入</button>
              </div>
            </div>
          </div>
        );
      }

      /* ================================ App ================================= */
      function App(){
        const {setMsg,Toast}=useToast();

        // gate
        const [authOK,setAuthOK]=useState(false);

        // data (only products & nonsales)
        const [PRODUCTS,setPRODUCTS]=useState([]);
        const [NONSALES,setNONSALES]=useState([]);

        // header state (only 非銷售)
        const [nonSalesCat,setNonSalesCat]=useState("");
        const [po,setPo]=useState("");
        const [memo,setMemo]=useState("");

        // collapsibles
        const [openOrder,setOpenOrder]=useState(true);
        const [openProducts,setOpenProducts]=useState(true);
        const [openPreview,setOpenPreview]=useState(true);

        // operation (plus/minus)
        const [op,setOp]=useState("ship"); // 'ship' | 'receive'

        // selections (only 單品)
        const [pendingSingles,setPendingSingles]=useState({});

        // final rows
        const [rows,setRows]=useState([]);

        // system panel
        const [sysOpen,setSysOpen]=useState(false);
        const [pinOK,setPinOK]=useState(false);

        // load CSV
        async function loadFromGitHub(){
          const [p,n] = await Promise.all([
            fetchCsv(URLS.products),
            fetchCsv(URLS.nonsales)
          ]);
          setPRODUCTS(parseProducts(p));
          setNONSALES(parsePairs(n));

          // reset selections & rows
          setPendingSingles({});
          setRows([]);

          setNonSalesCat(""); setPo(""); setMemo("");
          setMsg("已自動載入 GitHub CSV 並重置。");
        }
        useEffect(()=>{ if(authOK){ loadFromGitHub().catch(()=>setMsg("載入失敗，請檢查 RAW URL")); } },[authOK]);

        /* ---------- dropdown options for 單品 ---------- */
        const catA = useMemo(()=> [...new Set(PRODUCTS.map(x=>x.A))], [PRODUCTS]);
        const seriesByA = useMemo(()=>{
          const obj={}; catA.forEach(a=>obj[a]=[...new Set(PRODUCTS.filter(p=>p.A===a).map(p=>p.B))]); return obj;
        },[catA,PRODUCTS]);
        const prodsByAB = useMemo(()=>{
          const obj={}; PRODUCTS.forEach(p=>{ const k=`${p.A}__${p.B}`; (obj[k] ||= []).push(p);}); return obj;
        },[PRODUCTS]);
        const [selA,setSelA]=useState(""); const [selB,setSelB]=useState(""); const [selPid,setSelPid]=useState(""); const [singleQty,setSingleQty]=useState(1);
        useEffect(()=>{
          if(!PRODUCTS.length) return;
          const a0=catA[0]||""; const b0=(seriesByA[a0]||[])[0]||"";
          setSelA(a0); setSelB(b0);
          const first=(prodsByAB[`${a0}__${b0}`]||[])[0];
          setSelPid(first?first.id:"");
        },[PRODUCTS]);

        /* ---------- previews ---------- */
        const previewSingles = useMemo(()=> Object.entries(pendingSingles)
          .filter(([,q])=>q>0)
          .map(([pid,qty])=>{
            const name=(PRODUCTS.find(p=>p.id===pid)||{}).C||pid;
            return {productId:pid,name,qty};
          }),[pendingSingles,PRODUCTS]);

        function clearPreview(){ setPendingSingles({}); }

        function confirmPreview(){
          const addMap=new Map();
          const add=(pid,qty)=>addMap.set(pid,(addMap.get(pid)||0)+qty);
          previewSingles.forEach(s=>add(s.productId,s.qty));
          if(addMap.size===0){ setOpenPreview(false); return; }
          setRows(prev=>{
            const next=[...prev];
            addMap.forEach((qty,pid)=>{
              const name=(PRODUCTS.find(p=>p.id===pid)||{}).C||pid;
              const idx=next.findIndex(x=>x.productId===pid);
              if(idx>=0) next[idx]={...next[idx],qty:next[idx].qty+qty};
              else next.push({id:`${pid}-${Date.now()}-${Math.random()}`,productId:pid,name,qty,picked:0});
            });
            return next;
          });
          // auto-fold
          setOpenOrder(false);
          setOpenProducts(false);
          setOpenPreview(false);
        }

        const formDateId = useMemo(()=> genDocId(nonSalesCat||''),[nonSalesCat]);

        if(!authOK) return <AccessGate onOk={()=>setAuthOK(true)} />;

        /* ------------------------------- UI ------------------------------- */
        return (
          <div className="mx-auto max-w-6xl p-4 pb-28">
            <Toast/>

            {/* 頁首 + Reset All */}
            <div className="mb-4 flex items-center justify-between">
              <h1 className="text-xl font-semibold">三重倉庫存更新系統</h1>
              <button className="h-9 px-3 border border-gray-300 rounded text-xs"
                      onClick={loadFromGitHub}>Reset All Data</button>
            </div>

            {/* 申請單資訊（可收合） */}
            <section className="rounded border border-gray-200 bg-white shadow-sm mb-5">
              <div className="flex items-center justify-between px-4 py-2 border-b bg-gray-50">
                <div className="font-bold">申請表單</div>
                <div className="flex items-center gap-3">
                  <div className="text-xs text-gray-600">表單-日期-ID：<span className="font-mono">{formDateId}</span></div>
                  <button className="h-8 px-3 border border-gray-300 rounded text-xs" onClick={()=>setOpenOrder(o=>!o)}>{openOrder?"收":"展"}</button>
                </div>
              </div>

              {openOrder && (
                <div className="p-3 space-y-3">
                  <div className="grid grid-cols-1 md:grid-cols-3 gap-2">
                    <select className="border rounded h-9 px-3 text-sm"
                      value={nonSalesCat} onChange={e=>setNonSalesCat(e.target.value)}>
                      <option value="" disabled>選擇表單類別</option>
                      {NONSALES.map(n=> <option key={n.id} value={n.name}>{n.name}</option>)}
                    </select>
                    <input className="border rounded h-9 px-3 text-sm" placeholder="客戶 PO" value={po} onChange={e=>setPo(e.target.value)} />
                    <input className="border rounded h-9 px-3 text-sm" placeholder="備註" value={memo} onChange={e=>setMemo(e.target.value)} />
                  </div>
                </div>
              )}
            </section>

            {/* 產品選擇（只保留單品） */}
            <section className="rounded border border-gray-200 bg-white shadow-sm mb-5">
              <div className="flex items-center justify-between px-4 py-2 border-b bg-gray-50">
                <div className="font-bold">產品選擇</div>
                <button className="h-8 px-3 border border-gray-300 rounded text-xs" onClick={()=>setOpenProducts(o=>!o)}>{openProducts?"收":"展"}</button>
              </div>

              {openProducts && (
                <div className="p-4 space-y-6">
                  {/* 單品 */}
                  <div>
                    <div className="text-sm font-semibold mb-2">單品</div>
                    <div className="rounded border bg-gray-50 p-3 space-y-2">
                      <div className="grid md:grid-cols-6 gap-2">
                        <div className="md:col-span-2">
                          <div className="text-[11px] text-gray-500 mb-1">商品類別（A）</div>
                          <select className="w-full border rounded h-9 px-2 text-sm"
                            value={selA}
                            onChange={e=>{
                              const v=e.target.value; setSelA(v);
                              const nb=(seriesByA[v]||[])[0]||""; setSelB(nb);
                              const first=(prodsByAB[`${v}__${nb}`]||[])[0]; setSelPid(first?first.id:"");
                            }}>
                            {catA.map(a=> <option key={a}>{a}</option>)}
                          </select>
                        </div>
                        <div className="md:col-span-2">
                          <div className="text-[11px] text-gray-500 mb-1">系列名稱（B）</div>
                          <select className="w-full border rounded h-9 px-2 text-sm"
                            value={selB}
                            onChange={e=>{
                              const v=e.target.value; setSelB(v);
                              const first=(prodsByAB[`${selA}__${v}`]||[])[0]; setSelPid(first?first.id:"");
                            }}>
                            {(seriesByA[selA]||[]).map(b=> <option key={b}>{b}</option>)}
                          </select>
                        </div>
                        <div className="md:col-span-2">
                          <div className="text-[11px] text-gray-500 mb-1">產品名稱（C／唯一 ID）</div>
                          <select className="w-full border rounded h-9 px-2 text-sm"
                            value={selPid} onChange={e=>setSelPid(e.target.value)}
                            title="若下拉文字過長將自動截斷，點開可見完整名稱。">
                            {((prodsByAB[`${selA}__${selB}`])||[]).map(p=> <option key={p.id} value={p.id}>{p.C}</option>)}
                          </select>
                        </div>
                      </div>

                      <div className="flex flex-col sm:flex-row sm:items-center gap-2 justify-end">
                        <Stepper small value={singleQty} min={1} onChange={setSingleQty}/>
                        <button className="h-9 px-3 border border-gray-300 rounded text-sm"
                          onClick={()=> selPid && setPendingSingles(prev=>({...prev,[selPid]:(prev[selPid]||0)+singleQty}))}>加</button>
                      </div>
                    </div>
                  </div>
                </div>
              )}
            </section>

            {/* 庫存更新預覽（只顯示單品） */}
            <section className="rounded border border-gray-200 bg-white shadow-sm mb-5">
              <div className="flex items-center justify-between px-4 py-2 border-b bg-gray-50">
                <div className="font-bold">庫存更新預覽</div>
                <button className="h-8 px-3 border border-gray-300 rounded text-xs" onClick={()=>setOpenPreview(o=>!o)}>{openPreview?"收":"展"}</button>
              </div>

              {openPreview && (
                <div className="p-4">
                  <div className="grid grid-cols-1 lg:grid-cols-2 gap-4">
                    <Card title="單品">
                      {previewSingles.length===0 ? <Empty/> : (
                        <ul className="space-y-2 text-xs">
                          {previewSingles.map(s=> (
                            <li key={s.productId} className="grid grid-cols-1 md:grid-cols-[1fr_auto] gap-1 items-start">
                              <div className="text-[11px] leading-snug break-words">{s.name}</div>
                              <div className="md:justify-self-end">
                                <Stepper small value={s.qty} min={0}
                                  onChange={(v)=>setPendingSingles(prev=>{
                                    const nxt={...prev,[s.productId]:v};
                                    if(v===0) delete nxt[s.productId];
                                    return nxt;
                                  })}/>
                              </div>
                            </li>
                          ))}
                        </ul>
                      )}
                    </Card>
                  </div>

                  <div className="mt-3 flex justify-end gap-2">
                    <button className="h-8 px-3 border border-gray-300 rounded text-xs" onClick={clearPreview}>全部清除</button>
                    <button className="h-8 px-3 border border-gray-300 rounded text-xs" onClick={confirmPreview}>確認加入</button>
                  </div>
                </div>
              )}
            </section>

            {/* 出貨清單／庫存扣減確認 */}
            {rows.length>0 && (
              <section className="rounded border border-gray-200 bg-white shadow-sm mb-5">
                <div className="flex items-center justify-between px-4 py-2 border-b bg-gray-50">
                  <div className="font-bold">庫存扣減確認</div>

                  {/* 操作類型（只決定 delta 符號） */}
                  <div className="flex items-center gap-4 text-xs">
                    <label className="flex items-center gap-1">
                      <input type="radio" name="op" checked={op==='ship'} onChange={()=>setOp('ship')}/>
                      出（-）
                    </label>
                    <label className="flex items-center gap-1">
                      <input type="radio" name="op" checked={op==='receive'} onChange={()=>setOp('receive')}/>
                      進（+）
                    </label>
                  </div>
                </div>

                <div className="p-3">
                  <div className="mb-3 rounded-lg border border-gray-200 bg-gray-50 p-3">
                    <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-2">
                      <div><div className="text-[11px] text-gray-500">類別</div><div className="text-sm font-semibold">{nonSalesCat||'—'}</div></div>
                      <div><div className="text-[11px] text-gray-500">客戶 PO</div><div className="text-sm font-semibold">{po||'—'}</div></div>
                      <div><div className="text-[11px] text-gray-500">備註</div><div className="text-sm font-semibold">{memo||'—'}</div></div>
                      <div><div className="text-[11px] text-gray-500">表單-日期-ID</div><div className="text-sm font-semibold font-mono">{formDateId}</div></div>
                    </div>
                  </div>

                  <RowsList rows={rows} setRows={setRows}/>
                </div>

                <div className="px-3 pb-3 text-sm">
                  <span>項：{rows.length}　預計：{rows.reduce((s,r)=>s+r.qty,0)}　點交：{rows.reduce((s,r)=>s+(r.picked||0),0)}</span>
                </div>
              </section>
            )}

            {/* Sticky actions */}
            {rows.length>0 && (
              <div className="fixed bottom-0 left-0 right-0 bg-white/95 shadow-[0_-4px_12px_rgba(0,0,0,0.06)] p-2">
                <div className="max-w-6xl mx-auto flex justify-end gap-2">
                  <button className="h-9 px-3 border border-gray-300 rounded text-xs"
                          onClick={()=>setRows(prev=>prev.map(x=>({...x,picked:x.qty})))}>全部帶入</button>
                  <button className="h-9 px-3 border border-gray-300 rounded text-xs"
                          onClick={()=>setRows([])}>全部清除</button>
                  <SubmitButton rows={rows} op={op}
                    category={nonSalesCat}
                    po={po} memo={memo} formDateId={formDateId}/>
                </div>
              </div>
            )}

            {/* 系統用面板（PIN 開啟） */}
            <section className="mt-8 rounded border border-gray-200 bg-white shadow-sm">
              <div className="flex items-center justify-between px-4 py-2 border-b bg-gray-50">
                <div className="font-bold">匯入資料（管理員）</div>
                <button className="h-8 px-3 border border-gray-300 rounded text-xs"
                        onClick={()=>setSysOpen(o=>!o)}>{sysOpen?"收":"展"}</button>
              </div>

              {sysOpen && (
                <div className="p-4">
                  {!pinOK ? (
                    <PinGate onOk={()=>setPinOK(true)} />
                  ) : (
                    <SystemPanel
                      setPRODUCTS={setPRODUCTS}
                      setNONSALES={setNONSALES}
                      reload={loadFromGitHub}
                    />
                  )}
                </div>
              )}
            </section>
          </div>
        );
      }

      /* -------------------------- Subcomponents -------------------------- */

      function Card({title,children}){ return (
        <div className="rounded border border-gray-200 bg-white p-3">
          <div className="text-sm font-semibold mb-2">{title}</div>
          {children}
        </div>
      );}
      function Empty(){ return <div className="text-xs text-gray-400">（無）</div>; }

      function RowsList({rows,setRows}){
        return (
          <ul className="space-y-2">
            {rows.map(r=>{
              const mismatch=(r.picked||0)!==(r.qty||0);
              return (
                <li key={r.id} className={`rounded-md border ${mismatch?'border-red-300 bg-red-50/40':'border-gray-200 bg-white'}`}>
                  <div className="p-2 sm:p-2.5">
                    <div className="text-[15px] leading-5 md:text-[13px] break-words">{r.name}</div>
                    <div className="mt-2 grid grid-cols-12 items-center gap-2">
                      <div className="col-span-6 md:col-span-3 flex items-center gap-1">
                        <input className={`w-20 h-9 rounded border px-2 text-right tabular-nums ${mismatch?'border-red-400':'border-gray-300'}`} value={r.picked}
                          onChange={e=>{
                            const n=parseInt(e.target.value.replace(/[^0-9]/g,''),10);
                            setRows(prev=>prev.map(x=>x.id===r.id?{...x,picked:Number.isFinite(n)?n:0}:x));
                          }}/>
                        {mismatch && (
                          <button title="帶入預計" className="h-9 px-2 border border-gray-300 rounded text-sm text-gray-600"
                                  onClick={()=>setRows(prev=>prev.map(x=>x.id===r.id?{...x,picked:x.qty}:x))}>=</button>
                        )}
                      </div>
                      <div className="col-span-5 md:col-span-3 flex items-center justify-start md:justify-end">
                        <span className="mr-2 text-xs text-gray-500 hidden md:inline">預計</span>
                        <Stepper value={r.qty} min={0} small onChange={v=>setRows(prev=>prev.map(x=>x.id===r.id?{...x,qty:v}:x))}/>
                      </div>
                      <div className="col-span-1 md:col-span-1 flex justify-end">
                        <button className="h-9 w-9 border border-gray-300 rounded text-sm text-gray-600"
                                onClick={()=>setRows(prev=>prev.filter(x=>x.id!==r.id))}>×</button>
                      </div>
                    </div>
                  </div>
                </li>
              );
            })}
          </ul>
        );
      }

      function SubmitButton({rows,op,category,po,memo,formDateId}){
        const [open,setOpen]=useState(false);
        const [posting,setPosting]=useState(false);
        const hasMismatch = rows.some(r=>(r.picked||0)!==(r.qty||0));
        const sign = op==='ship' ? -1 : +1;
        const opLabel = op==='ship' ? '出（-）' : '進（+）';
        const items = rows.map(r=>({ productId:r.productId, name:r.name, delta:(r.picked||0)*sign }));

        async function doPost(){
          const payload = {
            category: category || "",
            po: po || "",
            memo: memo || "",
            formDateId,
            items: items.map(({productId,delta})=>({productId,delta}))
          };
          try{
            setPosting(true);
            const res = await fetch("https://hook.us2.make.com/pu1rskzq10r927b8orjw5ohxyhq3p5hp", {
              method:"POST",
              headers:{ "Content-Type":"application/json" },
              body: JSON.stringify(payload)
            });
            if(!res.ok) throw new Error("webhook failed");
            setOpen(false);
            alert("已送出成功！");
          }catch(e){
            console.error(e);
            alert("送出失敗，請稍後重試。");
          }finally{
            setPosting(false);
          }
        }

        return (
          <>
            <button className="h-9 px-3 border border-gray-300 rounded text-xs disabled:opacity-50"
                    disabled={rows.length===0}
                    onClick={()=>setOpen(true)}>庫存更新提交</button>

            {open && (
              <div className="fixed inset-0 z-50 flex items-center justify-center bg-black/40 p-4">
                <div className="w-full max-w-lg rounded-lg bg-white shadow-xl overflow-hidden">
                  <div className="px-4 py-3 border-b">
                    <div className="text-sm font-semibold">送出前確認</div>
                    <div className="mt-1 text-xs text-gray-600">操作類型：{opLabel}</div>
                  </div>

                  <div className="p-4 max-h-[65vh] overflow-auto">
                    <div className="mb-3 rounded-lg border border-gray-200 bg-gray-50 p-3 text-xs">
                      <div className="grid grid-cols-1 md:grid-cols-2 gap-2">
                        <div><span className="text-gray-500">類別：</span><span className="font-semibold">{category||'—'}</span></div>
                        <div><span className="text-gray-500">客戶 PO：</span><span className="font-semibold">{po||'—'}</span></div>
                        <div><span className="text-gray-500">備註：</span><span className="font-semibold">{memo||'—'}</span></div>
                        <div><span className="text-gray-500">表單-日期-ID：</span><span className="font-semibold font-mono">{formDateId}</span></div>
                      </div>
                    </div>

                    {hasMismatch && (
                      <div className="mb-2 text-xs text-red-600">
                        點交量與預計不一致，請先在清單中校對後再送出。
                      </div>
                    )}
                    <ul className="space-y-2 text-xs">
                      {items.map(it=> (
                        <li key={it.productId} className="rounded border border-gray-200 p-2">
                          <div className="font-medium mb-1">{it.name}</div>
                          <div className="text-[11px] text-gray-600">Δ 更新數量：<span className="font-semibold">{it.delta>=0?`+${it.delta}`:it.delta}</span></div>
                        </li>
                      ))}
                    </ul>
                  </div>

                  <div className="px-4 py-3 border-t flex justify-end gap-2">
                    <button className="h-8 px-3 border border-gray-300 rounded text-xs" onClick={()=>setOpen(false)}>取消</button>
                    <button className="h-8 px-3 border border-gray-300 rounded text-xs disabled:opacity-50"
                            disabled={hasMismatch || posting}
                            onClick={doPost}>{posting?"送出中…":"確認送出"}</button>
                  </div>
                </div>
              </div>
            )}
          </>
        );
      }

      function PinGate({onOk}){
        const [pin,setPin]=useState("");
        return (
          <div className="max-w-sm">
            <div className="text-sm font-medium mb-2">管理登入</div>
            <div className="flex gap-2">
              <input className="border rounded h-9 px-2 text-sm w-full" placeholder="輸入 8 位 PIN"
                     value={pin} onChange={e=>setPin(e.target.value)} />
              <button className="h-9 px-3 border border-gray-300 rounded text-sm"
                      onClick={()=> pin==="50963212" ? onOk() : alert("PIN 錯誤")}>GO</button>
            </div>
          </div>
        );
      }

      function SystemPanel({setPRODUCTS,setNONSALES,reload}){
        return (
          <div className="space-y-4">
            <div className="grid md:grid-cols-2 gap-4">
              <CsvBox title="商品 CSV（A,B,C）" setter={setPRODUCTS} parser={parseProducts}/>
              <CsvBox title="非銷售 CSV（id,name）" setter={setNONSALES} parser={parsePairs}/>
            </div>

            <div className="flex gap-2">
              <button className="h-9 px-3 border border-gray-300 rounded text-xs" onClick={reload}>
                Reset All Data
              </button>
            </div>
          </div>
        );

        function CsvBox({title,setter,parser}){
          const [val,setVal]=useState("");
          return (
            <div>
              <div className="text-sm font-medium mb-2">{title}</div>
              <textarea className="w-full h-40 border rounded p-2 text-xs font-mono" value={val} onChange={e=>setVal(e.target.value)}></textarea>
              <div className="mt-2">
                <button className="h-8 px-3 border border-gray-300 rounded text-xs"
                        onClick={()=>{
                          try{ setter(parser(val)); alert("已載入並覆蓋。"); }
                          catch(e){ alert("格式錯誤，請檢查 CSV。"); }
                        }}>載入</button>
              </div>
            </div>
          );
        }
      }

      ReactDOM.createRoot(document.getElementById("root")).render(<App/>);
    </script>
  </body>
</html>
