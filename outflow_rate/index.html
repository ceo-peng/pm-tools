<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Inventory Intelligence Dashboard (Monthly View)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');
        body { font-family: 'Inter', sans-serif; background-color: #f8fafc; color: #334155; }
        .chart-container { position: relative; width: 100%; height: 300px; margin: auto; }
        .loader { border: 3px solid #f3f3f3; border-radius: 50%; border-top: 3px solid #2563eb; width: 24px; height: 24px; animation: spin 1s linear infinite; display: inline-block; vertical-align: middle; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        /* Modal */
        .modal { transition: opacity 0.25s ease; }
        body.modal-active { overflow-x: hidden; overflow-y: visible !important; }
    </style>
</head>
<body class="flex flex-col min-h-screen">

    <!-- Header -->
    <header class="bg-white border-b border-stone-200 sticky top-0 z-30 shadow-sm">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 h-16 flex items-center justify-between">
            <div class="flex items-center gap-3">
                <div class="h-8 w-8 bg-sky-500 rounded-lg flex items-center justify-center text-white font-bold text-lg">I</div>
                <h1 class="text-xl font-bold tracking-tight text-stone-800">Inventory Intelligence</h1>
            </div>
            <div class="flex items-center gap-3">
                <div id="connection-status" class="hidden flex items-center gap-2 text-xs font-medium text-emerald-600 bg-emerald-50 px-3 py-1 rounded-full border border-emerald-100">
                    <span class="w-2 h-2 rounded-full bg-emerald-500 animate-pulse"></span> Live Data
                </div>
                <button id="btn-settings" class="p-2 text-stone-400 hover:text-stone-600 rounded-full" title="Configuration">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"/><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/></svg>
                </button>
            </div>
        </div>
    </header>

    <!-- Main -->
    <main class="flex-grow p-6 max-w-7xl mx-auto w-full space-y-8">
        <!-- Error Banner -->
        <div id="error-banner" class="hidden bg-rose-50 border border-rose-200 rounded-lg p-4 flex justify-between items-center">
            <span id="error-message" class="text-sm text-rose-800 font-medium"></span>
            <button onclick="app.loadMockData()" class="text-xs bg-white border border-rose-300 text-rose-700 px-3 py-1 rounded shadow-sm hover:bg-rose-100">Load Demo Data</button>
        </div>

        <!-- Dashboard -->
        <div id="dashboard-content" class="hidden space-y-8 animate-in fade-in slide-in-from-bottom-4 duration-500">
            <!-- Controls -->
            <div class="bg-white p-4 rounded-xl border border-stone-200 shadow-sm flex flex-wrap gap-6 items-end">
                <div class="space-y-1">
                    <label class="text-xs font-bold text-stone-500 uppercase">Analysis Window</label>
                    <select id="sel-window" class="block w-40 text-sm border-stone-300 rounded-md bg-stone-50 p-2">
                        <option value="30">Last 30 Days</option>
                        <option value="60">Last 60 Days</option>
                        <option value="90">Last 90 Days</option>
                        <option value="all">All History</option>
                    </select>
                </div>
                <div class="space-y-1">
                    <label class="text-xs font-bold text-stone-500 uppercase">Target Stock</label>
                    <div class="flex items-center gap-2">
                        <input type="number" id="inp-target" value="2" class="block w-20 text-sm border-stone-300 rounded-md bg-stone-50 p-2 text-center">
                        <span class="text-sm text-stone-400">Months</span>
                    </div>
                </div>
                <div class="space-y-1 flex-grow">
                    <!-- Spacer -->
                </div>
                <button id="btn-refresh" class="text-stone-500 hover:text-sky-600 text-sm font-bold flex items-center gap-2"><span>&#8635;</span> Refresh</button>
            </div>

            <!-- KPIs -->
            <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                <div class="bg-white p-5 rounded-xl border border-stone-200 shadow-sm">
                    <div class="text-xs font-bold text-stone-400 uppercase">Total SKUs</div>
                    <div id="kpi-total-skus" class="text-2xl font-bold text-stone-800 mt-1">-</div>
                </div>
                <div class="bg-white p-5 rounded-xl border border-stone-200 shadow-sm">
                    <div class="text-xs font-bold text-stone-400 uppercase">Refill Alerts</div>
                    <div id="kpi-risk-count" class="text-2xl font-bold text-rose-500 mt-1">-</div>
                    <div class="text-xs text-stone-400">Below target months</div>
                </div>
                <div class="bg-white p-5 rounded-xl border border-stone-200 shadow-sm">
                    <div class="text-xs font-bold text-stone-400 uppercase">Units Needed</div>
                    <div id="kpi-refill-qty" class="text-2xl font-bold text-sky-600 mt-1">-</div>
                    <div class="text-xs text-stone-400">To reach 2 months stock</div>
                </div>
                <div class="bg-white p-5 rounded-xl border border-stone-200 shadow-sm">
                    <div class="text-xs font-bold text-stone-400 uppercase">Low Confidence</div>
                    <div id="kpi-low-conf" class="text-2xl font-bold text-amber-500 mt-1">-</div>
                    <div class="text-xs text-stone-400">&lt; 3 active sales days</div>
                </div>
            </div>

            <!-- Charts -->
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                <div class="bg-white p-6 rounded-xl border border-stone-200 shadow-sm">
                    <h3 class="text-sm font-bold text-stone-800 mb-4">Inventory Health (Months)</h3>
                    <div class="chart-container"><canvas id="chart-health"></canvas></div>
                </div>
                <div class="bg-white p-6 rounded-xl border border-stone-200 shadow-sm">
                    <h3 class="text-sm font-bold text-stone-800 mb-4">Top Refill Priorities</h3>
                    <div class="chart-container"><canvas id="chart-refill"></canvas></div>
                </div>
            </div>

            <!-- Table -->
            <div class="bg-white rounded-xl border border-stone-200 shadow-sm overflow-hidden">
                <div class="p-4 border-b border-stone-200 bg-stone-50 flex justify-between items-center gap-4">
                    <h3 class="text-sm font-bold text-stone-800">Detail View</h3>
                    <input type="text" id="inp-search" placeholder="Search..." class="pl-4 pr-4 py-2 text-sm border border-stone-300 rounded-lg w-64 focus:ring-sky-500">
                </div>
                <div class="overflow-x-auto">
                    <table class="min-w-full divide-y divide-stone-200">
                        <thead class="bg-stone-100">
                            <tr>
                                <th class="px-6 py-3 text-left text-xs font-bold text-stone-500 uppercase cursor-pointer" onclick="app.sortTable('sku')">SKU</th>
                                <th class="px-6 py-3 text-left text-xs font-bold text-stone-500 uppercase cursor-pointer" onclick="app.sortTable('name')">Product</th>
                                <th class="px-6 py-3 text-right text-xs font-bold text-stone-500 uppercase cursor-pointer" onclick="app.sortTable('inv', true)">Stock</th>
                                <th class="px-6 py-3 text-right text-xs font-bold text-stone-500 uppercase cursor-pointer" onclick="app.sortTable('monthlyRate', true)">Est. Monthly Sales</th>
                                <th class="px-6 py-3 text-right text-xs font-bold text-stone-500 uppercase cursor-pointer" onclick="app.sortTable('mos', true)">Months Left</th>
                                <th class="px-6 py-3 text-right text-xs font-bold text-stone-500 uppercase cursor-pointer" onclick="app.sortTable('refill', true)">Refill Qty</th>
                                <th class="px-6 py-3 text-center text-xs font-bold text-stone-500 uppercase">Status</th>
                            </tr>
                        </thead>
                        <tbody id="table-body" class="bg-white divide-y divide-stone-200 text-sm text-stone-600"></tbody>
                    </table>
                </div>
            </div>
        </div>
    </main>

    <!-- Settings Modal -->
    <div id="settings-modal" class="modal opacity-0 pointer-events-none fixed inset-0 flex items-center justify-center z-50">
        <div class="absolute inset-0 bg-stone-900 opacity-50 modal-overlay"></div>
        <div class="bg-white w-11/12 max-w-md mx-auto rounded-xl shadow-lg z-50 p-6">
            <h2 class="text-lg font-bold text-stone-800 mb-4">Settings</h2>
            <div class="space-y-4">
                <div>
                    <label class="block text-xs font-bold text-stone-500 uppercase mb-1">Sheet ID</label>
                    <input id="conf-sheet-id" class="w-full p-2 text-sm border rounded">
                </div>
                <div>
                    <label class="block text-xs font-bold text-stone-500 uppercase mb-1">Tab Name</label>
                    <input id="conf-tab-name" class="w-full p-2 text-sm border rounded">
                </div>
                <div class="pt-4 border-t border-stone-100">
                    <p class="text-sm font-bold text-stone-700 mb-2">Advanced Mapping</p>
                    <div class="grid grid-cols-2 gap-3">
                        <div>
                            <label class="block text-[10px] font-bold text-stone-500 uppercase mb-1">Header Row #</label>
                            <input id="conf-row-header" placeholder="Auto (2)" type="number" class="w-full p-2 text-xs border rounded">
                        </div>
                        <div>
                            <label class="block text-[10px] font-bold text-stone-500 uppercase mb-1">Inventory Col</label>
                            <input id="conf-col-inv" placeholder="Auto (J)" class="w-full p-2 text-xs border rounded uppercase">
                        </div>
                        <div>
                            <label class="block text-[10px] font-bold text-stone-500 uppercase mb-1">SKU Col</label>
                            <input id="conf-col-sku" placeholder="Auto (A)" class="w-full p-2 text-xs border rounded uppercase">
                        </div>
                        <div>
                            <label class="block text-[10px] font-bold text-stone-500 uppercase mb-1">Name Col</label>
                            <input id="conf-col-name" placeholder="Auto (B)" class="w-full p-2 text-xs border rounded uppercase">
                        </div>
                    </div>
                </div>
            </div>
            <div class="flex justify-end mt-6">
                <button onclick="app.saveSettings()" class="bg-sky-600 text-white font-bold py-2 px-4 rounded text-sm hover:bg-sky-700">Save</button>
            </div>
        </div>
    </div>

    <!-- Loading Overlay -->
    <div id="loading-overlay" class="fixed inset-0 bg-white/90 z-50 flex flex-col items-center justify-center backdrop-blur-sm">
        <div class="loader"></div>
        <p class="mt-4 text-stone-600 font-medium">Loading Data...</p>
    </div>

    <script>
        // CONFIG
        const DEFAULT_CONFIG = {
            SHEET_ID: '14yjT90s9CV988KZZ_o6m8F4LbeDWpKTuqVO66gfLboI',
            TAB_NAME: 'inventory_tracking',
            HEADER_ROW: '', COL_SKU: '', COL_NAME: '', COL_INV: ''
        };

        // JSONP Callback
        window.googleSheetCallback = function(json) {
            if (json.status === 'error') {
                app.showError(true, "Google API Error: " + json.errors[0].detailed_message);
                app.toggleLoader(false);
                return;
            }
            const rows = json.table.rows.map(r => 
                r.c.map(cell => (cell && cell.v !== null) ? String(cell.v) : "")
            );
            
            app.rawData = rows;
            app.parseStructure();
            document.getElementById('connection-status').classList.remove('hidden');
        };

        const safeStorage = {
            getItem: (k) => { try { return localStorage.getItem(k); } catch(e){ return null; } },
            setItem: (k, v) => { try { localStorage.setItem(k, v); } catch(e){} }
        };

        function letterToIndex(letter) {
            if (!letter) return -1;
            let column = letter.toUpperCase();
            let sum = 0;
            for (let i = 0; i < column.length; i++) {
                sum *= 26; sum += (column.charCodeAt(i) - 'A'.charCodeAt(0) + 1);
            }
            return sum - 1;
        }

        const app = {
            config: {}, rawData: [], processedData: [], charts: {}, sort: { col: 'refill', asc: false },

            init: function() {
                this.loadConfig();
                this.setupListeners();
                this.fetchData();
            },

            loadConfig: function() {
                const stored = safeStorage.getItem('inventory_config_v5');
                this.config = stored ? JSON.parse(stored) : { ...DEFAULT_CONFIG };
                document.getElementById('conf-sheet-id').value = this.config.SHEET_ID;
                document.getElementById('conf-tab-name').value = this.config.TAB_NAME;
                document.getElementById('conf-row-header').value = this.config.HEADER_ROW || '';
                document.getElementById('conf-col-sku').value = this.config.COL_SKU || '';
                document.getElementById('conf-col-name').value = this.config.COL_NAME || '';
                document.getElementById('conf-col-inv').value = this.config.COL_INV || '';
            },

            saveSettings: function() {
                this.config.SHEET_ID = document.getElementById('conf-sheet-id').value.trim();
                this.config.TAB_NAME = document.getElementById('conf-tab-name').value.trim();
                this.config.HEADER_ROW = document.getElementById('conf-row-header').value.trim();
                this.config.COL_SKU = document.getElementById('conf-col-sku').value.trim();
                this.config.COL_NAME = document.getElementById('conf-col-name').value.trim();
                this.config.COL_INV = document.getElementById('conf-col-inv').value.trim();
                safeStorage.setItem('inventory_config_v5', JSON.stringify(this.config));
                this.toggleSettings(false);
                this.fetchData();
            },

            toggleSettings: function(show) {
                const modal = document.getElementById('settings-modal');
                const body = document.querySelector('body');
                if (show) { modal.classList.remove('opacity-0', 'pointer-events-none'); body.classList.add('modal-active'); }
                else { modal.classList.add('opacity-0', 'pointer-events-none'); body.classList.remove('modal-active'); }
            },

            setupListeners: function() {
                document.getElementById('btn-refresh').addEventListener('click', () => this.fetchData());
                document.getElementById('btn-settings').addEventListener('click', () => this.toggleSettings(true));
                document.querySelector('.modal-overlay').addEventListener('click', () => this.toggleSettings(false));
                ['sel-window', 'inp-target'].forEach(id => {
                    document.getElementById(id).addEventListener('change', () => this.recalculate());
                });
                document.getElementById('inp-search').addEventListener('keyup', (e) => this.renderTable(e.target.value));
            },

            fetchData: function() {
                this.showError(false);
                this.toggleLoader(true);
                const script = document.createElement('script');
                const url = `https://docs.google.com/spreadsheets/d/${this.config.SHEET_ID}/gviz/tq?sheet=${this.config.TAB_NAME}&headers=0&tqx=responseHandler:googleSheetCallback`;
                script.src = url;
                script.onerror = () => {
                    this.toggleLoader(false);
                    this.showError(true, "Network Error. Check internet.");
                };
                document.body.appendChild(script);
            },

            loadMockData: function() {
                this.showError(false);
                this.toggleLoader(true);
                setTimeout(() => {
                    const demoHeader = ['unique_key', 'product_name', '即時庫存數量', ...Array.from({length:15}, (_,i) => {
                        const d = new Date(); d.setDate(d.getDate()-i);
                        return `${d.getFullYear().toString().substr(2)}.${(d.getMonth()+1).toString().padStart(2,'0')}${d.getDate().toString().padStart(2,'0')}.1200`;
                    })];
                    this.rawData = [['junk'], demoHeader]; 
                    for(let i=1; i<=20; i++) {
                        const row = [`SKU-${i}`, `Demo Product ${i}`, Math.floor(Math.random()*500).toString(), ...Array(15).fill(0).map(()=> (Math.random()>0.7 ? -Math.floor(Math.random()*20) : 0).toString())];
                        this.rawData.push(row);
                    }
                    this.parseStructure();
                }, 500);
            },

            showError: function(show, msg) {
                const banner = document.getElementById('error-banner');
                if(show) { document.getElementById('error-message').innerText = msg || "Error"; banner.classList.remove('hidden'); }
                else { banner.classList.add('hidden'); }
            },

            toggleLoader: function(show) {
                const el = document.getElementById('loading-overlay');
                if(show) el.classList.remove('hidden'); else el.classList.add('hidden');
            },

            parseStructure: function() {
                const rows = this.rawData;
                let mainRowIdx = -1;
                
                if (this.config.HEADER_ROW && !isNaN(this.config.HEADER_ROW)) {
                    mainRowIdx = parseInt(this.config.HEADER_ROW) - 1;
                } else {
                    for (let i = 0; i < Math.min(rows.length, 10); i++) {
                        const rowStr = rows[i].join('|').toLowerCase();
                        if (rowStr.includes('unique_key')) { mainRowIdx = i; break; }
                    }
                }

                if (mainRowIdx === -1 || !rows[mainRowIdx]) {
                    this.toggleLoader(false);
                    this.showError(true, "Header not found. Please set 'Header Row #' in Settings.");
                    return;
                }

                const header = rows[mainRowIdx].map(c => c.toLowerCase().trim());
                const mapping = { sku: -1, name: -1, inv: -1 };

                if (this.config.COL_SKU) mapping.sku = letterToIndex(this.config.COL_SKU);
                else mapping.sku = header.indexOf('unique_key');

                if (this.config.COL_NAME) mapping.name = letterToIndex(this.config.COL_NAME);
                else mapping.name = header.findIndex(c => c.includes('product_name') || c.includes('品名'));

                if (this.config.COL_INV) mapping.inv = letterToIndex(this.config.COL_INV);
                else mapping.inv = header.findIndex(c => c.includes('庫存') || c.includes('stock') || c.includes('即時') || c === 'inventory');

                if (mapping.inv === -1 && header.length > 9 && !this.config.COL_INV) mapping.inv = 9;

                let dateCols = [];
                const dateRegex = /\d{2}\.\d{4}\.\d{4}/; 
                
                header.forEach((val, idx) => {
                    if (dateRegex.test(val)) {
                        const match = val.match(/(\d{2})\.(\d{4})/);
                        if (match) {
                            const y = '20' + match[1];
                            const m = match[2].substring(0, 2);
                            const d = match[2].substring(2, 4);
                            dateCols.push({ idx, date: `${y}-${m}-${d}` });
                        }
                    }
                });

                if (mapping.sku === -1) {
                    this.toggleLoader(false);
                    this.showError(true, `Found header at row ${mainRowIdx+1} but missing SKU column. Try manual mapping.`);
                    return;
                }

                this.mainRowIdx = mainRowIdx;
                this.mapping = { ...mapping, dateCols: dateCols.sort((a,b) => a.date.localeCompare(b.date)) };
                this.recalculate();
            },

            recalculate: function() {
                const windowDays = document.getElementById('sel-window').value;
                const targetMonths = parseFloat(document.getElementById('inp-target').value) || 2;

                let activeCols = this.mapping.dateCols;
                let denom = activeCols.length;

                if (windowDays !== 'all') {
                    const days = parseInt(windowDays);
                    const cutoff = new Date(); cutoff.setDate(cutoff.getDate() - days);
                    const cutoffStr = cutoff.toISOString().split('T')[0];
                    activeCols = activeCols.filter(c => c.date >= cutoffStr);
                    denom = days;
                } else {
                    if(activeCols.length > 1) {
                        const start = new Date(activeCols[0].date);
                        const end = new Date(activeCols[activeCols.length-1].date);
                        denom = Math.max(1, (end - start) / (1000 * 60 * 60 * 24));
                    }
                }

                const results = [];
                const startRow = this.mainRowIdx + 1; 

                for (let i = startRow; i < this.rawData.length; i++) {
                    const row = this.rawData[i];
                    if (!row || !row[this.mapping.sku]) continue;

                    let invStr = String(row[this.mapping.inv] || '0').replace(/,/g, '').trim();
                    let inv = parseFloat(invStr);
                    if (isNaN(inv)) inv = 0;

                    let totalOut = 0;
                    let dayVals = [];

                    activeCols.forEach(col => {
                        let valStr = String(row[col.idx] || '0').replace(/,/g, '').trim();
                        let val = parseFloat(valStr);
                        if (val < 0) {
                            const qty = Math.abs(val);
                            totalOut += qty;
                            dayVals.push(qty);
                        }
                    });

                    // Monthly Calculation
                    let dailyRate = totalOut / Math.max(1, denom);
                    let monthlyRate = dailyRate * 30; // 30-day standard month

                    const mos = monthlyRate > 0.01 ? inv / monthlyRate : 999;
                    const refill = Math.max(0, (monthlyRate * targetMonths) - inv);
                    
                    let status = 'OK';
                    if (dayVals.length < 3 && windowDays !== '14') status = 'Low Data';
                    else if (mos < targetMonths) status = 'Risk';

                    results.push({
                        sku: row[this.mapping.sku],
                        name: this.mapping.name > -1 ? row[this.mapping.name] : '',
                        inv, monthlyRate, mos, refill, status
                    });
                }

                this.processedData = results;
                this.updateDashboard();
                this.toggleLoader(false);
                document.getElementById('dashboard-content').classList.remove('hidden');
                document.getElementById('connection-status').classList.remove('hidden');
            },

            updateDashboard: function() {
                const totalSkus = this.processedData.length;
                const riskCount = this.processedData.filter(d => d.status === 'Risk').length;
                const totalRefill = this.processedData.reduce((acc, curr) => acc + curr.refill, 0);
                const lowConf = this.processedData.filter(d => d.status === 'Low Data').length;

                document.getElementById('kpi-total-skus').innerText = totalSkus.toLocaleString();
                document.getElementById('kpi-risk-count').innerText = riskCount.toLocaleString();
                document.getElementById('kpi-refill-qty').innerText = Math.ceil(totalRefill).toLocaleString();
                document.getElementById('kpi-low-conf').innerText = lowConf.toLocaleString();

                this.renderCharts(riskCount, lowConf, totalSkus);
                this.sortTable(this.sort.col, true); 
            },

            renderCharts: function(risk, lowConf, total) {
                const healthy = total - risk - lowConf;
                const ctxHealth = document.getElementById('chart-health').getContext('2d');
                if (this.charts.health) this.charts.health.destroy();
                this.charts.health = new Chart(ctxHealth, {
                    type: 'doughnut',
                    data: {
                        labels: ['Healthy', 'Risk (< Target)', 'Low Data'],
                        datasets: [{ data: [healthy, risk, lowConf], backgroundColor: ['#10b981', '#ef4444', '#f59e0b'], borderWidth: 0 }]
                    },
                    options: { responsive: true, maintainAspectRatio: false, cutout: '70%', plugins: { legend: { position: 'bottom' } } }
                });

                const topRefill = [...this.processedData].sort((a,b) => b.refill - a.refill).slice(0, 10);
                const ctxRefill = document.getElementById('chart-refill').getContext('2d');
                if (this.charts.refill) this.charts.refill.destroy();
                this.charts.refill = new Chart(ctxRefill, {
                    type: 'bar',
                    data: {
                        labels: topRefill.map(d => d.sku),
                        datasets: [{ label: 'Units', data: topRefill.map(d => d.refill), backgroundColor: '#0ea5e9', borderRadius: 4 }]
                    },
                    options: { responsive: true, maintainAspectRatio: false, indexAxis: 'y', plugins: { legend: { display: false } }, scales: { x: { grid: { display: false } }, y: { grid: { display: false } } } }
                });
            },

            sortTable: function(col, keepDir) {
                if (!keepDir) { this.sort.asc = this.sort.col === col ? !this.sort.asc : true; this.sort.col = col; }
                const mult = this.sort.asc ? 1 : -1;
                this.processedData.sort((a, b) => {
                    let v1 = a[col], v2 = b[col];
                    if (typeof v1 === 'string') return v1.localeCompare(v2) * mult;
                    return (v1 - v2) * mult;
                });
                this.renderTable();
            },

            renderTable: function(searchTerm = '') {
                const tbody = document.getElementById('table-body');
                tbody.innerHTML = '';
                const term = searchTerm.toLowerCase();
                let count = 0;

                for (const row of this.processedData) {
                    if (count >= 500) break;
                    if (term && !row.sku.toLowerCase().includes(term) && !row.name.toLowerCase().includes(term)) continue;
                    count++;
                    const tr = document.createElement('tr');
                    let statusClass = row.status === 'Risk' ? 'bg-rose-100 text-rose-800' : (row.status === 'Low Data' ? 'bg-amber-100 text-amber-800' : 'bg-emerald-100 text-emerald-800');
                    tr.className = "hover:bg-stone-50 transition-colors";
                    tr.innerHTML = `
                        <td class="px-6 py-4 font-medium text-stone-900">${row.sku}</td>
                        <td class="px-6 py-4 text-stone-500 truncate max-w-xs" title="${row.name}">${row.name}</td>
                        <td class="px-6 py-4 text-right font-mono">${Math.round(row.inv).toLocaleString()}</td>
                        <td class="px-6 py-4 text-right font-mono">${Math.round(row.monthlyRate).toLocaleString()}</td>
                        <td class="px-6 py-4 text-right font-mono ${row.status === 'Risk' ? 'text-rose-600 font-bold' : ''}">${row.mos > 999 ? '>999' : row.mos.toFixed(1)}</td>
                        <td class="px-6 py-4 text-right font-mono ${row.refill > 0 ? 'text-sky-600 font-bold' : 'text-stone-400'}">${row.refill > 0 ? Math.ceil(row.refill).toLocaleString() : '-'}</td>
                        <td class="px-6 py-4 text-center"><span class="px-2 py-1 rounded-full text-xs font-bold ${statusClass}">${row.status}</span></td>
                    `;
                    tbody.appendChild(tr);
                }
            }
        };

        window.addEventListener('load', () => app.init());
    </script>
</body>
</html>
