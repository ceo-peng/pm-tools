<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Inventory Intelligence Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');
        body { font-family: 'Inter', sans-serif; background-color: #f8fafc; color: #334155; }
        
        /* Chart Container */
        .chart-container { position: relative; width: 100%; height: 300px; margin: auto; }
        
        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 3px; }
        ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }

        /* Loader */
        .loader { border: 3px solid #f3f3f3; border-radius: 50%; border-top: 3px solid #2563eb; width: 24px; height: 24px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        /* UI Transitions */
        .modal { transition: opacity 0.2s ease-in-out; }
        .fade-in { animation: fadeIn 0.5s ease-out forwards; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body class="flex flex-col min-h-screen">

    <!-- Navbar -->
    <nav class="bg-white border-b border-slate-200 sticky top-0 z-30 shadow-sm">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 h-16 flex items-center justify-between">
            <div class="flex items-center gap-3">
                <div class="bg-blue-600 text-white p-1.5 rounded-lg font-bold text-lg leading-none">PM</div>
                <h1 class="text-lg font-bold text-slate-800 tracking-tight">Inventory Intelligence</h1>
            </div>
            
            <div class="flex items-center gap-4">
                <div id="status-indicator" class="hidden flex items-center gap-2 px-3 py-1 bg-emerald-50 text-emerald-700 text-xs font-medium rounded-full border border-emerald-100">
                    <span class="w-2 h-2 rounded-full bg-emerald-500 animate-pulse"></span> Live Connection
                </div>
                <button onclick="app.toggleSettings(true)" class="p-2 text-slate-400 hover:text-slate-600 hover:bg-slate-100 rounded-full transition-colors" title="Settings">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"/><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/></svg>
                </button>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <main class="flex-grow p-6 max-w-7xl mx-auto w-full space-y-6">
        
        <!-- Error Banner -->
        <div id="error-banner" class="hidden bg-rose-50 border border-rose-200 rounded-lg p-4 flex flex-wrap gap-4 justify-between items-center">
            <div class="flex items-center gap-3">
                <svg class="w-5 h-5 text-rose-600" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"/></svg>
                <span id="error-message" class="text-sm text-rose-800 font-medium">Connection Error</span>
            </div>
            <button onclick="app.loadMockData()" class="px-4 py-2 bg-white border border-rose-200 text-rose-700 text-xs font-bold rounded shadow-sm hover:bg-rose-50 transition-colors">
                Load Demo Data
            </button>
        </div>

        <!-- Dashboard View -->
        <div id="dashboard-content" class="hidden space-y-6 fade-in">
            
            <!-- Controls -->
            <div class="bg-white p-5 rounded-xl border border-slate-200 shadow-sm flex flex-wrap gap-6 items-end">
                <div class="space-y-1.5">
                    <label class="text-xs font-bold text-slate-500 uppercase tracking-wider">Analysis Window</label>
                    <select id="sel-window" class="w-40 text-sm border-slate-300 rounded-lg bg-slate-50 focus:ring-2 focus:ring-blue-500 focus:border-blue-500 p-2.5">
                        <option value="14">Last 14 Days</option>
                        <option value="30" selected>Last 30 Days</option>
                        <option value="60">Last 60 Days</option>
                        <option value="all">All History</option>
                    </select>
                </div>
                <div class="space-y-1.5">
                    <label class="text-xs font-bold text-slate-500 uppercase tracking-wider">Algorithm</label>
                    <select id="sel-algo" class="w-48 text-sm border-slate-300 rounded-lg bg-slate-50 focus:ring-2 focus:ring-blue-500 focus:border-blue-500 p-2.5">
                        <option value="simple_avg" selected>Average Velocity</option>
                        <option value="p70">P70 Safety (Conservative)</option>
                    </select>
                </div>
                <div class="space-y-1.5">
                    <label class="text-xs font-bold text-slate-500 uppercase tracking-wider">Target DOS</label>
                    <div class="flex items-center gap-2">
                        <input type="number" id="inp-target" value="60" class="w-20 text-sm border-slate-300 rounded-lg bg-slate-50 p-2.5 text-center focus:ring-2 focus:ring-blue-500">
                        <span class="text-sm text-slate-400">days</span>
                    </div>
                </div>
                <div class="flex-grow"></div>
                <button onclick="app.fetchData()" class="text-slate-500 hover:text-blue-600 text-sm font-bold flex items-center gap-2 px-3 py-2 rounded-lg hover:bg-blue-50 transition-colors">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"/></svg>
                    Refresh
                </button>
            </div>

            <!-- Metrics Grid -->
            <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                <div class="bg-white p-5 rounded-xl border border-slate-200 shadow-sm">
                    <div class="text-xs font-bold text-slate-400 uppercase mb-1">Total SKUs</div>
                    <div id="kpi-total" class="text-2xl font-bold text-slate-800">-</div>
                </div>
                <div class="bg-white p-5 rounded-xl border border-slate-200 shadow-sm">
                    <div class="text-xs font-bold text-slate-400 uppercase mb-1">Refill Alerts</div>
                    <div id="kpi-risk" class="text-2xl font-bold text-rose-500">-</div>
                    <div class="text-xs text-rose-200 mt-1">Below target stock</div>
                </div>
                <div class="bg-white p-5 rounded-xl border border-slate-200 shadow-sm">
                    <div class="text-xs font-bold text-slate-400 uppercase mb-1">Total Units Needed</div>
                    <div id="kpi-units" class="text-2xl font-bold text-blue-600">-</div>
                </div>
                <div class="bg-white p-5 rounded-xl border border-slate-200 shadow-sm">
                    <div class="text-xs font-bold text-slate-400 uppercase mb-1">Low Confidence</div>
                    <div id="kpi-conf" class="text-2xl font-bold text-amber-500">-</div>
                    <div class="text-xs text-slate-400 mt-1">&lt; 3 active sales days</div>
                </div>
            </div>

            <!-- Charts -->
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                <div class="bg-white p-6 rounded-xl border border-slate-200 shadow-sm">
                    <h3 class="text-sm font-bold text-slate-700 mb-6">Inventory Health Distribution</h3>
                    <div class="chart-container"><canvas id="chart-health"></canvas></div>
                </div>
                <div class="bg-white p-6 rounded-xl border border-slate-200 shadow-sm">
                    <h3 class="text-sm font-bold text-slate-700 mb-6">Top Refill Priorities (Units)</h3>
                    <div class="chart-container"><canvas id="chart-refill"></canvas></div>
                </div>
            </div>

            <!-- Data Table -->
            <div class="bg-white rounded-xl border border-slate-200 shadow-sm overflow-hidden flex flex-col h-[600px]">
                <div class="p-4 border-b border-slate-200 bg-slate-50 flex flex-col sm:flex-row justify-between items-center gap-4 shrink-0">
                    <h3 class="text-sm font-bold text-slate-800">Detailed Analysis</h3>
                    <div class="relative">
                        <input type="text" id="inp-search" placeholder="Search SKU or Name..." class="pl-9 pr-4 py-2 text-sm border-slate-300 rounded-lg w-full sm:w-64 focus:ring-blue-500">
                        <svg class="w-4 h-4 text-slate-400 absolute left-3 top-2.5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"/></svg>
                    </div>
                </div>
                <div class="overflow-auto flex-grow">
                    <table class="min-w-full divide-y divide-slate-200 relative">
                        <thead class="bg-slate-100 sticky top-0 z-10 shadow-sm">
                            <tr>
                                <th class="px-6 py-3 text-left text-xs font-bold text-slate-500 uppercase tracking-wider cursor-pointer hover:bg-slate-200 transition-colors" onclick="app.sort('sku')">SKU</th>
                                <th class="px-6 py-3 text-left text-xs font-bold text-slate-500 uppercase tracking-wider cursor-pointer hover:bg-slate-200 transition-colors" onclick="app.sort('name')">Product</th>
                                <th class="px-6 py-3 text-right text-xs font-bold text-slate-500 uppercase tracking-wider cursor-pointer hover:bg-slate-200 transition-colors" onclick="app.sort('inv', true)">Stock</th>
                                <th class="px-6 py-3 text-right text-xs font-bold text-slate-500 uppercase tracking-wider cursor-pointer hover:bg-slate-200 transition-colors" onclick="app.sort('rate', true)">Daily Out</th>
                                <th class="px-6 py-3 text-right text-xs font-bold text-slate-500 uppercase tracking-wider cursor-pointer hover:bg-slate-200 transition-colors" onclick="app.sort('dos', true)">DOS</th>
                                <th class="px-6 py-3 text-right text-xs font-bold text-slate-500 uppercase tracking-wider cursor-pointer hover:bg-slate-200 transition-colors" onclick="app.sort('refill', true)">Refill</th>
                                <th class="px-6 py-3 text-center text-xs font-bold text-slate-500 uppercase tracking-wider">Status</th>
                            </tr>
                        </thead>
                        <tbody id="table-body" class="bg-white divide-y divide-slate-200 text-sm text-slate-600"></tbody>
                    </table>
                </div>
            </div>
        </div>
    </main>

    <!-- Settings Modal -->
    <div id="settings-modal" class="modal fixed inset-0 z-50 flex items-center justify-center opacity-0 pointer-events-none">
        <div class="absolute inset-0 bg-slate-900/50 backdrop-blur-sm" onclick="app.toggleSettings(false)"></div>
        <div class="bg-white w-full max-w-lg rounded-xl shadow-2xl z-10 mx-4 flex flex-col max-h-[90vh]">
            <div class="p-5 border-b border-slate-100 flex justify-between items-center">
                <h2 class="text-lg font-bold text-slate-800">Source Configuration</h2>
                <button onclick="app.toggleSettings(false)" class="text-slate-400 hover:text-slate-600">
                    <svg class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/></svg>
                </button>
            </div>
            <div class="p-6 space-y-5 overflow-y-auto">
                <div class="bg-blue-50 text-blue-800 p-4 rounded-lg text-xs leading-relaxed">
                    <strong>Note:</strong> Google Sheet must be shared as <u>"Anyone with the link can view"</u>.
                </div>
                
                <div class="grid grid-cols-1 gap-4">
                    <div>
                        <label class="block text-xs font-bold text-slate-500 uppercase mb-1.5">Spreadsheet ID</label>
                        <input id="conf-id" class="w-full p-2.5 text-sm border-slate-300 rounded-lg focus:ring-blue-500">
                    </div>
                    <div>
                        <label class="block text-xs font-bold text-slate-500 uppercase mb-1.5">Tab Name</label>
                        <input id="conf-tab" class="w-full p-2.5 text-sm border-slate-300 rounded-lg focus:ring-blue-500">
                    </div>
                </div>

                <div class="pt-4 border-t border-slate-100">
                    <p class="text-sm font-bold text-slate-800 mb-3">Manual Column Mapping (Optional)</p>
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="block text-[10px] font-bold text-slate-400 uppercase mb-1">Header Row #</label>
                            <input id="conf-row" type="number" placeholder="Auto" class="w-full p-2 text-xs border-slate-300 rounded focus:ring-blue-500">
                        </div>
                        <div>
                            <label class="block text-[10px] font-bold text-slate-400 uppercase mb-1">Inventory Col</label>
                            <input id="conf-inv" placeholder="Auto (e.g. J)" class="w-full p-2 text-xs border-slate-300 rounded uppercase focus:ring-blue-500">
                        </div>
                        <div>
                            <label class="block text-[10px] font-bold text-slate-400 uppercase mb-1">SKU Col</label>
                            <input id="conf-sku" placeholder="Auto (e.g. A)" class="w-full p-2 text-xs border-slate-300 rounded uppercase focus:ring-blue-500">
                        </div>
                        <div>
                            <label class="block text-[10px] font-bold text-slate-400 uppercase mb-1">Name Col</label>
                            <input id="conf-name" placeholder="Auto (e.g. B)" class="w-full p-2 text-xs border-slate-300 rounded uppercase focus:ring-blue-500">
                        </div>
                    </div>
                </div>
            </div>
            <div class="p-5 border-t border-slate-100 flex justify-end bg-slate-50 rounded-b-xl">
                <button onclick="app.saveSettings()" class="bg-blue-600 text-white font-bold py-2 px-6 rounded-lg text-sm hover:bg-blue-700 shadow-md transition-all transform active:scale-95">Save & Reload</button>
            </div>
        </div>
    </div>

    <!-- Loading Overlay -->
    <div id="loader" class="fixed inset-0 bg-white/90 z-50 flex flex-col items-center justify-center backdrop-blur-sm transition-opacity duration-300">
        <div class="loader"></div>
        <p class="mt-4 text-slate-500 text-sm font-medium animate-pulse">Analyzing Data...</p>
    </div>

    <script>
        // --- Configuration ---
        const DEFAULT_CONFIG = {
            ID: '14yjT90s9CV988KZZ_o6m8F4LbeDWpKTuqVO66gfLboI',
            TAB: 'inventory_tracking',
            ROW: '', SKU: '', NAME: '', INV: ''
        };

        const storage = {
            get: () => { try { return JSON.parse(localStorage.getItem('pm_inv_config')) || DEFAULT_CONFIG; } catch(e){ return DEFAULT_CONFIG; } },
            set: (v) => { try { localStorage.setItem('pm_inv_config', JSON.stringify(v)); } catch(e){} }
        };

        // --- Core Application ---
        const app = {
            config: {}, raw: [], data: [], charts: {}, sortCol: 'refill', sortAsc: false,

            init() {
                this.config = storage.get();
                this.bindEvents();
                this.fetchData();
            },

            bindEvents() {
                document.getElementById('inp-search').addEventListener('keyup', e => this.renderTable(e.target.value));
                ['sel-window', 'sel-algo', 'inp-target'].forEach(id => {
                    document.getElementById(id).addEventListener('change', () => this.calc());
                });
            },

            // 1. Data Fetching (JSONP Pattern)
            fetchData() {
                this.toggleLoader(true);
                document.getElementById('error-banner').classList.add('hidden');
                
                // Construct GViz URL (Force headers=0 to get raw rows)
                const url = `https://docs.google.com/spreadsheets/d/${this.config.ID}/gviz/tq?sheet=${this.config.TAB}&headers=0&tqx=responseHandler:app.handleResponse`;
                const script = document.createElement('script');
                script.src = url;
                script.onerror = () => this.handleError("Network Error. Check internet connection.");
                document.body.appendChild(script);
            },

            // 2. Response Handling
            handleResponse(json) {
                if (json.status === 'error') return this.handleError(json.errors[0].detailed_message);
                
                // Flatten Google's complex JSON structure
                this.raw = json.table.rows.map(r => r.c.map(c => (c && c.v !== null) ? String(c.v) : ""));
                
                this.parse();
            },

            handleError(msg) {
                this.toggleLoader(false);
                document.getElementById('error-message').innerText = msg;
                document.getElementById('error-banner').classList.remove('hidden');
            },

            // 3. Intelligent Parsing (The Brain)
            parse() {
                const rows = this.raw;
                let hRow = -1;

                // A. Find Header Row
                if (this.config.ROW) {
                    hRow = parseInt(this.config.ROW) - 1;
                } else {
                    // Auto-scan first 15 rows for 'unique_key'
                    for(let i=0; i<Math.min(rows.length, 15); i++) {
                        if(rows[i].join('|').toLowerCase().includes('unique_key')) { hRow = i; break; }
                    }
                }

                if (hRow === -1 || !rows[hRow]) return this.handleError("Header 'unique_key' not found. Check Tab Name or set Header Row manually.");

                // B. Map Columns
                const header = rows[hRow].map(c => c.toLowerCase().trim());
                const map = { sku: -1, name: -1, inv: -1, dates: [] };

                // Helper to convert 'A' -> 0
                const l2i = (l) => l ? l.toUpperCase().split('').reduce((p,c) => p*26 + c.charCodeAt(0) - 64, 0) - 1 : -1;

                map.sku = this.config.SKU ? l2i(this.config.SKU) : header.indexOf('unique_key');
                map.name = this.config.NAME ? l2i(this.config.NAME) : header.findIndex(c => c.includes('product_name') || c.includes('品名'));
                
                // Fuzzy Inventory Match
                if(this.config.INV) map.inv = l2i(this.config.INV);
                else map.inv = header.findIndex(c => c.includes('庫存') || c.includes('stock') || c.includes('即時') || c === 'inventory');
                // Fallback for column J (index 9) if not found but structure looks familiar
                if (map.inv === -1 && header.length > 9) map.inv = 9;

                // C. Find Date Columns (Regex: YY.MMDD.HHMM)
                const dateRegex = /\d{2}\.\d{4}\.\d{4}/;
                header.forEach((txt, idx) => {
                    if (dateRegex.test(txt)) {
                        const m = txt.match(/(\d{2})\.(\d{4})/);
                        if (m) map.dates.push({ idx, date: `20${m[1]}-${m[2].substr(0,2)}-${m[2].substr(2,2)}` });
                    }
                });
                map.dates.sort((a,b) => a.date.localeCompare(b.date));

                if (map.sku === -1 || map.dates.length === 0) return this.handleError(`Mapping Failed (Row ${hRow+1}). SKU:${map.sku}, Dates:${map.dates.length}`);

                this.map = map;
                this.hRow = hRow;
                this.calc();
            },

            // 4. Calculation Engine
            calc() {
                const win = document.getElementById('sel-window').value;
                const algo = document.getElementById('sel-algo').value;
                const target = parseInt(document.getElementById('inp-target').value) || 60;

                // Date Filtering
                let activeDates = this.map.dates;
                let denom = activeDates.length;

                if (win !== 'all') {
                    const days = parseInt(win);
                    const cutoff = new Date(); cutoff.setDate(cutoff.getDate() - days);
                    const iso = cutoff.toISOString().split('T')[0];
                    activeDates = activeDates.filter(d => d.date >= iso);
                    denom = days;
                } else {
                    if(activeDates.length > 1) {
                        const start = new Date(activeDates[0].date);
                        const end = new Date(activeDates[activeDates.length-1].date);
                        denom = Math.max(1, (end-start)/(1000*60*60*24));
                    }
                }

                // Process Rows
                const result = [];
                for(let i = this.hRow + 1; i < this.raw.length; i++) {
                    const row = this.raw[i];
                    if(!row[this.map.sku]) continue;

                    // Clean inventory number (remove commas)
                    const inv = parseFloat(String(row[this.map.inv]||'0').replace(/,/g,'')) || 0;
                    
                    let totalOut = 0;
                    let dayVals = [];

                    activeDates.forEach(d => {
                        const val = parseFloat(String(row[d.idx]||'0').replace(/,/g,'')) || 0;
                        if(val < 0) { // Only negative implies sales/outflow
                            const qty = Math.abs(val);
                            totalOut += qty;
                            dayVals.push(qty);
                        }
                    });

                    // Algorithm
                    let rate = 0;
                    if(algo === 'simple_avg') {
                        rate = totalOut / Math.max(1, denom);
                    } else if (algo === 'p70') {
                        if(dayVals.length > 0) {
                            dayVals.sort((a,b)=>a-b);
                            rate = dayVals[Math.floor(dayVals.length * 0.7)];
                        }
                    }

                    const dos = rate > 0.001 ? inv / rate : 999;
                    const refill = Math.max(0, (rate * target) - inv);
                    let status = 'OK';
                    if(dayVals.length < 3 && win !== '14') status = 'Low Data'; // Heuristic
                    else if(dos < target) status = 'Risk';

                    result.push({
                        sku: row[this.map.sku],
                        name: this.map.name > -1 ? row[this.map.name] : '',
                        inv, rate, dos, refill, status
                    });
                }

                this.data = result;
                this.updateUI();
                this.toggleLoader(false);
                document.getElementById('dashboard-content').classList.remove('hidden');
                document.getElementById('status-indicator').classList.remove('hidden');
            },

            // 5. UI Updates
            updateUI() {
                const total = this.data.length;
                const risk = this.data.filter(x => x.status === 'Risk').length;
                const low = this.data.filter(x => x.status === 'Low Data').length;
                const units = this.data.reduce((a,b) => a + b.refill, 0);

                // KPIs
                const kpi = (id, val) => document.getElementById(id).innerText = Math.ceil(val).toLocaleString();
                kpi('kpi-total', total);
                kpi('kpi-risk', risk);
                kpi('kpi-units', units);
                kpi('kpi-conf', low);

                // Charts
                this.drawChart('chart-health', 'doughnut', ['Healthy', 'Risk', 'Low Data'], [total-risk-low, risk, low], ['#10b981', '#f43f5e', '#f59e0b']);
                
                const top = [...this.data].sort((a,b)=>b.refill-a.refill).slice(0, 10);
                this.drawChart('chart-refill', 'bar', top.map(x=>x.sku), top.map(x=>x.refill), '#3b82f6', true);

                // Table
                this.sort(this.sortCol, true);
            },

            drawChart(id, type, labels, data, colors, indexAxis=false) {
                const ctx = document.getElementById(id).getContext('2d');
                if(this.charts[id]) this.charts[id].destroy();
                this.charts[id] = new Chart(ctx, {
                    type,
                    data: { 
                        labels, 
                        datasets: [{ 
                            label: 'Data', 
                            data, 
                            backgroundColor: colors, 
                            borderWidth: 0,
                            borderRadius: type === 'bar' ? 4 : 0
                        }] 
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        indexAxis: indexAxis ? 'y' : 'x',
                        plugins: { legend: { display: type === 'doughnut', position: 'bottom' } },
                        cutout: '75%',
                        scales: { x: { display: false }, y: { display: false } }
                    }
                });
            },

            // 6. Table Sort & Render
            sort(col, keepDir) {
                if (!keepDir) { this.sortAsc = this.sortCol === col ? !this.sortAsc : true; this.sortCol = col; }
                const m = this.sortAsc ? 1 : -1;
                this.data.sort((a, b) => {
                    let v1 = a[col], v2 = b[col];
                    if (typeof v1 === 'string') return v1.localeCompare(v2) * m;
                    return (v1 - v2) * m;
                });
                this.renderTable();
            },

            renderTable(filter = '') {
                const tbody = document.getElementById('table-body');
                tbody.innerHTML = '';
                const term = filter.toLowerCase();
                let count = 0;

                for (const row of this.data) {
                    if (count >= 500) break;
                    if (term && !row.sku.toLowerCase().includes(term) && !row.name.toLowerCase().includes(term)) continue;
                    
                    count++;
                    const tr = document.createElement('tr');
                    tr.className = 'hover:bg-slate-50 border-b border-slate-100 transition-colors';
                    
                    let badge = 'bg-emerald-100 text-emerald-700';
                    if(row.status === 'Risk') badge = 'bg-rose-100 text-rose-700';
                    else if(row.status === 'Low Data') badge = 'bg-amber-100 text-amber-700';

                    tr.innerHTML = `
                        <td class="px-6 py-4 font-medium text-slate-900">${row.sku}</td>
                        <td class="px-6 py-4 text-slate-500 truncate max-w-xs" title="${row.name}">${row.name}</td>
                        <td class="px-6 py-4 text-right font-mono text-slate-600">${Math.round(row.inv).toLocaleString()}</td>
                        <td class="px-6 py-4 text-right font-mono text-slate-600">${row.rate.toFixed(1)}</td>
                        <td class="px-6 py-4 text-right font-mono ${row.status === 'Risk' ? 'text-rose-600 font-bold' : 'text-slate-600'}">${row.dos > 999 ? '>999' : row.dos.toFixed(1)}</td>
                        <td class="px-6 py-4 text-right font-mono ${row.refill > 0 ? 'text-blue-600 font-bold' : 'text-slate-400'}">${row.refill > 0 ? Math.ceil(row.refill).toLocaleString() : '-'}</td>
                        <td class="px-6 py-4 text-center"><span class="px-2.5 py-1 rounded-full text-xs font-bold ${badge}">${row.status}</span></td>
                    `;
                    tbody.appendChild(tr);
                }
            },

            // 7. Settings Management
            toggleSettings(show) {
                const el = document.getElementById('settings-modal');
                if(show) {
                    // Load current config into inputs
                    document.getElementById('conf-id').value = this.config.ID;
                    document.getElementById('conf-tab').value = this.config.TAB;
                    document.getElementById('conf-row').value = this.config.ROW;
                    document.getElementById('conf-inv').value = this.config.INV;
                    document.getElementById('conf-sku').value = this.config.SKU;
                    document.getElementById('conf-name').value = this.config.NAME;
                    
                    el.classList.remove('opacity-0', 'pointer-events-none');
                    document.body.classList.add('modal-active');
                } else {
                    el.classList.add('opacity-0', 'pointer-events-none');
                    document.body.classList.remove('modal-active');
                }
            },

            saveSettings() {
                this.config.ID = document.getElementById('conf-id').value.trim();
                this.config.TAB = document.getElementById('conf-tab').value.trim();
                this.config.ROW = document.getElementById('conf-row').value.trim();
                this.config.INV = document.getElementById('conf-inv').value.trim();
                this.config.SKU = document.getElementById('conf-sku').value.trim();
                this.config.NAME = document.getElementById('conf-name').value.trim();
                
                storage.set(this.config);
                this.toggleSettings(false);
                this.fetchData();
            },

            toggleLoader(show) {
                const el = document.getElementById('loader');
                if(show) el.classList.remove('hidden'); else el.classList.add('hidden');
            },

            loadMockData() {
                this.toggleLoader(true);
                setTimeout(() => {
                    // Generate Header
                    const head = ['unique_key', 'product_name', '即時庫存數量'];
                    const dates = [];
                    for(let i=14; i>=0; i--) {
                        const d = new Date(); d.setDate(d.getDate()-i);
                        const str = `${d.getFullYear().toString().substr(2)}.${String(d.getMonth()+1).padStart(2,'0')}${String(d.getDate()).padStart(2,'0')}.1200`;
                        head.push(str); dates.push(str);
                    }
                    // Generate Rows
                    const rows = [head]; // Header at index 0
                    for(let i=1; i<=20; i++) {
                        const inv = Math.floor(Math.random()*200);
                        const row = [`DEMO-${i}`, `Test Product ${i}`, String(inv)];
                        for(let j=0; j<15; j++) row.push(Math.random()>0.7 ? String(-Math.floor(Math.random()*10)) : "0");
                        rows.push(row);
                    }
                    this.raw = rows;
                    // Reset config for demo to ensure parsing works
                    const backup = {...this.config};
                    this.config.ROW = ''; 
                    this.parse();
                    this.config = backup; // Restore config
                    document.getElementById('connection-status').innerHTML = '<span class="w-2 h-2 rounded-full bg-amber-500"></span> Demo Mode';
                    document.getElementById('connection-status').classList.remove('hidden');
                }, 600);
            }
        };

        // Start
        window.addEventListener('load', () => app.init());
    </script>
</body>
</html>
