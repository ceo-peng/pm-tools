<!doctype html>
<html lang="zh-Hant">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>PM 庫存更新系統（Write4Version）</title>
<style>
  :root{
    --bg:#ffffff; --fg:#111827; --muted:#6b7280; --line:#e5e7eb;
    --card:#ffffff; --card2:#f9fafb; --accent:#2563eb; --accent2:#111827;
    --soft:#f3f4f6; --danger:#ef4444; --ok:#16a34a; --warn:#d97706;
    --radius:12px;
  }
  *{box-sizing:border-box}
  body{margin:0;background:var(--bg);color:var(--fg);font:14px/1.5 system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;}
  h1{font-size:22px;margin:16px 0}
  h2{font-size:18px;margin:0 0 8px}
  .container{max-width:1120px;margin:0 auto;padding:16px}
  .card{background:var(--card);border:1px solid var(--line);border-radius:var(--radius);box-shadow:0 1px 2px rgba(0,0,0,.04)}
  .card-hd{display:flex;align-items:center;justify-content:space-between;padding:10px 12px;border-bottom:1px solid var(--line);background:var(--card2)}
  .card-bd{padding:12px}
  .muted{color:var(--muted)}
  .row{display:flex;gap:12px;flex-wrap:wrap}
  .col{flex:1 1 280px}
  .grid{display:grid;gap:12px}
  .grid-3{grid-template-columns:repeat(3,minmax(0,1fr))}
  @media (max-width:960px){.grid-3{grid-template-columns:repeat(2,minmax(0,1fr))}}
  @media (max-width:640px){.grid-3{grid-template-columns:repeat(1,minmax(0,1fr))}}

  .btn{border:1px solid var(--line);background:#fff;border-radius:8px;padding:6px 10px;cursor:pointer}
  .btn:hover{border-color:#cbd5e1}
  .btn-ok{background:var(--accent);color:#fff;border-color:var(--accent)}
  .btn-danger{background:#fff;border-color:#fca5a5;color:#b91c1c}
  .btn-ghost{background:transparent;border-color:transparent;color:var(--accent)}
  .badge{font-size:12px;padding:2px 8px;border-radius:50px;border:1px solid var(--line);background:var(--soft);}

  .field{display:flex;flex-direction:column;gap:6px}
  .lab{font-size:12px;color:var(--muted)}
  select,input[type=text]{width:100%;padding:8px 10px;border:1px solid var(--line);border-radius:8px;background:#fff}
  .stack-8{display:flex;flex-direction:column;gap:8px}
  .stack-12{display:flex;flex-direction:column;gap:12px}
  .stack-16{display:flex;flex-direction:column;gap:16px}
  .bleed{margin:0 -6px}

  .bundle-card{border:1px solid var(--line);border-radius:10px;background:#fff;padding:10px}
  .title-2lines{display:-webkit-box;-webkit-line-clamp:2;-webkit-box-orient:vertical;overflow:hidden}
  .right{margin-left:auto}

  .stepper{display:inline-flex;align-items:center;border:1px solid var(--line);border-radius:10px;height:34px;background:#fff}
  .stepper button{width:36px;height:32px;border:0;background:transparent;font-size:16px;cursor:pointer}
  .stepper input{width:46px;height:32px;border:0;text-align:center;font-size:14px;outline:0}

  table{width:100%;border-collapse:collapse}
  th,td{padding:10px;border-bottom:1px solid var(--line);vertical-align:middle}
  th{font-weight:600;text-align:left;background:#fafafa}

  .pill{display:inline-block;padding:3px 8px;border:1px dashed var(--line);border-radius:999px;color:var(--muted);font-size:12px}

  /* modal */
  .modal{position:fixed;inset:0;background:rgba(0,0,0,.45);display:none;align-items:center;justify-content:center;padding:16px}
  .modal.show{display:flex}
  .modal-card{max-width:880px;width:100%;background:#fff;border-radius:12px;box-shadow:0 8px 24px rgba(0,0,0,.25);overflow:hidden}
  .modal-hd{padding:12px;border-bottom:1px solid var(--line);background:#f8fafc;font-weight:600}
  .modal-bd{padding:12px;max-height:70vh;overflow:auto}
  .modal-ft{padding:12px;border-top:1px solid var(--line);display:flex;gap:8px;justify-content:flex-end}
</style>
</head>
<body>
<div class="container">
  <h1>PM 庫存更新系統（Write4Version）</h1>

  <!-- 出貨訂單資訊 -->
  <section class="card" id="orderCard">
    <div class="card-hd">
      <div>出貨訂單資訊</div>
      <div class="muted" id="docIdLabel">表單-日期-ID：—</div>
    </div>
    <div class="card-bd stack-12">
      <div class="row">
        <label class="btn"><input type="radio" name="mode" value="sales" checked> 銷售</label>
        <label class="btn"><input type="radio" name="mode" value="non_sales"> 非銷售</label>
      </div>

      <div class="row">
        <div class="col field">
          <div class="lab" id="catLab">客戶分類</div>
          <select id="categorySelect">
            <option value="">選擇訂單類別</option>
          </select>
        </div>
        <div class="col field">
          <div class="lab">客戶 PO 出貨單號</div>
          <input id="poInput" type="text" placeholder="可留空" />
        </div>
        <div class="col field">
          <div class="lab">備註</div>
          <input id="memoInput" type="text" placeholder="可留空" />
        </div>
      </div>
    </div>
  </section>

  <!-- 產品選擇 -->
  <section class="card" style="margin-top:12px">
    <div class="card-hd">
      <div>產品選擇</div>
      <span class="pill">套組 / 單品 / 禮遇 → 先加入預覽</span>
    </div>
    <div class="card-bd stack-16">

      <!-- 套組 -->
      <div class="stack-8">
        <div class="lab">套組</div>
        <div id="bundleGrid" class="grid grid-3"></div>
      </div>

      <!-- 單品 -->
      <div class="stack-8">
        <div class="lab">單品</div>
        <div class="row">
          <div class="col field">
            <div class="lab">商品類別（A）</div>
            <select id="selA"></select>
          </div>
          <div class="col field">
            <div class="lab">系列名稱（B）</div>
            <select id="selB"></select>
          </div>
          <div class="col field">
            <div class="lab">產品名稱（C / 唯一 ID）</div>
            <select id="selC"></select>
          </div>
          <div class="col field">
            <div class="lab">數量</div>
            <div class="stepper" id="singleQtyWrap">
              <button type="button" data-s="-1">−</button>
              <input type="text" value="1" id="singleQty">
              <button type="button" data-s="1">＋</button>
            </div>
          </div>
          <div class="col field">
            <div class="lab">&nbsp;</div>
            <button class="btn btn-ok" id="addSingleBtn">加入</button>
          </div>
        </div>
      </div>

      <!-- 禮遇 -->
      <div class="stack-8">
        <div class="lab">禮遇</div>
        <div id="giftsWrap" class="stack-8"></div>
      </div>
    </div>
  </section>

  <!-- 庫存更新預覽（可編輯 + 可收合） -->
  <section class="card" style="margin-top:12px">
    <div class="card-hd">
      <div>庫存更新預覽</div>
      <button class="btn-ghost" id="togglePreviewBtn">收</button>
    </div>
    <div class="card-bd" id="previewBody">
      <div class="grid" style="grid-template-columns:repeat(3,minmax(0,1fr));gap:16px" id="previewGrid">
        <div>
          <div class="lab" style="margin-bottom:6px">套組</div>
          <div id="pvBundles" class="stack-8 muted">(無)</div>
        </div>
        <div>
          <div class="lab" style="margin-bottom:6px">單品</div>
          <div id="pvSingles" class="stack-8 muted">(無)</div>
        </div>
        <div>
          <div class="lab" style="margin-bottom:6px">禮遇</div>
          <div id="pvGifts" class="stack-8 muted">(無)</div>
        </div>
      </div>
      <div class="row" style="margin-top:12px">
        <button class="btn btn-danger" id="pvClear">全部清除</button>
        <div class="right"></div>
        <button class="btn btn-ok" id="pvCommit">確認加入</button>
      </div>
    </div>
  </section>

  <!-- 出貨清單／庫存扣減確認 -->
  <section class="card" style="margin-top:12px">
    <div class="card-hd">
      <div>出貨清單／庫存扣減確認</div>
      <div class="row" style="gap:8px;align-items:center">
        <span class="lab">簽名：</span>
        <label class="btn"><input type="radio" name="sign" value="-1" checked> 出貨（扣）</label>
        <label class="btn"><input type="radio" name="sign" value="1"> 進貨（入）</label>
      </div>
    </div>
    <div class="card-bd stack-12">
      <div id="orderHeader" class="stack-8">
        <div><span class="lab">類別：</span><span id="hdrCat">—</span></div>
        <div><span class="lab">客戶 PO：</span><span id="hdrPO">—</span></div>
        <div><span class="lab">備註：</span><span id="hdrMemo">—</span></div>
        <div><span class="lab">表單-日期-ID：</span><span id="hdrDoc">—</span></div>
      </div>

      <div class="stack-8">
        <table>
          <thead>
            <tr>
              <th style="width:120px">點交量（Picked）</th>
              <th>商品名稱</th>
              <th style="width:140px">預計（Planned）</th>
              <th style="width:56px">刪</th>
            </tr>
          </thead>
          <tbody id="finalTbody">
            <tr><td colspan="4" class="muted">尚未加入任何品項</td></tr>
          </tbody>
        </table>
      </div>

      <div class="row">
        <div class="badge" id="sumBadge">項：0　計：0　點：0</div>
        <div class="right"></div>
        <button class="btn" id="btnFill">全部帶入</button>
        <button class="btn btn-danger" id="btnClearFinal">全部清除</button>
        <button class="btn btn-ok" id="btnSubmit">庫存更新提交</button>
      </div>
    </div>
  </section>
</div>

<!-- 提交前預覽 Modal -->
<div class="modal" id="confirmModal" role="dialog" aria-modal="true">
  <div class="modal-card">
    <div class="modal-hd">送出前確認</div>
    <div class="modal-bd">
      <div class="stack-8" id="cmHeader">
        <!-- 訂單資訊會放這 -->
      </div>
      <table style="margin-top:8px">
        <thead>
          <tr><th style="width:80px">Δ</th><th>商品名稱（唯一 ID）</th></tr>
        </thead>
        <tbody id="cmBody"></tbody>
      </table>
    </div>
    <div class="modal-ft">
      <button class="btn" id="cmCancel">取消</button>
      <button class="btn btn-ok" id="cmOk">確認送出</button>
    </div>
  </div>
</div>

<script>
/* ---------- Config: GitHub CSV endpoints & Webhook ---------- */
const URLS = {
  products: "https://raw.githubusercontent.com/ceo-peng/pm-tools/refs/heads/main/data/products.csv",
  customers: "https://raw.githubusercontent.com/ceo-peng/pm-tools/refs/heads/main/data/customers.csv",
  bundles:   "https://raw.githubusercontent.com/ceo-peng/pm-tools/refs/heads/main/data/bundle_items.csv",
  gifts:     "https://raw.githubusercontent.com/ceo-peng/pm-tools/refs/heads/main/data/gifts.csv",
  nonsales:  "https://raw.githubusercontent.com/ceo-peng/pm-tools/refs/heads/main/data/non_sales_application.csv"
};
const WEBHOOK = "https://hook.us2.make.com/nbjdxrfypgoosj4qqxnzfmj9o29jq3c2";

/* ---------- Utils ---------- */
const $ = sel => document.querySelector(sel);
const $$ = sel => Array.from(document.querySelectorAll(sel));
const clamp = (n,min,max)=>Math.min(max,Math.max(min,n));
const parseLines = (csv)=> csv.split(/\r?\n/).map(s=>s.trim()).filter(s=>s && !/^#/.test(s));

function parseProducts(csv){
  const list = [];
  for(const line of parseLines(csv)){
    const parts = line.split(","); if(parts.length<3) continue;
    const [A,B,C] = parts.map(s=>s.trim());
    if(!C) continue;
    list.push({A,B,C,id:C,name:C});
  }
  return list;
}
function parsePairs(csv){
  const arr = [];
  for(const line of parseLines(csv)){
    const [id,name] = line.split(",").map(s=>s.trim());
    if(id && name) arr.push({id,name});
  }
  return arr;
}
function parseBundleCsv(csv){
  // bundle_id,bundle_name,product_id,qty,active
  const map = new Map();
  for(const line of parseLines(csv)){
    const [bid,bname,pid,qtyRaw,active] = line.split(",").map(s=>s.trim());
    if(!bid || !bname || !pid) continue;
    if(active==="0") continue;
    const qty = Number.parseInt(qtyRaw||"1",10) || 1;
    const rec = map.get(bid) || {id:bid, name:bname, items:[]};
    rec.items.push({productId:pid, qty});
    map.set(bid,rec);
  }
  return Array.from(map.values());
}

/* ---------- State ---------- */
let PRODUCTS=[], CUSTOMERS=[], NONSALES=[], BUNDLES=[], GIFTS=[];
let preview = { bundles:new Map(), singles:new Map(), gifts:new Set() }; // 可編輯預覽
let finalCart = new Map(); // productId -> {name, planned, picked}

/* ---------- Elements ---------- */
const docIdLabel = $("#docIdLabel");
const catLab = $("#catLab");
const categorySelect = $("#categorySelect");
const poInput = $("#poInput");
const memoInput = $("#memoInput");

const bundleGrid = $("#bundleGrid");
const selA=$("#selA"), selB=$("#selB"), selC=$("#selC");
const singleQty=$("#singleQty"), singleQtyWrap=$("#singleQtyWrap"), addSingleBtn=$("#addSingleBtn");
const giftsWrap=$("#giftsWrap");

const pvBundles=$("#pvBundles"), pvSingles=$("#pvSingles"), pvGifts=$("#pvGifts");
const pvClear=$("#pvClear"), pvCommit=$("#pvCommit"), togglePreviewBtn=$("#togglePreviewBtn"), previewBody=$("#previewBody");

const hdrCat=$("#hdrCat"), hdrPO=$("#hdrPO"), hdrMemo=$("#hdrMemo"), hdrDoc=$("#hdrDoc");
const finalTbody=$("#finalTbody");
const btnFill=$("#btnFill"), btnClearFinal=$("#btnClearFinal"), btnSubmit=$("#btnSubmit");
const sumBadge=$("#sumBadge");

const confirmModal=$("#confirmModal"), cmHeader=$("#cmHeader"), cmBody=$("#cmBody"), cmCancel=$("#cmCancel"), cmOk=$("#cmOk");

/* ---------- Mode: sales / non_sales -> category datasource ---------- */
function currentMode(){ return ($('input[name="mode"]:checked')||{}).value || "sales"; }
function setDocId(){
  const now=new Date(); const p=(n)=>String(n).padStart(2,"0");
  const prefix = (currentMode()==="sales" ? (categorySelect.value||"") : (categorySelect.value||""));
  const id = `${prefix||"—"}-${now.getFullYear()}${p(now.getMonth()+1)}${p(now.getDate())}-${p(now.getHours())}${p(now.getMinutes())}`;
  docIdLabel.textContent = `表單-日期-ID：${id}`;
  hdrDoc.textContent = id;
}
function fillCategoryOptions(){
  categorySelect.innerHTML = `<option value="">選擇訂單類別</option>`;
  const src = currentMode()==="sales" ? CUSTOMERS : NONSALES;
  src.forEach(x=>{
    const opt=document.createElement("option");
    opt.value=x.id; opt.textContent=x.name;
    categorySelect.appendChild(opt);
  });
  catLab.textContent = currentMode()==="sales" ? "客戶分類" : "非銷售分類";
  setDocId();
}

/* ---------- Singles A/B/C cascaded ---------- */
function refreshABC(){
  // A
  const Avals = [...new Set(PRODUCTS.map(p=>p.A))];
  selA.innerHTML = Avals.map(a=>`<option value="${a}">${a}</option>`).join("");
  selA.dispatchEvent(new Event("change"));
}
selA.addEventListener("change",()=>{
  const a=selA.value;
  const Bvals=[...new Set(PRODUCTS.filter(p=>p.A===a).map(p=>p.B))];
  selB.innerHTML=Bvals.map(b=>`<option value="${b}">${b}</option>`).join("");
  selB.dispatchEvent(new Event("change"));
});
selB.addEventListener("change",()=>{
  const a=selA.value,b=selB.value;
  const Cvals=PRODUCTS.filter(p=>p.A===a && p.B===b);
  selC.innerHTML=Cvals.map(p=>`<option value="${p.id}">${p.name}</option>`).join("");
});
/* stepper on singles qty */
singleQtyWrap.addEventListener("click",(e)=>{
  if(e.target.dataset.s){
    const delta=Number(e.target.dataset.s);
    const v=clamp((parseInt(singleQty.value||"0",10)||0)+delta,1,9999);
    singleQty.value=v;
  }
});

/* add single to preview.singles */
addSingleBtn.addEventListener("click",()=>{
  const id=selC.value; if(!id) return;
  const qty=clamp(parseInt(singleQty.value||"0",10)||0,1,9999);
  const name=(PRODUCTS.find(p=>p.id===id)||{}).name || id;
  const cur=preview.singles.get(id)||{name,qty:0};
  cur.qty += qty;
  preview.singles.set(id,cur);
  renderPreview();
});

/* ---------- Bundles / Gifts UI ---------- */
function renderBundleGrid(){
  bundleGrid.innerHTML="";
  BUNDLES.forEach(b=>{
    const div=document.createElement("div");
    div.className="bundle-card";
    div.innerHTML=`
      <div style="display:flex;gap:8px;align-items:center">
        <div class="title-2lines" style="font-weight:600;flex:1 1 auto">${b.name}</div>
        <div class="stepper" data-bid="${b.id}">
          <button type="button" data-s="-1">−</button>
          <input type="text" value="0" data-role="val">
          <button type="button" data-s="1">＋</button>
        </div>
      </div>`;
    const st=div.querySelector(".stepper");
    st.addEventListener("click",(e)=>{
      if(!e.target.dataset.s) return;
      const delta=Number(e.target.dataset.s);
      const inp=st.querySelector('[data-role="val"]');
      const v=clamp((parseInt(inp.value||"0",10)||0)+delta,0,999);
      inp.value=v;
      // 寫入預覽（可編輯）
      if(v===0) preview.bundles.delete(b.id);
      else preview.bundles.set(b.id,{name:b.name,qty:v});
      renderPreview();
    });
    // 直接輸入也要寫回
    st.querySelector('[data-role="val"]').addEventListener("input",(e)=>{
      let v=parseInt(e.target.value.replace(/[^0-9]/g,"")||"0",10); v=clamp(v,0,999);
      e.target.value=v;
      if(v===0) preview.bundles.delete(b.id);
      else preview.bundles.set(b.id,{name:b.name,qty:v});
      renderPreview();
    });
    bundleGrid.appendChild(div);
  });
}
function renderGifts(){
  giftsWrap.innerHTML="";
  GIFTS.forEach(g=>{
    const id=`gift_${g.id}`;
    const row=document.createElement("label");
    row.className="btn"; row.style.display="inline-flex"; row.style.alignItems="center"; row.style.gap="8px";
    row.innerHTML=`<input type="checkbox" id="${id}"> ${g.name}`;
    row.querySelector("input").addEventListener("change",(e)=>{
      if(e.target.checked) preview.gifts.add(g.id);
      else preview.gifts.delete(g.id);
      renderPreview();
    });
    giftsWrap.appendChild(row);
  });
}

/* ---------- Preview (editable) ---------- */
function renderPreview(){
  // 套組
  pvBundles.innerHTML="";
  if(preview.bundles.size===0) pvBundles.innerHTML='<span class="muted">(無)</span>';
  else {
    preview.bundles.forEach((rec,bid)=>{
      const row=document.createElement("div");
      row.className="row"; row.style.alignItems="center";
      row.innerHTML=`
        <div class="title-2lines" style="flex:1 1 auto">${rec.name}</div>
        <div class="stepper">
          <button type="button" data-k="${bid}" data-t="bundle" data-s="-1">−</button>
          <input type="text" value="${rec.qty}" data-k="${bid}" data-t="bundle">
          <button type="button" data-k="${bid}" data-t="bundle" data-s="1">＋</button>
        </div>`;
      pvBundles.appendChild(row);
    });
  }

  // 單品
  pvSingles.innerHTML="";
  if(preview.singles.size===0) pvSingles.innerHTML='<span class="muted">(無)</span>';
  else {
    preview.singles.forEach((rec,id)=>{
      const row=document.createElement("div");
      row.className="row"; row.style.alignItems="center";
      row.innerHTML=`
        <div class="title-2lines" style="flex:1 1 auto">${rec.name}</div>
        <div class="stepper">
          <button type="button" data-k="${id}" data-t="single" data-s="-1">−</button>
          <input type="text" value="${rec.qty}" data-k="${id}" data-t="single">
          <button type="button" data-k="${id}" data-t="single" data-s="1">＋</button>
        </div>`;
      pvSingles.appendChild(row);
    });
  }

  // 禮遇
  pvGifts.innerHTML="";
  const chosen=[...preview.gifts];
  if(chosen.length===0) pvGifts.innerHTML='<span class="muted">(無)</span>';
  else {
    chosen.forEach(id=>{
      const g=GIFTS.find(x=>x.id===id);
      const row=document.createElement("div");
      row.className="row"; row.style.alignItems="center";
      row.innerHTML=`<div class="title-2lines" style="flex:1 1 auto">${g?g.name:id}</div>
        <button class="btn btn-danger right" data-remove-g="${id}">移除</button>`;
      pvGifts.appendChild(row);
    });
  }

  // 綁定 stepper 事件：bundle/single 在預覽可直接改
  previewBody.querySelectorAll('.stepper button[data-s]').forEach(btn=>{
    btn.onclick=(e)=>{
      const s=Number(btn.dataset.s), t=btn.dataset.t, k=btn.dataset.k;
      const inp=btn.parentElement.querySelector('input');
      let v=clamp((parseInt(inp.value||"0",10)||0)+s,0,999);
      inp.value=v;
      if(t==="bundle"){
        if(v===0) preview.bundles.delete(k); else preview.bundles.set(k,{...(preview.bundles.get(k)||{}), qty:v});
      }else{
        const rec=preview.singles.get(k)||{name:(PRODUCTS.find(p=>p.id===k)||{}).name||k, qty:0};
        rec.qty=v; if(v===0) preview.singles.delete(k); else preview.singles.set(k,rec);
      }
      renderPreview();
    };
  });
  previewBody.querySelectorAll('.stepper input').forEach(inp=>{
    inp.oninput=(e)=>{
      let v=parseInt(inp.value.replace(/[^0-9]/g,"")||"0",10); v=clamp(v,0,999); inp.value=v;
      const t=inp.dataset.t, k=inp.dataset.k;
      if(t==="bundle"){
        if(v===0) preview.bundles.delete(k); else preview.bundles.set(k,{...(preview.bundles.get(k)||{}), qty:v});
      }else{
        const rec=preview.singles.get(k)||{name:(PRODUCTS.find(p=>p.id===k)||{}).name||k, qty:0};
        rec.qty=v; if(v===0) preview.singles.delete(k); else preview.singles.set(k,rec);
      }
    };
  });
  // 禮遇移除
  previewBody.querySelectorAll('[data-remove-g]').forEach(btn=>{
    btn.onclick=()=>{ preview.gifts.delete(btn.dataset.removeG); renderPreview(); };
  });
}

/* 收 / 展 */
togglePreviewBtn.addEventListener("click",()=>{
  const open = !previewBody.style.display || previewBody.style.display!=="none";
  previewBody.style.display = open ? "none" : "";
  togglePreviewBtn.textContent = open ? "展" : "收";
});

/* 全部清除預覽 */
pvClear.addEventListener("click",()=>{
  preview={bundles:new Map(),singles:new Map(),gifts:new Set()};
  // 同步把上面套組步進器清為 0（視覺一致）
  bundleGrid.querySelectorAll('.stepper [data-role="val"]').forEach(inp=>inp.value="0");
  renderPreview();
});

/* 確認加入：把預覽展開成單品，累加進 finalCart（planned） */
pvCommit.addEventListener("click",()=>{
  // 展開套組
  preview.bundles.forEach((rec,bid)=>{
    const b=BUNDLES.find(x=>x.id===bid); if(!b) return;
    b.items.forEach(it=>{
      const name=(PRODUCTS.find(p=>p.id===it.productId)||{}).name || it.productId;
      const addQty = it.qty * rec.qty;
      const cur = finalCart.get(it.productId) || {name, planned:0, picked:0};
      cur.planned += addQty;
      finalCart.set(it.productId, cur);
    });
  });
  // 單品
  preview.singles.forEach((rec,id)=>{
    const cur = finalCart.get(id) || {name:rec.name, planned:0, picked:0};
    cur.planned += rec.qty;
    finalCart.set(id,cur);
  });
  // 禮遇（按 bundle 規則展開）
  preview.gifts.forEach(gid=>{
    const g=GIFTS.find(x=>x.id===gid); if(!g) return;
    g.items.forEach(it=>{
      const name=(PRODUCTS.find(p=>p.id===it.productId)||{}).name || it.productId;
      const cur = finalCart.get(it.productId) || {name, planned:0, picked:0};
      cur.planned += it.qty;
      finalCart.set(it.productId,cur);
    });
  });
  // 清空預覽
  pvClear.click();
  renderFinal();
});

/* ---------- Final table ---------- */
function renderFinal(){
  // header 映射
  hdrCat.textContent = categorySelect.value || "—";
  hdrPO.textContent = poInput.value || "—";
  hdrMemo.textContent = memoInput.value || "—";

  finalTbody.innerHTML="";
  if(finalCart.size===0){
    finalTbody.innerHTML = `<tr><td colspan="4" class="muted">尚未加入任何品項</td></tr>`;
  }else{
    finalCart.forEach((rec,id)=>{
      const tr=document.createElement("tr");
      tr.innerHTML=`
        <td>
          <div class="stepper" data-pid="${id}" data-role="picked">
            <button type="button" data-s="-1">−</button>
            <input type="text" value="${rec.picked}">
            <button type="button" data-s="1">＋</button>
          </div>
        </td>
        <td>${rec.name}</td>
        <td style="text-align:right">
          <div class="stepper" data-pid="${id}" data-role="planned">
            <button type="button" data-s="-1">−</button>
            <input type="text" value="${rec.planned}">
            <button type="button" data-s="1">＋</button>
          </div>
        </td>
        <td><button class="btn btn-danger" data-del="${id}">×</button></td>`;
      finalTbody.appendChild(tr);
    });

    // 綁定 stepper
    finalTbody.querySelectorAll('.stepper button[data-s]').forEach(btn=>{
      btn.onclick=()=>{
        const s=Number(btn.dataset.s);
        const wrap=btn.closest('.stepper');
        const pid=wrap.dataset.pid;
        const role=wrap.dataset.role;
        const inp=wrap.querySelector('input');
        let v=clamp((parseInt(inp.value||"0",10)||0)+s,0,99999);
        inp.value=v;
        const rec=finalCart.get(pid);
        rec[role]=v;
        if(rec.planned===0 && rec.picked===0) finalCart.delete(pid);
        renderSum();
      };
    });
    finalTbody.querySelectorAll('.stepper input').forEach(inp=>{
      inp.oninput=()=>{
        let v=parseInt(inp.value.replace(/[^0-9]/g,"")||"0",10); v=clamp(v,0,99999); inp.value=v;
        const wrap=inp.closest('.stepper'); const pid=wrap.dataset.pid; const role=wrap.dataset.role;
        const rec=finalCart.get(pid); rec[role]=v;
        if(rec.planned===0 && rec.picked===0) finalCart.delete(pid);
        renderSum();
      };
    });
    finalTbody.querySelectorAll('[data-del]').forEach(btn=>{
      btn.onclick=()=>{ finalCart.delete(btn.dataset.del); renderFinal(); };
    });
  }
  renderSum();
}
function renderSum(){
  const items=finalCart.size;
  let planned=0, picked=0;
  finalCart.forEach(rec=>{ planned+=rec.planned; picked+=rec.picked; });
  sumBadge.textContent = `項：${items}　計：${planned}　點：${picked}`;
}

/* 全部帶入 picked = planned */
btnFill.addEventListener("click",()=>{
  finalCart.forEach(rec=>{ rec.picked = rec.planned; });
  renderFinal();
});
/* 清空最終清單 */
btnClearFinal.addEventListener("click",()=>{
  finalCart.clear(); renderFinal();
});

/* ---------- Submit with confirm modal ---------- */
btnSubmit.addEventListener("click",()=>{
  if(finalCart.size===0){ alert("沒有任何品項"); return; }
  // 填 header
  const cat = categorySelect.value || "—";
  cmHeader.innerHTML = `
    <div><span class="lab">類別：</span>${cat}</div>
    <div><span class="lab">客戶 PO：</span>${poInput.value||"—"}</div>
    <div><span class="lab">備註：</span>${memoInput.value||"—"}</div>
    <div><span class="lab">表單-日期-ID：</span>${hdrDoc.textContent}</div>
  `;
  // 列 Δ 項目
  const sign = Number(($('input[name="sign"]:checked')||{}).value||-1);
  cmBody.innerHTML="";
  finalCart.forEach((rec,id)=>{
    if(rec.picked===0) return; // 未點交就不會送
    const delta = rec.picked * sign;
    const tr=document.createElement("tr");
    tr.innerHTML=`<td style="font-weight:600;color:${delta<0?'#b91c1c':'#166534'}">${delta}</td><td>${rec.name}</td>`;
    cmBody.appendChild(tr);
  });
  confirmModal.classList.add("show");
});
cmCancel.addEventListener("click",()=>confirmModal.classList.remove("show"));
cmOk.addEventListener("click",async()=>{
  confirmModal.classList.remove("show");
  const sign = Number(($('input[name="sign"]:checked')||{}).value||-1);
  const payload = {
    category: categorySelect.value || "",
    po: poInput.value || "",
    memo: memoInput.value || "",
    formDateId: hdrDoc.textContent || "",
    items: Array.from(finalCart, ([productId,rec]) => {
      if(rec.picked===0) return null;
      return { productId, delta: rec.picked * sign };
    }).filter(Boolean)
  };
  try{
    const res = await fetch(WEBHOOK,{method:"POST",headers:{'Content-Type':'application/json'},body:JSON.stringify(payload)});
    alert(res.ok ? "已送出（Webhook OK）" : "送出失敗（Webhook 回應非 2xx）");
  }catch(e){
    alert("送出失敗（網路錯誤）");
  }
});

/* ---------- Sync: header values + doc id ---------- */
[categorySelect, poInput, memoInput].forEach(el=>el.addEventListener("input",()=>{
  hdrCat.textContent = categorySelect.value || "—";
  hdrPO.textContent = poInput.value || "—";
  hdrMemo.textContent = memoInput.value || "—";
  setDocId();
}));
$$('input[name="mode"]').forEach(r=>r.addEventListener("change",fillCategoryOptions));

/* ---------- Load seeds on start ---------- */
(async function init(){
  // 讀 CSV
  const [p,c,b,g,n] = await Promise.all([
    fetch(URLS.products).then(r=>r.text()).then(parseProducts),
    fetch(URLS.customers).then(r=>r.text()).then(parsePairs),
    fetch(URLS.bundles).then(r=>r.text()).then(parseBundleCsv),
    fetch(URLS.gifts).then(r=>r.text()).then(parseBundleCsv),
    fetch(URLS.nonsales).then(r=>r.text()).then(parsePairs),
  ]).catch(()=>[[],[],[],[],[]]);

  PRODUCTS=p; CUSTOMERS=c; BUNDLES=b; GIFTS=g; NONSALES=n;

  // 初始 UI
  fillCategoryOptions();
  renderBundleGrid();
  renderGifts();
  refreshABC();
  renderPreview();
  renderFinal();

  // 初次對 header
  hdrCat.textContent = categorySelect.value || "—";
  hdrPO.textContent = "—";
  hdrMemo.textContent = "—";
})();
</script>
</body>
</html>
