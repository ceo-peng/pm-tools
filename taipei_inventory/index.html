<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>åº«å­˜æ‰£æ¸›ç³»çµ± - Warehouse Inventory Deduction System</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            font-size: 14px;
            line-height: 1.5;
            color: #333;
            background: #fff;
            min-height: 100vh;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        .section {
            background: #fff;
            border: 1px solid #eee;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.06);
        }

        .section-title {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 20px;
            color: #1a1a1a;
            border-bottom: 2px solid #f2c14e;
            padding-bottom: 8px;
        }

        .form-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 20px;
        }

        .form-group {
            display: flex;
            flex-direction: column;
        }

        .form-label {
            font-weight: 500;
            margin-bottom: 6px;
            color: #555;
        }

        .form-select, .form-input {
            padding: 8px 10px;
            border: 1px solid #eee;
            border-radius: 8px;
            font-size: 13px;
            transition: all 0.2s;
            background: #fff;
        }

        .form-select:focus, .form-input:focus {
            outline: none;
            border-color: #f2c14e;
            box-shadow: 0 0 0 3px rgba(242, 193, 78, 0.1);
        }

        .filter-grid {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 16px;
            margin-bottom: 20px;
        }

        .qty-section {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-top: 16px;
        }

        .qty-controls {
            display: flex;
            align-items: center;
            border: 1px solid #ddd;
            border-radius: 8px;
            overflow: hidden;
        }

        .qty-btn {
            background: #f8f9fa;
            border: none;
            padding: 8px 12px;
            cursor: pointer;
            font-weight: 600;
            transition: background 0.2s;
        }

        .qty-btn:hover {
            background: #e9ecef;
        }

        .qty-input {
            border: none;
            padding: 8px 12px;
            width: 60px;
            text-align: center;
            font-size: 14px;
        }

        .qty-input:focus {
            outline: none;
        }

        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
            display: inline-flex;
            align-items: center;
            gap: 6px;
        }

        .btn-primary {
            background: linear-gradient(135deg, #f2c14e, #e6b345);
            color: #fff;
            box-shadow: 0 2px 4px rgba(242, 193, 78, 0.3);
        }

        .btn-primary:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(242, 193, 78, 0.4);
        }

        .btn-secondary {
            background: #fff;
            color: #666;
            border: 1px solid #ddd;
        }

        .btn-secondary:hover {
            background: #f8f9fa;
            border-color: #ccc;
        }

        .btn-danger {
            background: #dc3545;
            color: #fff;
        }

        .btn-danger:hover {
            background: #c82333;
        }

        .btn-success {
            background: #28a745;
            color: #fff;
        }

        .btn-success:hover {
            background: #218838;
        }

        .cart-table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 12px;
        }

        .cart-table th,
        .cart-table td {
            padding: 8px;
            text-align: left;
            border-bottom: 1px solid #eee;
        }

        .cart-table th {
            background: #f8f9fa;
            font-weight: 600;
            color: #555;
            font-size: 13px;
        }

        .cart-table td {
            font-size: 13px;
        }

        .cart-table td:first-child {
            font-weight: 600;
            font-size: 15px;
            width: 50%;
        }

        .cart-table td:nth-child(2) {
            width: 30%;
        }

        .cart-table td:last-child {
            width: 20%;
            text-align: right;
        }

        .order-preview {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            margin-bottom: 16px;
            overflow: hidden;
        }

        .order-preview-header {
            background: linear-gradient(135deg, #f2c14e, #e6b345);
            color: #fff;
            padding: 10px 16px;
            font-weight: 600;
            font-size: 14px;
        }

        .order-preview-content {
            padding: 12px 16px;
        }

        .preview-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 6px 0;
            border-bottom: 1px solid #e9ecef;
            font-size: 13px;
        }

        .preview-row:last-child {
            border-bottom: none;
        }

        .preview-label {
            font-weight: 500;
            color: #495057;
            min-width: 120px;
        }

        .preview-value {
            color: #212529;
            font-weight: 500;
        }

        .cart-summary {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 0;
            border-top: 2px solid #f2c14e;
            margin-top: 12px;
            font-size: 13px;
        }

        .summary-item {
            font-weight: 500;
        }

        .cart-actions {
            display: flex;
            gap: 12px;
            margin-top: 20px;
        }

        .import-section {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            padding: 20px;
            margin-top: 40px;
        }

        .import-title {
            font-size: 16px;
            font-weight: 600;
            margin-bottom: 16px;
            color: #495057;
        }

        .import-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 20px;
        }

        .import-textarea {
            width: 100%;
            height: 120px;
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 8px;
            font-family: monospace;
            font-size: 13px;
            resize: vertical;
        }

        .import-buttons {
            display: flex;
            flex-wrap: wrap;
            gap: 12px;
        }

        .toast {
            position: fixed;
            bottom: 20px;
            right: 20px;
            padding: 12px 20px;
            border-radius: 8px;
            color: #fff;
            font-weight: 500;
            z-index: 1000;
            transform: translateX(100%);
            transition: transform 0.3s;
        }

        .toast.show {
            transform: translateX(0);
        }

        .toast.success {
            background: #28a745;
        }

        .toast.error {
            background: #dc3545;
        }

        @media (max-width: 860px) {
            .container {
                padding: 16px;
            }

            .form-grid,
            .filter-grid {
                grid-template-columns: 1fr;
            }

            .import-grid {
                grid-template-columns: 1fr;
            }

            .cart-actions {
                flex-direction: column;
            }

            .cart-summary {
                flex-direction: column;
                gap: 8px;
                align-items: flex-start;
            }

            .import-buttons {
                justify-content: stretch;
            }

            .import-buttons .btn {
                flex: 1;
                justify-content: center;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- å‡ºè²¨è¨‚å–®è³‡è¨Š -->
        <div class="section">
            <h2 class="section-title">ğŸ“¦ å‡ºè²¨è¨‚å–®è³‡è¨Š</h2>
            
            <!-- æ¨¡å¼åˆ‡æ›èˆ‡é‡ç½®æŒ‰éˆ• -->
            <div class="form-group" style="margin-bottom: 20px;">
                <div style="display: flex; justify-content: space-between; align-items: center;">
                    <div>
                        <label class="form-label">ä½œæ¥­æ¨¡å¼</label>
                        <div style="display: flex; gap: 20px; align-items: center; margin-top: 8px;">
                            <label style="display: flex; align-items: center; gap: 6px; cursor: pointer;">
                                <input type="radio" name="mode" value="sales" checked id="modeSales">
                                <span>éŠ·å”® (Sales)</span>
                            </label>
                            <label style="display: flex; align-items: center; gap: 6px; cursor: pointer;">
                                <input type="radio" name="mode" value="non_sales" id="modeNonSales">
                                <span>ééŠ·å”® (Non-Sales)</span>
                            </label>
                        </div>
                    </div>
                    <button id="btnReset" class="btn btn-danger" style="height: fit-content; padding: 6px 12px; font-size: 13px;">ğŸ”„ é‡ç½®è³‡æ–™</button>
                </div>
            </div>
            
            <div class="form-grid">
                <div class="form-group" id="groupCustomer">
                    <label for="selCustomer" class="form-label">å‡ºè²¨å®¢æˆ¶</label>
                    <select id="selCustomer" class="form-select">
                        <option value="">è«‹é¸æ“‡å‡ºè²¨å®¢æˆ¶</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="po" class="form-label">PO å‡ºè²¨å–®è™Ÿ</label>
                    <input type="text" id="po" class="form-input" placeholder="è«‹è¼¸å…¥ PO å‡ºè²¨å–®è™Ÿ">
                </div>
            </div>
            
            <!-- ééŠ·å”®å°ˆç”¨æ¬„ä½ -->
            <div id="nonSalesFields" style="display: none;">
                <div class="form-grid">
                    <div class="form-group">
                        <label for="selNonSalesCategory" class="form-label">ééŠ·å”®é¡åˆ¥</label>
                        <select id="selNonSalesCategory" class="form-select">
                            <option value="">è«‹é¸æ“‡é¡åˆ¥</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="selUrgency" class="form-label">ç·Šæ€¥ç¨‹åº¦</label>
                        <select id="selUrgency" class="form-select">
                            <option value="0">ä¸€èˆ¬ (0)</option>
                            <option value="1">ç·Šæ€¥ (1)</option>
                            <option value="2">ç‰¹æ€¥ (2)</option>
                        </select>
                    </div>
                </div>
                <div class="form-group">
                    <label for="txtNote" class="form-label">å‚™è¨»</label>
                    <textarea id="txtNote" class="form-input" style="min-height: 80px;" placeholder="è«‹è¼¸å…¥å‚™è¨»"></textarea>
                </div>
            </div>
            
            <div class="form-grid">
                <div class="form-group">
                    <label for="formDateId" class="form-label">å‡ºè²¨å–®_æ—¥æœŸ_ID</label>
                    <input type="text" id="formDateId" class="form-input" readonly placeholder="è‡ªå‹•ç”Ÿæˆ">
                </div>
            </div>
        </div>

        <!-- åº«å­˜æ‰£æ¸›å•†å“æ¸…å–® -->
        <div class="section">
            <h2 class="section-title">ğŸ“‹ å‡ºè²¨å•†å“æŒ‘é¸ (åº«å­˜æ‰£æ¸›)</h2>
            
            <!-- å¥—çµ„é¸æ“‡ -->
            <div style="background: #fefefe; border: 1px solid #eee; border-radius: 8px; padding: 16px; margin-bottom: 20px;">
                <h3 style="font-size: 16px; font-weight: 600; margin-bottom: 12px; color: #333;">ğŸ å¥—çµ„é¸æ“‡</h3>
                <div style="display: flex; gap: 12px; align-items: end; flex-wrap: wrap;">
                    <div class="form-group" style="min-width: 200px; margin-bottom: 0;">
                        <label for="selBundle" class="form-label">é¸æ“‡å¥—çµ„</label>
                        <select id="selBundle" class="form-select">
                            <option value="">è«‹é¸æ“‡å¥—çµ„</option>
                        </select>
                    </div>
                    <div class="form-group" style="min-width: 100px; margin-bottom: 0;">
                        <label for="bundleQty" class="form-label">å¥—çµ„æ•¸é‡</label>
                        <div style="display: flex; align-items: center; gap: 6px;">
                            <button id="bundleDec" class="qty-btn">âˆ’</button>
                            <input type="number" id="bundleQty" class="qty-input" value="1" min="1" style="width: 60px;">
                            <button id="bundleInc" class="qty-btn">+</button>
                        </div>
                    </div>
                    <button id="btnAddBundle" class="btn btn-primary" style="height: fit-content;">åŠ å…¥å¥—çµ„</button>
                </div>
            </div>
            
            <div class="filter-grid">
                <div class="form-group">
                    <label for="selCategory" class="form-label">å•†å“å“é¡</label>
                    <select id="selCategory" class="form-select">
                        <option value="">å…¨éƒ¨å“é¡</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="selSeries" class="form-label">å•†å“ç³»åˆ—</label>
                    <select id="selSeries" class="form-select">
                        <option value="">å…¨éƒ¨ç³»åˆ—</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="selProduct" class="form-label">å•†å“åç¨±</label>
                    <select id="selProduct" class="form-select">
                        <option value="">è«‹é¸æ“‡å‡ºè²¨å•†å“</option>
                    </select>
                </div>
            </div>
            <!-- å…¥/å‡ºåº«åˆ‡æ› -->
            <div id="opSignSection" class="qty-section" style="margin-bottom: 16px;">
                <label class="form-label">æ“ä½œé¡å‹ï¼š</label>
                <div style="display: flex; gap: 20px; align-items: center;">
                    <label style="display: flex; align-items: center; gap: 6px; cursor: pointer;">
                        <input type="radio" name="opSign" value="sub" checked id="opSignSub">
                        <span>å‡ºè²¨ (âˆ’)</span>
                    </label>
                    <label style="display: flex; align-items: center; gap: 6px; cursor: pointer;">
                        <input type="radio" name="opSign" value="add" id="opSignAdd">
                        <span>é€²è²¨ (+)</span>
                    </label>
                </div>
            </div>
            
            <div class="qty-section">
                <label class="form-label">æ•¸é‡ï¼š</label>
                <div class="qty-controls">
                    <button id="dec" class="qty-btn">âˆ’</button>
                    <input type="number" id="qty" class="qty-input" value="1" min="1">
                    <button id="inc" class="qty-btn">+</button>
                </div>
                <button id="addBtn" class="btn btn-primary">åŠ å…¥æ¸…å–®</button>
            </div>
        </div>

        <!-- å‡ºè²¨æ¸…å–®é è¦½ -->
        <div class="section">
            <h2 class="section-title">ğŸ“¦ å‡ºè²¨æ¸…å–®é è¦½ (åº«å­˜æ‰£æ¸›ç¢ºèª)</h2>
            
            <!-- å‡ºè²¨è¨‚å–®è³‡è¨Šé è¦½ -->
            <div class="order-preview">
                <div class="order-preview-header">
                    <h3>ğŸ“‹ å‡ºè²¨è¨‚å–®è³‡è¨Š</h3>
                </div>
                <div class="order-preview-content">
                    <div class="preview-row">
                        <span class="preview-label">å‡ºè²¨å®¢æˆ¶:</span>
                        <span id="previewCustomer" class="preview-value">è«‹é¸æ“‡å®¢æˆ¶</span>
                    </div>
                    <div class="preview-row">
                        <span class="preview-label">PO å‡ºè²¨å–®è™Ÿ:</span>
                        <span id="previewPO" class="preview-value">è«‹è¼¸å…¥ PO ç·¨è™Ÿ</span>
                    </div>
                    <div class="preview-row">
                        <span class="preview-label">å‡ºè²¨å–®_æ—¥æœŸ_ID:</span>
                        <span id="previewFormDateId" class="preview-value">å¾…ç”Ÿæˆ</span>
                    </div>
                    <div class="preview-row">
                        <span class="preview-label">ç·Šæ€¥ç¨‹åº¦:</span>
                        <span id="previewUrgency" class="preview-value">ä¸€èˆ¬</span>
                    </div>
                    <div class="preview-row">
                        <span class="preview-label">å‚™è¨»:</span>
                        <span id="previewNote" class="preview-value">ç„¡</span>
                    </div>
                </div>
            </div>
            
            <table id="cartTable" class="cart-table">
                <thead>
                    <tr>
                        <th>å•†å“åç¨±</th>
                        <th>å‡ºè²¨æ•¸é‡</th>
                        <th>æ“ä½œ</th>
                    </tr>
                </thead>
                <tbody>
                </tbody>
            </table>
            <div class="cart-summary">
                <div class="summary-item">ç¸½é …ç›®ï¼š<span id="totalItems">0</span> é …</div>
                <div class="summary-item">ç¸½å‡ºè²¨æ•¸é‡ï¼š<span id="totalQty">0</span> ä»¶</div>
            </div>
            <div class="cart-actions">
                <button id="btnClear" class="btn btn-secondary">æ¸…ç©ºæ¸…å–®</button>
                <button id="btnSubmit" class="btn btn-success">ğŸš€ æäº¤åº«å­˜æ‰£æ¸›</button>
            </div>
        </div>

        <!-- åŒ¯å…¥è³‡æ–™ -->
        <div class="import-section">
            <h3 class="import-title">ğŸ“¥ åŒ¯å…¥è³‡æ–™ï¼ˆç³»çµ±ç”¨ï¼‰</h3>
            <div class="import-grid">
                <div class="form-group">
                    <label for="csvABC" class="form-label">å•†å“ CSV (A,B,C)</label>
                    <textarea id="csvABC" class="import-textarea" placeholder="å“é¡,ç³»åˆ—,ç”¢å“&#10;é›»å­ç”¢å“,æ‰‹æ©Ÿ,iPhone 15&#10;é›»å­ç”¢å“,å¹³æ¿,iPad Pro"></textarea>
                </div>
                <div class="form-group">
                    <label for="csvCus" class="form-label">å®¢æˆ¶ CSV (id,name)</label>
                    <textarea id="csvCus" class="import-textarea" placeholder="id,name&#10;C001,å®¢æˆ¶A&#10;C002,å®¢æˆ¶B"></textarea>
                </div>
            </div>
            <div class="import-buttons">
                <button id="btnParseABC" class="btn btn-secondary">è¼‰å…¥å•†å“</button>
                <button id="btnParseCus" class="btn btn-secondary">è¼‰å…¥å®¢æˆ¶</button>
                <button id="btnOverwriteAll" class="btn btn-primary">æ¸…é™¤èˆŠè³‡æ–™ä¸¦è¦†è“‹</button>
                <button id="btnClearLocal" class="btn btn-danger">æ¸…é™¤æœ¬æ©Ÿå„²å­˜</button>
            </div>
        </div>
    </div>

    <div id="toast" class="toast"></div>

    <script>
        // å¸¸æ•¸å®šç¾©
        const WEBHOOK_URL = "https://hook.us2.make.com/nbjdxrfypgoosj4qqxnzfmj9o29jq3c2";
        const STORAGE_KEY = "pm_order_data_v2";
        
        // ééŠ·å”®é¡åˆ¥å¸¸æ•¸ - ä½¿ç”¨ä¸­æ–‡ä½œç‚ºå”¯ä¸€å€¼
        const NON_SALES_CATEGORIES = [
            { id:'é€€åº«',         name:'é€€åº«', defaultSign:'minus',  order:1 },
            { id:'ç›¤é»',          name:'ç›¤é»', defaultSign:'any',   order:2 },
            { id:'è¡ŒéŠ·',       name:'è¡ŒéŠ·', defaultSign:'minus', order:3 },
            { id:'å®¢é€€', name:'å®¢é€€', defaultSign:'plus',  order:4 },
            { id:'æ­¸å€‰',           name:'æ­¸å€‰', defaultSign:'plus',   order:5 },
            { id:'å…¶ä»–',           name:'å…¶ä»–', defaultSign:'any',   order:6 }
        ];
        
        // å…¨åŸŸè®Šæ•¸
        let MODE = 'sales';

        // é è¨­è³‡æ–™ï¼ˆç¡¬ç·¨ç¢¼ï¼‰
        const PRODUCTS_DEFAULT_CSV = `æ­£å“(å¤§),é‡‘èƒæ²¹,ä»™äººæŒç±½è¶…èƒ½é‡é‡‘èƒæ²¹ 15ml (2027-07-30)
æ­£å“(æ—…),é‡‘èƒæ²¹,ä»™äººæŒç±½è¶…èƒ½é‡é‡‘èƒæ²¹ 5ml (2027-05-10)
æ­£å“(é«”),é‡‘èƒæ²¹,ä»™äººæŒç±½è¶…èƒ½é‡é‡‘èƒæ²¹ 1.5ml (2025-09-28)
æ­£å“(é«”),é‡‘èƒæ²¹,ä»™äººæŒç±½è¶…èƒ½é‡é‡‘èƒæ²¹ 1.5ml (2026-05-29)
æ­£å“(å¤§),é‡‘èƒæ²¹,æ‘©æ´›å“¥å …æœè³¦æ´»é‡‘èƒæ²¹ 28ml (2027-04-08)
æ­£å“(å¤§),é‡‘èƒæ²¹,æ‘©æ´›å“¥å …æœè³¦æ´»é‡‘èƒæ²¹ 28ml (2027-10-08)
æ­£å“(æ—…),é‡‘èƒæ²¹,æ‘©æ´›å“¥å …æœè³¦æ´»é‡‘èƒæ²¹ 5ml (2026-09-30)
æ­£å“(æ—…),é‡‘èƒæ²¹,æ‘©æ´›å“¥å …æœè³¦æ´»é‡‘èƒæ²¹ 5ml (2028-07-22)
æ­£å“(é«”),é‡‘èƒæ²¹,æ‘©æ´›å“¥å …æœè³¦æ´»é‡‘èƒæ²¹ 1.5ml (2025-09-28)
æ­£å“(é«”),é‡‘èƒæ²¹,æ‘©æ´›å“¥å …æœè³¦æ´»é‡‘èƒæ²¹ 1.5ml (2026-05-29)
æ­£å“(å¤§),è¶…ç´šè¤‡æ–¹æ²¹,è¶…ç´šè¤‡æ–¹æ²¹ ç«ç‘°ç…¥é¡ 28ml (2027-04-10)
æ­£å“(å¤§),è¶…ç´šè¤‡æ–¹æ²¹,è¶…ç´šè¤‡æ–¹æ²¹ ç«ç‘°ç…¥é¡ 28ml (2027-10-08)
æ­£å“(æ—…),è¶…ç´šè¤‡æ–¹æ²¹,è¶…ç´šè¤‡æ–¹æ²¹ ç«ç‘°ç…¥é¡ 5ml (2025-08-08)
æ­£å“(æ—…),è¶…ç´šè¤‡æ–¹æ²¹,è¶…ç´šè¤‡æ–¹æ²¹ ç«ç‘°ç…¥é¡ 5ml (2026-09-30)
æ­£å“(é«”),è¶…ç´šè¤‡æ–¹æ²¹,è¶…ç´šè¤‡æ–¹æ²¹ ç«ç‘°ç…¥é¡ 1.5ml (2025-09-28)
æ­£å“(é«”),è¶…ç´šè¤‡æ–¹æ²¹,è¶…ç´šè¤‡æ–¹æ²¹ ç«ç‘°ç…¥é¡ 1.5ml (2026-05-29)
æ­£å“(å¤§),è¶…ç´šè¤‡æ–¹æ²¹,è¶…ç´šè¤‡æ–¹æ²¹ è“æœäº®é‡‡ 28ml (2026-02-20)
æ­£å“(å¤§),è¶…ç´šè¤‡æ–¹æ²¹,è¶…ç´šè¤‡æ–¹æ²¹ è“æœäº®é‡‡ 28ml (2027-04-10)
æ­£å“(æ—…),è¶…ç´šè¤‡æ–¹æ²¹,è¶…ç´šè¤‡æ–¹æ²¹ è“æœäº®é‡‡ 5ml (2025-08-08)
æ­£å“(æ—…),è¶…ç´šè¤‡æ–¹æ²¹,è¶…ç´šè¤‡æ–¹æ²¹ è“æœäº®é‡‡ 5ml (2026-09-30)
æ­£å“(é«”),è¶…ç´šè¤‡æ–¹æ²¹,è¶…ç´šè¤‡æ–¹æ²¹ è“æœäº®é‡‡ 1.5ml (2025-09-28)
æ­£å“(é«”),è¶…ç´šè¤‡æ–¹æ²¹,è¶…ç´šè¤‡æ–¹æ²¹ è“æœäº®é‡‡ 1.5ml (2026-05-29)
æ­£å“(å¤§),ç¾é«”æ¥µèƒæ²¹,ç¾é«”æ¥µèƒæ²¹ ä¿æ¿•é€ç™½ 120ml (2028-05-08)
æ­£å“(æ—…),ç¾é«”æ¥µèƒæ²¹,ç¾é«”æ¥µèƒæ²¹ ä¿æ¿•é€ç™½ 4ml (2028-12-20)
æ­£å“(å¤§),ç¾é«”æ¥µèƒæ²¹,ç¾é«”æ¥µèƒæ²¹ è³¦æ´»ä¿®è­· 120ml (2028-05-08)
æ­£å“(æ—…),ç¾é«”æ¥µèƒæ²¹,ç¾é«”æ¥µèƒæ²¹ è³¦æ´»ä¿®è­· 4ml (2028-12-20)
æ­£å“(å¤§),è¶…èƒ½å‰å°ç²¾è¯éœ²,è¶…èƒ½å‰å°ç²¾è¯éœ² é–æ°´äº®æ¾¤ 120ml (2028-10-16)
æ­£å“(æ—…),è¶…èƒ½å‰å°ç²¾è¯éœ²,è¶…èƒ½å‰å°ç²¾è¯éœ² é–æ°´äº®æ¾¤ 5ml (2026-06-13)
æ­£å“(æ—…),è¶…èƒ½å‰å°ç²¾è¯éœ²,è¶…èƒ½å‰å°ç²¾è¯éœ² é–æ°´äº®æ¾¤ 5ml (2028-04-26)
æ­£å“(é«”),è¶…èƒ½å‰å°ç²¾è¯éœ²,è¶…èƒ½å‰å°ç²¾è¯éœ² é–æ°´äº®æ¾¤ 2ml (2026-09-28)
æ­£å“(å¤§),è¶…èƒ½å‰å°ç²¾è¯éœ²,è¶…èƒ½å‰å°ç²¾è¯éœ² é‡‘ç‡¦ç·Šå¯¦ 120ml (2028-10-16)
æ­£å“(æ—…),è¶…èƒ½å‰å°ç²¾è¯éœ²,è¶…èƒ½å‰å°ç²¾è¯éœ² é‡‘ç‡¦ç·Šå¯¦ 5ml (2026-06-13)
æ­£å“(æ—…),è¶…èƒ½å‰å°ç²¾è¯éœ²,è¶…èƒ½å‰å°ç²¾è¯éœ² é‡‘ç‡¦ç·Šå¯¦ 5ml (2027-10-16)
æ­£å“(é«”),è¶…èƒ½å‰å°ç²¾è¯éœ²,è¶…èƒ½å‰å°ç²¾è¯éœ² é‡‘ç‡¦ç·Šå¯¦ 2ml (2026-09-28)
æ­£å“(å¤§),å®Œç¾æ¥µèƒé¢è†œ,å®Œç¾æ¥µèƒé¢è†œ é–æ°´èƒ½é‡(äº”å…¥çµ„) (2025-05-26)
æ­£å“(å¤§),å®Œç¾æ¥µèƒé¢è†œ,å®Œç¾æ¥µèƒé¢è†œ é–æ°´èƒ½é‡(äº”å…¥çµ„) (2028-08-12)
æ­£å“(æ—…),å®Œç¾æ¥µèƒé¢è†œ,å®Œç¾æ¥µèƒé¢è†œ é–æ°´èƒ½é‡(å–®ç‰‡) (2028-08-12)
æ­£å“(å¤§),å®Œç¾æ¥µèƒé¢è†œ,å®Œç¾æ¥µèƒé¢è†œ é€äº®èƒ½é‡(äº”å…¥çµ„) (2025-05-26)
æ­£å“(å¤§),å®Œç¾æ¥µèƒé¢è†œ,å®Œç¾æ¥µèƒé¢è†œ é€äº®èƒ½é‡(äº”å…¥çµ„) (2028-08-12)
æ­£å“(æ—…),å®Œç¾æ¥µèƒé¢è†œ,å®Œç¾æ¥µèƒé¢è†œ é€äº®èƒ½é‡(å–®ç‰‡) (2028-08-12)
æ­£å“(å¤§),å®Œç¾æ¥µèƒé¢è†œ,å®Œç¾æ¥µèƒé¢è†œ è³¦æ´»èƒ½é‡(äº”å…¥çµ„) (2025-05-24)
æ­£å“(å¤§),å®Œç¾æ¥µèƒé¢è†œ,å®Œç¾æ¥µèƒé¢è†œ è³¦æ´»èƒ½é‡(äº”å…¥çµ„) (2028-08-12)
æ­£å“(æ—…),å®Œç¾æ¥µèƒé¢è†œ,å®Œç¾æ¥µèƒé¢è†œ è³¦æ´»èƒ½é‡(å–®ç‰‡) (2028-08-12)
æ­£å“(å¤§),å®Œç¾æ¥µèƒé¢è†œ,å®Œç¾æ¥µèƒé¢è†œ ä¸‰æ—¥é©šè±”çµ„(ä¸‰å…¥çµ„) (2028-08-12)
æ­£å“(å¤§),æ™¶é‘½æ¥µç·»æ½”é¡çš‚,æ™¶é‘½ä»™äººæŒç±½é‡‘èƒæ²¹æ¥µç·»æ½”é¡çš‚ 120g (2026-10-02)
æ­£å“(æ—…),æ™¶é‘½æ¥µç·»æ½”é¡çš‚,æ™¶é‘½ä»™äººæŒç±½é‡‘èƒæ²¹æ¥µç·»æ½”é¡çš‚ 25g (2027-08-23)
æ­£å“(æ—…),æ™¶é‘½æ¥µç·»æ½”é¡çš‚,æ™¶é‘½ä»™äººæŒç±½é‡‘èƒæ²¹æ¥µç·»æ½”é¡çš‚ 25g (2028-05-30)
æ­£å“(å¤§),æ™¶é‘½æ¥µç·»æ½”é¡çš‚,æ™¶é‘½æ‘©æ´›å“¥å …æœé‡‘èƒæ²¹æ¥µç·»æ½”é¡çš‚ 120g (2025-08-29)
æ­£å“(å¤§),æ™¶é‘½æ¥µç·»æ½”é¡çš‚,æ™¶é‘½æ‘©æ´›å“¥å …æœé‡‘èƒæ²¹æ¥µç·»æ½”é¡çš‚ 120g (2026-10-02)
æ­£å“(å¤§),æ™¶é‘½æ¥µç·»æ½”é¡çš‚,æ™¶é‘½æ‘©æ´›å“¥å …æœé‡‘èƒæ²¹æ¥µç·»æ½”é¡çš‚ 120g (2028-05-30)
æ­£å“(æ—…),æ™¶é‘½æ¥µç·»æ½”é¡çš‚,æ™¶é‘½æ‘©æ´›å“¥å …æœé‡‘èƒæ²¹æ¥µç·»æ½”é¡çš‚ 25g (2025-08-29)
æ­£å“(æ—…),æ™¶é‘½æ¥µç·»æ½”é¡çš‚,æ™¶é‘½æ‘©æ´›å“¥å …æœé‡‘èƒæ²¹æ¥µç·»æ½”é¡çš‚ 25g (2027-08-23)
æ­£å“(æ—…),æ™¶é‘½æ¥µç·»æ½”é¡çš‚,æ™¶é‘½æ‘©æ´›å“¥å …æœé‡‘èƒæ²¹æ¥µç·»æ½”é¡çš‚ 25g (2028-05-30)
æ­£å“(å¤§),æ™¶é‘½æ¥µç·»æ½”é¡çš‚,æ™¶é‘½çµ•ä¸–ç•ªç´…èŠ±æ¥µç·»æ½”é¡çš‚ 120g (2025-08-29)
æ­£å“(å¤§),æ™¶é‘½æ¥µç·»æ½”é¡çš‚,æ™¶é‘½çµ•ä¸–ç•ªç´…èŠ±æ¥µç·»æ½”é¡çš‚ 120g (2026-10-02)
æ­£å“(å¤§),æ™¶é‘½æ¥µç·»æ½”é¡çš‚,æ™¶é‘½çµ•ä¸–ç•ªç´…èŠ±æ¥µç·»æ½”é¡çš‚ 120g (2028-05-30)
æ­£å“(æ—…),æ™¶é‘½æ¥µç·»æ½”é¡çš‚,æ™¶é‘½çµ•ä¸–ç•ªç´…èŠ±æ¥µç·»æ½”é¡çš‚ 25g (2025-08-29)
æ­£å“(æ—…),æ™¶é‘½æ¥µç·»æ½”é¡çš‚,æ™¶é‘½çµ•ä¸–ç•ªç´…èŠ±æ¥µç·»æ½”é¡çš‚ 25g (2027-08-23)
æ­£å“(æ—…),æ™¶é‘½æ¥µç·»æ½”é¡çš‚,æ™¶é‘½çµ•ä¸–ç•ªç´…èŠ±æ¥µç·»æ½”é¡çš‚ 25g (2028-05-30)
æ­£å“(å¤§),æ™¶é‘½æ¥µç·»æ½”é¡çš‚,æ™¶é‘½çš‡å®¶å¤§é¦¬å£«é©ç«ç‘°æ¥µç·»æ½”é¡çš‚ 120g (2025-08-29)
æ­£å“(å¤§),æ™¶é‘½æ¥µç·»æ½”é¡çš‚,æ™¶é‘½çš‡å®¶å¤§é¦¬å£«é©ç«ç‘°æ¥µç·»æ½”é¡çš‚ 120g (2026-10-02)
æ­£å“(æ—…),æ™¶é‘½æ¥µç·»æ½”é¡çš‚,æ™¶é‘½çš‡å®¶å¤§é¦¬å£«é©ç«ç‘°æ¥µç·»æ½”é¡çš‚ 25g (2025-08-29)
æ­£å“(æ—…),æ™¶é‘½æ¥µç·»æ½”é¡çš‚,æ™¶é‘½çš‡å®¶å¤§é¦¬å£«é©ç«ç‘°æ¥µç·»æ½”é¡çš‚ 25g (2027-08-23)
æ­£å“(æ—…),æ™¶é‘½æ¥µç·»æ½”é¡çš‚,æ™¶é‘½çš‡å®¶å¤§é¦¬å£«é©ç«ç‘°æ¥µç·»æ½”é¡çš‚ 25g (2028-05-30)
æ­£å“(å¤§),æ™¶é‘½æ¥µç·»æ½”é¡çš‚,æ™¶é‘½é‡‘ç‡¦è–‘é»ƒèœ‚èœœæ¥µç·»æ½”é¡çš‚ 120g (2025-08-29)
æ­£å“(å¤§),æ™¶é‘½æ¥µç·»æ½”é¡çš‚,æ™¶é‘½é‡‘ç‡¦è–‘é»ƒèœ‚èœœæ¥µç·»æ½”é¡çš‚ 120g (2026-10-02)
æ­£å“(æ—…),æ™¶é‘½æ¥µç·»æ½”é¡çš‚,æ™¶é‘½é‡‘ç‡¦è–‘é»ƒèœ‚èœœæ¥µç·»æ½”é¡çš‚ 25g (2027-08-23)
æ­£å“(æ—…),æ™¶é‘½æ¥µç·»æ½”é¡çš‚,æ™¶é‘½é‡‘ç‡¦è–‘é»ƒèœ‚èœœæ¥µç·»æ½”é¡çš‚ 25g (2028-05-30)
æ­£å“(å¤§),æ™¶é‘½æ¥µç·»æ½”é¡çš‚,æ™¶é‘½ç…¥é‡‡æ´»æ€§ç‚­æ¥µç·»æ½”é¡çš‚ 120g (2025-08-29)
æ­£å“(æ—…),æ™¶é‘½æ¥µç·»æ½”é¡çš‚,æ™¶é‘½ç…¥é‡‡æ´»æ€§ç‚­æ¥µç·»æ½”é¡çš‚ 120g (2026-10-02)
æ­£å“(æ—…),æ™¶é‘½æ¥µç·»æ½”é¡çš‚,æ™¶é‘½ç…¥é‡‡æ´»æ€§ç‚­æ¥µç·»æ½”é¡çš‚ 120g (2028-05-30)
æ­£å“(æ—…),æ™¶é‘½æ¥µç·»æ½”é¡çš‚,æ™¶é‘½ç…¥é‡‡æ´»æ€§ç‚­æ¥µç·»æ½”é¡çš‚ 25g (2025-08-29)
æ­£å“(æ—…),æ™¶é‘½æ¥µç·»æ½”é¡çš‚,æ™¶é‘½ç…¥é‡‡æ´»æ€§ç‚­æ¥µç·»æ½”é¡çš‚ 25g (2027-08-23)
æ­£å“(æ—…),æ™¶é‘½æ¥µç·»æ½”é¡çš‚,æ™¶é‘½ç…¥é‡‡æ´»æ€§ç‚­æ¥µç·»æ½”é¡çš‚ 25g (2028-05-30)
æ­£å“(å¤§),æ™¶é‘½æ¥µç·»æ½”é¡çš‚,æ™¶é‘½æ™¶äº®é»‘ç¨®è‰ç±½æ²¹æ¥µç·»æ½”é¡çš‚ 120g (2026-10-02)
æ­£å“(å¤§),æ™¶é‘½æ¥µç·»æ½”é¡çš‚,æ™¶é‘½æ™¶äº®é»‘ç¨®è‰ç±½æ²¹æ¥µç·»æ½”é¡çš‚ 120g (2028-05-30)
æ­£å“(æ—…),æ™¶é‘½æ¥µç·»æ½”é¡çš‚,æ™¶é‘½æ™¶äº®é»‘ç¨®è‰ç±½æ²¹æ¥µç·»æ½”é¡çš‚ 25g (2025-08-29)
æ­£å“(æ—…),æ™¶é‘½æ¥µç·»æ½”é¡çš‚,æ™¶é‘½æ™¶äº®é»‘ç¨®è‰ç±½æ²¹æ¥µç·»æ½”é¡çš‚ 25g (2028-05-30)
æ­£å“(é«”),é«”é©—çµ„,é‰‘ç¿¡æ–¯é‡‘è‰²æ¸›æ³•ä¿é¤Š_ä»™æ²¹å‹»æ·¨é«”é©—çµ„ (2025-09-28)
æ­£å“(é«”),é«”é©—çµ„,é‰‘ç¿¡æ–¯é‡‘è‰²æ¸›æ³•ä¿é¤Š_æ‘©æ²¹æ½¤æ¾¤é«”é©—çµ„ (2025-09-28)
æ­£å“(é«”),é«”é©—çµ„,é‰‘ç¿¡æ–¯é‡‘è‰²æ¸›æ³•ä¿é¤Š_ç«ç‘°ç…¥é¡é«”é©—çµ„ (2025-09-28)
æ­£å“(é«”),é«”é©—çµ„,é‰‘ç¿¡æ–¯é‡‘è‰²æ¸›æ³•ä¿é¤Š_è“æœäº®é‡‡é«”é©—çµ„ (2025-09-28)
åŒ…æ,å“ç‰ŒPizzaç›’,é‰‘ç¿¡æ–¯ PIZZAç›’-ä¸­ (28.5*23*9 cm)
åŒ…æ,å“ç‰ŒPizzaç›’,é‰‘ç¿¡æ–¯ PIZZAç›’-å° (20*20*7.5 cm)
åŒ…æ,å“ç‰Œç´™ç®±,é‰‘ç¿¡æ–¯ä¸‰æ’èˆŒç´™ç®±-å¤§ (38*38*21 cm)
åŒ…æ,å“ç‰Œè£½ä½œç‰©,å“ç‰Œç´™è¢‹-ç™½ L (40.5*14*31.5 cm)
åŒ…æ,å“ç‰Œè£½ä½œç‰©,å“ç‰Œç´™è¢‹-ç™½ M (20.5*11*25 cm)
åŒ…æ,å“ç‰Œè£½ä½œç‰©,å“ç‰Œç´™è¢‹-ç™½ S (14.5*8.5*19 cm)
åŒ…æ,å“ç‰Œè£½ä½œç‰©,å“ç‰Œè¥¯ç´™ (æ’ç•«æ¬¾)
åŒ…æ,å“ç‰Œè£½ä½œç‰©,å“ç‰Œä¿¡å°è¢‹-ç´… (12.5*7.5 cm)
åŒ…æ,å“ç‰Œè£½ä½œç‰©,OPPï¼šç²¾è£ç›’ (6.9*44 cm)
åŒ…æ,å“ç‰Œè£½ä½œç‰©,OPPï¼šå‰å°æ¶² (26.1*16.5 cm)
åŒ…æ,å“ç‰Œè£½ä½œç‰©,OPPï¼šèº«é«”æ²¹ (27*16.6 cm)
åŒ…æ,å“ç‰Œè£½ä½œç‰©,OPPï¼šé¢è†œ/é‡‘è‰²ä¿é¤Šé«”é©—å¡å…±ç”¨ (13*42 cm)
è²¼ç´™,å“ç‰Œè²¼ç´™,åœ“å½¢éœ§é¢è²¼ (1*1 cm)
è²¼ç´™,å“ç‰Œè²¼ç´™,åœ“å½¢éœ§é¢è²¼ (2*2 cm)
è²¼ç´™,å“ç‰Œè²¼ç´™,é‡‘è‰²å¤§çš‡å† è²¼ç´™ (5*5 cm)
è²¼ç´™,å“ç‰Œè²¼ç´™,é‡‘è‰²å°çš‡å† è²¼ç´™ (2*2 cm)
è²¼ç´™,å“ç‰Œè²¼ç´™,çš‡å† è²¼ç´™-é›·å°„ç´™
è²¼ç´™,ä¸­æ–‡æ¨™,ä¸­æ–‡æ¨™ï¼šä»™äººæŒç±½è¶…èƒ½é‡é‡‘èƒæ²¹15ml (5.5*4.5 cm)
è²¼ç´™,ä¸­æ–‡æ¨™,ä¸­æ–‡æ¨™ï¼šæ‘©æ´›å“¥å …æœè³¦æ´»é‡‘èƒæ²¹ 28ml (5.5*4.5 cm)
è²¼ç´™,ä¸­æ–‡æ¨™,ä¸­æ–‡æ¨™ï¼šè¶…ç´šè¤‡æ–¹æ²¹ ç«ç‘°ç…¥é¡ 28ml (5.5*4.5 cm)
è²¼ç´™,ä¸­æ–‡æ¨™,ä¸­æ–‡æ¨™ï¼šè¶…ç´šè¤‡æ–¹æ²¹ è“æœäº®é‡‡ 28ml (5.5*4.5 cm)
å°åˆ·å“,DM,202312ç‰ˆ_ç¾é«”æ²¹DM
å°åˆ·å“,DM,202407ç‰ˆ_å…¨ç”¢å“DM
å°åˆ·å“,DM,æ²¹ä¿é¤Šä½¿ç”¨æŒ‡å—å°å¡
å‘¨é‚Š,å“ç‰Œè£½ä½œç‰©,æ°¸æ†ç¿¡å„·ç¶“å…¸çœŸçš®åŒ–å¦åŒ…
å‘¨é‚Š,å“ç‰Œè£½ä½œç‰©,æ½›éŠåŸæ£‰ä»™äººæŒæ‰˜ç‰¹åŒ… (38*42 cm)
å‘¨é‚Š,å“ç‰Œè£½ä½œç‰©,è¶…èƒ½é‡åŸæ£‰æ‰˜ç‰¹åŒ…ç³»åˆ—-è¿·ä½ æ‰‹æ (16*12 cm)
å‘¨é‚Š,å“ç‰Œè£½ä½œç‰©,ç¿¡ç¿ å¿ƒèªå¤šåŠŸèƒ½æ‹‰ææ¿
å‘¨é‚Š,å“ç‰Œè£½ä½œç‰©,æ°¸æ†ç¶“å…¸çœŸçš®ç å¯¶ç›¤ç³»åˆ—-å“ç‰Œç¶ 
å‘¨é‚Š,å“ç‰Œè£½ä½œç‰©,æ°¸æ†ç¶“å…¸çœŸçš®ç å¯¶ç›¤ç³»åˆ—-å …æœé»ƒ
å‘¨é‚Š,å“ç‰Œè£½ä½œç‰©,å“ç‰Œçš®å¥— (ç¶ ) 8*8cm
å‘¨é‚Š,å“ç‰Œè£½ä½œç‰©,Tå‹æŒ‰æ‘©æ£’çš®å¥—çµ„
å‘¨é‚Š,å“ç‰Œè£½ä½œç‰©,æ™¶é‘½æ‰‹å·¥çš‚ç¢Ÿ
å‘¨é‚Š,å“ç‰Œè£½ä½œç‰©,ã€Œæ‘©æ´›è—å¢ƒã€é™¶ç“·æ¯å¢Š ç³»åˆ—  é¡è‰²: ç¶ åº•äº¤ç¹”ç´‹
å‘¨é‚Š,å“ç‰Œè£½ä½œç‰©,ã€Œæ‘©æ´›è—å¢ƒã€é™¶ç“·æ¯å¢Š ç³»åˆ—  é¡è‰²: ç¶ åº•é‡‘æ˜ŸèŠ’
å‘¨é‚Š,å“ç‰Œè£½ä½œç‰©,ã€Œæ‘©æ´›è—å¢ƒã€é™¶ç“·æ¯å¢Š ç³»åˆ—  é¡è‰²: ç´…åº•äº¤ç¹”ç´‹
å‘¨é‚Š,å“ç‰Œè£½ä½œç‰©,ã€Œæ‘©æ´›è—å¢ƒã€é™¶ç“·æ¯å¢Š ç³»åˆ—  é¡è‰²: ç´…åº•ç¹èŠ±ç´‹
å‘¨é‚Š,å“ç‰Œè£½ä½œç‰©,ã€Œæ‘©æ´›è—å¢ƒã€é™¶ç“·æ¯å¢Š ç³»åˆ—  é¡è‰²: å››è‰²èŠ±ç£šç´‹
å‘¨é‚Š,å“ç‰Œè£½ä½œç‰©,ã€Œæ‘©æ´›è—å¢ƒã€é™¶ç“·æ¯å¢Š ç³»åˆ—  é¡è‰²: ç™½åº•ç´…æ˜ŸèŠ’
å‘¨é‚Š,å“ç‰Œè£½ä½œç‰©,ã€Œæ‘©æ´›è—å¢ƒã€é™¶ç“·æ¯å¢Š ç³»åˆ—  é¡è‰²: ç™½åº•ç´°èŠ±ç´‹
å‘¨é‚Š,å“ç‰Œè£½ä½œç‰©,ã€Œæ‘©æ´›è—å¢ƒã€é™¶ç“·æ¯å¢Š ç³»åˆ—  é¡è‰²: è¬èŠ±ç¹½ç´›ç´‹
å‘¨é‚Š,å“ç‰Œè£½ä½œç‰©,ç¿¡ç¿ é–å…‰ç‰çŸ³æ»¾è¼ª
å‘¨é‚Š,å“ç‰Œè£½ä½œç‰©,100%ç”Ÿçµ²æ‘©æ´›å“¥å‚³çµ±æ²æµ´æ‰‹å¥—
å‘¨é‚Š,å“ç‰Œè£½ä½œç‰©,æ™¶æ½¤æŸ”è†šçŸ½è† åˆ·`;

        const CUSTOMERS_DEFAULT_CSV = `å®˜ç¶²,å®˜ç¶²
AE,AE
MO,MO
é›…è™,é›…è™
è¦çš®,è¦çš®
è‚¯é©›,è‚¯é©›
PK,PK
å“¡è³¼,å“¡è³¼
å…¶ä»–,å…¶ä»–`;

        // å…¨åŸŸè®Šæ•¸
        let PRODUCTS = [];
        let CUSTOMERS = [];
        let cart = [];
        let opSign = 'sub';

        // å·¥å…·å‡½æ•¸
        function slug(str) {
            return (str || "").toLowerCase().replace(/[^a-z0-9]+/g, '-').replace(/(^-|-$)/g, '');
        }

        function parseCSV(text) {
            if (!text || !text.trim()) return [];
            
            const rows = [];
            const lines = text.replace(/\r/g, '').split(/\n+/);
            
            for (let line of lines) {
                line = line.trim();
                if (!line) continue;
                
                const row = [];
                let current = '';
                let inQuotes = false;
                
                for (let i = 0; i < line.length; i++) {
                    const char = line[i];
                    const nextChar = line[i + 1];
                    
                    if (char === '"') {
                        if (inQuotes && nextChar === '"') {
                            current += '"';
                            i++; // skip next quote
                        } else {
                            inQuotes = !inQuotes;
                        }
                    } else if (!inQuotes && (char === ',' || char === 'ï¼Œ' || char === ';' || char === '\t')) {
                        row.push(current.trim());
                        current = '';
                    } else {
                        current += char;
                    }
                }
                
                row.push(current.trim());
                if (row.length >= 2) {
                    rows.push(row);
                }
            }
            
            return rows;
        }

        function saveLocal() {
            try {
                localStorage.setItem(STORAGE_KEY, JSON.stringify({
                    PRODUCTS,
                    CUSTOMERS
                }));
            } catch (e) {
                console.error('Failed to save to localStorage:', e);
            }
        }

        function loadLocal() {
            try {
                const data = localStorage.getItem(STORAGE_KEY);
                if (data) {
                    const parsed = JSON.parse(data);
                    if (parsed.PRODUCTS && parsed.CUSTOMERS) {
                        PRODUCTS = parsed.PRODUCTS;
                        CUSTOMERS = parsed.CUSTOMERS;
                        return true;
                    }
                }
            } catch (e) {
                console.error('Failed to load from localStorage:', e);
            }
            return false;
        }

        function clearLocal() {
            localStorage.removeItem(STORAGE_KEY);
            initializeDefaultData();
            renderAll();
            showToast('æœ¬æ©Ÿå„²å­˜å·²æ¸…é™¤ï¼Œå·²é‚„åŸé è¨­è³‡æ–™', 'success');
        }

        function initializeDefaultData() {
            const productRows = parseCSV(PRODUCTS_DEFAULT_CSV);
            PRODUCTS = productRows.map(([A, B, C]) => ({ A: A || '', B: B || '', C: C || '' }));
            
            const customerRows = parseCSV(CUSTOMERS_DEFAULT_CSV);
            CUSTOMERS = customerRows.map(([id, name]) => ({ id: id || '', name: name || '' }));
        }

        function showToast(message, type = 'success') {
            const toast = document.getElementById('toast');
            toast.textContent = message;
            toast.className = `toast ${type} show`;
            
            setTimeout(() => {
                toast.classList.remove('show');
            }, 2000);
        }

        function generateFormDateId() {
            const formDateIdInput = document.getElementById('formDateId');
            
            // ç”Ÿæˆæ™‚é–“æˆ³
            const now = new Date();
            const year = now.getFullYear();
            const month = String(now.getMonth() + 1).padStart(2, '0');
            const day = String(now.getDate()).padStart(2, '0');
            const hours = String(now.getHours()).padStart(2, '0');
            const minutes = String(now.getMinutes()).padStart(2, '0');
            
            const dateTimeStr = `${year}${month}${day}-${hours}${minutes}`;
            let formDateId;
            
            if (MODE === 'sales') {
                const customerSelect = document.getElementById('selCustomer');
                if (!customerSelect.value) {
                    formDateIdInput.value = '';
                    updateOrderPreview();
                    return;
                }
                // æ‰¾åˆ°å®¢æˆ¶åç¨±
                const selectedCustomer = CUSTOMERS.find(c => c.id === customerSelect.value);
                const customerName = selectedCustomer ? selectedCustomer.name : customerSelect.value;
                formDateId = `${customerName}-${dateTimeStr}`;
            } else {
                // ééŠ·å”®æ¨¡å¼ï¼šä¾é¡åˆ¥ç”Ÿæˆå‰ç¶´
                const selNonSalesCategory = document.getElementById('selNonSalesCategory');
                if (!selNonSalesCategory.value) {
                    formDateIdInput.value = '';
                    updateOrderPreview();
                    return;
                }
                
                // ä½¿ç”¨å¯¦éš›çš„ä¸­æ–‡é¡åˆ¥åç¨±ä½œç‚ºå‰ç¶´
                const selectedCat = NON_SALES_CATEGORIES.find(c => c.id === selNonSalesCategory.value);
                const prefix = selectedCat ? selectedCat.name : 'NS';
                formDateId = `${prefix}-${dateTimeStr}`;
            }
            
            formDateIdInput.value = formDateId;
            updateOrderPreview();
        }

        function renderMode() {
            const groupCustomer = document.getElementById('groupCustomer');
            const nonSalesFields = document.getElementById('nonSalesFields');
            const opSignSection = document.getElementById('opSignSection');
            const poInput = document.getElementById('po');
            
            if (MODE === 'sales') {
                // éŠ·å”®æ¨¡å¼ï¼šé¡¯ç¤ºå®¢æˆ¶é¸æ“‡ï¼Œéš±è—ééŠ·å”®æ¬„ä½
                groupCustomer.style.display = 'flex';
                nonSalesFields.style.display = 'none';
                poInput.readOnly = false;
                poInput.style.background = '#fff';
                // åˆ‡æ›å›éŠ·å”®æ¨¡å¼æ™‚ï¼Œæ¸…ç©ºPOæ¬„ä½ï¼ˆå¦‚æœç›®å‰æ˜¯"-"ï¼‰
                if (poInput.value === '-') {
                    poInput.value = '';
                }
                opSignSection.style.display = 'flex';
            } else {
                // ééŠ·å”®æ¨¡å¼ï¼šéš±è—å®¢æˆ¶é¸æ“‡ï¼Œé¡¯ç¤ºééŠ·å”®æ¬„ä½
                groupCustomer.style.display = 'none';
                nonSalesFields.style.display = 'block';
                poInput.value = '-';
                poInput.readOnly = true;
                poInput.style.background = '#f8f9fa';
                
                // å¡«å…¥ééŠ·å”®é¡åˆ¥
                const selNonSalesCategory = document.getElementById('selNonSalesCategory');
                selNonSalesCategory.innerHTML = '<option value="">è«‹é¸æ“‡é¡åˆ¥</option>';
                NON_SALES_CATEGORIES.sort((a, b) => a.order - b.order).forEach(cat => {
                    const option = document.createElement('option');
                    option.value = cat.id; // ä¸­æ–‡å€¼
                    option.textContent = cat.name; // ä¸­æ–‡é¡¯ç¤º
                    option.dataset.defaultSign = cat.defaultSign;
                    selNonSalesCategory.appendChild(option);
                });
                
                // æ›´æ–°æ“ä½œåˆ‡æ›çš„é¡¯ç¤º
                updateOpSignVisibility();
            }
            
            // é‡æ–°ç”Ÿæˆè¡¨å–®ID (æ¸…ç©ºç¾æœ‰å€¼ä»¥å¼·åˆ¶é‡æ–°ç”Ÿæˆ)
            document.getElementById('formDateId').value = '';
            generateFormDateId();
            updateOrderPreview();
        }
        
        function updateOpSignVisibility() {
            const selNonSalesCategory = document.getElementById('selNonSalesCategory');
            const opSignSection = document.getElementById('opSignSection');
            
            if (MODE === 'non_sales' && selNonSalesCategory.value) {
                const selectedOption = selNonSalesCategory.options[selNonSalesCategory.selectedIndex];
                const defaultSign = selectedOption.dataset.defaultSign;
                
                if (defaultSign === 'plus') {
                    opSignSection.style.display = 'none';
                    opSign = 'add';
                } else if (defaultSign === 'minus') {
                    opSignSection.style.display = 'none';
                    opSign = 'sub';
                } else {
                    opSignSection.style.display = 'flex';
                }
            } else {
                opSignSection.style.display = 'flex';
            }
        }

        function updateOrderPreview() {
            const customerSelect = document.getElementById('selCustomer');
            const poInput = document.getElementById('po');
            const formDateIdInput = document.getElementById('formDateId');
            
            // å–å¾—é è¦½è¡Œå…ƒç´ 
            const previewRows = document.querySelectorAll('.preview-row');
            
            if (MODE === 'sales') {
                // éŠ·å”®æ¨¡å¼é è¦½ - ç¢ºä¿æ­£ç¢ºçš„æ¨™ç±¤ï¼Œéš±è—ééŠ·å”®å°ˆç”¨è¡Œ
                if (previewRows.length >= 5) {
                    previewRows[0].querySelector('.preview-label').textContent = 'å‡ºè²¨å®¢æˆ¶:';
                    previewRows[1].querySelector('.preview-label').textContent = 'PO å‡ºè²¨å–®è™Ÿ:';
                    previewRows[2].querySelector('.preview-label').textContent = 'å‡ºè²¨å–®_æ—¥æœŸ_ID:';
                    
                    // éš±è—ç·Šæ€¥ç¨‹åº¦å’Œå‚™è¨»è¡Œï¼ˆééŠ·å”®å°ˆç”¨ï¼‰
                    previewRows[3].style.display = 'none';
                    previewRows[4].style.display = 'none';
                }
                
                const previewCustomer = document.getElementById('previewCustomer');
                if (customerSelect.value) {
                    const selectedCustomer = CUSTOMERS.find(c => c.id === customerSelect.value);
                    previewCustomer.textContent = selectedCustomer ? selectedCustomer.name : customerSelect.value;
                } else {
                    previewCustomer.textContent = 'è«‹é¸æ“‡å®¢æˆ¶';
                }
                
                const previewPO = document.getElementById('previewPO');
                previewPO.textContent = poInput.value.trim() || 'è«‹è¼¸å…¥ PO ç·¨è™Ÿ';
            } else {
                // ééŠ·å”®æ¨¡å¼é è¦½
                const selNonSalesCategory = document.getElementById('selNonSalesCategory');
                const selUrgency = document.getElementById('selUrgency');
                const txtNote = document.getElementById('txtNote');
                
                // æ›´æ–°é è¦½æ¨™ç±¤å’Œå…§å®¹ - é¡¯ç¤ºæ‰€æœ‰è¡Œ
                if (previewRows.length >= 5) {
                    // ç¬¬ä¸€è¡Œï¼šééŠ·å”®é¡åˆ¥
                    previewRows[0].querySelector('.preview-label').textContent = 'ééŠ·å”®é¡åˆ¥:';
                    if (selNonSalesCategory.value) {
                        const selectedCat = NON_SALES_CATEGORIES.find(c => c.id === selNonSalesCategory.value);
                        previewRows[0].querySelector('.preview-value').textContent = selectedCat ? selectedCat.id : 'è«‹é¸æ“‡é¡åˆ¥';
                    } else {
                        previewRows[0].querySelector('.preview-value').textContent = 'è«‹é¸æ“‡é¡åˆ¥';
                    }
                    
                    // ç¬¬äºŒè¡Œï¼šPO ç·¨è™Ÿï¼ˆå›ºå®šé¡¯ç¤º "-"ï¼‰
                    previewRows[1].querySelector('.preview-label').textContent = 'PO å‡ºè²¨å–®è™Ÿ:';
                    previewRows[1].querySelector('.preview-value').textContent = '-';
                    
                    // ç¬¬ä¸‰è¡Œï¼šå‡ºè²¨å–®_æ—¥æœŸ_ID
                    previewRows[2].querySelector('.preview-label').textContent = 'å‡ºè²¨å–®_æ—¥æœŸ_ID:';
                    
                    // ç¬¬å››è¡Œï¼šç·Šæ€¥ç¨‹åº¦
                    const urgencyLabels = { '0': 'ä¸€èˆ¬', '1': 'å„ªå…ˆ', '2': 'æ€¥ä»¶' };
                    previewRows[3].querySelector('.preview-label').textContent = 'ç·Šæ€¥ç¨‹åº¦:';
                    previewRows[3].querySelector('.preview-value').textContent = urgencyLabels[selUrgency.value] || 'ä¸€èˆ¬';
                    previewRows[3].style.display = 'flex';
                    
                    // ç¬¬äº”è¡Œï¼šå‚™è¨»
                    previewRows[4].querySelector('.preview-label').textContent = 'å‚™è¨»:';
                    previewRows[4].querySelector('.preview-value').textContent = txtNote.value.trim() || 'ç„¡';
                    previewRows[4].style.display = 'flex';
                }
            }
            
            // æ›´æ–°è¡¨å–®IDé è¦½
            const previewFormDateId = document.getElementById('previewFormDateId');
            previewFormDateId.textContent = formDateIdInput.value || 'å¾…ç”Ÿæˆ';
        }

        // æ¸²æŸ“å‡½æ•¸
        function renderCustomers() {
            const select = document.getElementById('selCustomer');
            select.innerHTML = '<option value="">è«‹é¸æ“‡å®¢æˆ¶</option>';
            
            // ä¿æŒåŸå§‹ä¸Šå‚³é †åºï¼Œä¸é€²è¡Œæ’åº
            CUSTOMERS.forEach(customer => {
                const option = document.createElement('option');
                option.value = customer.id;
                option.textContent = customer.name;
                select.appendChild(option);
            });
        }

        function renderFilters() {
            // ä¿æŒåŸå§‹ä¸Šå‚³é †åºçš„å»é‡è™•ç†
            const seenCategories = new Set();
            const seenSeries = new Set();
            const categories = [];
            const series = [];
            
            // æŒ‰åŸå§‹é †åºå–å¾—å“é¡å’Œç³»åˆ—
            PRODUCTS.forEach(p => {
                if (!seenCategories.has(p.A)) {
                    seenCategories.add(p.A);
                    categories.push(p.A);
                }
                if (!seenSeries.has(p.B)) {
                    seenSeries.add(p.B);
                    series.push(p.B);
                }
            });
            
            // ç”¢å“æŒ‰åŸå§‹é †åº
            const products = [...PRODUCTS];
            
            // å“é¡ä¸‹æ‹‰
            const catSelect = document.getElementById('selCategory');
            catSelect.innerHTML = '<option value="">å…¨éƒ¨å“é¡</option>';
            categories.forEach(cat => {
                const option = document.createElement('option');
                option.value = cat;
                option.textContent = cat;
                catSelect.appendChild(option);
            });
            
            // ç³»åˆ—ä¸‹æ‹‰
            const serSelect = document.getElementById('selSeries');
            serSelect.innerHTML = '<option value="">å…¨éƒ¨ç³»åˆ—</option>';
            series.forEach(ser => {
                const option = document.createElement('option');
                option.value = ser;
                option.textContent = ser;
                serSelect.appendChild(option);
            });
            
            // ç”¢å“ä¸‹æ‹‰
            const prodSelect = document.getElementById('selProduct');
            prodSelect.innerHTML = '<option value="">è«‹é¸æ“‡ç”¢å“</option>';
            products.forEach(prod => {
                const option = document.createElement('option');
                option.value = JSON.stringify(prod);
                option.textContent = prod.C;
                prodSelect.appendChild(option);
            });
        }

        function filterProducts() {
            const categoryValue = document.getElementById('selCategory').value;
            const seriesValue = document.getElementById('selSeries').value;
            
            let filtered = [...PRODUCTS];
            
            if (categoryValue) {
                filtered = filtered.filter(p => p.A === categoryValue);
            }
            
            if (seriesValue) {
                filtered = filtered.filter(p => p.B === seriesValue);
            }
            
            // ç§»é™¤å­—æ¯æ’åºï¼Œç¶­æŒåŸå§‹ä¸Šå‚³é †åº
            
            const prodSelect = document.getElementById('selProduct');
            prodSelect.innerHTML = '<option value="">è«‹é¸æ“‡ç”¢å“</option>';
            
            filtered.forEach(prod => {
                const option = document.createElement('option');
                option.value = JSON.stringify(prod);
                option.textContent = prod.C;
                prodSelect.appendChild(option);
            });
        }

        function renderCart() {
            const tbody = document.querySelector('#cartTable tbody');
            tbody.innerHTML = '';
            
            cart.forEach((item, index) => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${item.C}</td>
                    <td>
                        <div class="qty-controls">
                            <button class="qty-btn" onclick="updateCartQty(${index}, -1)">âˆ’</button>
                            <input type="number" class="qty-input" value="${item.qty}" min="1" onchange="setCartQty(${index}, this.value)">
                            <button class="qty-btn" onclick="updateCartQty(${index}, 1)">+</button>
                        </div>
                    </td>
                    <td>
                        <button class="btn btn-danger" onclick="removeFromCart(${index})">åˆªé™¤</button>
                    </td>
                `;
                tbody.appendChild(row);
            });
            
            // æ›´æ–°çµ±è¨ˆ
            document.getElementById('totalItems').textContent = cart.length;
            document.getElementById('totalQty').textContent = cart.reduce((sum, item) => sum + item.qty, 0);
        }

        function renderBundles() {
            const select = document.getElementById('selBundle');
            select.innerHTML = '<option value="">è«‹é¸æ“‡å¥—çµ„</option>';
            
            BUNDLES.forEach(bundle => {
                const option = document.createElement('option');
                option.value = bundle.id;
                option.textContent = bundle.name;
                select.appendChild(option);
            });
        }

        function renderAll() {
            renderCustomers();
            renderFilters();
            renderBundles();
            renderCart();
        }

        // äº‹ä»¶è™•ç†
        function updateCartQty(index, change) {
            cart[index].qty = Math.max(1, cart[index].qty + change);
            renderCart();
        }

        function setCartQty(index, value) {
            const qty = parseInt(value) || 1;
            cart[index].qty = Math.max(1, qty);
            renderCart();
        }

        function removeFromCart(index) {
            cart.splice(index, 1);
            renderCart();
            showToast('å·²å¾æ¸…å–®ä¸­ç§»é™¤', 'success');
        }

        function addToCart() {
            const productSelect = document.getElementById('selProduct');
            const qtyInput = document.getElementById('qty');
            
            if (!productSelect.value) {
                showToast('è«‹é¸æ“‡ç”¢å“', 'error');
                return;
            }
            
            const product = JSON.parse(productSelect.value);
            const qty = Math.max(1, parseInt(qtyInput.value) || 1);
            
            // æª¢æŸ¥æ˜¯å¦å·²å­˜åœ¨
            const existingIndex = cart.findIndex(item => 
                item.A === product.A && item.B === product.B && item.C === product.C
            );
            
            if (existingIndex >= 0) {
                cart[existingIndex].qty += qty;
                showToast('æ•¸é‡å·²ç´¯åŠ ', 'success');
            } else {
                cart.push({ ...product, qty });
                showToast('å·²åŠ å…¥æ¸…å–®', 'success');
            }
            
            renderCart();
            qtyInput.value = 1;
        }

        function addBundleToCart() {
            const bundleSelect = document.getElementById('selBundle');
            const bundleQtyInput = document.getElementById('bundleQty');
            
            if (!bundleSelect.value) {
                showToast('è«‹é¸æ“‡å¥—çµ„', 'error');
                return;
            }
            
            const selectedBundle = BUNDLES.find(b => b.id === bundleSelect.value);
            if (!selectedBundle) {
                showToast('å¥—çµ„ä¸å­˜åœ¨', 'error');
                return;
            }
            
            const bundleQty = Math.max(1, parseInt(bundleQtyInput.value) || 1);
            let addedCount = 0;
            
            selectedBundle.items.forEach(bundleItem => {
                // å°‡ productKey è½‰æ›ç‚ºç”¢å“å°è±¡
                const [A, B, C] = bundleItem.productKey.split('__');
                const product = { A, B, C };
                const totalQty = bundleItem.qtyPerBundle * bundleQty;
                
                // æª¢æŸ¥ç”¢å“æ˜¯å¦å­˜åœ¨æ–¼ PRODUCTS ä¸­
                const productExists = PRODUCTS.find(p => p.A === A && p.B === B && p.C === C);
                if (!productExists) {
                    showToast(`å¥—çµ„ä¸­çš„ç”¢å“ã€Œ${C}ã€ä¸å­˜åœ¨æ–¼å•†å“æ¸…å–®ä¸­`, 'error');
                    return;
                }
                
                // æª¢æŸ¥æ˜¯å¦å·²å­˜åœ¨æ–¼è³¼ç‰©è»Š
                const existingIndex = cart.findIndex(item => 
                    item.A === A && item.B === B && item.C === C
                );
                
                if (existingIndex >= 0) {
                    cart[existingIndex].qty += totalQty;
                } else {
                    cart.push({ ...product, qty: totalQty });
                }
                addedCount++;
            });
            
            if (addedCount > 0) {
                renderCart();
                showToast(`å·²åŠ å…¥å¥—çµ„ã€Œ${selectedBundle.name}ã€Ã—${bundleQty}`, 'success');
                bundleQtyInput.value = 1;
            }
        }

        function clearCart() {
            if (cart.length === 0) {
                showToast('æ¸…å–®å·²ç¶“æ˜¯ç©ºçš„', 'error');
                return;
            }
            
            if (confirm('ç¢ºå®šè¦æ¸…ç©ºæ¸…å–®å—ï¼Ÿåªæœƒæ¸…é™¤å•†å“æ¸…å–®ï¼Œä¸å½±éŸ¿å…¶ä»–è¼¸å…¥æ¬„ä½ã€‚')) {
                cart = [];
                renderCart();
                showToast('å•†å“æ¸…å–®å·²æ¸…ç©º', 'success');
            }
        }

        function submitOrder() {
            const formDateIdInput = document.getElementById('formDateId');
            
            if (cart.length === 0) {
                showToast('æ¸…å–®æ˜¯ç©ºçš„', 'error');
                return;
            }
            
            // æ ¹æ“šæ¨¡å¼é€²è¡Œä¸åŒçš„é©—è­‰
            if (MODE === 'sales') {
                const customerSelect = document.getElementById('selCustomer');
                const poInput = document.getElementById('po');
                
                if (!customerSelect.value) {
                    showToast('è«‹é¸æ“‡å‡ºè²¨å®¢æˆ¶', 'error');
                    return;
                }
                
                if (!poInput.value.trim()) {
                    showToast('è«‹è¼¸å…¥ PO å‡ºè²¨å–®è™Ÿ', 'error');
                    return;
                }
            } else {
                const selNonSalesCategory = document.getElementById('selNonSalesCategory');
                
                if (!selNonSalesCategory.value) {
                    showToast('è«‹é¸æ“‡ééŠ·å”®é¡åˆ¥', 'error');
                    return;
                }
            }
            
            // è¨ˆç®— delta ç¸½å’Œ
            let totalDelta = 0;
            const itemsWithDelta = cart.map(item => {
                let delta;
                if (MODE === 'sales') {
                    delta = -item.qty; // éŠ·å”®æ¨¡å¼å›ºå®šç‚ºè² å€¼ï¼ˆå‡ºè²¨ï¼‰
                } else {
                    const selNonSalesCategory = document.getElementById('selNonSalesCategory');
                    const selectedOption = selNonSalesCategory.options[selNonSalesCategory.selectedIndex];
                    const defaultSign = selectedOption.dataset.defaultSign;
                    
                    if (defaultSign === 'plus') {
                        delta = +item.qty;
                    } else if (defaultSign === 'minus') {
                        delta = -item.qty;
                    } else {
                        // defaultSign === 'any'ï¼Œä¾ç…§ opSign æ±ºå®š
                        delta = opSign === 'add' ? +item.qty : -item.qty;
                    }
                }
                totalDelta += delta;
                
                return {
                    id: `${slug(item.A)}__${slug(item.B)}__${slug(item.C)}`,
                    category: item.A,
                    series: item.B,
                    product: item.C,
                    delta: delta
                };
            });
            
            // å‰µå»ºç¢ºèªè¨Šæ¯
            let confirmMessage;
            if (MODE === 'sales') {
                const customerSelect = document.getElementById('selCustomer');
                const poInput = document.getElementById('po');
                const selectedCustomer = CUSTOMERS.find(c => c.id === customerSelect.value);
                const customerName = selectedCustomer ? selectedCustomer.name : customerSelect.value;
                
                confirmMessage = `ğŸš€ ç¢ºèªè¦æäº¤åº«å­˜æ›´æ–°å—ï¼Ÿ

æ¨¡å¼: éŠ·å”® (Sales)
ğŸ“¦ å‡ºè²¨å®¢æˆ¶: ${customerName}
ğŸ“‹ PO å‡ºè²¨å–®è™Ÿ: ${poInput.value.trim()}
ğŸ†” å‡ºè²¨å–®_æ—¥æœŸ_ID: ${formDateIdInput.value}

ğŸ“Š å•†å“é …ç›®: ${cart.length} é …
ğŸ“Š åº«å­˜ç•°å‹•ç¸½é‡: ${totalDelta}

âš ï¸ æ­¤æ“ä½œå°‡æœƒæäº¤åˆ°åº«å­˜æ›´æ–°ç³»çµ±ï¼Œç¢ºå®šè¦ç¹¼çºŒå—ï¼Ÿ`;
            } else {
                const selNonSalesCategory = document.getElementById('selNonSalesCategory');
                const selUrgency = document.getElementById('selUrgency');
                const txtNote = document.getElementById('txtNote');
                const selectedCat = NON_SALES_CATEGORIES.find(c => c.id === selNonSalesCategory.value);
                
                confirmMessage = `ğŸš€ ç¢ºèªè¦æäº¤åº«å­˜æ›´æ–°å—ï¼Ÿ

æ¨¡å¼: ééŠ·å”® (Non-Sales)
ğŸ“‹ é¡åˆ¥: ${selectedCat ? selectedCat.id : 'æœªçŸ¥'}
âš¡ ç·Šæ€¥ç¨‹åº¦: ${selUrgency.value}
ğŸ“ å‚™è¨»: ${txtNote.value || 'ç„¡'}
ğŸ†” è¡¨å–®_æ—¥æœŸ_ID: ${formDateIdInput.value}

ğŸ“Š å•†å“é …ç›®: ${cart.length} é …
ğŸ“Š åº«å­˜ç•°å‹•ç¸½é‡: ${totalDelta}

âš ï¸ æ­¤æ“ä½œå°‡æœƒæäº¤åˆ°åº«å­˜æ›´æ–°ç³»çµ±ï¼Œç¢ºå®šè¦ç¹¼çºŒå—ï¼Ÿ`;
            }
            
            if (!confirm(confirmMessage)) {
                return;
            }
            
            
            // å»ºç«‹çµ±ä¸€ payload
const mode = MODE; // 'sales' | 'non_sales'
            const poVal = (mode === 'sales' ? (document.getElementById('po').value || '').trim() : '-');
            const noteVal = (document.getElementById('txtNote')?.value || '').trim(); // ééŠ·å”®æ™‚å¿…å¡«å¯åœ¨ UI é©—è­‰

            const payload = {
                action: "inventory_update",
                mode,
                // â€”â€” ééŠ·å”®å°ˆå±¬æ¬„ä½ï¼ˆéŠ·å”®ä¹Ÿè¦æœ‰ noteï¼Œä½†å¯ç‚ºç©ºï¼‰â€”â€”
                ...(mode === 'non_sales' ? {
                    categoryId: document.getElementById('selNonSalesCategory').value || "",
                    urgency: parseInt(document.getElementById('selUrgency').value || "0", 10)
                } : {}),
                note: noteVal,
                // â€”â€” è¨‚å–®è³‡æ–™ â€”â€” 
                order: {
                    customerId: (mode === 'sales'
                        ? (document.getElementById('selCustomer').value || "")
                        : (document.getElementById('selNonSalesCategory').value || "")), // ééŠ·å”®ç”¨é¡åˆ¥IDå ä½
                    category: (mode === 'non_sales' ? document.getElementById('selNonSalesCategory').value || "" : ""),
                    po: poVal,
                    docId: (document.getElementById('formDateId').value || "").trim()
                },
                // â€”â€” æ˜ç´°ï¼ˆè«‹ç¢ºä¿å« product èˆ‡ deltaï¼‰â€”â€”
                items: cart.map(p => ({
                    id: p.id || `${slug(p.A)}__${slug(p.B)}__${slug(p.C)}`,
                    category: p.A,
                    series: p.B,
                    product: p.C,
                    delta: (mode === 'sales' ? -(p.qty||0) : (p.delta || (p.qty||0))) // ä½¿ç”¨è¨ˆç®—å¥½çš„ delta
                })),
                // â€”â€” åˆä½µæ¬„ä½ï¼ˆçµ¦ Make ç›´æ¥ mappingï¼‰â€”â€”
                meta: {
                    noteCombined: [poVal, noteVal].filter(Boolean).join(" | ")
                }
            };

            // é€å‡ºå‰è«‹åŠ é€™è¡Œé™¤éŒ¯ï¼š
            console.log('[DEBUG payload]', JSON.stringify(payload, null, 2));
            
            fetch(WEBHOOK_URL, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(payload)
            })
            .then(response => {
                if (response.ok) {
                    showToast('âœ… åº«å­˜æ›´æ–°æäº¤æˆåŠŸï¼', 'success');
                } else {
                    throw new Error('Network response was not ok');
                }
            })
            .catch(error => {
                console.error('Submit error:', error);
                showToast('âŒ æäº¤å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦', 'error');
            });
        }

        function resetAllData() {
            if (!confirm('ğŸ”„ ç¢ºå®šè¦é‡ç½®æ‰€æœ‰è³‡æ–™å—ï¼Ÿé€™å°‡æ¢å¾©åˆ°ç³»çµ±åˆå§‹ç‹€æ…‹ï¼')) {
                return;
            }
            
            // é‡ç½®æ¨¡å¼ç‚ºéŠ·å”®
            MODE = 'sales';
            document.querySelector('input[name="mode"][value="sales"]').checked = true;
            
            // æ¸…ç©ºè¡¨å–®æ¬„ä½
            document.getElementById('selCustomer').value = '';
            document.getElementById('po').value = '';
            document.getElementById('formDateId').value = '';
            
            // æ¸…ç©ºééŠ·å”®æ¬„ä½
            document.getElementById('selNonSalesCategory').value = '';
            document.getElementById('selUrgency').value = '0';
            document.getElementById('txtNote').value = '';
            
            // æ¸…ç©ºè³¼ç‰©è»Š
            cart = [];
            
            // é‡ç½®ç”¢å“ç¯©é¸ç‚ºé è¨­å€¼
            document.getElementById('selCategory').value = '';
            document.getElementById('selSeries').value = '';
            document.getElementById('selProduct').value = '';
            document.getElementById('qty').value = '1';
            
            // é‡ç½®æ“ä½œé¡å‹ç‚ºå‡ºè²¨
            opSign = 'sub';
            document.querySelector('input[name="opSign"][value="sub"]').checked = true;
            
            // é‡æ–°æ¸²æŸ“æ‰€æœ‰çµ„ä»¶
            renderMode();  // é€™æœƒè™•ç†æ¨¡å¼ç›¸é—œçš„é¡¯ç¤º/éš±è—
            renderCart();
            updateOrderPreview();
            filterProducts();
            
            showToast('ğŸ”„ å·²é‡ç½®åˆ°ç³»çµ±åˆå§‹ç‹€æ…‹', 'success');
        }

        // CSV åŒ¯å…¥è™•ç†
        function importProducts() {
            const csvText = document.getElementById('csvABC').value.trim();
            if (!csvText) {
                showToast('è«‹è¼¸å…¥å•†å“ CSV è³‡æ–™', 'error');
                return;
            }
            
            try {
                const rows = parseCSV(csvText);
                PRODUCTS = rows.map(([A, B, C]) => ({ A: A || '', B: B || '', C: C || '' }));
                saveLocal();
                renderFilters();
                showToast(`å·²è¼‰å…¥ ${PRODUCTS.length} å€‹å•†å“`, 'success');
            } catch (error) {
                showToast('å•†å“ CSV æ ¼å¼éŒ¯èª¤', 'error');
            }
        }

        function importCustomers() {
            const csvText = document.getElementById('csvCus').value.trim();
            if (!csvText) {
                showToast('è«‹è¼¸å…¥å®¢æˆ¶ CSV è³‡æ–™', 'error');
                return;
            }
            
            try {
                const rows = parseCSV(csvText);
                CUSTOMERS = rows.map(([id, name]) => ({ id: id || '', name: name || '' }));
                saveLocal();
                renderCustomers();
                showToast(`å·²è¼‰å…¥ ${CUSTOMERS.length} å€‹å®¢æˆ¶`, 'success');
            } catch (error) {
                showToast('å®¢æˆ¶ CSV æ ¼å¼éŒ¯èª¤', 'error');
            }
        }

        function overwriteAll() {
            const productsCsv = document.getElementById('csvABC').value.trim();
            const customersCsv = document.getElementById('csvCus').value.trim();
            
            if (!productsCsv && !customersCsv) {
                showToast('è«‹è‡³å°‘è¼¸å…¥ä¸€ç¨®è³‡æ–™', 'error');
                return;
            }
            
            if (productsCsv) {
                try {
                    const rows = parseCSV(productsCsv);
                    PRODUCTS = rows.map(([A, B, C]) => ({ A: A || '', B: B || '', C: C || '' }));
                } catch (error) {
                    showToast('å•†å“ CSV æ ¼å¼éŒ¯èª¤', 'error');
                    return;
                }
            }
            
            if (customersCsv) {
                try {
                    const rows = parseCSV(customersCsv);
                    CUSTOMERS = rows.map(([id, name]) => ({ id: id || '', name: name || '' }));
                } catch (error) {
                    showToast('å®¢æˆ¶ CSV æ ¼å¼éŒ¯èª¤', 'error');
                    return;
                }
            }
            
            saveLocal();
            renderAll();
            showToast('è³‡æ–™å·²è¦†è“‹ä¸¦å„²å­˜', 'success');
        }

        // äº‹ä»¶ç¶å®š
        document.addEventListener('DOMContentLoaded', function() {
            // åˆå§‹åŒ–è³‡æ–™
            if (!loadLocal()) {
                initializeDefaultData();
            }
            renderAll();
            renderMode();
            
            // å¥—çµ„æ•¸é‡æ§åˆ¶
            document.getElementById('bundleInc').onclick = () => {
                const bundleQtyInput = document.getElementById('bundleQty');
                bundleQtyInput.value = Math.max(1, parseInt(bundleQtyInput.value) || 1) + 1;
            };
            
            document.getElementById('bundleDec').onclick = () => {
                const bundleQtyInput = document.getElementById('bundleQty');
                bundleQtyInput.value = Math.max(1, (parseInt(bundleQtyInput.value) || 1) - 1);
            };
            
            document.getElementById('bundleQty').onchange = function() {
                this.value = Math.max(1, parseInt(this.value) || 1);
            };
            
            // æ•¸é‡æ§åˆ¶
            document.getElementById('inc').onclick = () => {
                const qtyInput = document.getElementById('qty');
                qtyInput.value = Math.max(1, parseInt(qtyInput.value) || 1) + 1;
            };
            
            document.getElementById('dec').onclick = () => {
                const qtyInput = document.getElementById('qty');
                qtyInput.value = Math.max(1, (parseInt(qtyInput.value) || 1) - 1);
            };
            
            document.getElementById('qty').onchange = function() {
                this.value = Math.max(1, parseInt(this.value) || 1);
            };
            
            // ç¯©é¸è¯å‹•
            document.getElementById('selCategory').onchange = filterProducts;
            document.getElementById('selSeries').onchange = filterProducts;
            
            document.getElementById('selProduct').onchange = function() {
                if (this.value) {
                    const product = JSON.parse(this.value);
                    // åŒæ­¥ç¯©é¸å™¨
                    document.getElementById('selCategory').value = product.A;
                    document.getElementById('selSeries').value = product.B;
                }
            };
            
            // æ¨¡å¼åˆ‡æ›äº‹ä»¶
            document.querySelectorAll('input[name="mode"]').forEach(radio => {
                radio.onchange = function() {
                    MODE = this.value;
                    renderMode();
                };
            });
            
            // æ“ä½œé¡å‹åˆ‡æ›äº‹ä»¶
            document.querySelectorAll('input[name="opSign"]').forEach(radio => {
                radio.onchange = function() {
                    opSign = this.value;
                };
            });
            
            // ééŠ·å”®é¡åˆ¥è®Šæ›´äº‹ä»¶
            document.getElementById('selNonSalesCategory').onchange = function() {
                updateOpSignVisibility();
                generateFormDateId();
                updateOrderPreview();
            };
            
            // ç·Šæ€¥ç¨‹åº¦å’Œå‚™è¨»è®Šæ›´äº‹ä»¶
            document.getElementById('selUrgency').onchange = updateOrderPreview;
            document.getElementById('txtNote').oninput = updateOrderPreview;
            
            // å®¢æˆ¶é¸æ“‡äº‹ä»¶ - è‡ªå‹•ç”Ÿæˆè¡¨å–®_æ—¥æœŸ_ID
            document.getElementById('selCustomer').onchange = function() {
                generateFormDateId();
                updateOrderPreview();
            };
            
            // POç·¨è™Ÿè¼¸å…¥äº‹ä»¶ - æ›´æ–°é è¦½
            document.getElementById('po').oninput = updateOrderPreview;
            
            // æŒ‰éˆ•äº‹ä»¶
            document.getElementById('addBtn').onclick = addToCart;
            document.getElementById('btnAddBundle').onclick = addBundleToCart;
            document.getElementById('btnClear').onclick = clearCart;
            document.getElementById('btnSubmit').onclick = submitOrder;
            document.getElementById('btnReset').onclick = resetAllData;
            
            // åŒ¯å…¥æŒ‰éˆ•
            document.getElementById('btnParseABC').onclick = importProducts;
            document.getElementById('btnParseCus').onclick = importCustomers;
            document.getElementById('btnOverwriteAll').onclick = overwriteAll;
            document.getElementById('btnClearLocal').onclick = clearLocal;
        });
    </script>
</body>
</html>
