<!doctype html>
<html lang="zh-Hant">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>PM 庫存更新系統 — Write4Version (Final UI + Full Functions)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  </head>
  <body class="bg-white text-gray-950">
    <div id="root"></div>

    <script type="text/babel">
      const {useState,useEffect,useMemo} = React;

      /* -------------------- Config -------------------- */
      const URLS = {
        products :"https://raw.githubusercontent.com/ceo-peng/pm-tools/refs/heads/main/data/products.csv",
        customers:"https://raw.githubusercontent.com/ceo-peng/pm-tools/refs/heads/main/data/customers.csv",
        bundles  :"https://raw.githubusercontent.com/ceo-peng/pm-tools/refs/heads/main/data/bundle_items.csv",
        gifts    :"https://raw.githubusercontent.com/ceo-peng/pm-tools/refs/heads/main/data/gifts.csv",
        nonsales :"https://raw.githubusercontent.com/ceo-peng/pm-tools/refs/heads/main/data/non_sales_application.csv",
      };
      const WEBHOOK = "https://hook.us2.make.com/nbjdxrfypgoosj4qqxnzfmj9o29jq3c2";
      const PIN = "50963212";

      /* ----------------------------- CSV helpers ---------------------------- */
      const lines = (csv)=>csv.split(/\r?\n/).map(s=>s.trim()).filter(Boolean);
      const maybeStripHeader=(arr,expect)=> {
        if(!arr.length) return arr;
        const first=arr[0].toLowerCase();
        return expect.some(k=>first.includes(k)) ? arr.slice(1) : arr;
      };
      function parseProducts(csv){
        let l=lines(csv); l=maybeStripHeader(l,["a,","b,","c"]);
        return l.map(s=>{ const [A,B,C]=s.split(",").map(x=>x?.trim()); return {id:C,A,B,C}; })
                .filter(x=>x?.id && x?.C);
      }
      function parsePairs(csv){
        let l=lines(csv); l=maybeStripHeader(l,["id,","name"]);
        return l.map(s=>{ const [id,name]=s.split(",").map(x=>x?.trim()); return {id,name}; })
                .filter(x=>x?.id && x?.name);
      }
      function parseBundles(csv){ // for 套組 / 禮遇
        let l=lines(csv);
        l=maybeStripHeader(l,["bundle_id","bundle_name","product_id"]);
        const map={};
        l.forEach(s=>{
          const [bid,bname,pid,qtyRaw,active]=s.split(",").map(x=>x?.trim());
          if(!bid||!bname||!pid) return;
          if(active==="0") return;
          const qty=parseInt(qtyRaw||"1",10)||1;
          (map[bid] ||= {id:bid,name:bname,items:[]}).items.push({productId:pid,qty});
        });
        return Object.values(map);
      }
      async function fetchCsv(url){ const r=await fetch(url,{cache:"no-store"}); if(!r.ok) throw new Error(url); return r.text(); }

      /* -------------------------- Toast (tiny) -------------------------- */
      function useToast(){
        const [msg,setMsg]=useState("");
        useEffect(()=>{ if(!msg) return; const t=setTimeout(()=>setMsg(""),2200); return ()=>clearTimeout(t);},[msg]);
        const Toast = ()=> msg? <div className="fixed top-3 right-3 z-50 bg-black text-white text-xs px-3 py-2 rounded">{msg}</div>:null;
        return {setMsg,Toast};
      }

      /* -------------------- Stepper (符號按鈕 + 小輸入框) ------------------- */
      function Stepper({value,min=0,onChange,small=false}){
        const h = small ? "h-[26px]" : "h-[34px]";
        const btnW = small ? "w-6" : "w-7";
        const fz = small ? "text-[15px]" : "text-[16px]";
        const inW = small ? "w-10 text-[12.5px]" : "w-9 text-[13px]";
        return (
          <div className={`inline-flex items-stretch border border-gray-300 rounded ${h} overflow-hidden`}>
            <button
              className={`${btnW} ${fz} leading-none select-none`}
              onClick={()=>onChange(Math.max(min,(value||0)-1))}
              aria-label="decrement"
            >−</button>
            <input
              className={`${inW} text-center outline-none border-l border-r border-gray-300`}
              value={value}
              onChange={(e)=>{const n=parseInt(e.target.value.replace(/[^0-9]/g,''),10); onChange(Number.isFinite(n)?n:0);}}
              inputMode="numeric"
            />
            <button
              className={`${btnW} ${fz} leading-none select-none`}
              onClick={()=>onChange((value||0)+1)}
              aria-label="increment"
            >+</button>
          </div>
        );
      }

      /* --------------------------- Form-Date-ID --------------------------- */
      function genDocId(prefix){
        const d=new Date(); const p=n=>String(n).padStart(2,"0");
        return `${prefix}-${d.getFullYear()}${p(d.getMonth()+1)}${p(d.getDate())}-${p(d.getHours())}${p(d.getMinutes())}`;
      }

      /* ================================ App ================================= */
      function App(){
        const {setMsg,Toast}=useToast();

        // data
        const [PRODUCTS,setPRODUCTS]=useState([]);
        const [CUSTOMERS,setCUSTOMERS]=useState([]);
        const [BUNDLES,setBUNDLES]=useState([]);
        const [GIFTS,setGIFTS]=useState([]);
        const [NONSALES,setNONSALES]=useState([]);

        // 訂單模式（僅決定要顯示哪個下拉；與出/入庫無關）
        const [orderMode,setOrderMode]=useState("sales"); // 'sales' | 'nonSales'
        const [salesCat,setSalesCat]=useState("");
        const [nonSalesCat,setNonSalesCat]=useState("");
        const [po,setPo]=useState("");
        const [memo,setMemo]=useState("");

        // 出/入庫操作（決定簽名）
        const [op,setOp]=useState("out"); // 'out' 出貨(扣) | 'in' 進貨(入)

        // selections preview
        const [bundleGroups,setBundleGroups]=useState({}); // {bundleId: count}
        const [giftChecks,setGiftChecks]=useState({});      // {giftId: true}
        const [pendingSingles,setPendingSingles]=useState({}); // {productId: qty}
        const [openPreview,setOpenPreview]=useState(true);

        // final rows
        const [rows,setRows]=useState([]);

        // confirm modal
        const [showConfirm,setShowConfirm]=useState(false);

        // Admin panel
        const [adminOpen,setAdminOpen]=useState(false);

        useEffect(()=>{
          (async ()=>{
            try{
              const [p,c,b,g,n]=await Promise.all([
                fetchCsv(URLS.products), fetchCsv(URLS.customers),
                fetchCsv(URLS.bundles),  fetchCsv(URLS.gifts),
                fetchCsv(URLS.nonsales)
              ]);
              setPRODUCTS(parseProducts(p));
              setCUSTOMERS(parsePairs(c));
              setBUNDLES(parseBundles(b));
              setGIFTS(parseBundles(g));
              setNONSALES(parsePairs(n));
              setMsg("已自動載入 GitHub CSV");
            }catch(e){
              console.error(e);
              setMsg("自動載入失敗（請檢查 RAW URL）");
            }
          })();
        },[]);

        /* ---------- dropdown options for 單品 ---------- */
        const catA = useMemo(()=> [...new Set(PRODUCTS.map(x=>x.A))], [PRODUCTS]);
        const seriesByA = useMemo(()=>{
          const obj={}; catA.forEach(a=>obj[a]=[...new Set(PRODUCTS.filter(p=>p.A===a).map(p=>p.B))]); return obj;
        },[catA,PRODUCTS]);
        const prodsByAB = useMemo(()=>{
          const obj={}; PRODUCTS.forEach(p=>{ const k=`${p.A}__${p.B}`; (obj[k] ||= []).push(p);}); return obj;
        },[PRODUCTS]);

        const [selA,setSelA]=useState(""); const [selB,setSelB]=useState(""); const [selPid,setSelPid]=useState(""); const [singleQty,setSingleQty]=useState(1);
        useEffect(()=>{
          if(!PRODUCTS.length) return;
          const a0=catA[0]||""; const b0=(seriesByA[a0]||[])[0]||"";
          setSelA(a0); setSelB(b0);
          const first=(prodsByAB[`${a0}__${b0}`]||[])[0];
          setSelPid(first?first.id:"");
        },[PRODUCTS]);

        /* ---------- previews ---------- */
        const previewBundles = useMemo(()=> Object.entries(bundleGroups)
          .filter(([,c])=>c>0)
          .map(([bid,count])=>{
            const b=BUNDLES.find(x=>x.id===bid); if(!b) return null;
            return { id:bid, title:`${b.name} × ${count}`, details:b.items.map(it=>{
              const name=(PRODUCTS.find(p=>p.id===it.productId)||{}).C || it.productId;
              return {productId:it.productId,name,qty:it.qty*count};
            })};
          }).filter(Boolean), [bundleGroups,BUNDLES,PRODUCTS]);

        const previewSingles = useMemo(()=> Object.entries(pendingSingles)
          .filter(([,q])=>q>0)
          .map(([pid,qty])=>{
            const name=(PRODUCTS.find(p=>p.id===pid)||{}).C||pid;
            return {productId:pid,name,qty};
          }),[pendingSingles,PRODUCTS]);

        const previewGifts = useMemo(()=> Object.entries(giftChecks)
          .filter(([,ok])=>ok)
          .map(([gid])=>{
            const g=GIFTS.find(x=>x.id===gid); if(!g) return null;
            return {id:gid,title:g.name,details:g.items.map(it=>{
              const name=(PRODUCTS.find(p=>p.id===it.productId)||{}).C||it.productId;
              return {productId:it.productId,name,qty:it.qty};
            })};
          }).filter(Boolean),[giftChecks,GIFTS,PRODUCTS]);

        function clearPreview(){ setBundleGroups({}); setPendingSingles({}); setGiftChecks({}); }

        function confirmPreview(){
          const addMap=new Map();
          const add=(pid,qty)=>addMap.set(pid,(addMap.get(pid)||0)+qty);
          previewBundles.forEach(b=>b.details.forEach(d=>add(d.productId,d.qty)));
          previewSingles.forEach(s=>add(s.productId,s.qty));
          previewGifts.forEach(g=>g.details.forEach(d=>add(d.productId,d.qty)));
          if(addMap.size===0) return;
          setRows(prev=>{
            const next=[...prev];
            addMap.forEach((qty,pid)=>{
              const name=(PRODUCTS.find(p=>p.id===pid)||{}).C||pid;
              const idx=next.findIndex(x=>x.productId===pid);
              if(idx>=0) next[idx]={...next[idx],qty:next[idx].qty+qty};
              else next.push({id:`${pid}-${Date.now()}-${Math.random()}`,productId:pid,name,qty,picked:0});
            });
            return next;
          });
          // 保留預覽內容（不清空），作為參考
        }

        const formDateId = useMemo(()=> {
          const prefix = (orderMode==='sales' ? (salesCat||"") : (nonSalesCat||""));
          return genDocId(prefix);
        },[orderMode,salesCat,nonSalesCat]);

        /* ---------- UI helpers ---------- */
        const OrderInfo = () => (
          <section className="rounded border border-gray-200 bg-white shadow-sm mb-4">
            <div className="flex items-center justify-between px-4 py-2 border-b bg-gray-50">
              <div className="font-medium text-sm">出貨訂單資訊</div>
              <div className="text-xs text-gray-600">表單-日期-ID：<span className="font-mono">{formDateId}</span></div>
            </div>
            <div className="p-3 space-y-3 text-xs">
              <div className="flex items-center gap-4">
                <label className="flex items-center gap-1">
                  <input type="radio" name="ordermode" checked={orderMode==='sales'} onChange={()=>setOrderMode('sales')} />
                  銷售
                </label>
                <label className="flex items-center gap-1">
                  <input type="radio" name="ordermode" checked={orderMode==='nonSales'} onChange={()=>setOrderMode('nonSales')} />
                  非銷售
                </label>
              </div>

              {orderMode==='sales' ? (
                <div className="grid grid-cols-1 md:grid-cols-3 gap-2">
                  <div>
                    <div className="text-[11px] text-gray-500 mb-1">客戶分類</div>
                    <select className="border rounded h-8 px-2 w-full"
                            value={salesCat}
                            onChange={e=>setSalesCat(e.target.value)}>
                      <option value="" disabled>選擇訂單類別</option>
                      {(CUSTOMERS||[]).map(c=><option key={c.id} value={c.name}>{c.name}</option>)}
                    </select>
                  </div>
                  <div>
                    <div className="text-[11px] text-gray-500 mb-1">PO 出貨單號</div>
                    <input className="border rounded h-8 px-2 w-full" placeholder="—" value={po} onChange={e=>setPo(e.target.value)} />
                  </div>
                  <div>
                    <div className="text-[11px] text-gray-500 mb-1">備註</div>
                    <input className="border rounded h-8 px-2 w-full" placeholder="—" value={memo} onChange={e=>setMemo(e.target.value)} />
                  </div>
                </div>
              ) : (
                <div className="grid grid-cols-1 md:grid-cols-3 gap-2">
                  <div>
                    <div className="text-[11px] text-gray-500 mb-1">非銷售分類</div>
                    <select className="border rounded h-8 px-2 w-full"
                            value={nonSalesCat}
                            onChange={e=>setNonSalesCat(e.target.value)}>
                      <option value="" disabled>選擇訂單類別</option>
                      {(NONSALES||[]).map(n=><option key={n.id} value={n.name}>{n.name}</option>)}
                    </select>
                  </div>
                  <div>
                    <div className="text-[11px] text-gray-500 mb-1">PO 出貨單號</div>
                    <input className="border rounded h-8 px-2 w-full" placeholder="—" value={po} onChange={e=>setPo(e.target.value)} />
                  </div>
                  <div>
                    <div className="text-[11px] text-gray-500 mb-1">備註</div>
                    <input className="border rounded h-8 px-2 w-full" placeholder="—" value={memo} onChange={e=>setMemo(e.target.value)} />
                  </div>
                </div>
              )}

              <div>
                <button className="h-8 px-3 border border-gray-300 rounded text-xs" onClick={resetAll}>Reset All（重抓 GitHub CSV）</button>
              </div>
            </div>
          </section>
        );

        function resetAll(){
          (async ()=>{
            try{
              const [p,c,b,g,n]=await Promise.all([
                fetchCsv(URLS.products), fetchCsv(URLS.customers),
                fetchCsv(URLS.bundles),  fetchCsv(URLS.gifts),
                fetchCsv(URLS.nonsales)
              ]);
              setPRODUCTS(parseProducts(p));
              setCUSTOMERS(parsePairs(c));
              setBUNDLES(parseBundles(b));
              setGIFTS(parseBundles(g));
              setNONSALES(parsePairs(n));
              // clear working states
              setBundleGroups({}); setGiftChecks({}); setPendingSingles({});
              setRows([]);
              setMsg("已重抓 GitHub CSV");
            }catch(e){
              console.error(e);
              setMsg("重抓失敗");
            }
          })();
        }

        return (
          <div className="mx-auto max-w-6xl p-4 pb-24">
            <Toast/>
            <h1 className="text-lg md:text-xl font-semibold mb-4">PM 庫存更新系統（Write4Version — Final）</h1>

            {/* 出貨訂單資訊（含 銷售/非銷售 切換 + 下拉） */}
            <OrderInfo/>

            {/* 產品選擇（UI 同你範例；手機兩欄/桌機三欄；單品三下拉有標題） */}
            <ProductPicker
              PRODUCTS={PRODUCTS}
              BUNDLES={BUNDLES}
              GIFTS={GIFTS}
              bundleGroups={bundleGroups}
              setBundleGroups={setBundleGroups}
              pendingSingles={pendingSingles}
              setPendingSingles={setPendingSingles}
              giftChecks={giftChecks}
              setGiftChecks={setGiftChecks}
              catA={catA} seriesByA={seriesByA} prodsByAB={prodsByAB}
              selA={selA} setSelA={setSelA} selB={selB} setSelB={setSelB}
              selPid={selPid} setSelPid={setSelPid}
              singleQty={singleQty} setSingleQty={setSingleQty}
            />

            {/* 預覽（可收合） */}
            <Preview
              previewBundles={previewBundles}
              previewSingles={previewSingles}
              previewGifts={previewGifts}
              openPreview={openPreview}
              setOpenPreview={setOpenPreview}
              clearPreview={clearPreview}
              confirmPreview={confirmPreview}
            />

            {/* 出貨清單／庫存扣減確認 */}
            {rows.length>0 && (
              <section className="mt-6 rounded border border-gray-200 bg-white shadow-sm p-4">
                <div className="flex items-center justify-between mb-2">
                  <h2 className="font-medium text-sm">出貨清單／庫存扣減確認</h2>

                  {/* ✅ 出/入庫 selector（只決定簽名） */}
                  <div className="flex items-center gap-3 text-xs">
                    <label className="flex items-center gap-1">
                      <input type="radio" name="op" checked={op==='out'} onChange={()=>setOp('out')}/>
                      出貨（扣）
                    </label>
                    <label className="flex items-center gap-1">
                      <input type="radio" name="op" checked={op==='in'} onChange={()=>setOp('in')}/>
                      進貨（入）
                    </label>
                  </div>
                </div>

                {/* header 卡：與訂單資訊一致層級 */}
                <div className="mb-3 rounded-lg border border-gray-200 bg-gray-50 p-3">
                  <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-2">
                    <div><div className="text-[11px] text-gray-500">類別</div><div className="text-sm font-semibold">{orderMode==='sales'?(salesCat||'—'):(nonSalesCat||'—')}</div></div>
                    <div><div className="text-[11px] text-gray-500">客戶 PO</div><div className="text-sm font-semibold">{po||'—'}</div></div>
                    <div><div className="text-[11px] text-gray-500">備註</div><div className="text-sm font-semibold">{memo||'—'}</div></div>
                    <div><div className="text-[11px] text-gray-500">表單-日期-ID</div><div className="text-sm font-semibold font-mono">{formDateId}</div></div>
                  </div>
                </div>

                <RowsList rows={rows} setRows={setRows} />

                <div className="flex justify-between items-center mt-3 text-sm">
                  <span>項：{rows.length}　預計：{rows.reduce((s,r)=>s+r.qty,0)}　點交：<Totals rows={rows}/></span>
                </div>
              </section>
            )}

            {/* sticky actions + confirm modal + webhook POST */}
            <Actions
              rows={rows} setRows={setRows}
              op={op}
              orderMode={orderMode} salesCat={salesCat} nonSalesCat={nonSalesCat}
              po={po} memo={memo} formDateId={formDateId}
            />

            {/* 系統用：PIN 開啟；手貼 CSV 覆蓋（預設關閉） */}
            <AdminPanel
              adminOpen={adminOpen} setAdminOpen={setAdminOpen}
              setPRODUCTS={setPRODUCTS} setCUSTOMERS={setCUSTOMERS} setBUNDLES={setBUNDLES} setGIFTS={setGIFTS} setNONSALES={setNONSALES}
              setBundleGroups={setBundleGroups} setGiftChecks={setGiftChecks} setPendingSingles={setPendingSingles} setRows={setRows}
            />
          </div>
        );
      }

      /* -------------------------- Subcomponents -------------------------- */

      function ProductPicker(props){
        const {
          PRODUCTS,BUNDLES,GIFTS,
          bundleGroups,setBundleGroups,
          pendingSingles,setPendingSingles,
          giftChecks,setGiftChecks,
          catA,seriesByA,prodsByAB,
          selA,setSelA,selB,setSelB,selPid,setSelPid,
          singleQty,setSingleQty
        } = props;

        // 當 A/B 改變時，重置下游選擇
        useEffect(()=>{ const b0=(seriesByA[selA]||[])[0]||""; setSelB(b0); },[selA]);
        useEffect(()=>{ const first=(prodsByAB[`${selA}__${selB}`]||[])[0]; setSelPid(first?first.id:""); },[selB,selA,prodsByAB]);

        return (
          <section className="rounded border border-gray-200 bg-white shadow-sm p-4">
            <div className="flex items-center justify-between mb-3">
              <h2 className="font-medium text-sm">產品選擇</h2>
              <div className="text-xs text-gray-500">套組 / 單品 / 禮遇 → 先加入預覽</div>
            </div>

            {/* 套組：手機兩欄；桌機三欄；標題可 2 行；Stepper 置右且精簡 */}
            <div className="mb-4">
              <h3 className="text-xs font-semibold mb-2">套組</h3>
              <div className="grid grid-cols-2 lg:grid-cols-3 gap-2">
                {(BUNDLES||[]).map(b=>(
                  <div key={b.id} className="rounded border border-gray-200 bg-white p-2">
                    <div className="flex flex-col md:flex-row md:items-center md:justify-between gap-1 md:gap-2">
                      <span
                        className="text-[13px] leading-snug md:flex-1"
                        style={{display:"-webkit-box",WebkitLineClamp:2,WebkitBoxOrient:"vertical",overflow:"hidden"}}
                        title={b.name}
                      >{b.name}</span>
                      <div className="md:self-auto self-end md:mt-0 mt-1 flex justify-end">
                        <Stepper value={bundleGroups[b.id]||0}
                                 onChange={v=>setBundleGroups(s=>({...s,[b.id]:v}))}
                                 small/>
                      </div>
                    </div>
                  </div>
                ))}
                {(BUNDLES||[]).length===0 && <div className="text-[11px] text-gray-400">（尚無套組）</div>}
              </div>
            </div>

            {/* 單品（3 個下拉有標題；切換 A/B 會重置下游；加入數量 Stepper 靠右） */}
            <div className="mb-4">
              <h3 className="text-xs font-semibold mb-2">單品</h3>
              <div className="grid md:grid-cols-6 gap-2 items-center bg-white p-2 rounded border">
                <div>
                  <div className="text-[11px] text-gray-500 mb-1">商品類別（A）</div>
                  <select className="border rounded h-8 px-2 text-xs w-full" value={selA} onChange={e=>setSelA(e.target.value)}>
                    {catA.map(a=><option key={a}>{a}</option>)}
                  </select>
                </div>
                <div>
                  <div className="text-[11px] text-gray-500 mb-1">系列名稱（B）</div>
                  <select className="border rounded h-8 px-2 text-xs w-full" value={selB} onChange={e=>setSelB(e.target.value)}>
                    {(seriesByA[selA]||[]).map(b=><option key={b}>{b}</option>)}
                  </select>
                </div>
                <div className="md:col-span-3">
                  <div className="text-[11px] text-gray-500 mb-1">產品名稱（C / 唯一 ID）</div>
                  <select className="border rounded h-8 px-2 text-xs w-full" value={selPid} onChange={e=>setSelPid(e.target.value)}>
                    {((prodsByAB[`${selA}__${selB}`])||[]).map(p=><option key={p.id} value={p.id}>{p.C}</option>)}
                  </select>
                </div>
                <div className="flex items-end justify-end gap-1">
                  <Stepper value={singleQty} min={1} onChange={setSingleQty} />
                  <button
                    className="h-8 px-3 border border-gray-300 rounded text-xs"
                    onClick={()=> selPid && setPendingSingles(prev=>({...prev,[selPid]:(prev[selPid]||0)+singleQty}))}
                  >加</button>
                </div>
              </div>
            </div>

            {/* 禮遇：手機兩欄；桌機三欄；checkbox + 兩行標題 */}
            <div>
              <h3 className="text-xs font-semibold mb-2">禮遇</h3>
              <div className="grid grid-cols-2 lg:grid-cols-3 gap-2">
                {(GIFTS||[]).map(g=>(
                  <label key={g.id} className="flex items-center gap-2 rounded border border-gray-200 bg-white p-2 cursor-pointer">
                    <input type="checkbox" checked={!!giftChecks[g.id]} onChange={e=>setGiftChecks(s=>({...s,[g.id]:e.target.checked}))}/>
                    <span className="text-xs leading-snug"
                          style={{display:"-webkit-box",WebkitLineClamp:2,WebkitBoxOrient:"vertical",overflow:"hidden"}}
                          title={g.name}>{g.name}</span>
                  </label>
                ))}
                {(GIFTS||[]).length===0 && <div className="text-[11px] text-gray-400">（尚無禮遇）</div>}
              </div>
            </div>
          </section>
        );
      }

      function Preview({previewBundles,previewSingles,previewGifts,openPreview,setOpenPreview,clearPreview,confirmPreview}){
        return (
          <section className="mt-4">
            <div className="flex items-center justify-between">
              <h3 className="text-xs font-semibold">庫存更新預覽</h3>
              <button className="h-8 px-3 border border-gray-300 rounded text-xs" onClick={()=>setOpenPreview(o=>!o)}>{openPreview?"收":"展"}</button>
            </div>
            {openPreview && (
              <div className="mt-2">
                <div className="grid grid-cols-1 lg:grid-cols-3 gap-3">
                  <Card title="套組">
                    {previewBundles.length===0 ? <Empty/> : (
                      <ul className="space-y-2 text-xs">
                        {previewBundles.map(b=>(
                          <li key={b.id} className="border-b border-dashed border-gray-200 pb-1">
                            <div className="font-medium mb-1">{b.title}</div>
                            <ul className="ml-3 list-disc text-[11px] text-gray-600">
                              {b.details.map((d,i)=><li key={i} title={d.name}>{d.name} × {d.qty}</li>)}
                            </ul>
                          </li>
                        ))}
                      </ul>
                    )}
                  </Card>
                  <Card title="單品">
                    {previewSingles.length===0 ? <Empty/> : (
                      <ul className="space-y-2 text-xs">
                        {previewSingles.map(s=>(
                          <li key={s.productId} className="flex items-center justify-between gap-2">
                            <div className="text-[11px] leading-snug whitespace-normal break-words" title={s.name}>{s.name}</div>
                            <div className="flex items-center gap-2">
                              <span className="text-xs">× {s.qty}</span>
                            </div>
                          </li>
                        ))}
                      </ul>
                    )}
                  </Card>
                  <Card title="禮遇">
                    {previewGifts.length===0 ? <Empty/> : (
                      <ul className="space-y-2 text-xs">
                        {previewGifts.map(g=>(
                          <li key={g.id} className="border-b border-dashed border-gray-200 pb-1">
                            <div className="font-medium mb-1">{g.title}</div>
                            <ul className="ml-3 list-disc text-[11px] text-gray-600">
                              {g.details.map((d,i)=><li key={i} title={d.name}>{d.name} × {d.qty}</li>)}
                            </ul>
                          </li>
                        ))}
                      </ul>
                    )}
                  </Card>
                </div>
                <div className="mt-3 flex justify-end gap-2">
                  <button className="h-8 px-3 border border-gray-300 rounded text-xs" onClick={clearPreview}>全部清除</button>
                  <button className="h-8 px-3 border border-gray-300 rounded text-xs" onClick={confirmPreview}>確認加入</button>
                </div>
              </div>
            )}
          </section>
        );
      }

      function Card({title,children}){ return (
        <div className="rounded border border-gray-200 bg-white p-3">
          <div className="text-xs font-semibold mb-2">{title}</div>
          {children}
        </div>
      );}
      function Empty(){ return <div className="text-xs text-gray-400">（無）</div>; }

      function RowsList({rows,setRows}){
        return (
          <ul className="space-y-2">
            {rows.map(r=>{
              const mismatch=(r.picked||0)!==(r.qty||0);
              return (
                <li key={r.id} className={`rounded-md border ${mismatch?'border-red-300 bg-red-50/40':'border-gray-200 bg-white'}`}>
                  <div className="p-2 sm:p-2.5 grid grid-cols-1 md:grid-cols-12 md:items-center md:gap-2">
                    <div className="md:col-span-7">
                      <div className="text-[15px] leading-5 md:text-[13px] break-words">{r.name}</div>
                    </div>
                    {/* desktop controls */}
                    <div className="hidden md:flex md:col-span-2 items-center gap-1">
                      <input className={`w-16 h-7 rounded border px-2 text-right tabular-nums ${mismatch?'border-red-400':'border-gray-300'}`} value={r.picked}
                        onChange={e=>{const n=parseInt(e.target.value.replace(/[^0-9]/g,''),10); setRows(prev=>prev.map(x=>x.id===r.id?{...x,picked:Number.isFinite(n)?n:0}:x));}}/>
                      {mismatch && <button title="帶入預計" className="h-7 px-2 border border-gray-300 rounded text-xs text-gray-600" onClick={()=>setRows(prev=>prev.map(x=>x.id===r.id?{...x,picked:x.qty}:x))}>=</button>}
                    </div>
                    <div className="hidden md:flex md:col-span-2 justify-end">
                      <span className="text-xs text-gray-500 mr-2">預計</span>
                      <Stepper value={r.qty} min={0} onChange={v=>setRows(prev=>prev.map(x=>x.id===r.id?{...x,qty:v}:x))} small/>
                    </div>
                    <div className="hidden md:flex md:col-span-1 justify-end">
                      <button className="h-7 w-7 border border-gray-300 rounded text-sm text-gray-600" onClick={()=>setRows(prev=>prev.filter(x=>x.id!==r.id))}>×</button>
                    </div>
                    {/* mobile controls */}
                    <div className="mt-2 md:hidden flex items-center justify-between gap-2">
                      <div className="flex items-center gap-1">
                        <input className={`w-16 h-9 rounded border px-2 text-right tabular-nums ${mismatch?'border-red-400':'border-gray-300'}`} value={r.picked}
                          onChange={e=>{const n=parseInt(e.target.value.replace(/[^0-9]/g,''),10); setRows(prev=>prev.map(x=>x.id===r.id?{...x,picked:Number.isFinite(n)?n:0}:x));}}/>
                        {mismatch && <button title="帶入預計" className="h-9 px-2 border border-gray-300 rounded text-sm text-gray-600" onClick={()=>setRows(prev=>prev.map(x=>x.id===r.id?{...x,picked:x.qty}:x))}>=</button>}
                      </div>
                      <Stepper value={r.qty} min={0} onChange={v=>setRows(prev=>prev.map(x=>x.id===r.id?{...x,qty:v}:x))}/>
                      <button className="h-9 px-3 border border-gray-300 rounded text-sm text-gray-600" onClick={()=>setRows(prev=>prev.filter(x=>x.id!==r.id))}>刪</button>
                    </div>
                  </div>
                </li>
              );
            })}
          </ul>
        );
      }

      function Totals({rows}){ const v=rows.reduce((s,r)=>s+(r.picked||0),0); const eq=v===rows.reduce((s,r)=>s+r.qty,0); return <span className={eq?'':'text-red-600 font-medium'}>{v}</span> }

      function Actions({rows,setRows,op,orderMode,salesCat,nonSalesCat,po,memo,formDateId}){
        const hasMismatch = rows.some(r=>(r.picked||0)!==(r.qty||0));
        const opLabel = op==='out' ? '出貨（扣）' : '進貨（入）';
        const plannedTotal = rows.reduce((s,r)=>s+(r.qty||0),0);
        const pickedTotal  = rows.reduce((s,r)=>s+(r.picked||0),0);
        const [showConfirm,setShowConfirm]=useState(false);

        async function postWebhook(){
          const sign = op==='out' ? -1 : +1;
          const category = (orderMode==='sales'?salesCat:nonSalesCat) || "";
          const payload = {
            category,
            po: po || "",
            memo: memo || "",
            formDateId,
            items: rows
              .filter(r=>(r.picked||0)>0)
              .map(r=>({ productId:r.productId, delta: (r.picked||0)*sign }))
          };
          const res = await fetch(WEBHOOK,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(payload)});
          if(!res.ok) throw new Error("HTTP "+res.status);
        }

        return (
          <>
            {rows.length>0 && (
              <div className="md:static fixed bottom-0 left-0 right-0 md:bg-transparent bg-white/95 md:shadow-none shadow-[0_-4px_12px_rgba(0,0,0,0.06)] md:p-0 p-2">
                <div className="flex justify-end gap-2 max-w-6xl mx-auto">
                  <button className="h-9 px-3 border border-gray-300 rounded text-xs" onClick={()=>setRows(prev=>prev.map(x=>({...x,picked:x.qty})))}>全部帶入</button>
                  <button className="h-9 px-3 border border-gray-300 rounded text-xs" onClick={()=>setRows([])}>全部清除</button>
                  <button className="h-9 px-3 border border-gray-300 rounded text-xs disabled:opacity-50"
                          disabled={rows.length===0}
                          onClick={()=>setShowConfirm(true)}>庫存更新提交</button>
                </div>
              </div>
            )}

            {/* 確認對話框（含訂單 header） */}
            {showConfirm && (
              <div className="fixed inset-0 z-50 flex items-center justify-center bg-black/40 p-4">
                <div className="w-full max-w-lg rounded-lg bg-white shadow-xl">
                  <div className="px-4 py-3 border-b">
                    <div className="text-sm font-semibold">送出前確認</div>
                    <div className="mt-1 text-xs text-gray-600">操作類型：{opLabel}</div>
                    <div className="mt-2 grid grid-cols-1 md:grid-cols-2 gap-2 text-xs">
                      <div><span className="text-gray-500">類別：</span><span className="font-semibold">{orderMode==='sales'?(salesCat||'—'):(nonSalesCat||'—')}</span></div>
                      <div><span className="text-gray-500">客戶 PO：</span><span className="font-semibold">{po||'—'}</span></div>
                      <div><span className="text-gray-500">備註：</span><span className="font-semibold">{memo||'—'}</span></div>
                      <div><span className="text-gray-500">表單-日期-ID：</span><span className="font-semibold font-mono">{formDateId}</span></div>
                    </div>
                  </div>
                  <div className="p-4 max-h-[60vh] overflow-auto">
                    <div className="text-xs mb-2">
                      項：{rows.length}　預計：{plannedTotal}　點交：<span className={hasMismatch?'text-red-600 font-semibold':''}>{pickedTotal}</span>
                    </div>
                    {hasMismatch && <div className="mb-2 text-xs text-red-600">點交量與預計不一致，請先調整至一致才能送出。</div>}
                    <ul className="space-y-2 text-xs">
                      {rows.map(r=>( // 按你的需求：這裡不顯示 stepper，只顯示預計/點交總覽
                        <li key={r.id} className="rounded border border-gray-200 p-2">
                          <div className="font-medium">{r.name}</div>
                          <div className="mt-1 text-[11px] text-gray-600">預計：{r.qty}　|　點交：{r.picked}</div>
                        </li>
                      ))}
                    </ul>
                  </div>
                  <div className="px-4 py-3 border-t flex justify-end gap-2">
                    <button className="h-8 px-3 border border-gray-300 rounded text-xs" onClick={()=>setShowConfirm(false)}>取消</button>
                    <button className="h-8 px-3 border border-gray-300 rounded text-xs disabled:opacity-50"
                            disabled={hasMismatch}
                            onClick={async ()=>{
                              try{
                                await postWebhook();
                                setShowConfirm(false);
                                alert("已提交成功");
                              }catch(e){
                                console.error(e);
                                alert("提交失敗，請稍後重試");
                              }
                            }}>確認送出</button>
                  </div>
                </div>
              </div>
            )}
          </>
        );
      }

      function AdminPanel({adminOpen,setAdminOpen,setPRODUCTS,setCUSTOMERS,setBUNDLES,setGIFTS,setNONSALES,setBundleGroups,setGiftChecks,setPendingSingles,setRows}){
        const [csvProducts,setCsvProducts]=useState("");
        const [csvCustomers,setCsvCustomers]=useState("");
        const [csvBundles,setCsvBundles]=useState("");
        const [csvGifts,setCsvGifts]=useState("");
        const [csvNonsales,setCsvNonsales]=useState("");

        function tryPin(){
          const pin=prompt("請輸入管理員 PIN：");
          if(pin===PIN){ setAdminOpen(true); }
          else if(pin!==null){ alert("PIN 錯誤"); }
        }

        return (
          <section className="mt-6 rounded border border-gray-200 bg-white shadow-sm">
            <div className="flex items-center justify-between px-4 py-2 border-b bg-gray-50">
              <div className="font-medium text-sm">匯入資料（系統用）</div>
              <button className="h-8 px-3 border border-gray-300 rounded text-xs" onClick={()=>adminOpen?setAdminOpen(false):tryPin()}>
                {adminOpen? "隱藏面板 ▴" : "管理登入 ▾"}
              </button>
            </div>
            {adminOpen && (
              <div className="p-4">
                <div className="text-xs text-gray-500 mb-2">貼上 CSV 後按「載入」，會清空並覆蓋該資料集並即時重建 UI。</div>
                <div className="grid md:grid-cols-2 gap-4">
                  <div>
                    <div className="text-[11px] text-gray-500 mb-1">商品 CSV（A,B,C）</div>
                    <textarea className="w-full h-28 border rounded p-2 text-xs font-mono" value={csvProducts} onChange={e=>setCsvProducts(e.target.value)} placeholder="正品(大),金萃油,仙人掌籽超能量金萃油 15ml (2027/07/30)"></textarea>
                    <button className="mt-2 h-8 px-3 border border-gray-300 rounded text-xs"
                      onClick={()=>{ const list=parseProducts(csvProducts||""); if(!list.length) return alert("未解析到商品資料"); setPRODUCTS(list); setBundleGroups({}); setGiftChecks({}); setPendingSingles({}); setRows([]); alert(`商品 ${list.length} 筆已覆蓋`); }}>
                      載入商品
                    </button>
                  </div>
                  <div>
                    <div className="text-[11px] text-gray-500 mb-1">客戶 CSV（id,name）</div>
                    <textarea className="w-full h-28 border rounded p-2 text-xs font-mono" value={csvCustomers} onChange={e=>setCsvCustomers(e.target.value)} placeholder="C001,官網"></textarea>
                    <button className="mt-2 h-8 px-3 border border-gray-300 rounded text-xs"
                      onClick={()=>{ const list=parsePairs(csvCustomers||""); if(!list.length) return alert("未解析到客戶資料"); setCUSTOMERS(list); alert(`客戶 ${list.length} 筆已覆蓋`); }}>
                      載入客戶
                    </button>
                  </div>
                  <div>
                    <div className="text-[11px] text-gray-500 mb-1">套組 CSV（bundle_id,bundle_name,product_id,qty,active）</div>
                    <textarea className="w-full h-28 border rounded p-2 text-xs font-mono" value={csvBundles} onChange={e=>setCsvBundles(e.target.value)} placeholder="bundleX,夏日組,仙人掌籽超能量金萃油 15ml (2027/07/30),2,1"></textarea>
                    <button className="mt-2 h-8 px-3 border border-gray-300 rounded text-xs"
                      onClick={()=>{ const list=parseBundles(csvBundles||""); if(!list.length) return alert("未解析到套組資料"); setBUNDLES(list); setBundleGroups({}); alert(`套組 ${list.length} 筆已覆蓋`); }}>
                      載入套組
                    </button>
                  </div>
                  <div>
                    <div className="text-[11px] text-gray-500 mb-1">禮遇 CSV（bundle_id,bundle_name,product_id,qty,active）</div>
                    <textarea className="w-full h-28 border rounded p-2 text-xs font-mono" value={csvGifts} onChange={e=>setCsvGifts(e.target.value)} placeholder="giftA,消費禮,完美極萃面膜 鎖水能量(單片) (2028/08/12),1,1"></textarea>
                    <button className="mt-2 h-8 px-3 border border-gray-300 rounded text-xs"
                      onClick={()=>{ const list=parseBundles(csvGifts||""); if(!list.length) return alert("未解析到禮遇資料"); setGIFTS(list); setGiftChecks({}); alert(`禮遇 ${list.length} 筆已覆蓋`); }}>
                      載入禮遇
                    </button>
                  </div>
                  <div>
                    <div className="text-[11px] text-gray-500 mb-1">非銷售 CSV（id,name）</div>
                    <textarea className="w-full h-28 border rounded p-2 text-xs font-mono" value={csvNonsales} onChange={e=>setCsvNonsales(e.target.value)} placeholder="INV,盤點"></textarea>
                    <button className="mt-2 h-8 px-3 border border-gray-300 rounded text-xs"
                      onClick={()=>{ const list=parsePairs(csvNonsales||""); if(!list.length) return alert("未解析到非銷售資料"); setNONSALES(list); alert(`非銷售 ${list.length} 筆已覆蓋`); }}>
                      載入非銷售
                    </button>
                  </div>
                </div>
              </div>
            )}
          </section>
        );
      }

      ReactDOM.createRoot(document.getElementById("root")).render(<App/>);
    </script>
  </body>
</html>
