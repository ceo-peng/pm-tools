<!doctype html>
<html lang="zh-Hant">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>PM 庫存更新系統（Write4Version – Final）</title>
<style>
  :root{
    --bg:#ffffff; --fg:#111827; --muted:#6b7280; --line:#e5e7eb;
    --brand:#0ea5e9; --brand-600:#0284c7; --card:#f9fafb; --danger:#ef4444;
  }
  *{box-sizing:border-box}
  body{margin:0;background:var(--bg);color:var(--fg);font:14px/1.45 ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;}
  .container{max-width:1120px;margin:24px auto;padding:0 16px}
  h1{font-size:22px;margin:0 0 16px}
  .block{background:#fff;border:1px solid var(--line);border-radius:12px;box-shadow:0 2px 6px rgba(0,0,0,.03);margin:16px 0}
  .block-hd{display:flex;align-items:center;justify-content:space-between;padding:12px 16px;border-bottom:1px solid var(--line);background:#fafafa}
  .block-hd .ttl{font-weight:700;font-size:16px;letter-spacing:.02em}
  .block-bd{padding:16px}
  .muted{color:var(--muted)}
  .row{display:flex;gap:12px;flex-wrap:wrap}
  .field{display:flex;flex-direction:column;gap:6px;min-width:220px;flex:1}
  label{font-size:12px;color:var(--muted)}
  input[type=text],select,textarea{
    width:100%;padding:10px 12px;border:1px solid var(--line);border-radius:10px;background:#fff;
    outline:none;transition:.15s;border-color:var(--line);
  }
  input[type=text]:focus,select:focus,textarea:focus{border-color:var(--brand)}
  textarea{min-height:72px;resize:vertical}
  .radio-row{display:flex;gap:18px;align-items:center}
  .hint{font-size:12px;color:var(--muted)}
  .grid{display:grid;gap:12px}
  .grid-3{grid-template-columns:repeat(3,minmax(0,1fr))}
  .grid-2{grid-template-columns:repeat(2,minmax(0,1fr))}
  @media (max-width:1024px){.grid-3{grid-template-columns:repeat(2,minmax(0,1fr))}}
  @media (max-width:640px){.grid-3,.grid-2{grid-template-columns:repeat(2,minmax(0,1fr))}}
  .card{border:1px solid var(--line);border-radius:12px;background:#fff;padding:12px}
  .item-row{display:flex;align-items:center;justify-content:space-between;gap:8px}
  .name{font-weight:600;font-size:14px;line-height:1.3;display:-webkit-box;-webkit-line-clamp:2;-webkit-box-orient:vertical;overflow:hidden}
  .stepper{display:inline-flex;align-items:center;border:1px solid var(--line);border-radius:10px;height:36px;overflow:hidden}
  .stepper button{width:36px;height:36px;border:0;background:#fff;font-size:18px;cursor:pointer}
  .stepper input{width:46px;border:0;border-left:1px solid var(--line);border-right:1px solid var(--line);text-align:center;font-weight:600}
  .right{margin-left:auto}
  .btn{display:inline-flex;align-items:center;justify-content:center;gap:6px;padding:10px 14px;border-radius:10px;border:1px solid var(--line);background:#fff;cursor:pointer}
  .btn.primary{background:var(--brand);border-color:var(--brand);color:#fff}
  .btn.danger{background:#fff;border-color:var(--danger);color:var(--danger)}
  .btn.ghost{background:#fff}
  .btn.small{padding:6px 10px;font-size:12px;border-radius:8px}
  .divider{height:1px;background:var(--line);margin:12px 0}
  .mono{font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace}
  .pill{display:inline-flex;align-items:center;height:28px;padding:0 8px;border-radius:999px;border:1px solid var(--line);gap:8px;background:#fff}
  .table{width:100%;border-collapse:separate;border-spacing:0 12px}
  .tr{display:grid;grid-template-columns:140px 1fr 150px 50px;gap:12px;align-items:center}
  .tr .title{font-weight:600}
  @media (max-width:680px){
    .tr{grid-template-columns:1fr;align-items:stretch}
  }
  .tag{padding:2px 8px;border-radius:999px;font-size:12px;background:#eef6ff;color:#0b6fb6}
  .preview-list .row-item{border:1px dashed var(--line);border-radius:10px;padding:10px 12px;margin-bottom:8px;background:#fff}
  .sticky-actions{position:sticky;bottom:0;background:rgba(255,255,255,.9);backdrop-filter:saturate(180%) blur(6px);border-top:1px solid var(--line);padding:12px;display:flex;gap:10px;justify-content:flex-end}
  /* Modal */
  .modal{position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:rgba(0,0,0,.35);z-index:40}
  .modal.open{display:flex}
  .modal-card{width:min(840px,92vw);max-height:88vh;overflow:auto;background:#fff;border-radius:12px;border:1px solid var(--line)}
  .modal-hd{padding:12px 16px;border-bottom:1px solid var(--line);font-weight:700}
  .modal-bd{padding:16px}
</style>
</head>
<body>
<div class="container">
  <h1>PM 庫存更新系統（Write4Version – Final）</h1>

  <!-- 出貨訂單資訊 -->
  <section class="block" id="orderBlock">
    <div class="block-hd">
      <div class="ttl">出貨訂單資訊</div>
      <div class="hint">表單-日期-ID：<span id="docId" class="mono">—</span></div>
    </div>
    <div class="block-bd">
      <div class="radio-row" style="margin-bottom:8px">
        <label><input type="radio" name="mode" value="sales" checked> 銷售</label>
        <label><input type="radio" name="mode" value="non_sales"> 非銷售</label>
      </div>
      <div class="row">
        <div class="field" id="customerWrap">
          <label>類別（請選擇）</label>
          <select id="customerSelect">
            <option value="">— 選擇訂單類別 —</option>
          </select>
        </div>
        <div class="field" id="nonSalesWrap" style="display:none">
          <label>類別（請選擇）</label>
          <select id="nonSalesSelect">
            <option value="">— 選擇訂單類別 —</option>
          </select>
        </div>
      </div>
      <div class="row" style="margin-top:8px">
        <div class="field"><label>客戶 PO 出貨單號</label><input id="poInput" type="text" placeholder="—" /></div>
        <div class="field"><label>備註</label><input id="memoInput" type="text" placeholder="—" /></div>
      </div>
      <div class="row" style="margin-top:8px;justify-content:flex-end">
        <button class="btn small" id="resetBtn">Reset All（重新載入資料）</button>
      </div>
    </div>
  </section>

  <!-- 產品選擇 -->
  <section class="block">
    <div class="block-hd">
      <div class="ttl">產品選擇</div>
      <div class="hint">套組 / 單品 / 禮遇 → 先加入預覽</div>
    </div>
    <div class="block-bd">

      <!-- 套組 -->
      <div style="font-weight:700;margin:2px 0 8px">套組</div>
      <div id="bundleGrid" class="grid grid-3"></div>

      <!-- 單品 -->
      <div class="divider"></div>
      <div style="font-weight:700;margin:2px 0 8px">單品</div>
      <div class="row">
        <div class="field">
          <label>商品類別（A）</label>
          <select id="catA"></select>
        </div>
        <div class="field">
          <label>系列名稱（B）</label>
          <select id="catB"></select>
        </div>
        <div class="field" style="flex:2">
          <label>產品名稱（C／唯一 ID）</label>
          <select id="catC"></select>
        </div>
        <div class="field" style="max-width:180px">
          <label>數量</label>
          <div class="stepper">
            <button id="sDec">−</button>
            <input id="sQty" value="1" inputmode="numeric">
            <button id="sInc">+</button>
          </div>
        </div>
        <div class="field" style="max-width:140px;align-self:flex-end">
          <button id="addSingle" class="btn primary" title="加入單品">加入</button>
        </div>
      </div>

      <!-- 禮遇 -->
      <div class="divider"></div>
      <div style="font-weight:700;margin:2px 0 8px">禮遇</div>
      <div id="giftGrid" class="grid grid-3"></div>

    </div>
  </section>

  <!-- 預覽（單欄直列） -->
  <section class="block" id="previewBlock">
    <div class="block-hd">
      <div class="ttl">庫存更新預覽</div>
      <button id="togglePreview" class="btn small">收</button>
    </div>
    <div class="block-bd" id="previewBody">
      <div class="preview-list">
        <div class="hint" id="emptyPreview">（無）</div>
        <div id="previewList"></div>
      </div>
      <div class="row" style="justify-content:flex-end;margin-top:8px">
        <button class="btn danger" id="clearPreview">全部清除</button>
        <button class="btn primary" id="commitPreview">確認加入</button>
      </div>
    </div>
  </section>

  <!-- 出貨清單／庫存扣減確認 -->
  <section class="block">
    <div class="block-hd">
      <div class="ttl">出貨清單／庫存扣減確認</div>
      <div class="pill">
        <span class="muted">簽名：</span>
        <label><input type="radio" name="op" value="out" checked> 出貨（扣）</label>
        <label style="margin-left:8px"><input type="radio" name="op" value="in"> 進貨（入）</label>
      </div>
    </div>
    <div class="block-bd">

      <!-- header summary -->
      <div id="summary" class="card" style="margin-bottom:12px">
        <div class="row">
          <div><span class="muted">類別：</span><span id="sumCat">—</span></div>
          <div><span class="muted">客戶 PO：</span><span id="sumPO">—</span></div>
          <div><span class="muted">備註：</span><span id="sumMemo">—</span></div>
          <div><span class="muted">表單-日期-ID：</span><span id="sumDoc" class="mono">—</span></div>
        </div>
      </div>

      <div id="finalTable">
        <div class="muted" id="finalEmpty">（尚未加入項目）</div>
        <div id="finalRows"></div>
      </div>

      <div class="sticky-actions">
        <button class="btn small" id="fillPicked">全部帶入</button>
        <button class="btn small danger" id="clearFinal">全部清除</button>
        <button class="btn small primary" id="submitAll">庫存更新提交</button>
      </div>
    </div>
  </section>

</div>

<!-- Modal -->
<div class="modal" id="confirmModal" aria-hidden="true">
  <div class="modal-card">
    <div class="modal-hd">送出前確認</div>
    <div class="modal-bd">
      <div class="card" style="margin-bottom:10px">
        <div class="row">
          <div><span class="muted">類別：</span><span id="mCat">—</span></div>
          <div><span class="muted">客戶 PO：</span><span id="mPO">—</span></div>
          <div><span class="muted">備註：</span><span id="mMemo">—</span></div>
          <div><span class="muted">表單-日期-ID：</span><span id="mDoc" class="mono">—</span></div>
          <div><span class="muted">簽名：</span><span id="mOp">出貨（扣）</span></div>
        </div>
      </div>
      <div id="mList"></div>
      <div class="row" style="justify-content:flex-end;margin-top:12px">
        <button class="btn" id="mCancel">取消</button>
        <button class="btn primary" id="mOk">確定送出</button>
      </div>
    </div>
  </div>
</div>

<script>
/* ========= Config (hard-coded CSV sources) ========= */
const URLS = {
  products: "https://raw.githubusercontent.com/ceo-peng/pm-tools/refs/heads/main/data/products.csv",
  customers: "https://raw.githubusercontent.com/ceo-peng/pm-tools/refs/heads/main/data/customers.csv",
  bundles: "https://raw.githubusercontent.com/ceo-peng/pm-tools/refs/heads/main/data/bundle_items.csv",
  gifts:     "https://raw.githubusercontent.com/ceo-peng/pm-tools/refs/heads/main/data/gifts.csv",
  nonsales:  "https://raw.githubusercontent.com/ceo-peng/pm-tools/refs/heads/main/data/non_sales_application.csv",
  webhook:   "https://hook.us2.make.com/nbjdxrfypgoosj4qqxnzfmj9o29jq3c2"
};

/* ========= State ========= */
let PRODUCTS=[];          // [{A,B,C,id=C}]
let CUSTOMERS=[];         // [{id,name}]
let NONSALES=[];          // [{id,name}]
let BUNDLES=[];           // [{id,name,items:[{productId,qty}]}]
let GIFTS=[];             // same as bundles

// selection
const bundleCount = {};   // bundleId -> qty
const giftChecked = {};   // giftId -> true/false
let singleSel = {A:"",B:"",C:"",qty:1};

// preview aggregated lines (before commit to final)
let previewLines = [];    // [{productId, name, qty}]

// final table items (planned & picked)
let finalItems = {};      // productId -> {name, planned, picked}

/* ========= Utils ========= */
const $ = sel => document.querySelector(sel);
const el = (tag,attrs={},children=[])=>{
  const n=document.createElement(tag);
  Object.entries(attrs).forEach(([k,v])=>{
    if(k==="class") n.className=v;
    else if(k==="text") n.textContent=v;
    else if(k==="html") n.innerHTML=v;
    else n.setAttribute(k,v);
  });
  children.forEach(c=>n.appendChild(c));
  return n;
};

const parseLines = (csv)=> csv.split(/\r?\n/).map(s=>s.trim()).filter(Boolean);
const parseProducts = (csv)=> parseLines(csv).map(line=>{
  const [A,B,C]=line.split(",").map(s=>s.trim());
  return (C?{A,B,C,id:C}:null);
}).filter(Boolean);

const parsePairs = (csv)=> parseLines(csv).map(line=>{
  const [id,name]=line.split(",").map(s=>s.trim());
  return (id&&name)?{id,name}:null;
}).filter(Boolean);

const parseBundles = (csv)=> {
  const lines=parseLines(csv); const m={};
  lines.forEach(line=>{
    const [bid,bname,pid,qtyRaw,active]=line.split(",").map(s=>s.trim());
    if(!bid||!bname||!pid) return;
    if(active==="0") return;
    const qty=parseInt(qtyRaw||"1",10)||1;
    (m[bid] ||= {id:bid,name:bname,items:[]}).items.push({productId:pid,qty});
  });
  return Object.values(m);
};

const nowId = (prefix)=>{
  const d=new Date(),pad=n=>String(n).padStart(2,"0");
  return `${prefix}-${d.getFullYear()}${pad(d.getMonth()+1)}${pad(d.getDate())}-${pad(d.getHours())}${pad(d.getMinutes())}`;
};

/* ========= Renderers ========= */
function renderDocId(){
  const mode = document.querySelector('input[name="mode"]:checked').value;
  const cat = mode==="sales" ? $("#customerSelect").value || "待選" : $("#nonSalesSelect").value || "未選";
  $("#docId").textContent = nowId(cat);
  // summary mirror
  $("#sumCat").textContent = cat || "—";
  $("#sumPO").textContent = $("#poInput").value || "—";
  $("#sumMemo").textContent = $("#memoInput").value || "—";
  $("#sumDoc").textContent = $("#docId").textContent;
}

function renderBundleGrid(){
  const host=$("#bundleGrid"); host.innerHTML="";
  BUNDLES.forEach((b,i)=>{
    const card=el("div",{class:"card"});
    const top=el("div",{class:"item-row"},[
      el("div",{class:"name",text:`${i+1}. ${b.name}`})
    ]);
    const st=el("div",{class:"stepper right"},[
      el("button",{text:"−"}),
      el("input",{value: bundleCount[b.id]||0,inputmode:"numeric"}),
      el("button",{text:"+"})
    ]);
    top.appendChild(st); card.appendChild(top); host.appendChild(card);
    const inp=st.querySelector("input");
    st.children[0].onclick=()=>{ const v=Math.max(0,(+inp.value||0)-1); inp.value=v; bundleCount[b.id]=v; };
    st.children[2].onclick=()=>{ const v=(+inp.value||0)+1; inp.value=v; bundleCount[b.id]=v; };
    inp.oninput=()=>{ const n=parseInt(inp.value.replace(/[^0-9]/g,''),10); inp.value=Number.isFinite(n)?n:0; bundleCount[b.id]=+inp.value; };
  });
}

function renderGiftGrid(){
  const host=$("#giftGrid"); host.innerHTML="";
  GIFTS.forEach((g,i)=>{
    const card=el("label",{class:"card item-row"});
    const left=el("div",{class:"name",text:`${i+1}. ${g.name}`});
    const ck=el("input",{type:"checkbox"});
    ck.checked=!!giftChecked[g.id];
    ck.onchange=()=>giftChecked[g.id]=ck.checked;
    card.appendChild(left); card.appendChild(ck); host.appendChild(card);
  });
}

function buildSingleSelectors(){
  // A
  const aSel=$("#catA"), bSel=$("#catB"), cSel=$("#catC");
  const A=[...new Set(PRODUCTS.map(p=>p.A))].filter(Boolean);
  aSel.innerHTML=A.map(a=>`<option value="${a}">${a}</option>`).join("");
  singleSel.A=A[0]||"";
  onAchange();

  aSel.onchange=()=>{ singleSel.A=aSel.value; onAchange(); };
  bSel.onchange=()=>{ singleSel.B=bSel.value; onBchange(); };
  cSel.onchange=()=>{ singleSel.C=cSel.value; };
}

function onAchange(){
  const bSel=$("#catB"), cSel=$("#catC");
  const listB=[...new Set(PRODUCTS.filter(p=>p.A===singleSel.A).map(p=>p.B))].filter(Boolean);
  bSel.innerHTML=listB.map(b=>`<option value="${b}">${b}</option>`).join("");
  singleSel.B=listB[0]||"";
  onBchange();
}

function onBchange(){
  const cSel=$("#catC");
  const listC=PRODUCTS.filter(p=>p.A===singleSel.A && p.B===singleSel.B).map(p=>p.C);
  cSel.innerHTML=listC.map(c=>`<option value="${c}">${c}</option>`).join("");
  singleSel.C=listC[0]||"";
}

function renderPreview(){
  const list=$("#previewList"); list.innerHTML="";
  $("#emptyPreview").style.display = previewLines.length? "none":"block";
  previewLines.forEach(it=>{
    const row=el("div",{class:"row-item"},[
      el("div",{class:"name",text:`${it.name}`}),
      el("div",{class:"muted",text:`× ${it.qty}`})
    ]);
    list.appendChild(row);
  });
}

function renderFinal(){
  const host=$("#finalRows"); host.innerHTML="";
  const keys=Object.keys(finalItems);
  $("#finalEmpty").style.display = keys.length? "none":"block";
  keys.forEach(id=>{
    const it=finalItems[id];
    const row=el("div",{class:"tr"});
    // picked
    const stPicked=el("div",{class:"stepper"},[
      el("button",{text:"−"}),
      el("input",{value: it.picked||0,inputmode:"numeric"}),
      el("button",{text:"+"})
    ]);
    row.appendChild(stPicked);
    // name
    row.appendChild(el("div",{class:"title",text:it.name}));
    // planned
    const stPlan=el("div",{class:"stepper"},[
      el("button",{text:"−"}),
      el("input",{value: it.planned||0,inputmode:"numeric"}),
      el("button",{text:"+"})
    ]);
    row.appendChild(stPlan);
    // delete
    const del=el("button",{class:"btn small danger",text:"✕"});
    row.appendChild(del);

    const pI=stPicked.querySelector("input"), plI=stPlan.querySelector("input");
    stPicked.children[0].onclick=()=>{ const v=Math.max(0,(+pI.value||0)-1); pI.value=v; it.picked=v; };
    stPicked.children[2].onclick=()=>{ const v=(+pI.value||0)+1; pI.value=v; it.picked=v; };
    pI.oninput=()=>{ const n=parseInt(pI.value.replace(/[^0-9]/g,''),10); pI.value=Number.isFinite(n)?n:0; it.picked=+pI.value; };

    stPlan.children[0].onclick=()=>{ const v=Math.max(0,(+plI.value||0)-1); plI.value=v; it.planned=v; };
    stPlan.children[2].onclick=()=>{ const v=(+plI.value||0)+1; plI.value=v; it.planned=v; };
    plI.oninput=()=>{ const n=parseInt(plI.value.replace(/[^0-9]/g,''),10); plI.value=Number.isFinite(n)?n:0; it.planned=+plI.value; };

    del.onclick=()=>{ delete finalItems[id]; renderFinal(); };
    host.appendChild(row);
  });
}

/* ========= Behaviors ========= */
function rebuildDocIdOnChange(){
  ["mode","customerSelect","nonSalesSelect","poInput","memoInput"].forEach(id=>{
    (id==="mode" ? document.querySelectorAll('input[name="mode"]') : [$("#"+id)]).forEach(n=>{
      n.addEventListener("change",renderDocId);
      n.addEventListener("input",renderDocId);
    });
  });
}

function updateModeVisibility(){
  const mode = document.querySelector('input[name="mode"]:checked').value;
  $("#customerWrap").style.display = (mode==="sales") ? "" : "none";
  $("#nonSalesWrap").style.display = (mode==="non_sales") ? "" : "none";
  renderDocId();
}

function collectFromSelectionsIntoPreview(){
  previewLines.length=0;

  // bundles
  BUNDLES.forEach(b=>{
    const cnt = bundleCount[b.id]||0;
    if(!cnt) return;
    // expand items
    b.items.forEach(it=>{
      const prod = PRODUCTS.find(p=>p.id===it.productId);
      if(!prod) return;
      pushPreview(prod.id, prod.id, it.qty*cnt);
    });
  });

  // single
  // (no-op here; single is added by button)

  // gifts
  GIFTS.forEach(g=>{
    if(!giftChecked[g.id]) return;
    g.items.forEach(it=>{
      const prod = PRODUCTS.find(p=>p.id===it.productId);
      if(!prod) return;
      pushPreview(prod.id, prod.id, it.qty);
    });
  });

  renderPreview();
}

function pushPreview(id,name,qty){
  const ex=previewLines.find(x=>x.productId===id);
  if(ex) ex.qty += qty;
  else previewLines.push({productId:id,name:id,qty});
}

function commitPreviewToFinal(){
  previewLines.forEach(it=>{
    if(!finalItems[it.productId]) finalItems[it.productId]={name:it.name,planned:0,picked:0};
    finalItems[it.productId].planned += it.qty;
  });
  // clear preview (but keep selections for reference，如你所述)
  previewLines.length=0;
  renderPreview();
  renderFinal();
}

function addSingle(){
  const qty = Math.max(0, parseInt($("#sQty").value,10)||0);
  if(!singleSel.C || !qty) return;
  pushPreview(singleSel.C, singleSel.C, qty);
  renderPreview();
}

/* ========= Modal & Submit ========= */
const modal = $("#confirmModal");
function openModal(){
  // prepare list from finalItems & op
  const op = document.querySelector('input[name="op"]:checked').value; // out/in
  const sign = op==="out" ? -1 : +1;

  $("#mCat").textContent = $("#sumCat").textContent;
  $("#mPO").textContent = $("#sumPO").textContent;
  $("#mMemo").textContent = $("#sumMemo").textContent;
  $("#mDoc").textContent = $("#sumDoc").textContent;
  $("#mOp").textContent  = op==="out" ? "出貨（扣）" : "進貨（入）";

  const host=$("#mList"); host.innerHTML="";
  const keys=Object.keys(finalItems);
  if(!keys.length){ host.innerHTML='<div class="hint">（沒有要送出的項目）</div>'; }
  keys.forEach(id=>{
    const it=finalItems[id];
    const delta=(it.picked||0)*sign;
    const row=el("div",{class:"row",style:"justify-content:space-between;border:1px solid var(--line);border-radius:10px;padding:8px 10px;margin-bottom:8px"},[
      el("div",{class:"name",text:it.name}),
      el("div",{class:"mono",text:`Δ ${delta}`})
    ]);
    host.appendChild(row);
  });

  modal.classList.add("open");
}
function closeModal(){ modal.classList.remove("open"); }

async function doSubmit(){
  const op = document.querySelector('input[name="op"]:checked').value;
  const sign = op==="out" ? -1 : +1;

  const mode = document.querySelector('input[name="mode"]:checked').value;
  const category = (mode==="sales" ? $("#customerSelect").value : $("#nonSalesSelect").value) || "";

  const payload = {
    category,
    po: $("#poInput").value || "",
    memo: $("#memoInput").value || "",
    formDateId: $("#docId").textContent || "",
    items: Object.keys(finalItems).map(id=>{
      const it=finalItems[id];
      return { productId:id, delta:(it.picked||0)*sign };
    }).filter(x=>x.delta!==0)
  };

  try{
    await fetch(URLS.webhook,{
      method:"POST",
      headers:{ "Content-Type":"application/json" },
      body: JSON.stringify(payload)
    });
    alert("已送出！");
    closeModal();
  }catch(e){
    alert("送出失敗，請稍後再試。");
    console.error(e);
  }
}

/* ========= Data Loading ========= */
async function loadAll(){
  const [p,c,b,g,n]=await Promise.all([
    fetch(URLS.products).then(r=>r.text()),
    fetch(URLS.customers).then(r=>r.text()),
    fetch(URLS.bundles).then(r=>r.text()),
    fetch(URLS.gifts).then(r=>r.text()),
    fetch(URLS.nonsales).then(r=>r.text())
  ]);
  PRODUCTS=parseProducts(p);
  CUSTOMERS=parsePairs(c);
  BUNDLES=parseBundles(b);
  GIFTS=parseBundles(g);
  NONSALES=parsePairs(n);

  // fill customer & non-sales dropdowns
  $("#customerSelect").innerHTML = `<option value="">— 選擇訂單類別 —</option>` + CUSTOMERS.map(x=>`<option value="${x.name}">${x.name}</option>`).join("");
  $("#nonSalesSelect").innerHTML = `<option value="">— 選擇訂單類別 —</option>` + NONSALES.map(x=>`<option value="${x.name}">${x.name}</option>`).join("");

  renderBundleGrid();
  renderGiftGrid();
  buildSingleSelectors();
  collectFromSelectionsIntoPreview();
  renderDocId();
}

/* ========= Event wiring ========= */
document.addEventListener("DOMContentLoaded", async ()=>{
  await loadAll();

  // Mode toggle
  document.querySelectorAll('input[name="mode"]').forEach(r=>r.addEventListener("change", updateModeVisibility));
  updateModeVisibility();
  rebuildDocIdOnChange();

  // singles stepper
  $("#sDec").onclick=()=>{ const v=Math.max(1,(+$("#sQty").value||1)-1); $("#sQty").value=v; };
  $("#sInc").onclick=()=>{ const v=(+$("#sQty").value||1)+1; $("#sQty").value=v; };
  $("#addSingle").onclick=addSingle;

  // preview
  $("#togglePreview").onclick=()=>{
    const bd=$("#previewBody");
    const isOpen = bd.style.display!=="none";
    bd.style.display=isOpen?"none":"block";
    $("#togglePreview").textContent = isOpen ? "展開" : "收";
  };
  $("#clearPreview").onclick=()=>{ previewLines.length=0; renderPreview(); };
  $("#commitPreview").onclick=()=>{
    commitPreviewToFinal();
    // mirror summary
    renderDocId();
  };

  // final actions
  $("#fillPicked").onclick=()=>{
    Object.values(finalItems).forEach(it=>it.picked = it.planned);
    renderFinal();
  };
  $("#clearFinal").onclick=()=>{ finalItems={}; renderFinal(); };
  $("#submitAll").onclick=()=>{
    // open modal for confirm
    openModal();
  };

  // modal
  $("#mCancel").onclick=closeModal;
  $("#mOk").onclick=doSubmit;

  // reset all
  $("#resetBtn").onclick=async ()=>{
    // wipe states
    Object.keys(bundleCount).forEach(k=>delete bundleCount[k]);
    Object.keys(giftChecked).forEach(k=>delete giftChecked[k]);
    previewLines.length=0; finalItems={};
    $("#poInput").value=""; $("#memoInput").value="";
    document.querySelector('input[name="mode"][value="sales"]').checked=true;
    await loadAll();
    renderFinal();
  };

  // reflect summary on inputs change
  ["poInput","memoInput","customerSelect","nonSalesSelect"].forEach(id=>{
    $("#"+id).addEventListener("input",renderDocId);
    $("#"+id).addEventListener("change",renderDocId);
  });

  // keep preview synced with selections
  setInterval(collectFromSelectionsIntoPreview, 400);
});
</script>
</body>
</html>
