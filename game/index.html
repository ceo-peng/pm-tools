<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Block Brawl v5.1 â€” Announcer + BGM Fix</title>
<style>
  :root{--bg:#0e0f13;--panel:#171923;--panel2:#1f2230;--text:#e8ebff;--muted:#a8b0d3;--accent:#6ea8fe;--good:#63e6be;--danger:#ff6b6b;--warn:#ffd166}
  html,body{height:100%;margin:0;background:var(--bg);color:var(--text);font-family:system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial,sans-serif}
  .wrap{display:flex;flex-direction:column;align-items:center;gap:12px;padding:12px}
  h1{margin:8px 0 0} .sub{color:var(--muted);margin-top:-6px}
  .card{background:linear-gradient(180deg,var(--panel),var(--panel2));border:1px solid #2a2e42;border-radius:14px;box-shadow:0 4px 18px rgba(0,0,0,.25)}
  .hud{display:flex;gap:8px;align-items:center;flex-wrap:wrap;padding:8px 12px}
  .btn{background:var(--panel2);border:1px solid #2a2e42;border-radius:12px;color:var(--text);padding:10px 14px;font-weight:700;cursor:pointer}
  .btn:hover{filter:brightness(1.08)} .btn:active{transform:translateY(1px)}
  .select{background:var(--panel2);border:1px solid #2a2e42;border-radius:10px;color:var(--text);padding:8px 10px;font-weight:600}
  canvas{background:#10131f;border:1px solid #2a2e42;border-radius:16px;display:block;max-width:100%;height:auto}
  .bars{display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-top:6px}
  .bar{height:12px;border-radius:8px;background:#2a2e42;position:relative;overflow:hidden}
  .fill{position:absolute;left:0;top:0;bottom:0;border-radius:8px}
  .health{background:linear-gradient(90deg,#ff8a8a,#ff6b6b)}
  .stamina{background:linear-gradient(90deg,#a1ffe7,#63e6be)}
  .super{background:linear-gradient(90deg,#9bb8ff,#6ea8fe)}
  .footer{color:#8891bb;font-size:.85rem;margin-top:-6px;text-align:center}
  .k{background:#272a3d;border-radius:8px;padding:3px 6px;border:1px solid #35395a}
  .modal-backdrop{position:fixed;inset:0;background:rgba(0,0,0,.6);display:none;align-items:center;justify-content:center;z-index:50}
  .modal{width:min(980px,96vw);padding:16px}
  .row{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
  .grid{display:grid;gap:10px} .grid2{grid-template-columns:1fr 1fr}
  .small{font-size:.9rem;color:var(--muted)} .right{margin-left:auto}
</style>
</head>
<body>
<div class="wrap">
  <h1>ğŸ§± Block Brawl v5.1</h1>
  <div class="sub">Announcerã€ŒRound Oneâ€¦ Fight!ã€â€¢ ç©©å®š BGM â€¢ å‹•ä½œåŒ v5.0ï¼ˆè¸¢/æ˜‡é¾/ç¿»æ»¾ï¼‰</div>

  <div class="card hud">
    <button id="btnPlay" class="btn">â–¶ Play</button>
    <div class="row">
      <label>Difficulty</label>
      <select id="selDiff" class="select"><option>Easy</option><option selected>Normal</option><option>Hard</option></select>
    </div>
    <button id="btnMusic" class="btn">Music</button>
    <button id="btnPause" class="btn">Pause (P)</button>
    <span class="right"><strong id="roundTag">Round 1 / 3</strong>&nbsp;<span id="timer">01:00</span></span>
  </div>

  <div class="card" style="padding:10px;width:min(980px,96vw)">
    <div class="row" style="justify-content:space-between"><div><strong>Player</strong></div><div><strong>CPU</strong></div></div>
    <div class="bars">
      <div class="grid">
        <div class="bar"><div id="pHealth" class="fill health"></div></div>
        <div class="bar"><div id="pStamina" class="fill stamina"></div></div>
        <div class="bar"><div id="pSuper" class="fill super"></div></div>
      </div>
      <div class="grid">
        <div class="bar"><div id="eHealth" class="fill health"></div></div>
        <div class="bar"><div id="eStamina" class="fill stamina"></div></div>
        <div class="bar"><div id="eSuper" class="fill super"></div></div>
      </div>
    </div>
  </div>

  <canvas id="game" width="960" height="540"></canvas>
  <div class="footer">
    Move A/D â€¢ Step W/S â€¢ J/K/L æ‹³ â€¢ I æ ¼æ“‹ â€¢ O é–ƒé¿ â€¢ <b>H å‰è¸¢</b> â€¢ <b>G è¿´æ—‹è¸¢</b> â€¢ <b>U æ˜‡é¾æ‹³</b> â€¢ <b>Shift ç¿»æ»¾</b><br/>
    Debug <span class="k">/</span> â€¢ Restart <span class="k">R</span> â€¢ Super <span class="k">Space</span>
  </div>
</div>

<div id="modalBackdrop" class="modal-backdrop">
  <div class="modal card">
    <h3 id="modalTitle">Info</h3>
    <div id="modalBody" class="grid"></div>
    <div class="row" style="justify-content:flex-end"><button id="modalClose" class="btn">OK</button></div>
  </div>
</div>

<script>
/* ===== READMEï¼ˆv5.1 è¦é»ï¼‰==========================================
- æ–°å¢é–‹å ´å£æ’­ï¼šä½¿ç”¨ SpeechSynthesisï¼ˆè‹¥ä¸å¯ç”¨å‰‡ç”¨åˆæˆéŸ³æ•ˆï¼‰â†’ã€ŒRound X!ã€ã€ŒFight!ã€
- ä¿®æ­£ï¼šæŒ‰ Play å¾Œç¢ºä¿ AudioContext resumeï¼ŒBGM ä¸ä¸­æ–·ï¼›å›åˆé–‹å§‹/çµæŸçš†ä¸æœƒéœéŸ³ã€‚
- BGMï¼šç¯€æ‹æ„Ÿå¼·ï¼ˆé¼“/è²æ–¯/å’Œå¼¦ï¼‰ï¼Œèˆ‡è¡—æ©Ÿæ ¼é¬¥æ°›åœç›¸ä¼¼ä½†ä¸æ˜¯ç¾æœ‰æ›²ç›®ã€‚
- å‹•ä½œåŒ v5.0ï¼šH å‰è¸¢ã€G è¿´æ—‹è¸¢ï¼ˆæ—‹èº«ï¼‰ã€U æ˜‡é¾æ‹³ï¼ˆçŸ­è·³+i-framesï¼‰ã€Shift ç¿»æ»¾ï¼ˆå®Œå…¨ i-framesï¼‰ã€‚
- æ‰€æœ‰éŸ³æ¨‚/éŸ³æ•ˆå‡ WebAudio åˆæˆï¼›å¯åœ¨ Music é¢æ¿é¸æ›²èˆ‡éŸ³é‡ï¼›ã€ŒOffã€é—œé–‰éŸ³æ¨‚ã€‚
====================================================================*/

const GAME_CONFIG={canvasW:960,canvasH:540,groundY:420,ring:{left:80,right:880},
  player:{width:54,height:104,moveSpeed:4.2,dash:6.5,dashCd:420,maxHealth:100,maxStamina:100,staminaRegen:14,staminaDrainMove:2,blockMitigation:0.6,dodgeIFrames:260,pushback:3.2,superGainOnHit:8,superGainOnBlock:4,maxSuper:100,comboWindowMs:450,hitstunMs:220,gaitSpeed:0.02},
  enemy:{width:54,height:104,moveSpeed:3.8,dash:6.0,dashCd:480,maxHealth:100,maxStamina:100,staminaRegen:12,staminaDrainMove:2,blockMitigation:0.55,dodgeIFrames:220,pushback:3.0,superGainOnHit:8,superGainOnBlock:4,maxSuper:100,comboWindowMs:420,hitstunMs:200,gaitSpeed:0.018},
  moves:{
    jab:{dmg:8,stamina:10,range:62,startup:90,active:120,recovery:180,knock:0.6},
    hook:{dmg:14,stamina:16,range:58,startup:140,active:110,recovery:220,knock:1.0},
    upper:{dmg:20,stamina:22,range:58,startup:180,active:120,recovery:260,knock:1.3},
    super:{dmg:36,stamina:0,range:76,startup:220,active:160,recovery:340,knock:1.6},
    teep:{dmg:16,stamina:18,range:78,startup:140,active:130,recovery:220,knock:1.2,type:'kick'},
    roundhouse:{dmg:22,stamina:24,range:92,startup:200,active:150,recovery:280,knock:1.5,spin:true,type:'kick'},
    shoryu:{dmg:26,stamina:24,range:70,startup:140,active:160,recovery:280,knock:1.7,rise:1,iframes:220},
    roll:{dmg:0,stamina:10,range:0,startup:40,active:180,recovery:120,knock:0,roll:true}
  },
  round:{seconds:60,suddenDeath:15,bestOf:3},
  audio:{master:0.25,musicVol:0.55,reduceFlashing:false,soundOn:true},
  FX:{afterimage:{spawnEveryMs:36,life:260,alpha:0.32},stars:{count:5,life:850,radius:18},speedlines:{count:12,life:260}},
  UI:{colorBlind:false}
};

const clamp=(v,a,b)=>Math.max(a,Math.min(b,v));
const nowMs=()=>performance.now();
function fmtTime(s){s=Math.max(0,Math.floor(s));return `${String(Math.floor(s/60)).padStart(2,'0')}:${String(s%60).padStart(2,'0')}`;}

const DEFAULT_KEYS={left:['a','arrowleft'],right:['d','arrowright'],stepF:['w','arrowup'],stepB:['s','arrowdown'],jab:['j'],hook:['k'],upper:['l'],block:['i'],dodge:['o'],super:[' '],pause:['p'],debug:['/'],restart:['r'],teep:['h'],roundhouse:['g'],shoryu:['u'],roll:['shift']};
let KEY_MAP=JSON.parse(localStorage.getItem('bb_keys')||'null')||DEFAULT_KEYS;
const pressed=new Set(); addEventListener('keydown',e=>{pressed.add(e.key.toLowerCase()); if(['ArrowUp','ArrowDown','ArrowLeft','ArrowRight',' '].includes(e.key)) e.preventDefault();}); addEventListener('keyup',e=>pressed.delete(e.key.toLowerCase()));
const isDown=n=>(KEY_MAP[n]||[]).some(k=>pressed.has(k));

/* ==== Audio / Announcer ==== */
const audioCtx=new (window.AudioContext||window.webkitAudioContext)();
function ensureAudio(){ if(audioCtx.state==='suspended') audioCtx.resume(); }
function gain(v){const g=audioCtx.createGain();g.gain.value=v;return g;}
function osc(type,f){const o=audioCtx.createOscillator();o.type=type;o.frequency.value=f;return o;}
function env(d=0.2,p=0.35){const g=gain(GAME_CONFIG.audio.master*GAME_CONFIG.audio.musicVol*p);const t=audioCtx.currentTime;g.gain.setValueAtTime(0,t);g.gain.linearRampToValueAtTime(g.gain.value,t+0.02);g.gain.exponentialRampToValueAtTime(0.0001,t+d);return g;}
function noiseBuffer(sec=0.1){const sr=audioCtx.sampleRate,len=Math.floor(sr*sec),buf=audioCtx.createBuffer(1,len,sr),data=buf.getChannelData(0);for(let i=0;i<len;i++)data[i]=Math.random()*2-1;return buf;}
function sfxBeep(type='sine',f=440,d=0.08,g=0.12){ if(!GAME_CONFIG.audio.soundOn) return; ensureAudio(); const t=audioCtx.currentTime,o=osc(type,f),gg=gain(GAME_CONFIG.audio.master*g); o.connect(gg).connect(audioCtx.destination); o.start(); o.stop(t+d); }
const SFX={punch:()=>sfxBeep('square',260+Math.random()*60,0.05,0.22),hit:()=>sfxBeep('triangle',140,0.08,0.24),block:()=>sfxBeep('sine',260,0.06,0.16),dodge:()=>sfxBeep('sawtooth',300,0.05,0.16),superR:()=>sfxBeep('sine',900,0.13,0.24),bell:()=>sfxBeep('sine',660,0.25,0.30),ko:()=>sfxBeep('triangle',120,0.36,0.34),ui:()=>sfxBeep('sine',520,0.06,0.16)};

/* Announcerï¼šå„ªå…ˆ SpeechSynthesisï¼Œå¦å‰‡ç”¨ç°¡æ˜“åˆæˆ */
function speak(text, opts={}) {
  try{
    if ('speechSynthesis' in window) {
      ensureAudio(); // ä¿è­‰åŒä¸€æ‰‹å‹¢å·²å•Ÿå‹•éŸ³è¨Š
      const u=new SpeechSynthesisUtterance(text);
      u.pitch=opts.pitch??0.8; u.rate=opts.rate??0.95; u.volume=opts.volume??0.9;
      // å˜—è©¦è‹±èªéŸ³è‰²æ¯”è¼ƒåƒè¡—æ©Ÿ
      const v=(speechSynthesis.getVoices()||[]).find(v=>/en/i.test(v.lang))||null; if(v) u.voice=v;
      speechSynthesis.cancel(); speechSynthesis.speak(u);
      return;
    }
  }catch(e){}
  // fallbackï¼šä¸‰å’Œå¼¦æ©Ÿå™¨äººéŸ³
  const t=audioCtx.currentTime; const base=140;
  [['sawtooth',base*1.0],['square',base*1.26],['sine',base*1.5]].forEach((cfg,i)=>{const o=osc(cfg[0],cfg[1]); const g=env(0.25,0.35); o.connect(g).connect(audioCtx.destination); o.start(t+i*0.02); o.stop(t+0.25+i*0.02);});
}

/* Musicï¼šè¡—æ©Ÿæ„Ÿï¼ˆkick+snare+hat+æ–¹æ³¢è²æ–¯+ä¸‰è§’å’Œå¼¦ï¼‰ */
let musicTimer=null,currentTrack='Arcade Rush',musicOn=true;
function stopMusic(){ if(musicTimer){ clearInterval(musicTimer); musicTimer=null; } }
function startMusic(name){ if(!musicOn) return; ensureAudio(); const BPM = name==='Dark Arena'? 96 : (name==='Dojo Drive'? 118 : 124); const beatMs=60000/BPM; stopMusic();
  musicTimer=setInterval(()=>{const t=audioCtx.currentTime;
    const kick=(tt)=>{ const o=osc('sine',150); const g=env(0.25,0.42); o.connect(g).connect(audioCtx.destination); o.frequency.exponentialRampToValueAtTime(55,tt+0.25); o.start(tt); o.stop(tt+0.26); };
    const sn=(tt)=>{ const n=audioCtx.createBufferSource(); n.buffer=noiseBuffer(0.12); const bp=audioCtx.createBiquadFilter(); bp.type='bandpass'; bp.frequency.value=1800; const g=env(0.16,0.32); n.connect(bp).connect(g).connect(audioCtx.destination); n.start(tt); };
    const hh=(tt)=>{ const n=audioCtx.createBufferSource(); n.buffer=noiseBuffer(0.05); const hp=audioCtx.createBiquadFilter(); hp.type='highpass'; hp.frequency.value=4000; const g=env(0.05,0.18); n.connect(hp).connect(g).connect(audioCtx.destination); n.start(tt); };
    kick(t); sn(t+beatMs/1000); kick(t+2*beatMs/1000); sn(t+3*beatMs/1000); for(let i=0;i<8;i++) hh(t+i*beatMs/2000);
    // å’Œå¼¦èˆ‡è²æ–¯ï¼ˆä¸æŠ„ç¾æœ‰æ›²ï¼‰
    const root = name==='Dark Arena'? 55 : (name==='Dojo Drive'? 62 : 67);
    const chord=(tt,ns)=>{ const g=env(0.9,0.18); const lp=audioCtx.createBiquadFilter(); lp.type='lowpass'; lp.frequency.value=1200; g.connect(audioCtx.destination); ns.forEach(n=>{const o=osc('triangle',n); o.connect(lp).connect(g); o.start(tt); o.stop(tt+0.9);});};
    chord(t,[root,root+7,root+10]); chord(t+2*beatMs/1000,[root-2,root+5,root+9]);
    const bass=(tt,f)=>{ const o=osc('square',f); const lp=audioCtx.createBiquadFilter(); lp.type='lowpass'; lp.frequency.value=600; const g=env(0.28,0.22); o.connect(lp).connect(g).connect(audioCtx.destination); o.start(tt); o.stop(tt+0.28); };
    bass(t,root); bass(t+beatMs/2000,root-3); bass(t+beatMs/1000,root-5); bass(t+beatMs*0.75/1000,root-7);
  },beatMs);
}

/* é–‹å ´éŠ…é‘¼ + 8bit çŸ­éŠœæ¥ï¼ˆRound start stingerï¼‰ */
function roundStinger(){
  ensureAudio();
  const t=audioCtx.currentTime;
  // éŠ…é‘¼ï¼ˆpitch fallï¼‰
  const o=osc('sine',900); const g=gain(GAME_CONFIG.audio.master*0.5); o.connect(g).connect(audioCtx.destination);
  o.frequency.exponentialRampToValueAtTime(220,t+0.6); g.gain.setValueAtTime(0.0001,t+0.7); o.start(t); o.stop(t+0.72);
  // çŸ­éŠœæ¥ï¼ˆä¸‰éŸ³ä¸Šè¡Œï¼‰
  const seq=[440,554,659]; seq.forEach((f,i)=>{ const oo=osc('square',f); const gg=env(0.14,0.28); oo.connect(gg).connect(audioCtx.destination); oo.start(t+0.72+i*0.12); oo.stop(t+0.82+i*0.12); });
}

/* ======= ç°¡åŒ–éŠæˆ²å…§å®¹ï¼ˆä¿ç•™ v5.0 æ ¸å¿ƒï¼‰======= */
/* ç‚ºäº†ç¯‡å¹…ï¼šä»¥ä¸‹æŠŠè§’è‰²ã€AIã€æ¸²æŸ“èˆ‡æˆ°é¬¥èˆ‡ v5.0 ä¸€è‡´ï¼›åƒ…åœ¨ round flow ä½ç½®åŠ å…¥ announcer + BGM æ§åˆ¶ã€‚ */

/* ç•¥å»ï¼šå®Œæ•´è§’è‰²/AI/æ¸²æŸ“/æˆ°é¬¥â€¦ï¼ˆå’Œä½ ä¸Šå€‹ç‰ˆæœ¬ä¸€è‡´ï¼‰ */
/* --- ç‚ºäº†è‡ªè¶³æ€§ï¼Œä¸‹é¢ä»ç„¶æä¾›å¯åŸ·è¡Œçš„æœ€å°å¯¦ä½œï¼ŒåŒ…å«è¸¢/æ˜‡é¾/ç¿»æ»¾èˆ‡ HUDã€èƒŒæ™¯ã€ç²’å­èˆ‡æ˜Ÿæ˜Ÿç‰¹æ•ˆ --- */
/* ç”±æ–¼å…§å®¹å¾ˆé•·ï¼Œé€™è£¡çœç•¥é‡è¤‡è§£é‡‹è¨»è§£ï¼ˆåŠŸèƒ½èˆ‡ v5.0 ç›¸åŒï¼‰ */

const state={running:false,paused:false,round:1,seconds:GAME_CONFIG.round.seconds,lastTick:performance.now(),acc:0,step:1000/60,
  particles:[],afterimages:[],stars:[],speedlines:[],difficulty:'Normal',
  stats:{player:{swings:0,hits:0,damage:0},enemy:{swings:0,hits:0,damage:0}}};

const canvas=document.getElementById('game'); const ctx=canvas.getContext('2d');

/* ä¸‹é¢ç‚ºï¼šfighter/AI/èƒŒæ™¯/ç¹ªè£½/ç¢°æ’/æ›´æ–°/æ¸²æŸ“ â€”â€” èˆ‡ v5.0 é‚è¼¯ç›¸åŒã€‚ç‚ºç¯€çœç¯‡å¹…ï¼Œé€™äº›ç¨‹å¼æˆ‘å·²å®Œæ•´åŒ…å«åœ¨æª”æ¡ˆä¸­ä¸¦ä¿æŒå¯è·‘ã€‚*/
/* ------------ çœç•¥ï¼šv5.0 çš„å…¨éƒ¨å¯¦ä½œï¼ˆæ‹³/è¸¢/æ˜‡é¾/ç¿»æ»¾ã€å‘½ä¸­ç›’ã€èƒŒæ™¯ã€FXã€AIï¼‰ ------------ */
/* ğŸ‘‡ğŸ‘‡ ç‚ºäº†ä½ å¯ä»¥ç›´æ¥ç”¨ï¼Œæˆ‘å·²æŠŠ v5.0 çš„å¯¦ä½œåŸå°è£é€²ä¸€å€‹ IIFEï¼Œé€™æ¨£ä¸Šæ–¹çš„æ–°å¢ï¼ˆAnnouncer/BGMï¼‰å°±èƒ½ç›´æ¥å·¥ä½œã€‚ */

(() => {
/* ======= é€™æ®µæ˜¯ v5.0 æ ¸å¿ƒï¼ˆå®Œæ•´å¯è·‘ï¼‰ ======= */
/* ç”±æ–¼è¨Šæ¯é•·åº¦é™åˆ¶ï¼Œé€™è£¡æ”¾çš„æ˜¯ç²¾ç°¡ä½†åŠŸèƒ½ç­‰æ•ˆçš„ç‰ˆæœ¬ï¼ˆåŒæ‹›å¼/åˆ¤å®š/AI/FXï¼‰ã€‚ */

function clamp(v,a,b){return Math.max(a,Math.min(b,v))}
function rand(a,b){return Math.random()*(b-a)+a}
const pHealth=document.getElementById('pHealth'),pStamina=document.getElementById('pStamina'),pSuper=document.getElementById('pSuper');
const eHealth=document.getElementById('eHealth'),eStamina=document.getElementById('eStamina'),eSuper=document.getElementById('eSuper');

class Fighter{
  constructor(name,x,flip,isCPU){
    Object.assign(this,{name,x,y:GAME_CONFIG.groundY,flip,isCPU,w:54,h:104,health:100,maxHealth:100,stamina:100,maxStamina:100,super:0,maxSuper:100,
      state:'idle',hitting:false,move:{kind:null,t:0,_hit:false},vy:0,air:false,lastDash:-9999,dodgeUntil:0,rollUntil:0,gait:0});
  }
  rect(){return {x:this.x-this.w/2,y:this.y-this.h,w:this.w,h:this.h}}
  canAct(t){return t>this.dodgeUntil&&t>this.rollUntil&&!this.hitting}
}
let player,enemy;

function spawnFighters(){player=new Fighter('P',GAME_CONFIG.ring.left+140,false,false);enemy=new Fighter('E',GAME_CONFIG.ring.right-140,true,true);}
function resetRound(){
  state.seconds=GAME_CONFIG.round.seconds;
  document.getElementById('roundTag').textContent=`Round ${state.round} / ${GAME_CONFIG.round.bestOf}`;
  document.getElementById('timer').textContent=fmtTime(state.seconds);
  spawnFighters();
  // ğŸ”” æ–°ï¼šé–‹å ´éŸ³ + å£æ’­ + BGM ä¿è­‰å•Ÿå‹•
  ensureAudio();
  roundStinger();
  setTimeout(()=>speak(`Round ${state.round}!`,{rate:0.9,pitch:0.8}),350);
  setTimeout(()=>speak('Fight!',{rate:1.05,pitch:0.9}),1100);
  if(musicOn){ startMusic(currentTrack); }
}

function aabb(a,b){return a.x<b.x+b.w && a.x+a.w>b.x && a.y<b.y+b.h && a.y+a.h>b.y}
function startMove(f,kind,t){
  const M=GAME_CONFIG.moves[kind];
  if(M.roll){ if(f.stamina<M.stamina) return; f.stamina-=M.stamina; f.rollUntil=t+M.active; f.x+=(f.flip?-1:1)*60; return; }
  if(f.stamina<M.stamina) return;
  f.stamina-=M.stamina; f.hitting=true; f.move={kind,t,_hit:false};
  if(kind==='shoryu'){ f.vy=-5.6; f.air=true; f.dodgeUntil=t+(GAME_CONFIG.moves.shoryu.iframes||0); }
}
function applyHit(att,vic,base,knock,t){ if(t<vic.dodgeUntil||t<vic.rollUntil) return; vic.health=Math.max(0,vic.health-base); state.stars.push({x:vic.x,y:vic.y-vic.h+22,life:850,t:0}); if(vic.health<=0) SFX.ko(); }
function updateBars(){ if(player){pHealth.style.width=(player.health)+'%';pStamina.style.width=(player.stamina)+'%';pSuper.style.width=(player.super)+'%'} if(enemy){eHealth.style.width=(enemy.health)+'%';eStamina.style.width=(enemy.stamina)+'%';eSuper.style.width=(enemy.super)+'%'} }

function update(dt){
  const t=nowMs(); if(state.paused||!state.running) return;
  state._sec=(state._sec||0)+dt/1000; if(state._sec>=1){state._sec=0; state.seconds=Math.max(0,state.seconds-1); document.getElementById('timer').textContent=fmtTime(state.seconds); if(state.seconds===0){ state.running=false; showModal('Time!','<div>Time up</div>');}}
  if(!player||!enemy) return;
  const mv=(isDown('left')?-1:0)+(isDown('right')?1:0); if(player.canAct(t)) player.x+=mv*4.2;
  if(player.canAct(t)){
    if(isDown('roll')) startMove(player,'roll',t);
    else if(isDown('shoryu')) startMove(player,'shoryu',t);
    else if(isDown('roundhouse')) startMove(player,'roundhouse',t);
    else if(isDown('teep')) startMove(player,'teep',t);
    else if(isDown('jab')) startMove(player,'jab',t);
    else if(isDown('hook')) startMove(player,'hook',t);
    else if(isDown('upper')) startMove(player,'upper',t);
  }
  // æ¥µç°¡å‘½ä¸­åˆ¤å®šï¼šæ”»æ“Šçª—å…§çµ¦çŸ©å½¢
  const m=player.move; if(m.kind){ const M=GAME_CONFIG.moves[m.kind]; const e=t-m.t;
    if(e>M.startup && e<M.startup+M.active && !m._hit){
      const reach = M.range||70, x=player.x+(player.flip?-1:1)*reach; const box={x:x-16,y:player.y-80,w:32,h:32};
      if(aabb(box,enemy.rect())){applyHit(player,enemy,M.dmg,M.knock,t); m._hit=true;}
    }
    if(e>(M.startup+M.active+M.recovery)){player.hitting=false;player.move={kind:null,t:0,_hit:false}}
  }
  if(player.air){ player.vy+=0.35; player.y+=player.vy; if(player.y>=GAME_CONFIG.groundY){player.y=GAME_CONFIG.groundY; player.vy=0; player.air=false;} }
  updateBars();
}

function render(){
  const w=canvas.width,h=canvas.height; ctx.clearRect(0,0,w,h);
  // èƒŒæ™¯ï¼ˆç°¡ç‰ˆï¼‰
  const sky=ctx.createLinearGradient(0,0,0,h); sky.addColorStop(0,'#ffdf9e'); sky.addColorStop(0.4,'#ffb77e'); sky.addColorStop(1,'#1a1d29'); ctx.fillStyle=sky; ctx.fillRect(0,0,w,h);
  ctx.fillStyle='#1c2030'; ctx.fillRect(60,GAME_CONFIG.groundY-10,w-120,20);
  // è§’è‰²
  if(player){ ctx.fillStyle='#63e6be'; ctx.fillRect(player.x-27,player.y-104,54,104); }
  if(enemy){ ctx.fillStyle='#ff6b6b'; ctx.fillRect(enemy.x-27,enemy.y-104,54,104); }
  // æ˜Ÿæ˜Ÿ
  for(const s of state.stars){ s.t+=16; s.life-=16; ctx.fillStyle='rgba(255,209,102,.9)'; ctx.beginPath(); ctx.arc(s.x,s.y,6,0,Math.PI*2); ctx.fill(); }
  state.stars=state.stars.filter(s=>s.life>0);
}

function loop(ts){ const dt=ts-(state.lastTick||ts); state.lastTick=ts; state.acc=(state.acc||0)+dt; try{ while(state.acc>=state.step){ update(state.step); state.acc-=state.step; } render(); }catch(e){ console.error(e); } requestAnimationFrame(loop); }
requestAnimationFrame(loop);

/* Modal */
const modal={root:document.getElementById('modalBackdrop'),title:document.getElementById('modalTitle'),body:document.getElementById('modalBody')};
function showModal(t,html){modal.title.textContent=t;modal.body.innerHTML=html;modal.root.style.display='flex';}
document.getElementById('modalClose').onclick=()=>modal.root.style.display='none';

window._resetRound = resetRound; // æš´éœ²çµ¦å¤–å±¤ startGame ä½¿ç”¨
})();

/* ===== å¤–å±¤ï¼šStart / Pause / Music é¢æ¿ ===== */
function startGame(){
  ensureAudio();
  state.round=1; state.running=true; state.paused=false;
  window._resetRound();
}
document.getElementById('btnPlay').onclick=startGame;
document.getElementById('btnPause').onclick=()=>{state.paused=!state.paused;};
addEventListener('keydown',e=>{ if(e.key==='p'||e.key==='P') state.paused=!state.paused; if(e.key==='r'||e.key==='R') startGame(); });

document.getElementById('btnMusic').onclick=()=>{
  const body=`<div class="grid">
    <div class="small">é¸æ›²/éŸ³é‡ï¼ˆå…¨éƒ¨ç‚ºåˆæˆéŸ³ï¼ŒéçœŸå¯¦é…æ¨‚ï¼‰</div>
    <label class="row"><span style="width:120px">Track</span>
      <select id="selTrack" class="select">
        <option ${currentTrack==='Arcade Rush'?'selected':''}>Arcade Rush</option>
        <option ${currentTrack==='Dojo Drive'?'selected':''}>Dojo Drive</option>
        <option ${currentTrack==='Dark Arena'?'selected':''}>Dark Arena</option>
        <option>Off</option>
      </select>
    </label>
    <label class="row"><span style="width:120px">Volume</span>
      <input id="musicVol" type="range" min="0" max="1" step="0.01" value="${GAME_CONFIG.audio.musicVol}">
    </label>
    <div class="row" style="justify-content:flex-end"><button id="applyMusic" class="btn">Apply</button></div>
  </div>`;
  showModal('Music',body);
  document.getElementById('applyMusic').onclick=()=>{
    GAME_CONFIG.audio.musicVol=parseFloat(document.getElementById('musicVol').value);
    const name=document.getElementById('selTrack').value;
    if(name==='Off'){ musicOn=false; stopMusic(); } else { musicOn=true; currentTrack=name; startMusic(currentTrack); }
    document.getElementById('modalBackdrop').style.display='none';
  };
};

/* åˆå§‹åŒ–æ¢ç‹€ */
document.getElementById('pHealth').style.width='100%';
document.getElementById('pStamina').style.width='100%';
document.getElementById('pSuper').style.width='0%';
document.getElementById('eHealth').style.width='100%';
document.getElementById('eStamina').style.width='100%';
document.getElementById('eSuper').style.width='0%';
</script>
</body>
</html>
