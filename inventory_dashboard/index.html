<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>PM Inventory Dashboard — TTQ (TPE/SC/MOMO)</title>
  <style>
    :root{ --bg:#0b0b0c; --card:#121214; --muted:#a7a7b3; --fg:#f5f5f7; --accent:#d4af37; --danger:#d9534f; --warn:#f0ad4e; }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0;background:linear-gradient(180deg,#0b0b0c,#0f0f12);color:var(--fg);font:14px/1.6 system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif}
    .wrap{max-width:1140px;margin:0 auto;padding:20px}
    header{display:flex;align-items:center;gap:12px;flex-wrap:wrap;margin-bottom:16px}
    h1{font-size:20px;font-weight:700;letter-spacing:.2px;margin:0}
    .sub{color:var(--muted);font-size:12px}

    .toolbar{display:flex;flex-wrap:wrap;gap:8px;margin:14px 0}
    .input, select, button, label.switch{background:#111114;border:1px solid #26262b;border-radius:10px;color:var(--fg);padding:8px 10px}
    .input{flex:1 1 260px;min-width:160px}
    select{flex:0 0 220px}
    button{cursor:pointer;font-weight:600}
    button:hover{background:#1f1f25}
    label.switch{display:flex;align-items:center;gap:6px;cursor:pointer;padding:6px 10px}
    label.switch input{accent-color:#caa94a}

    .table{overflow:auto;border-radius:14px;border:1px solid #232328}
    table{width:100%;border-collapse:separate;border-spacing:0;background:var(--card);table-layout:fixed}
    thead th{position:sticky;top:0;background:#16161a;z-index:2}
    th,td{padding:10px 12px;border-bottom:1px solid #1f1f24;text-align:left;vertical-align:top}
    tr:hover td{background:#141418}
    th.sortable{cursor:pointer}
    th.sortable:after{content:"⇅";opacity:.4;margin-left:6px;font-size:11px}

    /* Stats */
    .stats{display:grid;grid-template-columns:repeat(3,1fr);gap:8px;margin:10px 0}
    .stat{background:#111114;border:1px solid #24242a;border-radius:12px;padding:10px 12px;display:flex;flex-direction:column;gap:2px}
    .stat .label{color:var(--muted);font-size:11px;letter-spacing:.3px}
    .stat .value{font-size:16px;font-weight:800}

    .mono{font-variant-numeric:tabular-nums}
    .col-idx{width:44px}
    .col-qty{width:84px}
    .col-src{width:84px}
    .col-dte{width:76px}
    .col-dte.warn{color:var(--warn)}
    .col-dte.danger{color:var(--danger)}
    .product-name{font-weight:600}

    .footer{color:var(--muted);font-size:12px;margin-top:12px}
    .spinner{display:none}
    .spinner.show{display:inline-block;width:16px;height:16px;border-radius:50%;border:2px solid #333;border-top-color:var(--accent);animation:spin 1s linear infinite;vertical-align:middle}
    @keyframes spin{to{transform:rotate(360deg)}}

    details{background:#111114;border:1px solid #232328;border-radius:12px;padding:10px;margin:12px 0}
    details>summary{cursor:pointer;list-style:none}
    details>summary::-webkit-details-marker{display:none}
    .row{display:flex;flex-wrap:wrap;gap:8px;align-items:center}
    .row input[type="text"],.row input[type="number"],.row select{flex:1 1 220px}

    /* RWD tweaks */
    @media (max-width:760px){
      th,td{padding:8px 10px}
      .stats{grid-template-columns:repeat(2,1fr)}
      .product-name{font-size:13px;line-height:1.3}
      .col-qty,.col-dte{white-space:nowrap}
      /* 預設隱藏來源欄位（手機）；切換開關可展開 */
      body:not(.show-sources) th.col-src, body:not(.show-sources) td.col-src{display:none}
      .toolbar{gap:6px}
      .input, select, button{padding:6px 8px}
      .col-idx{width:36px}
      .col-qty{width:72px}
      .col-dte{width:64px}
    }
    @media (max-width:420px){
      body{font-size:13px}
      th,td{padding:6px 8px}
      .product-name{font-size:12.5px;line-height:1.25}
      .col-qty{width:64px}
      .col-dte{width:58px}
    }

    /* Default: hide source columns until toggled */
    body:not(.show-sources) th.col-src, body:not(.show-sources) td.col-src{display:none}
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <h1>PM Inventory Dashboard</h1>
      <span class="right spinner" id="spinner"></span>
    </header>

    <section class="card">
      <!-- Single, concise control bar -->
      <div class="toolbar">
        <input id="search" class="input" placeholder="搜尋 Item…" />
        <select id="rangeSel" class="input" style="max-width:220px">
          <option value="expired">已過期</option>
          <option value="30">≤ 30 天</option>
          <option value="60">≤ 60 天</option>
          <option value="90" selected>≤ 90 天</option>
          <option value="365+">≥ 365 天 (1y)</option>
          <option value="548+">≥ 548 天 (1.5y)</option>
          <option value="730+">≥ 730 天 (2y)</option>
          <option value="913+">≥ 913 天 (2.5y)</option>
          <option value="365-548">365–548 天 (1–1.5y)</option>
          <option value="365-730">365–730 天 (1–2y)</option>
          <option value="all">全部</option>
          <option value="custom">自訂區間…</option>
        </select>
        <label class="switch"><input type="checkbox" id="toggleSources"/> 顯示來源明細（三重/台北/MOMO）</label>
        <span class="sub">1y=365 · 1.5y=548 · 2y=730 · 2.5y=913</span>
      </div>
      <div id="customBar" class="row" style="display:none; margin:6px 0 4px">
        <input id="minDays" type="number" class="input" placeholder="最小天數（空=不限）" />
        <input id="maxDays" type="number" class="input" placeholder="最大天數（空=不限）" />
        <button id="applyCustom">套用自訂</button>
      </div>

      <div id="stats" class="stats">
        <div class="stat"><span class="label">SKU</span><span class="value" id="statSku">–</span></div>
        <div class="stat"><span class="label">Qty (TTQ)</span><span class="value" id="statQty">–</span></div>
        <div class="stat"><span class="label">最早到期</span><span class="value" id="statEarliest">–</span></div>
      </div>

      <div id="meta" class="sub" style="margin:2px 0 10px"></div>

      <div class="table"><table id="tbl">
        <thead>
          <tr>
            <th class="col-idx">#</th>
            <th class="sortable col-product" data-key="ProductName">Item</th>
            <th class="sortable col-qty" data-key="Quantity">TTQ</th>
            <th class="sortable col-src" data-key="Qty_TPE">台北</th>
            <th class="sortable col-src" data-key="Qty_SC">三重</th>
            <th class="sortable col-src" data-key="Qty_MOMO">MOMO</th>
            <th class="sortable col-dte" data-key="DaysToExpiry">DTE</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table></div>

      <div class="footer">Tips：搜尋、選區間、點標題排序；預設僅顯示 TTQ，勾選「顯示來源明細」後可看三重/台北/MOMO。</div>
    </section>

    <details>
      <summary class="sub">資料來源設定 & 測試（多來源彙總）</summary>
      <div class="sub" style="margin:6px 0 8px">請將三個清單（台北/三重/MOMO）各自「發佈到網路」。若某來源未提供，系統以 0 計。</div>

      <div class="row" style="margin:8px 0 6px">
        <strong class="sub">台北（TPE）</strong>
        <input id="gvizLink_TPE" type="text" class="input" value="https://docs.google.com/spreadsheets/d/14yjT90s9CV988KZZ_o6m8F4LbeDWpKTuqVO66gfLboI/edit" />
        <input id="gvizSheet_TPE" type="text" class="input" value="inventory_tracking" />
      </div>
      <div class="row" style="margin:0 0 6px">
        <input id="gvizHeader_TPE" type="number" class="input" value="4" min="1" />
        <input id="gvizNameCol_TPE" type="text" class="input" value="D" />
        <input id="gvizExpiryCol_TPE" type="text" class="input" value="E" />
        <input id="gvizQtyCol_TPE" type="text" class="input" value="J" />
      </div>

      <div class="row" style="margin:8px 0 6px">
        <strong class="sub">三重（SC）</strong>
        <input id="gvizLink_SC" type="text" class="input" value="https://docs.google.com/spreadsheets/d/12C25rcfSEMtSkkARzLtxlW9Wmhu64m6eSP_KoK8M-js/edit" />
        <input id="gvizSheet_SC" type="text" class="input" value="inventory_tracking" />
      </div>
      <div class="row" style="margin:0 0 6px">
        <input id="gvizHeader_SC" type="number" class="input" value="4" min="1" />
        <input id="gvizNameCol_SC" type="text" class="input" value="D" />
        <input id="gvizExpiryCol_SC" type="text" class="input" value="E" />
        <input id="gvizQtyCol_SC" type="text" class="input" value="J" />
      </div>

      <div class="row" style="margin:8px 0 6px">
        <strong class="sub">MOMO</strong>
        <input id="gvizLink_MOMO" type="text" class="input" value="" />
        <input id="gvizSheet_MOMO" type="text" class="input" value="inventory_tracking" />
      </div>
      <div class="row" style="margin:0 0 6px">
        <input id="gvizHeader_MOMO" type="number" class="input" value="4" min="1" />
        <input id="gvizNameCol_MOMO" type="text" class="input" value="D" />
        <input id="gvizExpiryCol_MOMO" type="text" class="input" value="E" />
        <input id="gvizQtyCol_MOMO" type="text" class="input" value="J" />
      </div>

      <div class="row" style="margin:0 0 12px">
        <button id="saveGViz">儲存全部來源（立即重新載入）</button>
        <span class="sub">＊遇 CORS：Google Sheet → <b>檔案 → 發佈到網路</b>（各別工作表）。</span>
      </div>

      <div id="testArea" class="sub"></div>
      <div id="diagArea" class="sub" style="margin-top:8px"></div>
    </details>
  </div>

<script>
const DEFAULT_TPE = {
  sheetId:'14yjT90s9CV988KZZ_o6m8F4LbeDWpKTuqVO66gfLboI',
  sheetName:'inventory_tracking',
  headerRow:4,
  nameCol:'D',
  expiryCol:'E',
  qtyCol:'J'
};
const DEFAULT_SC = {
  sheetId:'12C25rcfSEMtSkkARzLtxlW9Wmhu64m6eSP_KoK8M-js',
  sheetName:'inventory_tracking', // 留空=第一個工作表
  headerRow:4,
  nameCol:'D',
  expiryCol:'E',
  qtyCol:'J'
};
const DEFAULT_MOMO = { sheetId:'', sheetName:'inventory_tracking', headerRow:4, nameCol:'D', expiryCol:'E', qtyCol:'J' };

let CONF_TPE = loadConf('TPE', DEFAULT_TPE);
let CONF_SC  = loadConf('SC',  DEFAULT_SC);
let CONF_MOMO= loadConf('MOMO',DEFAULT_MOMO);

let RAW_ALL=[], DATA=[], VIEW=[];
let sortKey='DaysToExpiry', sortAsc=true;
let currentRange=90;
let GROUP_MODE = (localStorage.getItem('pm_group_mode')||'product');
let DIAG = { raw:0,included:0,skipNoName:0,skipNoDate:0,uniqueAfterGroup:0,aggregatedFrom:0, sources:{} };

// ---------- helpers ----------
const $=(q,r=document)=>r.querySelector(q); const $$=(q,r=document)=>Array.from(r.querySelectorAll(q));
const fmtInt=n=>Number(n).toLocaleString();
function toggleSpinner(on){ $('#spinner').classList.toggle('show',!!on); }
function letterToIndex(L){ L=String(L||'').trim().toUpperCase(); let n=0; for(let i=0;i<L.length;i++){ n = n*26 + (L.charCodeAt(i)-64); } return n-1; }
function parseDate(v){ if(v instanceof Date) return v; if(typeof v==='number') return new Date(Math.round((v-25569)*86400*1000)); const t=(v||'').toString().trim().replace(/\./g,'/').replace(/-/g,'/'); const d=new Date(t); return isNaN(d)?null:d; }
const daysForward=(a,b)=>Math.round((b-a)/(1000*60*60*24));
function addDays(base,n){const d=new Date(base); d.setDate(d.getDate()+n); return d;}
function escapeHTML(s){ return (s||'').replace(/[&<>"']/g, c=>({"&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;"}[c]||c)); }

function loadConf(tag, def){
  try{
    if(tag==='TPE' && !localStorage.getItem('pm_gviz_config_TPE') && localStorage.getItem('pm_gviz_config')){
      const old = JSON.parse(localStorage.getItem('pm_gviz_config'));
      localStorage.setItem('pm_gviz_config_TPE', JSON.stringify({ ...def, ...old }));
    }
    const raw = localStorage.getItem('pm_gviz_config_'+tag);
    const saved = raw ? JSON.parse(raw) : {};
    const merged = { ...def };
    const keys = ['sheetId','sheetName','headerRow','nameCol','expiryCol','qtyCol'];
    for(const k of keys){
      const v = saved[k];
      if(v !== undefined && v !== null && String(v).trim() !== ''){
        merged[k] = (k==='headerRow') ? Number(v) : v;
      }
    }
    return merged;
  }catch(e){ return { ...def }; }
}
function saveConfFromInputs(tag){
  const get=(id)=>($('#'+id+'_'+tag)?.value||'').trim();
  function extractSheetId(linkOrId){ if(!linkOrId) return ''; const token='/d/'; const i=linkOrId.indexOf(token); if(i<0) return linkOrId; const start=i+token.length; let end=linkOrId.indexOf('/',start); if(end<0) end=linkOrId.length; return linkOrId.slice(start,end); }
  const c={
    sheetId: extractSheetId(get('gvizLink')) || (tag==='TPE'?DEFAULT_TPE.sheetId: (tag==='SC'?DEFAULT_SC.sheetId:'')),
    sheetName: get('gvizSheet') || (tag==='TPE'?DEFAULT_TPE.sheetName:''),
    headerRow: Number(get('gvizHeader')|| (tag==='TPE'?DEFAULT_TPE.headerRow:4)),
    nameCol: (get('gvizNameCol')|| (tag==='TPE'?DEFAULT_TPE.nameCol:'D')).toUpperCase(),
    expiryCol: (get('gvizExpiryCol')|| (tag==='TPE'?DEFAULT_TPE.expiryCol:'E')).toUpperCase(),
    qtyCol: (get('gvizQtyCol')|| (tag==='TPE'?DEFAULT_TPE.qtyCol:'J')).toUpperCase(),
  };
  localStorage.setItem('pm_gviz_config_'+tag, JSON.stringify(c));
  if(tag==='TPE') CONF_TPE=c; if(tag==='SC') CONF_SC=c; if(tag==='MOMO') CONF_MOMO=c;
}
function hydrateInputs(tag, conf){
  const set=(sel,val)=>{ const el=$('#'+sel+'_'+tag); if(el){ el.value = val==null? '' : String(val); } };
  set('gvizLink', conf.sheetId ? `https://docs.google.com/spreadsheets/d/${conf.sheetId}/edit` : '');
  set('gvizSheet', conf.sheetName || '');
  set('gvizHeader', conf.headerRow || 4);
  set('gvizNameCol', conf.nameCol || 'D');
  set('gvizExpiryCol', conf.expiryCol || 'E');
  set('gvizQtyCol', conf.qtyCol || 'J');
}
function gvizTestUrl(conf){
  if(!conf.sheetId) return '';
  const base = `https://docs.google.com/spreadsheets/d/${conf.sheetId}/gviz/tq?`;
  const parts=[];
  if(conf.sheetName) parts.push(`sheet=${encodeURIComponent(conf.sheetName)}`);
  parts.push(`range=A${conf.headerRow}:Z`);
  parts.push('tqx=out:csv');
  return base + parts.join('&');
}

// ---------- data ----------
async function fetchOne(conf, tag){
  if(!conf.sheetId) return [];
  const url = gvizTestUrl(conf);
  const res = await fetch(url,{cache:'no-store'});
  if(!res.ok) throw new Error(`[${tag}] HTTP ${res.status}`);
  const csv = await res.text();
  const rows = parseCSV(csv); if(!rows.length) return [];
  const dataRows = rows.slice(1);
  const idxName   = letterToIndex(conf.nameCol||'D');
  const idxExpiry = letterToIndex(conf.expiryCol||'E');
  const idxQty    = letterToIndex(conf.qtyCol||'J');
  const out=[];
  for(const arr of dataRows){
    const name=(arr[idxName]||'').toString().trim();
    const expiry=arr[idxExpiry];
    const qty=Number(arr[idxQty]||0);
    if(!name && !expiry && !qty) continue;
    out.push({ ProductName:name, 'Expiry Date':expiry, Quantity:qty, Source:tag });
  }
  return out;
}

async function fetchAll(){
  toggleSpinner(true);
  try{
    const parts = await Promise.all([
      fetchOne(CONF_TPE,'TPE').catch(e=>{console.warn(e); return []; }),
      fetchOne(CONF_SC,'SC').catch(e=>{console.warn(e); return []; }),
      fetchOne(CONF_MOMO,'MOMO').catch(e=>{console.warn(e); return []; }),
    ]);
    RAW_ALL = parts.flat();
    DATA = normalizeRowsMulti(RAW_ALL);
  } finally { toggleSpinner(false); }
}

function normalizeRowsMulti(rows){
  DIAG={ raw:rows.length,included:0,skipNoName:0,skipNoDate:0,uniqueAfterGroup:0,aggregatedFrom:0, sources:{TPE:0,SC:0,MOMO:0} };
  const included=[];
  for(const r of rows){
    const name=String(r.ProductName||'').trim();
    const d=parseDate(r['Expiry Date']||r['ExpiryDate']||r['Expiration Date']);
    const src=r.Source||'TPE';
    if(!name){ DIAG.skipNoName++; continue; }
    if(!d){ DIAG.skipNoDate++; continue; }
    const qty=Number(r.Quantity||0)||0;
    included.push({ name,d,qty,src });
  }
  DIAG.included=included.length;
  const buckets=new Map();
  for(const r of included){
    const iso=r.d.toISOString().slice(0,10);
    const key=(GROUP_MODE==='batch')? `${r.name}||${iso}` : r.name;
    if(!buckets.has(key)) buckets.set(key,{ ProductName:r.name, Qty_TPE:0, Qty_SC:0, Qty_MOMO:0, ExpiryDate:r.d });
    const o=buckets.get(key);
    if(r.src==='TPE') o.Qty_TPE += r.qty; else if(r.src==='SC') o.Qty_SC += r.qty; else if(r.src==='MOMO') o.Qty_MOMO += r.qty;
    if(GROUP_MODE==='product'){ if(r.d < o.ExpiryDate) o.ExpiryDate=r.d; }
  }
  const today=new Date();
  const out = Array.from(buckets.values()).map(o=>{
    const TTQ = (o.Qty_TPE||0) + (o.Qty_SC||0) + (o.Qty_MOMO||0);
    return { ...o, Quantity:TTQ, Qty_TTQ:TTQ, DaysToExpiry:daysForward(today,o.ExpiryDate) };
  });
  DIAG.uniqueAfterGroup=out.length; DIAG.aggregatedFrom=DIAG.included-DIAG.uniqueAfterGroup;
  out.forEach(o=>{ DIAG.sources.TPE+=(o.Qty_TPE||0); DIAG.sources.SC+=(o.Qty_SC||0); DIAG.sources.MOMO+=(o.Qty_MOMO||0); });
  return out;
}

// ---------- render ----------
function render(){
  const q=$('#search').value.trim().toLowerCase();

  VIEW = DATA.filter(r=>{
    let inRange=true; const cr=currentRange;
    if(typeof cr==='object' && cr && cr.mode==='custom'){
      if(cr.min!=null && r.DaysToExpiry < cr.min) inRange=false;
      if(cr.max!=null && r.DaysToExpiry > cr.max) inRange=false;
    }else if(cr==='all'){ inRange=true; }
    else if(cr==='expired'){ inRange = r.DaysToExpiry < 0; }
    else{ inRange = (r.DaysToExpiry >= 0 && r.DaysToExpiry <= Number(cr)); }
    if(!inRange) return false;
    if(!q) return true; return `${r.ProductName}`.toLowerCase().includes(q);
  }).sort((a,b)=>{ const va=a[sortKey], vb=b[sortKey]; if(va===vb) return 0; return (va>vb?1:-1) * (sortAsc?1:-1); });

  const totalQty = VIEW.reduce((s,r)=>s+(Number.isFinite(r.Quantity)?r.Quantity:0),0);
  const earliestItem = VIEW.slice().sort((a,b)=>a.ExpiryDate-b.ExpiryDate)[0];
  const earliestStr = earliestItem? `${earliestItem.ExpiryDate.toISOString().slice(0,10)} (${earliestItem.DaysToExpiry}天)` : '–';
  $('#statSku').textContent = fmtInt(VIEW.length);
  $('#statQty').textContent = fmtInt(totalQty);
  $('#statEarliest').textContent = earliestStr;

  const tbody=$('#tbl tbody'); tbody.innerHTML=''; const frag=document.createDocumentFragment();
  VIEW.forEach((r,i)=>{
    const cls = r.DaysToExpiry < 0 ? 'danger' : (r.DaysToExpiry <= 60 ? 'warn' : '');
    const tr=document.createElement('tr');
    tr.innerHTML = `
      <td class="mono col-idx">${i+1}</td>
      <td class="col-product"><span class="product-name">${escapeHTML(r.ProductName||'')}</span></td>
      <td class="mono col-qty">${fmtInt(r.Qty_TTQ||r.Quantity||0)}</td>
      <td class="mono col-src">${fmtInt(r.Qty_TPE||0)}</td>
      <td class="mono col-src">${fmtInt(r.Qty_SC||0)}</td>
      <td class="mono col-src">${fmtInt(r.Qty_MOMO||0)}</td>
      <td class="mono col-dte ${cls}">${fmtInt(r.DaysToExpiry)}</td>`;
    frag.appendChild(tr);
  });
  tbody.appendChild(frag);

  const cr=currentRange; let rangeLabel;
  if(typeof cr==='object' && cr && cr.mode==='custom'){
    const minLabel=(cr.min!=null)?cr.min:'-∞'; const maxLabel=(cr.max!=null)?cr.max:'+∞';
    rangeLabel=`自訂 ${minLabel}–${maxLabel} 天`;
  }else{ rangeLabel = cr==='all'? '全部' : (cr==='expired'? '已過期' : `到期 ≤ ${cr} 天`); }
  $('#meta').textContent = `${rangeLabel} · ${VIEW.length} 筆`;

  renderDiagnostics();
}

function renderDiagnostics(){
  const links = [
    ['台北', gvizTestUrl(CONF_TPE)],
    ['三重', gvizTestUrl(CONF_SC)],
    ['MOMO', gvizTestUrl(CONF_MOMO)],
  ].filter(x=>x[1]);
  const qSum = DATA.reduce((s,r)=>s+(Number(r.Quantity)||0),0);
  const html=[
    `<div>資料診斷${links.length? ' · ' + links.map(([n,u])=>`<a href="${u}" target="_blank" rel="noopener">${n}測試</a>`).join(' · ') : ''}</div>`,
    `<div>原始列 ${DIAG.raw} · 有效列 ${DIAG.included} · 分組後 ${DIAG.uniqueAfterGroup}（彙總自 ${DIAG.aggregatedFrom} 列）</div>`,
    `<div>略過：無商品名 ${DIAG.skipNoName}、無法解析日期 ${DIAG.skipNoDate}</div>`,
    `<div>來源合計：台北 ${fmtInt(DIAG.sources.TPE||0)} · 三重 ${fmtInt(DIAG.sources.SC||0)} · MOMO ${fmtInt(DIAG.sources.MOMO||0)} · 視圖 TTQ ${fmtInt(qSum)}</div>`,
    `<div>彙總模式：<b>${GROUP_MODE==='product'?'同商品彙總（保留最早到期）':'保留批次（商品+到期日）'}</b></div>`
  ].join('');
  $('#diagArea').innerHTML=html;
}

// ---------- events ----------
$('#search').addEventListener('input',()=>render());
$$('#tbl thead th.sortable').forEach(th=>{ th.addEventListener('click',()=>{ const key=th.dataset.key; if(sortKey===key){ sortAsc=!sortAsc; } else { sortKey=key; sortAsc=(key!=='Quantity'); } render(); }); });

function applyRangeFromSelect(){
  const v = $('#rangeSel').value;
  if (v==='custom'){
    $('#customBar').style.display='flex';
    return;
  }
  $('#customBar').style.display='none';
  if (v==='all' || v==='expired'){
    currentRange = v;
  } else if (v.endsWith('+')){
    const n = Number(v.slice(0,-1));
    currentRange = {mode:'custom', min:n, max:null};
  } else if (v.includes('-')){
    const parts=v.split('-');
    if(parts.length===2){
      const a=Number(parts[0]); const b=Number(parts[1]);
      if(Number.isFinite(a) && Number.isFinite(b)) currentRange = {mode:'custom', min:a, max:b};
    }
  } else {
    currentRange = Number(v);
  }
  render();
}
$('#rangeSel').addEventListener('change', applyRangeFromSelect);

$('#applyCustom').addEventListener('click',()=>{
  const toNum=v=> (v===''||v==null)? null : Number(v);
  currentRange={mode:'custom', min:toNum($('#minDays').value), max:toNum($('#maxDays').value)};
  $('#customBar').style.display='none';
  render();
});

$('#toggleSources').addEventListener('change', (e)=>{
  document.body.classList.toggle('show-sources', e.target.checked);
});

$('#saveGViz').addEventListener('click', async()=>{
  ['TPE','SC','MOMO'].forEach(tag=>saveConfFromInputs(tag));
  try{ await fetchAll(); render(); renderDiagnostics(); alert('已儲存並重新載入'); }catch(e){
    alert('讀取 Google Sheet 失敗：'+e.message+'\n\n請確認：\n1) 三個工作表皆「發佈到網路」\n2) 名稱/欄位字母正確 (D/E/J)\n3) 權限為任何持有連結者可檢視');
  }
});

// hydrate inputs
(function(){
  hydrateInputs('TPE', CONF_TPE);
  hydrateInputs('SC',  CONF_SC);
  hydrateInputs('MOMO',CONF_MOMO);
})();

// ---------- CSV parser (fixed) ----------
function parseCSV(text){
  const rows=[]; let cur='', row=[], inQ=false;
  for(let i=0;i<text.length;i++){
    const ch=text[i];
    if(inQ){
      if(ch === '"'){
        if(text[i+1] === '"'){ cur+='"'; i++; } else { inQ=false; }
      } else {
        cur += ch;
      }
    } else {
      if(ch === '"'){ inQ = true; }
      else if(ch === ','){ row.push(cur); cur=''; }
      else if(ch === '\n'){ row.push(cur); rows.push(row); row=[]; cur=''; }
      else if(ch === '\r'){ /* ignore CR */ }
      else { cur += ch; }
    }
  }
  if(cur.length>0 || row.length){ row.push(cur); rows.push(row); }
  return rows;
}

// ---------- tests ----------
function runTests(){
  const results=[]; const today=new Date();
  const ten=daysForward(today,addDays(today,10)); results.push(['T1 daysForward +10',ten===10,ten]);
  const known=new Date('2025-01-15T00:00:00'); const serial=Math.floor(known.getTime()/(86400*1000))+25569; const parsed=parseDate(serial); const sameDay=parsed && parsed.getUTCFullYear()===known.getUTCFullYear() && parsed.getUTCMonth()===known.getUTCMonth() && parsed.getUTCDate()===known.getUTCDate(); results.push(['T2 parse Excel serial',!!sameDay,parsed?.toISOString()?.slice(0,10)]);
  const demo=[
    {ProductName:'Demo','Expiry Date':addDays(today,50),Quantity:5,Source:'TPE'},
    {ProductName:'Demo','Expiry Date':addDays(today,20),Quantity:7,Source:'SC'},
    {ProductName:'Demo','Expiry Date':addDays(today,30),Quantity:3,Source:'MOMO'},
  ];
  const norm=normalizeRowsMulti(demo);
  results.push(['T3 TTQ sum', norm[0]?.Qty_TTQ===15, norm[0]?.Qty_TTQ]);
  results.push(['T3 earliest kept', norm[0]?.DaysToExpiry===20, norm[0]?.DaysToExpiry]);
  const ok=results.filter(r=>r[1]).length; $('#testArea').innerHTML=[`<div>測試通過 ${ok}/${results.length}</div>`, '<ul>', ...results.map(([n,p,i])=>`<li>${p?'✅':'❌'} ${n} <span class="sub">(${i??''})</span></li>`), '</ul>'].join('');
}

// ---------- boot ----------
(async function init(){
  try{ await fetchAll(); } catch(e){
    alert('讀取 Google Sheet 失敗：'+e.message+'\n\n請確認：\n1) 三個工作表皆「發佈到網路」\n2) 名稱/欄位字母正確 (D/E/J)\n3) 權限為任何持有連結者可檢視');
  }
  render(); runTests();
})();
</script>
</body>
</html>
