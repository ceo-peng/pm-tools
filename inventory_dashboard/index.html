<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>PM Inventory Dashboard v2.9</title>
    <!-- React & Tailwind -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        :root {
            --primary: 222.2 47.4% 11.2%;
            --radius: 0.5rem;
        }
        body { background-color: #f8fafc; color: #334155; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif; -webkit-tap-highlight-color: transparent; }
        
        /* Desktop Table Styles */
        .table-container { max-height: 60vh; overflow-y: auto; border-radius: var(--radius); box-shadow: 0 1px 3px 0 rgb(0 0 0 / 0.1); background: white; border: 1px solid #e2e8f0; }
        .data-table { width: 100%; border-collapse: separate; border-spacing: 0; }
        .data-table th { position: sticky; top: 0; z-index: 20; background-color: #f1f5f9; color: #475569; font-weight: 700; font-size: 0.75rem; text-transform: uppercase; letter-spacing: 0.05em; padding: 0.75rem 1rem; border-bottom: 2px solid #cbd5e1; user-select: none; }
        .data-table td { padding: 0.6rem 1rem; border-bottom: 1px solid #f1f5f9; font-size: 0.875rem; vertical-align: middle; }
        .data-table tr:hover td { background-color: #f8fafc; }

        /* Sort Indicator - Enhanced Stability */
        .sort-icon { 
            display: inline-flex; 
            align-items: center; 
            justify-content: center;
            vertical-align: middle; 
            margin-left: 4px; 
            width: 12px; 
            height: 12px; 
            opacity: 0; 
            transition: opacity 0.2s ease-in-out; 
        }
        .sort-icon.active {
            opacity: 1; 
        }
        
        /* Stats Cards - Interactive */
        .stat-card { 
            position: relative;
            border-radius: 0.75rem; 
            padding: 1rem; 
            flex: 1; 
            min-width: 150px; 
            cursor: pointer;
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
            user-select: none;
            border: 1px solid transparent;
        }
        
        /* Unchecked State */
        .stat-card.unchecked {
            background: white;
            border-color: #e2e8f0;
            color: #64748b;
            box-shadow: 0 1px 2px 0 rgb(0 0 0 / 0.05);
        }
        .stat-card.unchecked:hover {
            border-color: #cbd5e1;
            transform: translateY(-2px);
            box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1);
        }

        /* Checked State */
        .stat-card.checked {
            background-color: #1e293b; /* Slate 800 */
            color: white;
            border-color: #0f172a;
            box-shadow: 0 4px 6px -1px rgb(30 41 59 / 0.3);
            transform: translateY(-2px);
        }

        .stat-card-header { display: flex; justify-content: space-between; align-items: start; margin-bottom: 0.5rem; }
        .stat-label { font-size: 0.75rem; text-transform: uppercase; font-weight: 700; letter-spacing: 0.05em; }
        .stat-value { font-size: 1.5rem; font-weight: 700; font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, monospace; line-height: 1; }
        .stat-sub { font-size: 0.75rem; margin-top: 0.25rem; opacity: 0.8; }

        /* Custom Checkbox */
        .custom-checkbox {
            width: 1.25rem;
            height: 1.25rem;
            border-radius: 0.25rem;
            border: 2px solid;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
        }
        .unchecked .custom-checkbox { border-color: #cbd5e1; background: transparent; }
        .checked .custom-checkbox { border-color: white; background: white; color: #1e293b; }

        /* Mobile Card Styles */
        .mobile-card { background: white; border-radius: 0.75rem; padding: 1rem; margin-bottom: 0.75rem; box-shadow: 0 1px 2px 0 rgb(0 0 0 / 0.05); border: 1px solid #e2e8f0; position: relative; }
        .mobile-label { font-size: 0.7rem; color: #94a3b8; text-transform: uppercase; margin-bottom: 0.1rem; }
        
        /* Status Badges */
        .status-badge { display: inline-flex; align-items: center; padding: 0.125rem 0.625rem; border-radius: 9999px; font-weight: 600; font-size: 0.75rem; line-height: 1.25rem; }
        .status-expired { background-color: #fee2e2; color: #991b1b; }
        .status-warning { background-color: #fef3c7; color: #92400e; }
        .status-good { background-color: #dcfce7; color: #166534; }

        /* UI Elements */
        .btn { display: inline-flex; align-items: center; justify-content: center; border-radius: var(--radius); font-weight: 500; transition: all 0.2s; padding: 0.5rem 1rem; cursor: pointer; user-select: none; }
        .btn:disabled { opacity: 0.5; cursor: not-allowed; }
        .btn-primary { background-color: #0f172a; color: white; }
        .btn-primary:hover:not(:disabled) { background-color: #1e293b; }
        .btn-outline { border: 1px solid #cbd5e1; background: white; color: #334155; }
        .btn-outline:hover:not(:disabled) { background: #f8fafc; border-color: #94a3b8; }
        .btn-danger-ghost { color: #94a3b8; padding: 0.4rem; border-radius: 0.375rem; }
        .btn-danger-ghost:hover { color: #ef4444; background-color: #fee2e2; }

        .input-base { width: 100%; border-radius: var(--radius); border: 1px solid #cbd5e1; padding: 0.5rem 0.75rem; font-size: 0.875rem; background-color: white; transition: border-color 0.2s; }
        .input-base:focus { outline: none; border-color: #64748b; ring: 2px solid #e2e8f0; }

        .animate-spin { animation: spin 1s linear infinite; }
        @keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useMemo, useCallback } = React;

        // --- Utils & Config ---
        const DEFAULT_SOURCES = [
            { name: 'TPE', sheetId: '14yjT90s9CV988KZZ_o6m8F4LbeDWpKTuqVO66gfLboI', sheetName: 'inventory_tracking', headerRow: 4, nameCol: 'D', expiryCol: 'E', qtyCol: 'J' },
            { name: 'SC', sheetId: '12C25rcfSEMtSkkARzLtxlW9Wmhu64m6eSP_KoK8M-js', sheetName: 'inventory_tracking', headerRow: 4, nameCol: 'D', expiryCol: 'E', qtyCol: 'J' },
            { name: 'MOMO', sheetId: '1j04xLITImSX6WgtXkaGQfs0IZ5E8r3UEOrT2CKKGAxE', sheetName: 'inventory_tracking', headerRow: 4, nameCol: 'D', expiryCol: 'E', qtyCol: 'J' }
        ];

        const parseCSV = (text) => {
            const rows = [];
            let row = [];
            let cell = "";
            let inQuote = false;
            for (let i = 0; i < text.length; i++) {
                const char = text[i];
                if (char === '"') { inQuote = !inQuote; }
                else if (char === ',' && !inQuote) { row.push(cell.trim()); cell = ""; }
                else if ((char === '\r' || char === '\n') && !inQuote) {
                    if (cell || row.length) row.push(cell.trim());
                    if (row.length) rows.push(row);
                    row = []; cell = "";
                } else { cell += char; }
            }
            if (cell || row.length) { row.push(cell.trim()); rows.push(row); }
            return rows;
        };

        const colToIndex = (col) => {
            if (!col) return -1;
            let index = 0;
            for (let i = 0; i < col.length; i++) index = index * 26 + (col.charCodeAt(i) - 64);
            return index - 1;
        };

        const parseDate = (dateStr) => {
            if (!dateStr) return null;
            if (!isNaN(dateStr) && parseFloat(dateStr) > 20000) {
                return new Date((parseFloat(dateStr) - 25569) * 86400 * 1000);
            }
            const d = new Date(dateStr);
            return isNaN(d.getTime()) ? null : d;
        };

        // --- Components ---
        const Icon = ({ path, className = "" }) => (
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}>
                {path}
            </svg>
        );

        const Checkbox = ({ checked }) => (
            <div className="custom-checkbox">
                {checked && <Icon path={<polyline points="20 6 9 17 4 12"></polyline>} className="w-3 h-3 stroke-[4]" />}
            </div>
        );

        const SortIndicator = ({ active, direction }) => {
            return (
                <span className={`sort-icon ${active ? 'active' : ''}`}>
                    {direction === 'desc' ? '↓' : '↑'}
                </span>
            );
        };

        const SettingsPanel = ({ sources, setSources, onSave, onClose, hiddenCount, onResetHidden }) => {
            const updateSource = (index, field, value) => {
                const newSources = [...sources];
                newSources[index][field] = field.includes('Col') ? value.toUpperCase() : value;
                setSources(newSources);
            };

            const addSource = () => {
                setSources([...sources, { name: 'NEW', sheetId: '', sheetName: '', headerRow: 1, nameCol: 'A', expiryCol: 'B', qtyCol: 'C' }]);
            };

            const removeSource = (idx) => {
                if (confirm('確定移除此來源?')) {
                    setSources(sources.filter((_, i) => i !== idx));
                }
            };

            return (
                <div className="fixed inset-0 bg-black/60 z-50 flex items-center justify-center p-4 backdrop-blur-sm">
                    <div className="bg-white rounded-xl shadow-2xl w-full max-w-4xl max-h-[90vh] flex flex-col animate-in fade-in zoom-in-95 duration-200">
                        <div className="flex justify-between items-center p-6 border-b">
                            <h2 className="text-xl font-bold text-slate-800">設定 (Settings)</h2>
                            <button onClick={onClose} className="p-2 hover:bg-slate-100 rounded-full transition-colors">✕</button>
                        </div>
                        
                        <div className="flex-1 overflow-y-auto p-6 space-y-6">
                            <div className="bg-slate-50 p-4 rounded-lg border border-slate-200 flex justify-between items-center">
                                <div>
                                    <h3 className="font-semibold text-slate-700">隱藏品項管理</h3>
                                    <p className="text-sm text-slate-500">已隱藏 {hiddenCount} 個品項</p>
                                </div>
                                <button 
                                    onClick={onResetHidden}
                                    disabled={hiddenCount === 0}
                                    className="btn btn-outline text-red-600 border-red-200 hover:bg-red-50"
                                >
                                    重置隱藏
                                </button>
                            </div>

                            <hr className="border-slate-100" />

                            <div className="space-y-4">
                                <div className="flex justify-between items-center">
                                    <h3 className="font-semibold text-slate-700">資料來源 (Data Sources)</h3>
                                    <button onClick={addSource} className="text-sm text-blue-600 hover:underline font-medium">+ 新增來源</button>
                                </div>
                                {sources.map((src, idx) => (
                                    <div key={idx} className="p-4 border rounded-lg bg-white shadow-sm grid grid-cols-1 md:grid-cols-12 gap-3 relative group">
                                        <button onClick={() => removeSource(idx)} className="absolute top-2 right-2 text-gray-300 hover:text-red-500 p-1">✕</button>
                                        
                                        <div className="md:col-span-2">
                                            <label className="text-[10px] uppercase text-gray-400 font-bold">Name</label>
                                            <input className="input-base font-bold text-slate-700" value={src.name} onChange={e => updateSource(idx, 'name', e.target.value)} />
                                        </div>
                                        <div className="md:col-span-4">
                                            <label className="text-[10px] uppercase text-gray-400 font-bold">Sheet ID</label>
                                            <input className="input-base font-mono text-xs" value={src.sheetId} onChange={e => updateSource(idx, 'sheetId', e.target.value)} />
                                        </div>
                                        <div className="md:col-span-2">
                                            <label className="text-[10px] uppercase text-gray-400 font-bold">Tab</label>
                                            <input className="input-base" value={src.sheetName} onChange={e => updateSource(idx, 'sheetName', e.target.value)} />
                                        </div>
                                        <div className="md:col-span-1">
                                            <label className="text-[10px] uppercase text-gray-400 font-bold">Row</label>
                                            <input type="number" className="input-base" value={src.headerRow} onChange={e => updateSource(idx, 'headerRow', parseInt(e.target.value))} />
                                        </div>
                                        <div className="md:col-span-3 grid grid-cols-3 gap-2">
                                            <div><label className="text-[10px] uppercase text-gray-400 font-bold">N</label><input className="input-base text-center uppercase" value={src.nameCol} onChange={e => updateSource(idx, 'nameCol', e.target.value)} /></div>
                                            <div><label className="text-[10px] uppercase text-gray-400 font-bold">E</label><input className="input-base text-center uppercase" value={src.expiryCol} onChange={e => updateSource(idx, 'expiryCol', e.target.value)} /></div>
                                            <div><label className="text-[10px] uppercase text-gray-400 font-bold">Q</label><input className="input-base text-center uppercase" value={src.qtyCol} onChange={e => updateSource(idx, 'qtyCol', e.target.value)} /></div>
                                        </div>
                                    </div>
                                ))}
                            </div>
                        </div>
                        <div className="p-6 border-t bg-slate-50 rounded-b-xl flex justify-end gap-3">
                            <button onClick={onClose} className="btn btn-outline">取消</button>
                            <button onClick={onSave} className="btn btn-primary shadow-lg shadow-blue-900/20">儲存</button>
                        </div>
                    </div>
                </div>
            );
        };

        const Dashboard = () => {
            // -- State --
            const [sources, setSources] = useState(() => {
                const saved = localStorage.getItem('pm_dashboard_sources_v2');
                return saved ? JSON.parse(saved) : DEFAULT_SOURCES;
            });
            const [hiddenItems, setHiddenItems] = useState(() => {
                const saved = localStorage.getItem('pm_dashboard_hidden');
                return saved ? JSON.parse(saved) : [];
            });

            const [data, setData] = useState([]);
            const [loading, setLoading] = useState(false);
            const [searchTerm, setSearchTerm] = useState('');
            const [settingsOpen, setSettingsOpen] = useState(false);
            const [lastUpdate, setLastUpdate] = useState(null);

            // Filters
            const [activeLocations, setActiveLocations] = useState(['TOTAL']); 
            const [dteType, setDteType] = useState('90'); 
            const [customDteMin, setCustomDteMin] = useState('');
            const [customDteMax, setCustomDteMax] = useState('');
            
            // Sort
            const [sortConfig, setSortConfig] = useState({ key: 'dte', direction: 'asc' });

            // -- Logic --
            const fetchData = useCallback(async () => {
                setLoading(true);
                try {
                    const allDataMap = new Map();
                    
                    await Promise.all(sources.map(async (src) => {
                        if (!src.sheetId) return;
                        const url = `https://docs.google.com/spreadsheets/d/${src.sheetId}/gviz/tq?sheet=${src.sheetName}&range=A${src.headerRow}:Z&tqx=out:csv`;
                        
                        try {
                            const res = await fetch(url);
                            if (!res.ok) throw new Error('Network err');
                            const csv = await res.text();
                            const rows = parseCSV(csv);
                            
                            const nIdx = colToIndex(src.nameCol);
                            const eIdx = colToIndex(src.expiryCol);
                            const qIdx = colToIndex(src.qtyCol);

                            rows.forEach(row => {
                                const nameRaw = row[nIdx];
                                const expRaw = row[eIdx];
                                const qtyRaw = row[qIdx];

                                if (!nameRaw || !expRaw) return;
                                
                                const key = nameRaw.trim().toUpperCase();
                                const expiry = parseDate(expRaw);
                                const cleanQty = typeof qtyRaw === 'string' ? qtyRaw.replace(/,/g, '') : qtyRaw;
                                const qty = parseInt(cleanQty) || 0;

                                if (!expiry) return;

                                if (!allDataMap.has(key)) {
                                    allDataMap.set(key, {
                                        name: nameRaw.trim(),
                                        expiry: expiry,
                                        quantities: {}
                                    });
                                }
                                
                                const entry = allDataMap.get(key);
                                if (expiry < entry.expiry) entry.expiry = expiry;
                                
                                const srcKey = src.name || 'Unknown';
                                entry.quantities[srcKey] = (entry.quantities[srcKey] || 0) + qty;
                            });
                        } catch (err) {
                            console.error(`Failed to load ${src.name}`, err);
                        }
                    }));

                    const today = new Date();
                    today.setHours(0,0,0,0);
                    
                    const processed = Array.from(allDataMap.values()).map(item => {
                        const total = Object.values(item.quantities).reduce((acc, v) => acc + v, 0);
                        const dte = Math.ceil((item.expiry - today) / (1000 * 60 * 60 * 24));
                        return { ...item, total, dte };
                    });

                    setData(processed);
                    setLastUpdate(new Date());
                } finally {
                    setLoading(false);
                }
            }, [sources]);

            useEffect(() => { fetchData(); }, []); 

            // -- Actions --
            const handleSaveSettings = () => {
                localStorage.setItem('pm_dashboard_sources_v2', JSON.stringify(sources));
                setSettingsOpen(false);
                fetchData();
            };

            const toggleHideItem = (itemName) => {
                const newHidden = [...hiddenItems, itemName];
                setHiddenItems(newHidden);
                localStorage.setItem('pm_dashboard_hidden', JSON.stringify(newHidden));
            };

            const resetHiddenItems = () => {
                setHiddenItems([]);
                localStorage.removeItem('pm_dashboard_hidden');
            };

            const toggleLocation = (locName) => {
                if (locName === 'TOTAL') {
                    setActiveLocations(['TOTAL']);
                } else {
                    let newActive;
                    if (activeLocations.includes('TOTAL')) {
                        newActive = [locName];
                    } else {
                        if (activeLocations.includes(locName)) {
                            const remaining = activeLocations.filter(l => l !== locName);
                            newActive = remaining.length === 0 ? ['TOTAL'] : remaining;
                        } else {
                            newActive = [...activeLocations, locName];
                        }
                    }
                    setActiveLocations(newActive);
                }
            };

            // -- Derived State --
            const sourceNames = useMemo(() => sources.map(s => s.name), [sources]);
            
            // Determine visible columns based on selection
            const visibleSources = useMemo(() => {
                if (activeLocations.includes('TOTAL')) return sourceNames;
                return sourceNames.filter(src => activeLocations.includes(src));
            }, [activeLocations, sourceNames]);

            // ** 1. Base Filtered Data (Search, Hidden, DTE, AND Auto-Hide Expired) **
            const baseFilteredData = useMemo(() => {
                return data.filter(item => {
                    // 1. Check Hidden
                    if (hiddenItems.includes(item.name)) return false;

                    // 2. Check Auto-Hide Expired (DTE <= 0)
                    if (item.dte <= 0) return false;

                    // 3. Check Search
                    if (searchTerm && !item.name.toLowerCase().includes(searchTerm.toLowerCase())) return false;
                    
                    // 4. Check DTE User Filter
                    if (dteType === 'CUSTOM') {
                        const min = customDteMin === '' ? -Infinity : parseInt(customDteMin);
                        const max = customDteMax === '' ? Infinity : parseInt(customDteMax);
                        if (item.dte < min || item.dte > max) return false;
                    } else if (dteType !== 'ALL') {
                        const maxDays = parseInt(dteType);
                        if (item.dte > maxDays) return false; 
                    }
                    return true;
                });
            }, [data, searchTerm, dteType, customDteMin, customDteMax, hiddenItems]);

            // ** 2. Stats for Cards (Calculated from Base Filtered Data) **
            const sourceStats = useMemo(() => {
                const stats = {};
                sourceNames.forEach(src => stats[src] = { qty: 0, sku: 0 });
                
                baseFilteredData.forEach(row => {
                    sourceNames.forEach(src => {
                        const q = row.quantities[src] || 0;
                        if (q > 0) {
                            stats[src].qty += q;
                            stats[src].sku += 1;
                        }
                    });
                });
                return stats;
            }, [baseFilteredData, sourceNames]);

            // ** 3. Display Data (For Table & Total Card Sum) **
            const finalDisplayData = useMemo(() => {
                return baseFilteredData.map(item => {
                    // Calculate dynamic total based on active checks
                    let displayTotal = 0;
                    if (activeLocations.includes('TOTAL')) {
                        displayTotal = item.total; // Sum of all
                    } else {
                        // Sum only active locations
                        activeLocations.forEach(loc => {
                            displayTotal += (item.quantities[loc] || 0);
                        });
                    }
                    return { ...item, displayTotal };
                }).filter(item => {
                    // Final check: Must have stock in SELECTED locations to show in table
                    return item.displayTotal > 0;
                }).sort((a, b) => {
                    let aVal, bVal;

                    // Determine sort value based on config
                    if (sourceNames.includes(sortConfig.key)) {
                        // Sorting by specific warehouse quantity
                        aVal = a.quantities[sortConfig.key] || 0;
                        bVal = b.quantities[sortConfig.key] || 0;
                    } else if (sortConfig.key === 'total') {
                        // Sorting by Display Total
                        aVal = a.displayTotal;
                        bVal = b.displayTotal;
                    } else {
                        // Standard keys: name, expiry, dte
                        aVal = a[sortConfig.key];
                        bVal = b[sortConfig.key];
                    }

                    // String comparison (for names)
                    if (typeof aVal === 'string') {
                        return sortConfig.direction === 'asc' 
                            ? aVal.localeCompare(bVal) 
                            : bVal.localeCompare(aVal);
                    }

                    // Number/Date comparison
                    if (aVal < bVal) return sortConfig.direction === 'asc' ? -1 : 1;
                    if (aVal > bVal) return sortConfig.direction === 'asc' ? 1 : -1;
                    return 0;
                });
            }, [baseFilteredData, activeLocations, sortConfig, sourceNames]);

            const requestSort = (key) => {
                let direction = 'asc';
                if (sortConfig.key === key && sortConfig.direction === 'asc') direction = 'desc';
                setSortConfig({ key, direction });
            };

            // ** 4. Dynamic Total Sum (For Total Card) **
            const dynamicTotalSum = useMemo(() => {
                return finalDisplayData.reduce((acc, curr) => acc + curr.displayTotal, 0);
            }, [finalDisplayData]);


            const getDteBadge = (dte) => {
                if (dte <= 60) return <span className="status-badge status-expired">剩 {dte} 天</span>;
                if (dte <= 180) return <span className="status-badge status-warning">剩 {dte} 天</span>;
                return <span className="status-badge status-good">剩 {dte} 天</span>;
            };

            return (
                <div className="max-w-7xl mx-auto p-4 md:p-6 pb-20 md:pb-6 space-y-4 md:space-y-6">
                    {/* Header */}
                    <header className="flex flex-col md:flex-row justify-between items-start md:items-center gap-4">
                        <div>
                            <h1 className="text-xl md:text-2xl font-bold text-slate-800 flex items-center gap-2">
                                <Icon path={<path d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z"></path>} />
                                庫存水位監控 v2.9
                            </h1>
                            <p className="text-xs md:text-sm text-slate-500 mt-1">
                                {lastUpdate ? `更新: ${lastUpdate.toLocaleTimeString()}` : '等待更新...'} 
                            </p>
                        </div>
                        <div className="flex gap-2 w-full md:w-auto">
                            <button onClick={fetchData} className="btn btn-outline flex-1 md:flex-none justify-center" disabled={loading}>
                                <Icon path={<path d="M23 4v6h-6M1 20v-6h6"></path>} className={loading ? "animate-spin mr-2" : "mr-2"} />
                                重新整理
                            </button>
                            <button onClick={() => setSettingsOpen(true)} className="btn btn-outline flex-1 md:flex-none justify-center">
                                <Icon path={<circle cx="12" cy="12" r="3"></circle>} className="mr-2" /> 設定
                            </button>
                        </div>
                    </header>

                    {/* Interactive Filter Cards */}
                    <div className="flex flex-wrap gap-3">
                        {/* Total Card (Dynamic Sum based on checks) */}
                        <div 
                            className={`stat-card ${activeLocations.includes('TOTAL') ? 'checked' : 'unchecked'}`}
                            onClick={() => toggleLocation('TOTAL')}
                        >
                            <div className="stat-card-header">
                                <div className={`stat-label ${activeLocations.includes('TOTAL') ? 'text-blue-200' : 'text-slate-500'}`}>Total Inventory</div>
                                <Checkbox checked={activeLocations.includes('TOTAL')} />
                            </div>
                            <div className="stat-value">{dynamicTotalSum.toLocaleString()}</div>
                            <div className={`stat-sub ${activeLocations.includes('TOTAL') ? 'text-blue-200' : 'text-slate-400'}`}>{finalDisplayData.length} items</div>
                        </div>

                        {/* Individual Source Cards (Static Stats based on DTE/Search only) */}
                        {sourceNames.map(src => {
                            const isChecked = activeLocations.includes(src);
                            return (
                                <div 
                                    key={src} 
                                    className={`stat-card ${isChecked ? 'checked' : 'unchecked'}`}
                                    onClick={() => toggleLocation(src)}
                                >
                                    <div className="stat-card-header">
                                        <div className={`stat-label ${isChecked ? 'text-blue-200' : 'text-slate-500'}`}>{src}</div>
                                        <Checkbox checked={isChecked} />
                                    </div>
                                    <div className="stat-value">{sourceStats[src]?.qty.toLocaleString() || 0}</div>
                                    <div className={`stat-sub ${isChecked ? 'text-blue-200' : 'text-slate-400'}`}>{sourceStats[src]?.sku || 0} items</div>
                                </div>
                            );
                        })}
                    </div>

                    {/* Filter Bar */}
                    <div className="bg-white p-4 rounded-xl shadow-sm border border-slate-200 sticky top-2 z-30">
                        <div className="grid grid-cols-1 md:grid-cols-12 gap-3 items-center">
                            {/* Search */}
                            <div className="md:col-span-5 relative">
                                <input 
                                    type="text" 
                                    placeholder="搜尋品名..." 
                                    className="input-base pl-9 bg-slate-50 border-slate-200 focus:bg-white"
                                    value={searchTerm}
                                    onChange={e => setSearchTerm(e.target.value)}
                                />
                                <div className="absolute left-3 top-2.5 text-gray-400">
                                    <Icon path={<circle cx="11" cy="11" r="8"></circle>} />
                                </div>
                            </div>
                            
                            {/* Time Filter */}
                            <div className={`md:col-span-${dteType === 'CUSTOM' ? '7' : '4'} flex gap-2 transition-all duration-300`}>
                                <select className="input-base cursor-pointer w-full" value={dteType} onChange={e => setDteType(e.target.value)}>
                                    <option value="ALL">全部效期 (All)</option>
                                    <option value="60">≤ 60 天 (緊急)</option>
                                    <option value="90">≤ 90 天 (注意)</option>
                                    <option value="180">≤ 180 天 (半年)</option>
                                    <option value="CUSTOM">自訂區間...</option>
                                </select>
                                
                                {dteType === 'CUSTOM' && (
                                    <div className="flex gap-2 w-full animate-in fade-in zoom-in duration-200">
                                        <input type="number" placeholder="Min" className="input-base w-20 px-2 text-center" value={customDteMin} onChange={e => setCustomDteMin(e.target.value)} />
                                        <span className="self-center text-slate-400">-</span>
                                        <input type="number" placeholder="Max" className="input-base w-20 px-2 text-center" value={customDteMax} onChange={e => setCustomDteMax(e.target.value)} />
                                    </div>
                                )}
                            </div>
                        </div>
                    </div>

                    {/* --- Mobile View (Cards) --- */}
                    <div className="md:hidden space-y-3">
                        {loading ? (
                             <div className="text-center py-10 text-gray-400">載入中...</div>
                        ) : finalDisplayData.length === 0 ? (
                             <div className="text-center py-10 text-gray-400">無符合資料</div>
                        ) : (
                            finalDisplayData.map((row, idx) => (
                                <div key={idx} className="mobile-card flex flex-col gap-3">
                                    <div className="flex justify-between items-start">
                                        <div className="font-semibold text-slate-800 text-base break-words pr-8">{row.name}</div>
                                        <button onClick={() => toggleHideItem(row.name)} className="btn-danger-ghost absolute top-3 right-3">
                                            <Icon path={<polyline points="3 6 5 6 21 6"></polyline>} />
                                            <Icon path={<path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>} className="ml-[-16px]" />
                                        </button>
                                    </div>
                                    
                                    <div className="grid grid-cols-2 gap-4">
                                        <div>
                                            <div className="mobile-label">總庫存 (TTQ)</div>
                                            <div className="text-lg font-bold text-blue-600">{row.displayTotal.toLocaleString()}</div>
                                        </div>
                                        <div>
                                            <div className="mobile-label">效期 (EXP)</div>
                                            <div className="text-sm font-mono text-slate-600">{row.expiry.toISOString().split('T')[0]}</div>
                                        </div>
                                    </div>

                                    <div className="flex justify-between items-end border-t pt-3 mt-1">
                                        <div className="text-xs text-slate-400 space-x-2">
                                            {visibleSources.map(src => row.quantities[src] > 0 && (
                                                <span key={src} className="inline-block bg-slate-100 px-1.5 py-0.5 rounded">
                                                    {src}: {row.quantities[src]}
                                                </span>
                                            ))}
                                        </div>
                                        <div>{getDteBadge(row.dte)}</div>
                                    </div>
                                </div>
                            ))
                        )}
                    </div>

                    {/* --- Desktop View (Table) --- */}
                    <div className="hidden md:block table-container">
                        <table className="data-table">
                            <thead>
                                <tr>
                                    <th 
                                        className="text-left cursor-pointer hover:bg-slate-100 pl-4 w-1/3" 
                                        onClick={() => requestSort('name')}
                                    >
                                        品名 <SortIndicator active={sortConfig.key === 'name'} direction={sortConfig.direction} />
                                    </th>
                                    
                                    {/* Dynamic Columns - Sortable */}
                                    {visibleSources.map(src => (
                                        <th 
                                            key={src} 
                                            className="text-center w-24 text-slate-500 cursor-pointer hover:bg-slate-100"
                                            onClick={() => requestSort(src)}
                                        >
                                            {src} <SortIndicator active={sortConfig.key === src} direction={sortConfig.direction} />
                                        </th>
                                    ))}
                                    
                                    <th 
                                        className="text-center w-28 cursor-pointer hover:bg-slate-100 text-blue-600" 
                                        onClick={() => requestSort('total')}
                                    >
                                        總量 <SortIndicator active={sortConfig.key === 'total'} direction={sortConfig.direction} />
                                    </th>
                                    
                                    <th 
                                        className="text-center w-32 cursor-pointer hover:bg-slate-100" 
                                        onClick={() => requestSort('expiry')}
                                    >
                                        效期 <SortIndicator active={sortConfig.key === 'expiry'} direction={sortConfig.direction} />
                                    </th>
                                    
                                    <th 
                                        className="text-center w-32 cursor-pointer hover:bg-slate-100" 
                                        onClick={() => requestSort('dte')}
                                    >
                                        DTE <SortIndicator active={sortConfig.key === 'dte'} direction={sortConfig.direction} />
                                    </th>
                                    <th className="w-10"></th>
                                </tr>
                            </thead>
                            <tbody>
                                {loading ? (
                                    <tr><td colSpan={5 + visibleSources.length} className="text-center py-20 text-slate-400">載入數據中...</td></tr>
                                ) : finalDisplayData.length === 0 ? (
                                    <tr><td colSpan={5 + visibleSources.length} className="text-center py-20 text-slate-400">無符合資料</td></tr>
                                ) : (
                                    finalDisplayData.map((row, idx) => (
                                        <tr key={idx} className="group transition-colors">
                                            <td className="font-medium text-slate-700 pl-4">{row.name}</td>
                                            
                                            {/* Dynamic Cells */}
                                            {visibleSources.map(src => (
                                                <td key={src} className={`text-center font-mono ${!row.quantities[src] ? 'text-slate-200' : 'text-slate-600'}`}>
                                                    {row.quantities[src] || 0}
                                                </td>
                                            ))}

                                            <td className="text-center font-bold text-blue-600 bg-blue-50/30 font-mono">{row.displayTotal.toLocaleString()}</td>
                                            <td className="text-center text-sm font-mono text-slate-500">{row.expiry.toISOString().split('T')[0]}</td>
                                            <td className="text-center">{getDteBadge(row.dte)}</td>
                                            <td className="text-center">
                                                <button 
                                                    onClick={() => toggleHideItem(row.name)}
                                                    className="btn-danger-ghost opacity-0 group-hover:opacity-100 transition-opacity"
                                                    title="隱藏此商品"
                                                >
                                                    <Icon path={<polyline points="3 6 5 6 21 6"></polyline>} />
                                                    <Icon path={<path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>} className="hidden" />
                                                </button>
                                            </td>
                                        </tr>
                                    ))
                                )}
                            </tbody>
                        </table>
                    </div>

                    {settingsOpen && (
                        <SettingsPanel 
                            sources={sources} 
                            setSources={setSources} 
                            hiddenCount={hiddenItems.length}
                            onResetHidden={resetHiddenItems}
                            onClose={() => setSettingsOpen(false)} 
                            onSave={handleSaveSettings} 
                        />
                    )}
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<Dashboard />);
    </script>
</body>
</html>
