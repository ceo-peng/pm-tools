<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>PM Inventory · Expiry Dashboard</title>
  <style>
    :root{ --bg:#0b0b0c; --card:#121214; --muted:#a7a7b3; --fg:#f5f5f7; --accent:#d4af37; --danger:#d9534f; --warn:#f0ad4e; }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0;background:linear-gradient(180deg,#0b0b0c,#0f0f12);color:var(--fg);font:14px/1.6 system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif}
    .wrap{max-width:1140px;margin:0 auto;padding:20px}
    header{display:flex;align-items:center;gap:12px;flex-wrap:wrap;margin-bottom:16px}
    h1{font-size:20px;font-weight:700;letter-spacing:.2px;margin:0}
    .sub{color:var(--muted);font-size:12px}

    .toolbar{display:flex;flex-wrap:wrap;gap:8px;margin:14px 0}
    button,.pill{background:#1a1a1f;border:1px solid #26262b;color:var(--fg);border-radius:999px;padding:8px 12px;cursor:pointer;transition:background .2s ease,border-color .2s ease; font-weight:600; font-size:13px}
    button:hover{background:#1f1f25}
    button.active{border-color:var(--accent);box-shadow:0 0 0 1px var(--accent) inset}
    .right{margin-left:auto}
    .input{background:#111114;border:1px solid #26262b;border-radius:10px;color:var(--fg);padding:8px 10px}

    .table{overflow:auto;border-radius:14px;border:1px solid #232328}
    table{width:100%;border-collapse:separate;border-spacing:0;background:var(--card);table-layout:fixed}
    thead th{position:sticky;top:0;background:#16161a;z-index:2}
    th,td{padding:10px 12px;border-bottom:1px solid #1f1f24;text-align:left;vertical-align:top}
    tr:hover td{background:#141418}
    th.sortable{cursor:pointer}
    th.sortable:after{content:"⇅";opacity:.4;margin-left:6px;font-size:11px}

    /* Stats */
    .stats{display:grid;grid-template-columns:repeat(3,1fr);gap:8px;margin:10px 0}
    .stat{background:#111114;border:1px solid #24242a;border-radius:12px;padding:10px 12px;display:flex;flex-direction:column;gap:2px}
    .stat .label{color:var(--muted);font-size:11px;letter-spacing:.3px}
    .stat .value{font-size:16px;font-weight:800}
    .dist{display:flex;flex-wrap:wrap;gap:8px;margin:6px 0 12px}
    .dist .chip{background:#121217;border:1px solid #26262b;border-radius:999px;padding:6px 10px;font-weight:600;font-size:12px;cursor:pointer}
    .dist .chip:hover{background:#17171c}

    .mono{font-variant-numeric:tabular-nums}
    .col-idx{width:44px}
    .col-qty{width:80px}
    .col-exp{width:110px}
    .col-dte{width:76px}
    .col-dte.warn{color:var(--warn)}
    .col-dte.danger{color:var(--danger)}
    .product-name{font-weight:600}

    .footer{color:var(--muted);font-size:12px;margin-top:12px}
    .spinner{display:none}
    .spinner.show{display:inline-block;width:16px;height:16px;border-radius:50%;border:2px solid #333;border-top-color:var(--accent);animation:spin 1s linear infinite;vertical-align:middle}
    @keyframes spin{to{transform:rotate(360deg)}}

    details{background:#111114;border:1px solid #232328;border-radius:12px;padding:10px;margin:12px 0}
    details>summary{cursor:pointer;list-style:none}
    details>summary::-webkit-details-marker{display:none}
    .row{display:flex;flex-wrap:wrap;gap:8px;align-items:center}
    .row input[type="text"],.row input[type="number"],.row select{flex:1 1 220px}

    @media (max-width:760px){
      th,td{padding:8px 10px}
      .stats{grid-template-columns:repeat(2,1fr)}
      .product-name{font-size:13px;line-height:1.3}
      .col-qty,.col-exp,.col-dte{white-space:nowrap}
    }
  @media (max-width:760px){
      /* Hide Expiry column on mobile for compactness */
      th.col-exp, td.col-exp{display:none}
      /* tighter buttons/inputs */
      .toolbar{gap:6px}
      button,.pill{padding:6px 10px;font-size:12px}
      .input{padding:6px 8px}
      /* narrower numeric columns */
      .col-idx{width:36px}
      .col-qty{width:72px}
      .col-dte{width:64px}
    }
    @media (max-width:420px){
      body{font-size:13px}
      th,td{padding:6px 8px}
      .product-name{font-size:12.5px;line-height:1.25}
      .col-qty{width:64px}
      .col-dte{width:58px}
    }
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <h1>PM Inventory · Expiry Dashboard</h1>
      <span class="sub">Golden Minimalism — expiry‑aware, fast, clear.</span>
      <span class="right spinner" id="spinner"></span>
    </header>

    <section class="card">
      <div class="toolbar">
        <button data-range="expired">已過期</button>
        <button data-range="30">≤ 30 天</button>
        <button data-range="60">≤ 60 天</button>
        <button data-range="90" class="active">≤ 90 天</button>
        <button data-range="all">全部</button>
        <label class="pill" style="display:flex;align-items:center;gap:6px">
          <input id="expiredToggle" type="checkbox" style="accent-color:#d4af37"> 含已過期
        </label>
        <input id="search" class="input" placeholder="搜尋 Item…" />
      </div>

      <div id="customRange" class="row" style="margin:6px 0 4px">
        <details style="width:100%">
          <summary class="sub">自訂期間篩選（以「到期天數」為單位，今天=0；負值=已過期）</summary>
          <div class="row" style="margin-top:8px">
            <input id="minDays" type="number" class="input" placeholder="最小天數（空=不限）" />
            <input id="maxDays" type="number" class="input" placeholder="最大天數（空=不限）" />
            <button id="applyCustom">套用自訂</button>
            <span class="sub">快捷：1y≈365、1.5y≈548、2y≈730</span>
          </div>
          <div class="row" style="margin-top:6px">
            <button class="preset" data-min="365" data-max="">≥365天</button>
            <button class="preset" data-min="548" data-max="">≥548天</button>
            <button class="preset" data-min="365" data-max="548">365–548天</button>
            <button class="preset" data-min="365" data-max="730">365–730天</button>
            <button class="preset" data-min="" data-max="30">≤30天</button>
            <button class="preset" data-min="" data-max="60">≤60天</button>
            <button class="preset" data-min="" data-max="90">≤90天</button>
          </div>
        </details>
      </div>

      <div id="stats" class="stats">
        <div class="stat"><span class="label">SKU</span><span class="value" id="statSku">–</span></div>
        <div class="stat"><span class="label">Qty</span><span class="value" id="statQty">–</span></div>
        <div class="stat"><span class="label">最早到期</span><span class="value" id="statEarliest">–</span></div>
      </div>
      <div id="dist" class="dist">
        <button class="chip" data-min="" data-max="0">已過期</button>
        <button class="chip" data-min="0" data-max="30">≤30</button>
        <button class="chip" data-min="31" data-max="60">31–60</button>
        <button class="chip" data-min="61" data-max="90">61–90</button>
        <button class="chip" data-min="365" data-max="">≥365</button>
        <button class="chip" data-min="548" data-max="">≥548</button>
      </div>

      <div id="meta" class="sub" style="margin:2px 0 10px"></div>

      <div class="table"><table id="tbl">
        <thead>
          <tr>
            <th class="col-idx">#</th>
            <th class="sortable col-product" data-key="ProductName">Item</th>
            <th class="sortable col-qty" data-key="Quantity">Qty</th>
            <th class="sortable col-exp" data-key="ExpiryDate">Expiry</th>
            <th class="sortable col-dte" data-key="DaysToExpiry">DTE</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table></div>

      <div class="footer">Tips：點欄位標題可排序；按鈕可用「到期天數」篩選；可切換「含已過期」。</div>
    </section>

    <details>
      <summary class="sub">資料來源設定 & 測試</summary>
      <div class="row" style="margin:8px 0 6px">
        <input id="gvizLink" type="text" class="input" placeholder="貼上 Google Sheet 連結 或 ID（已預設為你的檔案）" />
        <input id="gvizSheet" type="text" class="input" placeholder="工作表名稱（例如：inventory_tracking）" />
      </div>
      <div class="row" style="margin:0 0 6px">
        <input id="gvizHeader" type="number" class="input" placeholder="標題列：4" min="1" />
        <input id="gvizNameCol" type="text" class="input" placeholder="Item 欄位字母：D" />
        <input id="gvizExpiryCol" type="text" class="input" placeholder="Expiry 欄位字母：E" />
        <input id="gvizQtyCol" type="text" class="input" placeholder="Qty 欄位字母：J" />
      </div>
      <div class="row" style="margin:0 0 12px">
        <button id="saveGViz">儲存GViz設定（會立即重新載入）</button>
        <span class="sub">＊若遇 CORS，請在 Google Sheet：<b>檔案 → 發佈到網路</b>（只發佈該工作表）。</span>
      </div>
      <div class="row" style="margin:4px 0 6px">
        <label class="pill">彙總模式
          <select id="groupModeSel" class="input" style="margin-left:8px">
            <option value="product">同商品彙總（保留最早到期）</option>
            <option value="batch">保留批次（商品+到期日）</option>
          </select>
        </label>
      </div>
      <div id="testArea" class="sub"></div>
      <div id="diagArea" class="sub" style="margin-top:8px"></div>
    </details>
  </div>

<script>
// ====== Minimal GViz-only single-file dashboard ======
// Defaults wired to your Sheet (auto-load on open)
const DEFAULT_GVIZ = {
  sheetId:'14yjT90s9CV988KZZ_o6m8F4LbeDWpKTuqVO66gfLboI',
  sheetName:'inventory_tracking',
  headerRow:4,
  nameCol:'D',
  expiryCol:'E',
  qtyCol:'J'
};

let GVIZ_CONF = loadGVizConf();
let RAW=[], DATA=[], VIEW=[];
let sortKey='DaysToExpiry', sortAsc=true;
let currentRange=90; // number | 'all' | 'expired' | {mode:'custom',min?,max?}
let GROUP_MODE = (localStorage.getItem('pm_group_mode')||'product'); // 'product' | 'batch'
let DIAG = { raw:0,included:0,skipNoName:0,skipNoDate:0,uniqueAfterGroup:0,aggregatedFrom:0 };

// ---------- helpers ----------
const $=(q,r=document)=>r.querySelector(q); const $$=(q,r=document)=>Array.from(r.querySelectorAll(q));
const fmtInt=n=>Number(n).toLocaleString();
function toggleSpinner(on){ $('#spinner').classList.toggle('show',!!on); }
function letterToIndex(L){ L=String(L||'').trim().toUpperCase(); let n=0; for(let i=0;i<L.length;i++){ n = n*26 + (L.charCodeAt(i)-64); } return n-1; }
function parseDate(v){ if(v instanceof Date) return v; if(typeof v==='number') return new Date(Math.round((v-25569)*86400*1000)); const t=(v||'').toString().trim().replace(/\./g,'/').replace(/-/g,'/'); const d=new Date(t); return isNaN(d)?null:d; }
const daysForward=(a,b)=>Math.round((b-a)/(1000*60*60*24));
function addDays(base,n){const d=new Date(base); d.setDate(d.getDate()+n); return d;}
function escapeHTML(s){ return (s||'').replace(/[&<>"']/g,c=>({"&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;"}[c])); }

function loadGVizConf(){
  try{ const saved=JSON.parse(localStorage.getItem('pm_gviz_config')||'null'); return { ...DEFAULT_GVIZ, ...(saved||{}) }; }catch{ return { ...DEFAULT_GVIZ }; }
}
function saveGVizInputsToConf(){
  const linkOrId=$('#gvizLink').value.trim();
  GVIZ_CONF.sheetId = extractSheetId(linkOrId) || DEFAULT_GVIZ.sheetId;
  GVIZ_CONF.sheetName = $('#gvizSheet').value.trim() || DEFAULT_GVIZ.sheetName;
  GVIZ_CONF.headerRow = Number($('#gvizHeader').value.trim()||DEFAULT_GVIZ.headerRow);
  GVIZ_CONF.nameCol = ($('#gvizNameCol').value.trim()||DEFAULT_GVIZ.nameCol).toUpperCase();
  GVIZ_CONF.expiryCol = ($('#gvizExpiryCol').value.trim()||DEFAULT_GVIZ.expiryCol).toUpperCase();
  GVIZ_CONF.qtyCol = ($('#gvizQtyCol').value.trim()||DEFAULT_GVIZ.qtyCol).toUpperCase();
  localStorage.setItem('pm_gviz_config', JSON.stringify(GVIZ_CONF));
}
function hydrateGVizInputs(){
  $('#gvizLink').value = GVIZ_CONF.sheetId ? `https://docs.google.com/spreadsheets/d/${GVIZ_CONF.sheetId}/edit` : '';
  $('#gvizSheet').value = GVIZ_CONF.sheetName || '';
  $('#gvizHeader').value = GVIZ_CONF.headerRow || 4;
  $('#gvizNameCol').value = GVIZ_CONF.nameCol || 'D';
  $('#gvizExpiryCol').value = GVIZ_CONF.expiryCol || 'E';
  $('#gvizQtyCol').value = GVIZ_CONF.qtyCol || 'J';
}
function extractSheetId(linkOrId){ if(!linkOrId) return ''; const m = linkOrId.match(/\/d\/([a-zA-Z0-9-_]+)/); return m? m[1] : linkOrId; }
function gvizTestUrl(){ const c=GVIZ_CONF; if(!c.sheetId) return ''; return `https://docs.google.com/spreadsheets/d/${c.sheetId}/gviz/tq?sheet=${encodeURIComponent(c.sheetName)}&range=A${c.headerRow}:Z&tqx=out:csv`; }

// ---------- data ----------
async function fetchFromGViz(){
  toggleSpinner(true);
  try{
    const c=GVIZ_CONF; if(!c.sheetId) throw new Error('NO_SHEET_ID');
    const url = gvizTestUrl();
    const res = await fetch(url,{cache:'no-store'});
    if(!res.ok) throw new Error(`HTTP ${res.status}`);
    const csv = await res.text();
    const rows = parseCSV(csv); if(!rows.length) throw new Error('EMPTY');
    const dataRows = rows.slice(1); // first row is header from GViz
    const idxName   = letterToIndex(c.nameCol||'D');
    const idxExpiry = letterToIndex(c.expiryCol||'E');
    const idxQty    = letterToIndex(c.qtyCol||'J');

    const objs=[];
    for(const arr of dataRows){
      const name=(arr[idxName]||'').toString().trim();
      const expiry=arr[idxExpiry];
      const qty=Number(arr[idxQty]||0);
      if(!name && !expiry && !qty) continue;
      objs.push({ ProductName:name, 'Expiry Date':expiry, Quantity:qty });
    }
    RAW=objs; DATA=normalizeRows(objs);
  }finally{ toggleSpinner(false); }
}

function normalizeRows(rows){
  DIAG={ raw:rows.length,included:0,skipNoName:0,skipNoDate:0,uniqueAfterGroup:0,aggregatedFrom:0 };
  const included=[];
  for(const r of rows){
    const name=String(r.ProductName||'').trim();
    const d=parseDate(r['Expiry Date']||r['ExpiryDate']||r['Expiration Date']);
    if(!name){ DIAG.skipNoName++; continue; }
    if(!d){ DIAG.skipNoDate++; continue; }
    const qty=Number(r.Quantity||0)||0;
    included.push({ name,d,qty });
  }
  DIAG.included=included.length;
  const buckets=new Map();
  for(const r of included){
    const iso=r.d.toISOString().slice(0,10);
    const key=(GROUP_MODE==='batch')? `${r.name}||${iso}` : r.name;
    if(!buckets.has(key)) buckets.set(key,{ ProductName:r.name, Quantity:0, ExpiryDate:r.d });
    const o=buckets.get(key); o.Quantity += r.qty; if(GROUP_MODE==='product'){ if(r.d < o.ExpiryDate) o.ExpiryDate=r.d; }
  }
  DIAG.uniqueAfterGroup=buckets.size; DIAG.aggregatedFrom=DIAG.included-DIAG.uniqueAfterGroup;
  const today=new Date();
  return Array.from(buckets.values()).map(o=>({ ...o, DaysToExpiry:daysForward(today,o.ExpiryDate) }));
}

// ---------- render ----------
function render(){
  const q=$('#search').value.trim().toLowerCase();
  const includeExpired=$('#expiredToggle')?.checked;

  VIEW = DATA.filter(r=>{
    let inRange=true; const cr=currentRange;
    if(typeof cr==='object' && cr && cr.mode==='custom'){
      if(cr.min!=null && r.DaysToExpiry < cr.min) inRange=false;
      if(cr.max!=null && r.DaysToExpiry > cr.max) inRange=false;
    }else if(cr==='all'){ inRange=true; }
    else if(cr==='expired'){ inRange = r.DaysToExpiry < 0; }
    else{ inRange = (r.DaysToExpiry >= 0 && r.DaysToExpiry <= Number(cr)); }
    const expiredOK = includeExpired ? (r.DaysToExpiry < 0 || inRange) : inRange;
    if(!expiredOK) return false;
    if(!q) return true; return `${r.ProductName}`.toLowerCase().includes(q);
  }).sort((a,b)=>{ const va=a[sortKey], vb=b[sortKey]; if(va===vb) return 0; return (va>vb?1:-1) * (sortAsc?1:-1); });

  const totalQty = VIEW.reduce((s,r)=>s+(Number.isFinite(r.Quantity)?r.Quantity:0),0);
  const earliestItem = VIEW.slice().sort((a,b)=>a.ExpiryDate-b.ExpiryDate)[0];
  const earliestStr = earliestItem? `${earliestItem.ExpiryDate.toISOString().slice(0,10)} (${earliestItem.DaysToExpiry}天)` : '–';
  $('#statSku').textContent = fmtInt(VIEW.length);
  $('#statQty').textContent = fmtInt(totalQty);
  $('#statEarliest').textContent = earliestStr;

  const tbody=$('#tbl tbody'); tbody.innerHTML=''; const frag=document.createDocumentFragment();
  VIEW.forEach((r,i)=>{
    const cls = r.DaysToExpiry < 0 ? 'danger' : (r.DaysToExpiry <= 60 ? 'warn' : '');
    const tr=document.createElement('tr');
    tr.innerHTML = `
      <td class="mono col-idx">${i+1}</td>
      <td class="col-product"><span class="product-name">${escapeHTML(r.ProductName||'')}</span></td>
      <td class="mono col-qty">${fmtInt(r.Quantity)}</td>
      <td class="mono col-exp">${r.ExpiryDate.toISOString().slice(0,10)}</td>
      <td class="mono col-dte ${cls}">${fmtInt(r.DaysToExpiry)}</td>`;
    frag.appendChild(tr);
  });
  tbody.appendChild(frag);

  // meta label
  const cr=currentRange; let rangeLabel;
  if(typeof cr==='object' && cr && cr.mode==='custom'){
    const minLabel=(cr.min!=null)?cr.min:'-∞'; const maxLabel=(cr.max!=null)?cr.max:'+∞';
    rangeLabel=`自訂 ${minLabel}–${maxLabel} 天`;
  }else{ rangeLabel = cr==='all'? '全部' : (cr==='expired'? '已過期' : `到期 ≤ ${cr} 天`); }
  const expiredCnt = VIEW.filter(r=>r.DaysToExpiry<0).length;
  $('#meta').textContent = `${rangeLabel} · ${VIEW.length} 筆 · 已過期 ${expiredCnt} 筆`;

  renderDiagnostics();
}

function renderDiagnostics(){
  const link=gvizTestUrl();
  const qSum = DATA.reduce((s,r)=>s+(Number(r.Quantity)||0),0);
  const html=[
    `<div>資料診斷${link?` · <a href="${link}" target="_blank" rel="noopener">GViz測試連結</a>`:''}</div>`,
    `<div>原始列 ${DIAG.raw} · 有效列 ${DIAG.included} · 分組後 ${DIAG.uniqueAfterGroup}（彙總自 ${DIAG.aggregatedFrom} 列）</div>`,
    `<div>略過：無商品名 ${DIAG.skipNoName}、無法解析日期 ${DIAG.skipNoDate}</div>`,
    `<div>彙總模式：<b>${GROUP_MODE==='product'?'同商品彙總（保留最早到期）':'保留批次（商品+到期日）'}</b> · 目前總庫存（視圖）：<b>${fmtInt(qSum)}</b></div>`
  ].join('');
  $('#diagArea').innerHTML=html;
}

// ---------- events ----------
$$('.toolbar button').forEach(btn=>{ btn.addEventListener('click',()=>{ $$('.toolbar button').forEach(b=>b.classList.remove('active')); btn.classList.add('active'); const r=btn.dataset.range; currentRange=(r==='all'||r==='expired')? r : Number(r); render(); }); });
$('#search').addEventListener('input',()=>render());
$$('#tbl thead th.sortable').forEach(th=>{ th.addEventListener('click',()=>{ const key=th.dataset.key; if(sortKey===key){ sortAsc=!sortAsc; } else { sortKey=key; sortAsc=(key!=='Quantity'); } render(); }); });

$('#applyCustom').addEventListener('click',()=>{
  const toNum=v=> (v===''||v==null)? null : Number(v);
  currentRange={mode:'custom', min:toNum($('#minDays').value), max:toNum($('#maxDays').value)};
  $$('.toolbar button').forEach(b=>b.classList.remove('active'));
  render();
});
$$('#customRange .preset').forEach(btn=>{ btn.addEventListener('click',()=>{ const min = btn.dataset.min===''? null:Number(btn.dataset.min); const max = btn.dataset.max===''? null:Number(btn.dataset.max); $('#minDays').value=min??''; $('#maxDays').value=max??''; currentRange={mode:'custom',min,max}; $$('.toolbar button').forEach(b=>b.classList.remove('active')); render(); }); });
$$('#dist .chip').forEach(ch=>{ ch.addEventListener('click',()=>{ const min = ch.dataset.min===''? null:Number(ch.dataset.min); const max = ch.dataset.max===''? null:Number(ch.dataset.max); currentRange={mode:'custom',min,max}; $$('.toolbar button').forEach(b=>b.classList.remove('active')); render(); }); });
const tgl=$('#expiredToggle'); if(tgl) tgl.addEventListener('change',()=>render());

$('#saveGViz').addEventListener('click', async()=>{ saveGVizInputsToConf(); try{ await fetchFromGViz(); render(); renderDiagnostics(); alert('已儲存並重新載入'); }catch(e){ alert('重新載入失敗：'+e.message); } });
$('#groupModeSel').value = GROUP_MODE; $('#groupModeSel').addEventListener('change',()=>{ GROUP_MODE=$('#groupModeSel').value; localStorage.setItem('pm_group_mode',GROUP_MODE); DATA=normalizeRows(RAW); render(); renderDiagnostics(); });

// ---------- CSV parser ----------
function parseCSV(text){
  const rows=[]; let i=0,cur='',row=[],inQ=false; while(i<text.length){ const ch=text[i++]; if(inQ){ if(ch==='"'){ if(text[i]==='"'){ cur+='"'; i++; } else { inQ=false; } } else { cur+=ch; } } else { if(ch==='"'){ inQ=true; } else if(ch===','){ row.push(cur); cur=''; } else if(ch==='\n'){ row.push(cur); rows.push(row); row=[]; cur=''; } else if(ch==='\r'){ } else { cur+=ch; } } } if(cur.length>0||row.length){ row.push(cur); rows.push(row); } return rows; }

// ---------- tests ----------
function runTests(){
  const results=[]; const today=new Date();
  const ten=daysForward(today,addDays(today,10)); results.push(['T1 daysForward +10',ten===10,ten]);
  const known=new Date('2025-01-15T00:00:00'); const serial=Math.floor(known.getTime()/(86400*1000))+25569; const parsed=parseDate(serial); const sameDay=parsed && parsed.getUTCFullYear()===known.getUTCFullYear() && parsed.getUTCMonth()===known.getUTCMonth() && parsed.getUTCDate()===known.getUTCDate(); results.push(['T2 parse Excel serial',!!sameDay,parsed?.toISOString()?.slice(0,10)]);
  const demo=[ {ProductName:'Demo','Expiry Date':addDays(today,50),Quantity:5}, {ProductName:'Demo','Expiry Date':addDays(today,20),Quantity:7} ];
  const norm=normalizeRows(demo); results.push(['T3 aggregate qty', norm[0]?.Quantity===12, norm[0]?.Quantity]); results.push(['T3 earliest kept', norm[0]?.DaysToExpiry===20, norm[0]?.DaysToExpiry]);
  const ok=results.filter(r=>r[1]).length; $('#testArea').innerHTML=[`<div>測試通過 ${ok}/${results.length}</div>`, '<ul>', ...results.map(([n,p,i])=>`<li>${p?'✅':'❌'} ${n} <span class="sub">(${i??''})</span></li>`), '</ul>'].join('');
}

// ---------- boot ----------
(async function init(){
  hydrateGVizInputs();
  try{ await fetchFromGViz(); } catch(e){ alert('讀取 Google Sheet 失敗：'+e.message+'\n\n請確認：\n1) 該工作表已「發佈到網路」\n2) 工作表名稱/欄位字母正確 (D/E/J)\n3) 權限為任何持有連結者可檢視'); }
  render(); runTests();
})();
</script>
</body>
</html>
