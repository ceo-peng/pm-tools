<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PM Inventory Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.js"></script>
    <style>
        /* PM Inventory Dashboard - Clean Design System */
        :root {
            --background: 0 0% 100%;
            --foreground: 222.2 84% 4.9%;
            --card: 0 0% 100%;
            --card-foreground: 222.2 84% 4.9%;
            --popover: 0 0% 100%;
            --popover-foreground: 222.2 84% 4.9%;
            --primary: 221.2 83.2% 53.3%;
            --primary-foreground: 210 40% 98%;
            --secondary: 210 40% 96%;
            --secondary-foreground: 222.2 47.4% 11.2%;
            --muted: 210 40% 96%;
            --muted-foreground: 215.4 16.3% 46.9%;
            --accent: 210 40% 96%;
            --accent-foreground: 222.2 47.4% 11.2%;
            --destructive: 0 84.2% 60.2%;
            --destructive-foreground: 210 40% 98%;
            --warning: 38 92% 50%;
            --warning-foreground: 222.2 84% 4.9%;
            --success: 142.1 76.2% 36.3%;
            --success-foreground: 355.7 100% 97.3%;
            --border: 214.3 31.8% 91.4%;
            --input: 214.3 31.8% 91.4%;
            --ring: 221.2 83.2% 53.3%;
            --radius: 0.5rem;
        }

        @media (prefers-color-scheme: dark) {
            :root {
                --background: 222.2 84% 4.9%;
                --foreground: 210 40% 98%;
                --card: 222.2 84% 4.9%;
                --card-foreground: 210 40% 98%;
                --popover: 222.2 84% 4.9%;
                --popover-foreground: 210 40% 98%;
                --primary: 217.2 91.2% 59.8%;
                --primary-foreground: 222.2 47.4% 11.2%;
                --secondary: 217.2 32.6% 17.5%;
                --secondary-foreground: 210 40% 98%;
                --muted: 217.2 32.6% 17.5%;
                --muted-foreground: 215 20.2% 65.1%;
                --accent: 217.2 32.6% 17.5%;
                --accent-foreground: 210 40% 98%;
                --destructive: 0 62.8% 30.6%;
                --destructive-foreground: 210 40% 98%;
                --warning: 54 91% 50%;
                --warning-foreground: 222.2 84% 4.9%;
                --success: 142.1 70.6% 45.3%;
                --success-foreground: 144.9 80.4% 10%;
                --border: 217.2 32.6% 17.5%;
                --input: 217.2 32.6% 17.5%;
                --ring: 217.2 91.2% 59.8%;
            }
        }

        body {
            background-color: hsl(var(--background));
            color: hsl(var(--foreground));
            font-family: system-ui, -apple-system, sans-serif;
        }

        .card {
            background-color: hsl(var(--card));
            color: hsl(var(--card-foreground));
            border: 1px solid hsl(var(--border));
            border-radius: var(--radius);
            box-shadow: 0 1px 3px 0 rgb(0 0 0 / 0.1), 0 1px 2px -1px rgb(0 0 0 / 0.1);
        }

        .button {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            border-radius: var(--radius);
            font-size: 0.875rem;
            font-weight: 500;
            transition: all 0.2s;
            cursor: pointer;
            border: 1px solid transparent;
            padding: 0.5rem 1rem;
            height: 2.25rem;
        }

        .button-outline {
            border: 1px solid hsl(var(--border));
            background-color: hsl(var(--background));
            color: hsl(var(--foreground));
        }

        .button-outline:hover {
            background-color: hsl(var(--accent));
        }

        .button-sm {
            height: 2rem;
            padding: 0.25rem 0.75rem;
            font-size: 0.75rem;
        }

        .input {
            display: flex;
            height: 2.25rem;
            width: 100%;
            border-radius: var(--radius);
            border: 1px solid hsl(var(--border));
            background-color: hsl(var(--background));
            padding: 0.5rem 0.75rem;
            font-size: 0.875rem;
            transition: border-color 0.2s;
        }

        .input:focus {
            outline: none;
            border-color: hsl(var(--ring));
        }

        .checkbox {
            height: 1rem;
            width: 1rem;
            border: 1px solid hsl(var(--border));
            border-radius: 0.25rem;
            background-color: hsl(var(--background));
        }

        .select {
            display: flex;
            height: 2.25rem;
            width: 100%;
            border-radius: var(--radius);
            border: 1px solid hsl(var(--border));
            background-color: hsl(var(--background));
            padding: 0.5rem 0.75rem;
            font-size: 0.875rem;
            cursor: pointer;
        }

        .tabular-nums {
            font-variant-numeric: tabular-nums;
            font-feature-settings: "tnum";
        }

        .status-expired {
            color: hsl(var(--destructive));
            background-color: hsl(var(--destructive) / 0.1);
            border: 1px solid hsl(var(--destructive) / 0.2);
            border-radius: 9999px;
            padding: 0.25rem 0.75rem;
            font-size: 0.75rem;
            font-weight: 500;
        }

        .status-warning {
            color: hsl(var(--warning-foreground));
            background-color: hsl(var(--warning) / 0.1);
            border: 1px solid hsl(var(--warning) / 0.2);
            border-radius: 9999px;
            padding: 0.25rem 0.75rem;
            font-size: 0.75rem;
            font-weight: 500;
        }

        .animate-spin {
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }

        .line-clamp-2 {
            overflow: hidden;
            display: -webkit-box;
            -webkit-box-orient: vertical;
            -webkit-line-clamp: 2;
            line-height: 1.3;
            max-height: 2.6em;
        }

        .table-header-btn {
            background: none;
            border: none;
            cursor: pointer;
            color: inherit;
            font-size: inherit;
        }

        .table-header-btn:hover {
            color: hsl(var(--primary));
        }

        .muted-text {
            color: hsl(var(--muted-foreground));
        }

        .primary-text {
            color: hsl(var(--primary));
        }

        .hidden { display: none; }
        .block { display: block; }
        .flex { display: flex; }
        .grid { display: grid; }
        .inline-flex { display: inline-flex; }
    </style>
</head>
<body>
    <div class="min-h-screen bg-white p-4" style="background-color: hsl(var(--background));">
        <div class="max-w-7xl mx-auto space-y-6">
            <!-- Header -->
            <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-2">
                <h1 class="text-xl sm:text-2xl font-bold">PM Inventory Dashboard</h1>
                <div class="flex items-center gap-2 text-xs sm:text-sm">
                    <span id="last-fetch" class="muted-text"></span>
                    <button id="refresh-btn" class="button button-outline button-sm">
                        <i data-lucide="refresh-cw" class="h-3 w-3 sm:h-4 sm:w-4"></i>
                    </button>
                    <button id="settings-btn" class="button button-outline button-sm">
                        <i data-lucide="settings" class="h-3 w-3 sm:h-4 sm:w-4"></i>
                    </button>
                </div>
            </div>

            <!-- Settings Panel -->
            <div id="settings-panel" class="card p-6 hidden">
                <h2 class="text-lg font-semibold mb-4">Data Source Settings</h2>
                <div id="sources-config" class="space-y-6"></div>
                <button id="save-settings-btn" class="button w-full mt-4" style="background-color: hsl(var(--primary)); color: hsl(var(--primary-foreground));">
                    Save All Sources (Reload Now)
                </button>
                <p class="text-sm muted-text mt-4">
                    <strong>Note:</strong> If data cannot be fetched due to permissions, ensure you've used "File → Publish to the web" for each tab in Google Sheets.
                </p>
            </div>

            <!-- Toolbar -->
            <div class="card p-2 sm:p-4">
                <div class="flex flex-col sm:flex-row gap-2 sm:gap-4 items-start sm:items-center">
                    <div class="flex-1 relative w-full sm:w-auto">
                        <i data-lucide="search" class="absolute left-2 sm:left-3 top-1/2 transform -translate-y-1/2 h-3 w-3 sm:h-4 sm:w-4 muted-text"></i>
                        <input id="search-input" type="text" placeholder="搜索產品..." class="input pl-8 sm:pl-10 text-sm sm:text-base h-8 sm:h-10">
                    </div>
                    
                    <div class="flex flex-col sm:flex-row gap-2 w-full sm:w-auto">
                        <!-- Location Checkboxes -->
                        <div id="location-checkboxes" class="flex gap-1 sm:gap-2 items-center">
                            <!-- Will be populated by JavaScript -->
                        </div>
                        
                        <select id="dte-filter" class="select w-20 sm:w-32 text-xs sm:text-sm h-8 sm:h-10">
                            <option value="all">全部</option>
                            <option value="expired">過期</option>
                            <option value="≤30">≤30天</option>
                            <option value="≤60">≤60天</option>
                            <option value="≤90" selected>≤90天</option>
                            <option value="≥365">≥365天</option>
                            <option value="≥548">≥548天</option>
                            <option value="≥730">≥730天</option>
                            <option value="≥913">≥913天</option>
                            <option value="365-548">365-548天</option>
                            <option value="365-730">365-730天</option>
                            <option value="custom">自定義</option>
                        </select>
                    </div>
                </div>
            </div>

            <!-- Stats -->
            <div class="grid grid-cols-2 lg:grid-cols-3 gap-2 sm:gap-4">
                <div class="card p-2 sm:p-3">
                    <div id="stats-sku" class="text-lg sm:text-xl font-bold tabular-nums">0</div>
                    <div class="text-xs sm:text-sm muted-text">SKU</div>
                </div>
                <div class="card p-2 sm:p-3">
                    <div id="stats-qty" class="text-lg sm:text-xl font-bold tabular-nums">0</div>
                    <div class="text-xs sm:text-sm muted-text">總量</div>
                </div>
                <div class="card col-span-2 lg:col-span-1 p-2 sm:p-3">
                    <div id="stats-earliest-date" class="text-sm sm:text-base font-bold">N/A</div>
                    <div id="stats-earliest-days" class="text-xs sm:text-sm muted-text">最早到期</div>
                </div>
            </div>

            <!-- Data Table -->
            <div class="card">
                <div class="overflow-x-auto">
                    <table class="w-full tabular-nums text-sm">
                        <thead style="background-color: hsl(var(--muted) / 0.5);">
                            <tr>
                                <th class="p-2 sm:p-3 text-left font-medium" style="width: auto; min-width: 40%;">
                                    <button class="table-header-btn text-xs sm:text-sm" onclick="handleSort('name')">
                                        物品 <span id="sort-name"></span>
                                    </button>
                                </th>
                                <th class="p-2 sm:p-3 text-right font-medium w-12 sm:w-16">
                                    <button class="table-header-btn text-xs sm:text-sm" onclick="handleSort('dte')">
                                        天 <span id="sort-dte"></span>
                                    </button>
                                </th>
                                <th class="p-2 sm:p-3 text-right font-medium w-12 sm:w-16">
                                    <button class="table-header-btn text-xs sm:text-sm flex items-center justify-end gap-1" onclick="handleSort('qty_TTQ')">
                                        總 <span id="sort-qty_TTQ"></span>
                                        <button id="toggle-columns-btn" onclick="toggleSourceColumns(event)" class="ml-1 p-0.5 rounded hover:bg-gray-200">
                                            <i data-lucide="chevron-right" class="h-3 w-3"></i>
                                        </button>
                                    </button>
                                </th>
                                <th id="source-col-tpe" class="p-2 sm:p-3 text-right font-medium w-12 sm:w-16 hidden">
                                    <button class="table-header-btn text-xs sm:text-sm" onclick="handleSort('qty_TPE')">
                                        北 <span id="sort-qty_TPE"></span>
                                    </button>
                                </th>
                                <th id="source-col-sc" class="p-2 sm:p-3 text-right font-medium w-12 sm:w-16 hidden">
                                    <button class="table-header-btn text-xs sm:text-sm" onclick="handleSort('qty_SC')">
                                        重 <span id="sort-qty_SC"></span>
                                    </button>
                                </th>
                                <th id="source-col-momo" class="p-2 sm:p-3 text-right font-medium w-12 sm:w-16 hidden">
                                    <button class="table-header-btn text-xs sm:text-sm" onclick="handleSort('qty_MOMO')">
                                        M <span id="sort-qty_MOMO"></span>
                                    </button>
                                </th>
                            </tr>
                        </thead>
                        <tbody id="data-table-body">
                            <!-- Will be populated by JavaScript -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Global state
        let data = [];
        let filteredData = [];
        let loading = false;
        let lastFetch = null;
        let searchTerm = '';
        let dteFilter = '≤90';
        let locationFilter = ['ALL'];
        let sortField = 'dte';
        let sortDirection = 'asc';
        let showSettings = false;
        let sourceColumnsExpanded = false;

        // Default data sources
        const defaultSources = [
            {
                name: 'TPE',
                sheetId: '14yjT90s9CV988KZZ_o6m8F4LbeDWpKTuqVO66gfLboI',
                sheetName: 'inventory_tracking',
                headerRow: 4,
                nameCol: 'D',
                expiryCol: 'E',
                qtyCol: 'J'
            },
            {
                name: 'SC',
                sheetId: '12C25rcfSEMtSkkARzLtxlW9Wmhu64m6eSP_KoK8M-js',
                sheetName: 'inventory_tracking',
                headerRow: 4,
                nameCol: 'D',
                expiryCol: 'E',
                qtyCol: 'J'
            },
            {
                name: 'MOMO',
                sheetId: '1j04xLITImSX6WgtXkaGQfs0IZ5E8r3UEOrT2CKKGAxE',
                sheetName: 'inventory_tracking',
                headerRow: 4,
                nameCol: 'D',
                expiryCol: 'E',
                qtyCol: 'J'
            }
        ];

        let sources = [...defaultSources];

        // Utility functions
        function parseCSV(csv) {
            const rows = [];
            let currentRow = [];
            let currentField = '';
            let inQuotes = false;
            let i = 0;

            while (i < csv.length) {
                const char = csv[i];
                const nextChar = csv[i + 1];

                if (char === '"') {
                    if (inQuotes && nextChar === '"') {
                        currentField += '"';
                        i += 2;
                        continue;
                    }
                    inQuotes = !inQuotes;
                } else if (char === ',' && !inQuotes) {
                    currentRow.push(currentField.trim());
                    currentField = '';
                } else if ((char === '\n' || char === '\r') && !inQuotes) {
                    if (char === '\r' && nextChar === '\n') i++;
                    currentRow.push(currentField.trim());
                    if (currentRow.some(field => field.length > 0)) {
                        rows.push(currentRow);
                    }
                    currentRow = [];
                    currentField = '';
                } else {
                    currentField += char;
                }
                i++;
            }

            if (currentField || currentRow.length > 0) {
                currentRow.push(currentField.trim());
                if (currentRow.some(field => field.length > 0)) {
                    rows.push(currentRow);
                }
            }

            return rows;
        }

        function parseDate(dateStr) {
            if (!dateStr) return null;

            // Try YYYY-MM-DD format
            if (/^\d{4}-\d{2}-\d{2}$/.test(dateStr)) {
                const date = new Date(dateStr + 'T00:00:00');
                return isNaN(date.getTime()) ? null : date;
            }

            // Try Excel serial number
            const serial = parseFloat(dateStr);
            if (!isNaN(serial) && serial > 25569) {
                return new Date((serial - 25569) * 86400 * 1000);
            }

            // Try other formats
            const date = new Date(dateStr);
            return isNaN(date.getTime()) ? null : date;
        }

        function colToIndex(col) {
            let index = 0;
            for (let i = 0; i < col.length; i++) {
                index = index * 26 + (col.charCodeAt(i) - 65 + 1);
            }
            return index - 1;
        }

        function getDTEStatusClass(dte) {
            if (dte < 0) return 'status-expired';
            if (dte <= 60) return 'status-warning';
            return '';
        }

        // Data fetching
        async function fetchSheetData(source) {
            if (!source.sheetId) return [];
            try {
                const sheetParam = source.sheetName ? `&sheet=${encodeURIComponent(source.sheetName)}` : '';
                const url = `https://docs.google.com/spreadsheets/d/${source.sheetId}/gviz/tq?${sheetParam}&range=A${source.headerRow}:Z&tqx=out:csv`;
                
                const response = await fetch(url, { cache: 'no-store' });
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}`);
                }

                const csvText = await response.text();
                const rows = parseCSV(csvText);
                const nameIdx = colToIndex(source.nameCol);
                const expiryIdx = colToIndex(source.expiryCol);
                const qtyIdx = colToIndex(source.qtyCol);

                const items = [];
                for (const row of rows) {
                    const name = row[nameIdx]?.trim();
                    const expiryStr = row[expiryIdx]?.trim();
                    const qtyStr = row[qtyIdx]?.trim();

                    if (!name || !expiryStr) continue;

                    const expiry = parseDate(expiryStr);
                    const qty = parseInt(qtyStr) || 0;

                    if (expiry && !isNaN(qty)) {
                        items.push({ name, expiry, qty });
                    }
                }

                return items;
            } catch (error) {
                console.error(`[${source.name}] Error fetching data:`, error);
                alert(`[${source.name}] HTTP Error: ${error.message}`);
                return [];
            }
        }

        async function fetchAllData() {
            setLoading(true);
            try {
                const results = await Promise.all(sources.map(fetchSheetData));

                // Aggregate data
                const productMap = new Map();
                results.forEach((items, sourceIndex) => {
                    const sourceName = sources[sourceIndex].name;
                    items.forEach(item => {
                        const existing = productMap.get(item.name);
                        if (existing) {
                            if (item.expiry < existing.expiry) {
                                existing.expiry = item.expiry;
                            }
                            if (sourceName === 'TPE') existing.qty_TPE += item.qty;
                            else if (sourceName === 'SC') existing.qty_SC += item.qty;
                            else if (sourceName === 'MOMO') existing.qty_MOMO += item.qty;
                        } else {
                            const newItem = {
                                name: item.name,
                                expiry: item.expiry,
                                qty_TPE: sourceName === 'TPE' ? item.qty : 0,
                                qty_SC: sourceName === 'SC' ? item.qty : 0,
                                qty_MOMO: sourceName === 'MOMO' ? item.qty : 0
                            };
                            productMap.set(item.name, newItem);
                        }
                    });
                });

                // Calculate DTE
                const today = new Date();
                today.setHours(0, 0, 0, 0);
                data = Array.from(productMap.values()).map(item => ({
                    ...item,
                    qty_TTQ: item.qty_TPE + item.qty_SC + item.qty_MOMO,
                    dte: Math.floor((item.expiry.getTime() - today.getTime()) / (1000 * 60 * 60 * 24))
                }));

                lastFetch = new Date();
                updateLastFetch();
                filterAndSortData();
                updateUI();
            } catch (error) {
                console.error('Error fetching data:', error);
            } finally {
                setLoading(false);
            }
        }

        function setLoading(isLoading) {
            loading = isLoading;
            const refreshBtn = document.getElementById('refresh-btn');
            const icon = refreshBtn.querySelector('[data-lucide="refresh-cw"]');
            
            if (loading) {
                icon.classList.add('animate-spin');
                refreshBtn.disabled = true;
            } else {
                icon.classList.remove('animate-spin');
                refreshBtn.disabled = false;
            }
        }

        function updateLastFetch() {
            const element = document.getElementById('last-fetch');
            if (lastFetch) {
                element.textContent = `更新: ${lastFetch.toLocaleTimeString()}`;
            }
        }

        // Filtering and sorting
        function filterAndSortData() {
            let filtered = [...data];

            // Search filter
            if (searchTerm) {
                filtered = filtered.filter(item => 
                    item.name.toLowerCase().includes(searchTerm.toLowerCase())
                );
            }

            // Location filter
            if (!locationFilter.includes('ALL')) {
                filtered = filtered.filter(item => {
                    if (locationFilter.includes('TAIPEI') && item.qty_TPE > 0) return true;
                    if (locationFilter.includes('SANCHONG') && item.qty_SC > 0) return true;
                    if (locationFilter.includes('MOMO') && item.qty_MOMO > 0) return true;
                    return false;
                });
            }

            // DTE filter
            if (dteFilter === 'expired') {
                filtered = filtered.filter(item => item.dte < 0);
            } else if (dteFilter === '≤30') {
                filtered = filtered.filter(item => item.dte <= 30);
            } else if (dteFilter === '≤60') {
                filtered = filtered.filter(item => item.dte <= 60);
            } else if (dteFilter === '≤90') {
                filtered = filtered.filter(item => item.dte <= 90);
            } else if (dteFilter === '≥365') {
                filtered = filtered.filter(item => item.dte >= 365);
            } else if (dteFilter === '≥548') {
                filtered = filtered.filter(item => item.dte >= 548);
            } else if (dteFilter === '≥730') {
                filtered = filtered.filter(item => item.dte >= 730);
            } else if (dteFilter === '≥913') {
                filtered = filtered.filter(item => item.dte >= 913);
            } else if (dteFilter === '365-548') {
                filtered = filtered.filter(item => item.dte >= 365 && item.dte <= 548);
            } else if (dteFilter === '365-730') {
                filtered = filtered.filter(item => item.dte >= 365 && item.dte <= 730);
            }

            // Sort
            filtered.sort((a, b) => {
                let aVal = a[sortField];
                let bVal = b[sortField];

                if (sortField === 'expiry') {
                    aVal = a.expiry.getTime();
                    bVal = b.expiry.getTime();
                }

                if (typeof aVal === 'string' && typeof bVal === 'string') {
                    aVal = aVal.toLowerCase();
                    bVal = bVal.toLowerCase();
                }

                if (aVal < bVal) return sortDirection === 'asc' ? -1 : 1;
                if (aVal > bVal) return sortDirection === 'asc' ? 1 : -1;
                return 0;
            });

            filteredData = filtered;
        }

        // UI updates
        function updateUI() {
            updateStats();
            updateTable();
            updateSortIndicators();
        }

        function updateStats() {
            const sku = filteredData.length;
            
            let qty = 0;
            if (locationFilter.includes('ALL')) {
                qty = filteredData.reduce((sum, item) => sum + item.qty_TTQ, 0);
            } else {
                qty = filteredData.reduce((sum, item) => {
                    let total = 0;
                    if (locationFilter.includes('TAIPEI')) total += item.qty_TPE;
                    if (locationFilter.includes('SANCHONG')) total += item.qty_SC;
                    if (locationFilter.includes('MOMO')) total += item.qty_MOMO;
                    return sum + total;
                }, 0);
            }

            const earliestItem = filteredData.reduce((earliest, item) => 
                !earliest || item.expiry < earliest.expiry ? item : earliest, null
            );

            document.getElementById('stats-sku').textContent = sku.toLocaleString();
            document.getElementById('stats-qty').textContent = qty.toLocaleString();
            
            if (earliestItem) {
                document.getElementById('stats-earliest-date').textContent = 
                    earliestItem.expiry.toISOString().split('T')[0];
                document.getElementById('stats-earliest-days').textContent = 
                    `${earliestItem.dte}天`;
            } else {
                document.getElementById('stats-earliest-date').textContent = 'N/A';
                document.getElementById('stats-earliest-days').textContent = '最早到期';
            }
        }

        function updateTable() {
            const tbody = document.getElementById('data-table-body');
            
            if (loading) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="${3 + (sourceColumnsExpanded ? 3 : 0)}" class="p-4 sm:p-8 text-center">
                            <div class="flex items-center justify-center gap-2">
                                <i data-lucide="refresh-cw" class="h-4 w-4 animate-spin"></i>
                                <span class="text-xs sm:text-sm">Loading...</span>
                            </div>
                        </td>
                    </tr>
                `;
                lucide.createIcons();
                return;
            }

            if (filteredData.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="${3 + (sourceColumnsExpanded ? 3 : 0)}" class="p-4 sm:p-8 text-center muted-text text-xs sm:text-sm">
                            無數據
                        </td>
                    </tr>
                `;
                return;
            }

            tbody.innerHTML = filteredData.map((item, index) => {
                const statusClass = getDTEStatusClass(item.dte);
                const alertIcon = item.dte < 0 ? '<i data-lucide="alert-triangle" class="inline h-2 w-2 sm:h-3 sm:w-3 mr-0.5 sm:mr-1"></i>' : '';
                
                const totalQty = locationFilter.includes('ALL') 
                    ? item.qty_TTQ 
                    : (locationFilter.includes('TAIPEI') ? item.qty_TPE : 0) +
                      (locationFilter.includes('SANCHONG') ? item.qty_SC : 0) +
                      (locationFilter.includes('MOMO') ? item.qty_MOMO : 0);

                const sourceColumns = sourceColumnsExpanded ? `
                    <td class="p-2 sm:p-3 text-right font-medium align-top">
                        <span class="text-xs sm:text-sm tabular-nums">${item.qty_TPE.toLocaleString()}</span>
                    </td>
                    <td class="p-2 sm:p-3 text-right font-medium align-top">
                        <span class="text-xs sm:text-sm tabular-nums">${item.qty_SC.toLocaleString()}</span>
                    </td>
                    <td class="p-2 sm:p-3 text-right font-medium align-top">
                        <span class="text-xs sm:text-sm tabular-nums">${item.qty_MOMO.toLocaleString()}</span>
                    </td>
                ` : '';

                return `
                    <tr class="border-t hover:bg-gray-50" style="border-top: 1px solid hsl(var(--border));">
                        <td class="p-2 sm:p-3 align-top" style="min-width: 40%;">
                            <div class="font-medium leading-tight break-words line-clamp-2" style="
                                font-size: clamp(0.75rem, 2.5vw, 0.875rem);
                                line-height: 1.3;
                            ">
                                ${item.name}
                            </div>
                        </td>
                        <td class="p-2 sm:p-3 text-right align-top">
                            <span class="px-1 sm:px-2 py-0.5 sm:py-1 rounded text-xs font-medium ${statusClass}">
                                ${alertIcon}
                                <span class="tabular-nums">${item.dte}</span>
                            </span>
                        </td>
                        <td class="p-2 sm:p-3 text-right font-bold primary-text align-top">
                            <span class="text-xs sm:text-sm tabular-nums">
                                ${totalQty.toLocaleString()}
                            </span>
                        </td>
                        ${sourceColumns}
                    </tr>
                `;
            }).join('');

            lucide.createIcons();
        }

        function updateSortIndicators() {
            // Clear all indicators
            ['name', 'dte', 'qty_TTQ', 'qty_TPE', 'qty_SC', 'qty_MOMO'].forEach(field => {
                const element = document.getElementById(`sort-${field}`);
                if (element) element.textContent = '';
            });

            // Set current indicator
            const element = document.getElementById(`sort-${sortField}`);
            if (element) {
                element.textContent = sortDirection === 'asc' ? '↑' : '↓';
            }
        }

        // Event handlers
        function handleSort(field) {
            if (sortField === field) {
                sortDirection = sortDirection === 'asc' ? 'desc' : 'asc';
            } else {
                sortField = field;
                sortDirection = 'asc';
            }
            filterAndSortData();
            updateUI();
        }

        function handleLocationToggle(value) {
            if (value === 'ALL') {
                locationFilter = ['ALL'];
            } else {
                const newFilter = locationFilter.includes('ALL')
                    ? [value]
                    : locationFilter.includes(value)
                    ? locationFilter.filter(l => l !== value)
                    : [...locationFilter.filter(l => l !== 'ALL'), value];
                
                locationFilter = newFilter.length === 0 ? ['ALL'] : newFilter;
            }
            
            updateLocationCheckboxes();
            filterAndSortData();
            updateUI();
        }

        function updateLocationCheckboxes() {
            const container = document.getElementById('location-checkboxes');
            const locations = [
                { value: 'ALL', label: '全部' },
                { value: 'TAIPEI', label: '北' },
                { value: 'SANCHONG', label: '重' },
                { value: 'MOMO', label: 'M' }
            ];

            container.innerHTML = locations.map(location => `
                <div class="flex items-center space-x-1">
                    <input type="checkbox" 
                           id="checkbox-${location.value}" 
                           class="checkbox h-3 w-3 sm:h-4 sm:w-4"
                           ${locationFilter.includes(location.value) ? 'checked' : ''}
                           onchange="handleLocationToggle('${location.value}')">
                    <label for="checkbox-${location.value}" class="text-xs sm:text-sm font-normal cursor-pointer">
                        ${location.label}
                    </label>
                </div>
            `).join('');
        }

        function toggleSourceColumns(event) {
            event.stopPropagation();
            sourceColumnsExpanded = !sourceColumnsExpanded;
            
            const columns = ['source-col-tpe', 'source-col-sc', 'source-col-momo'];
            const toggleBtn = document.getElementById('toggle-columns-btn');
            const icon = toggleBtn.querySelector('[data-lucide]');
            
            if (sourceColumnsExpanded) {
                columns.forEach(col => document.getElementById(col).classList.remove('hidden'));
                icon.setAttribute('data-lucide', 'chevron-down');
            } else {
                columns.forEach(col => document.getElementById(col).classList.add('hidden'));
                icon.setAttribute('data-lucide', 'chevron-right');
            }
            
            lucide.createIcons();
            updateTable();
        }

        // Settings
        function toggleSettings() {
            showSettings = !showSettings;
            const panel = document.getElementById('settings-panel');
            if (showSettings) {
                panel.classList.remove('hidden');
                renderSourcesConfig();
            } else {
                panel.classList.add('hidden');
            }
        }

        function renderSourcesConfig() {
            const container = document.getElementById('sources-config');
            container.innerHTML = sources.map((source, index) => `
                <div class="space-y-4 p-4 border rounded-lg" style="border-color: hsl(var(--border));">
                    <h3 class="font-semibold">${source.name}</h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                        <div>
                            <label class="block text-sm font-medium mb-1">Sheet ID/URL</label>
                            <input type="text" class="input" value="${source.sheetId}" 
                                   onchange="updateSource(${index}, 'sheetId', this.value)"
                                   placeholder="Sheet ID or full URL">
                        </div>
                        <div>
                            <label class="block text-sm font-medium mb-1">Sheet Name</label>
                            <input type="text" class="input" value="${source.sheetName}" 
                                   onchange="updateSource(${index}, 'sheetName', this.value)"
                                   placeholder="Leave blank for first tab">
                        </div>
                        <div>
                            <label class="block text-sm font-medium mb-1">Header Row</label>
                            <input type="number" class="input" value="${source.headerRow}" 
                                   onchange="updateSource(${index}, 'headerRow', parseInt(this.value) || 1)">
                        </div>
                        <div>
                            <label class="block text-sm font-medium mb-1">Name Column</label>
                            <input type="text" class="input" value="${source.nameCol}" 
                                   onchange="updateSource(${index}, 'nameCol', this.value.toUpperCase())"
                                   placeholder="D">
                        </div>
                        <div>
                            <label class="block text-sm font-medium mb-1">Expiry Column</label>
                            <input type="text" class="input" value="${source.expiryCol}" 
                                   onchange="updateSource(${index}, 'expiryCol', this.value.toUpperCase())"
                                   placeholder="E">
                        </div>
                        <div>
                            <label class="block text-sm font-medium mb-1">Quantity Column</label>
                            <input type="text" class="input" value="${source.qtyCol}" 
                                   onchange="updateSource(${index}, 'qtyCol', this.value.toUpperCase())"
                                   placeholder="J">
                        </div>
                    </div>
                    <div class="text-sm muted-text">
                        <p>GViz CSV URL: 
                            <a href="https://docs.google.com/spreadsheets/d/${source.sheetId}/gviz/tq?${source.sheetName ? `sheet=${source.sheetName}&` : ''}range=A${source.headerRow}:Z&tqx=out:csv" 
                               target="_blank" rel="noopener noreferrer" 
                               class="primary-text hover:underline ml-1">
                                Test Link
                            </a>
                        </p>
                    </div>
                </div>
            `).join('');
        }

        function updateSource(index, field, value) {
            if (field === 'sheetId') {
                // Extract sheet ID from URL if full URL provided
                const match = value.match(/\/d\/([a-zA-Z0-9-_]+)/);
                if (match) value = match[1];
            }
            sources[index][field] = value;
        }

        function saveSettings() {
            sources.forEach(source => {
                localStorage.setItem(`pm_gviz_config_${source.name}`, JSON.stringify({
                    sheetId: source.sheetId,
                    sheetName: source.sheetName,
                    headerRow: source.headerRow,
                    nameCol: source.nameCol,
                    expiryCol: source.expiryCol,
                    qtyCol: source.qtyCol
                }));
            });
            toggleSettings();
            fetchAllData();
        }

        function loadSettings() {
            sources = defaultSources.map(source => {
                const stored = localStorage.getItem(`pm_gviz_config_${source.name}`);
                return stored ? { ...source, ...JSON.parse(stored) } : source;
            });
        }

        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            // Load settings
            loadSettings();

            // Set up event listeners
            document.getElementById('refresh-btn').onclick = fetchAllData;
            document.getElementById('settings-btn').onclick = toggleSettings;
            document.getElementById('save-settings-btn').onclick = saveSettings;

            document.getElementById('search-input').oninput = function(e) {
                searchTerm = e.target.value;
                filterAndSortData();
                updateUI();
            };

            document.getElementById('dte-filter').onchange = function(e) {
                dteFilter = e.target.value;
                filterAndSortData();
                updateUI();
            };

            // Initialize UI
            updateLocationCheckboxes();
            
            // Load icons
            lucide.createIcons();
            
            // Fetch initial data
            fetchAllData();
        });
    </script>
</body>
</html>
