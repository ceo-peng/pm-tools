<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PM Inventory Dashboard</title>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        :root {
            --background: 0 0% 100%;
            --foreground: 240 10% 3.9%;
            --card: 0 0% 100%;
            --card-foreground: 240 10% 3.9%;
            --popover: 0 0% 100%;
            --popover-foreground: 240 10% 3.9%;
            --primary: 240 5.9% 10%;
            --primary-foreground: 0 0% 98%;
            --secondary: 240 4.8% 95.9%;
            --secondary-foreground: 240 5.9% 10%;
            --muted: 240 4.8% 95.9%;
            --muted-foreground: 240 3.8% 46.1%;
            --accent: 240 4.8% 95.9%;
            --accent-foreground: 240 5.9% 10%;
            --destructive: 0 84.2% 60.2%;
            --destructive-foreground: 0 0% 98%;
            --border: 240 5.9% 90%;
            --input: 240 5.9% 90%;
            --ring: 240 10% 3.9%;
            --radius: 0.5rem;
        }
        
        .dark {
            --background: 240 10% 3.9%;
            --foreground: 0 0% 98%;
            --card: 240 10% 3.9%;
            --card-foreground: 0 0% 98%;
            --popover: 240 10% 3.9%;
            --popover-foreground: 0 0% 98%;
            --primary: 0 0% 98%;
            --primary-foreground: 240 5.9% 10%;
            --secondary: 240 3.7% 15.9%;
            --secondary-foreground: 0 0% 98%;
            --muted: 240 3.7% 15.9%;
            --muted-foreground: 240 5% 64.9%;
            --accent: 240 3.7% 15.9%;
            --accent-foreground: 0 0% 98%;
            --destructive: 0 62.8% 30.6%;
            --destructive-foreground: 0 0% 98%;
            --border: 240 3.7% 15.9%;
            --input: 240 3.7% 15.9%;
            --ring: 240 4.9% 83.9%;
        }

        * {
            border-color: hsl(var(--border));
        }

        body {
            background-color: hsl(var(--background));
            color: hsl(var(--foreground));
        }

        .status-expired {
            background-color: hsl(var(--destructive));
            color: hsl(var(--destructive-foreground));
        }

        .status-warning {
            background-color: hsl(40 96% 84%);
            color: hsl(25 95% 53%);
        }

        .data-table th {
            background-color: hsl(var(--muted) / 0.5);
        }

        .data-table tbody tr:hover {
            background-color: hsl(var(--muted) / 0.25);
        }

        .card {
            background-color: hsl(var(--card));
            border: 1px solid hsl(var(--border));
            color: hsl(var(--card-foreground));
        }

        .btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            white-space: nowrap;
            border-radius: calc(var(--radius) - 2px);
            font-size: 0.875rem;
            font-weight: 500;
            transition: all 0.2s;
            outline: none;
            cursor: pointer;
            border: none;
        }

        .btn-outline {
            border: 1px solid hsl(var(--border));
            background-color: hsl(var(--background));
            color: hsl(var(--foreground));
        }

        .btn-outline:hover {
            background-color: hsl(var(--accent));
            color: hsl(var(--accent-foreground));
        }

        .btn-ghost {
            background-color: transparent;
            color: hsl(var(--foreground));
        }

        .btn-ghost:hover {
            background-color: hsl(var(--accent));
            color: hsl(var(--accent-foreground));
        }

        .input {
            display: flex;
            height: 2.5rem;
            width: 100%;
            border-radius: calc(var(--radius) - 2px);
            border: 1px solid hsl(var(--border));
            background-color: hsl(var(--background));
            padding: 0 0.75rem;
            font-size: 0.875rem;
            color: hsl(var(--foreground));
        }

        .input:focus {
            outline: 2px solid hsl(var(--ring));
            outline-offset: 2px;
        }

        .select-trigger {
            display: flex;
            height: 2.5rem;
            width: 100%;
            align-items: center;
            justify-content: between;
            border-radius: calc(var(--radius) - 2px);
            border: 1px solid hsl(var(--border));
            background-color: hsl(var(--background));
            padding: 0 0.75rem;
            font-size: 0.875rem;
            color: hsl(var(--foreground));
            cursor: pointer;
        }

        .popover {
            position: absolute;
            z-index: 50;
            background-color: hsl(var(--popover));
            border: 1px solid hsl(var(--border));
            border-radius: var(--radius);
            box-shadow: 0 10px 15px -3px rgb(0 0 0 / 0.1);
        }

        .checkbox {
            height: 1rem;
            width: 1rem;
            border: 1px solid hsl(var(--border));
            border-radius: 0.25rem;
        }

        .animate-spin {
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }

        .collapsible-content {
            overflow: hidden;
            transition: all 0.2s ease-in-out;
        }

        .collapsible-content[data-state="closed"] {
            height: 0;
        }

        .hidden {
            display: none;
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useMemo, useCallback } = React;

        // Icons as SVG components
        const RefreshCw = ({ className, ...props }) => (
            <svg className={className} {...props} width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                <path d="M3 12a9 9 0 0 1 9-9 9.75 9.75 0 0 1 6.74 2.74L21 8"/>
                <path d="M21 3v5h-5"/>
                <path d="M21 12a9 9 0 0 1-9 9 9.75 9.75 0 0 1-6.74-2.74L3 16"/>
                <path d="M3 21v-5h5"/>
            </svg>
        );

        const Settings = ({ className, ...props }) => (
            <svg className={className} {...props} width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                <path d="M12.22 2h-.44a2 2 0 0 0-2 2v.18a2 2 0 0 1-1 1.73l-.43.25a2 2 0 0 1-2 0l-.15-.08a2 2 0 0 0-2.73.73l-.22.38a2 2 0 0 0 .73 2.73l.15.1a2 2 0 0 1 1 1.72v.51a2 2 0 0 1-1 1.74l-.15.09a2 2 0 0 0-.73 2.73l.22.38a2 2 0 0 0 2.73.73l.15-.08a2 2 0 0 1 2 0l.43.25a2 2 0 0 1 1 1.73V20a2 2 0 0 0 2 2h.44a2 2 0 0 0 2-2v-.18a2 2 0 0 1 1-1.73l.43-.25a2 2 0 0 1 2 0l.15.08a2 2 0 0 0 2.73-.73l.22-.39a2 2 0 0 0-.73-2.73l-.15-.08a2 2 0 0 1-1-1.74v-.5a2 2 0 0 1 1-1.74l.15-.09a2 2 0 0 0 .73-2.73l-.22-.38a2 2 0 0 0-2.73-.73l-.15.08a2 2 0 0 1-2 0l-.43-.25a2 2 0 0 1-1-1.73V4a2 2 0 0 0-2-2z"/>
                <circle cx="12" cy="12" r="3"/>
            </svg>
        );

        const Search = ({ className, ...props }) => (
            <svg className={className} {...props} width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                <circle cx="11" cy="11" r="8"/>
                <path d="m21 21-4.35-4.35"/>
            </svg>
        );

        const AlertTriangle = ({ className, ...props }) => (
            <svg className={className} {...props} width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                <path d="m21.73 18-8-14a2 2 0 0 0-3.48 0l-8 14A2 2 0 0 0 4 21h16a2 2 0 0 0 1.73-3Z"/>
                <path d="M12 9v4"/>
                <path d="M12 17h.01"/>
            </svg>
        );

        const ChevronDown = ({ className, ...props }) => (
            <svg className={className} {...props} width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                <path d="m6 9 6 6 6-6"/>
            </svg>
        );

        const ChevronUp = ({ className, ...props }) => (
            <svg className={className} {...props} width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                <path d="m18 15-6-6-6 6"/>
            </svg>
        );

        // Location Multi-Select Component
        const LocationMultiSelect = ({ locationFilter, setLocationFilter }) => {
            const [open, setOpen] = useState(false);

            const locations = [
                { value: 'ALL', label: '全部' },
                { value: 'TAIPEI', label: 'TPE' },
                { value: 'SANCHONG', label: 'SC' },
                { value: 'MOMO', label: 'MOMO' }
            ];

            const handleLocationToggle = (value) => {
                if (value === 'ALL') {
                    setLocationFilter(['ALL']);
                } else {
                    const newFilter = locationFilter.includes('ALL')
                        ? [value]
                        : locationFilter.includes(value)
                        ? locationFilter.filter(l => l !== value)
                        : [...locationFilter.filter(l => l !== 'ALL'), value];
                    
                    setLocationFilter(newFilter.length === 0 ? ['ALL'] : newFilter);
                }
            };

            const selectedText = locationFilter.includes('ALL') 
                ? '全部' 
                : locationFilter.length === 0
                ? 'Select locations'
                : locationFilter.join(', ');

            return (
                <div className="relative">
                    <button
                        className="btn btn-outline w-48 justify-between"
                        onClick={() => setOpen(!open)}
                    >
                        <span className="truncate">{selectedText}</span>
                        <ChevronDown className="h-4 w-4 shrink-0 opacity-50" />
                    </button>
                    {open && (
                        <div className="popover w-48 p-3 mt-1">
                            <div className="space-y-2">
                                {locations.map(location => (
                                    <div key={location.value} className="flex items-center space-x-2">
                                        <input
                                            type="checkbox"
                                            className="checkbox"
                                            id={location.value}
                                            checked={locationFilter.includes(location.value)}
                                            onChange={() => handleLocationToggle(location.value)}
                                        />
                                        <label htmlFor={location.value} className="text-sm font-normal cursor-pointer">
                                            {location.label}
                                        </label>
                                    </div>
                                ))}
                            </div>
                        </div>
                    )}
                </div>
            );
        };

        // Earliest Expiry Collapsible Component
        const EarliestExpiryCollapsible = ({ data }) => {
            const [isOpen, setIsOpen] = useState(false);

            const earliestItem = data.reduce((earliest, item) => 
                !earliest || item.expiry < earliest.expiry ? item : earliest, 
                null
            );

            if (!earliestItem) {
                return <div className="text-sm opacity-60">No items</div>;
            }

            const itemsWithEarliestDate = data.filter(item => 
                item.expiry.getTime() === earliestItem.expiry.getTime()
            );

            return (
                <div className="space-y-2">
                    <div className="text-2xl font-bold">
                        {earliestItem.expiry.toISOString().split('T')[0]}
                    </div>
                    <div className="text-sm opacity-60">
                        {earliestItem.dte} days remaining
                    </div>
                    
                    <div>
                        <button
                            className="btn btn-ghost p-0 h-auto text-xs text-blue-600 hover:text-blue-500"
                            onClick={() => setIsOpen(!isOpen)}
                        >
                            <span>{itemsWithEarliestDate.length} item{itemsWithEarliestDate.length !== 1 ? 's' : ''}</span>
                            {isOpen ? <ChevronUp className="h-3 w-3 ml-1" /> : <ChevronDown className="h-3 w-3 ml-1" />}
                        </button>
                        <div className={`collapsible-content mt-2 ${isOpen ? '' : 'hidden'}`}>
                            <div className="max-h-32 overflow-y-auto space-y-1">
                                {itemsWithEarliestDate.map((item, index) => (
                                    <div key={index} className="text-xs opacity-60 p-1 bg-gray-100 rounded">
                                        {item.name}
                                    </div>
                                ))}
                            </div>
                        </div>
                    </div>
                </div>
            );
        };

        const PMInventoryDashboard = () => {
            const [loading, setLoading] = useState(false);
            const [data, setData] = useState([]);
            const [searchTerm, setSearchTerm] = useState('');
            const [dteFilter, setDteFilter] = useState('≤90');
            const [customDteMin, setCustomDteMin] = useState('');
            const [customDteMax, setCustomDteMax] = useState('');
            const [locationFilter, setLocationFilter] = useState(['ALL']);
            const [sortField, setSortField] = useState('dte');
            const [sortDirection, setSortDirection] = useState('asc');
            const [showSettings, setShowSettings] = useState(false);
            const [lastFetch, setLastFetch] = useState(null);

            const defaultSources = [{
                name: 'TPE',
                sheetId: '14yjT90s9CV988KZZ_o6m8F4LbeDWpKTuqVO66gfLboI',
                sheetName: 'inventory_tracking',
                headerRow: 4,
                nameCol: 'D',
                expiryCol: 'E',
                qtyCol: 'J'
            }, {
                name: 'SC',
                sheetId: '12C25rcfSEMtSkkARzLtxlW9Wmhu64m6eSP_KoK8M-js',
                sheetName: 'inventory_tracking',
                headerRow: 4,
                nameCol: 'D',
                expiryCol: 'E',
                qtyCol: 'J'
            }, {
                name: 'MOMO',
                sheetId: '1j04xLITImSX6WgtXkaGQfs0IZ5E8r3UEOrT2CKKGAxE',
                sheetName: 'inventory_tracking',
                headerRow: 4,
                nameCol: 'D',
                expiryCol: 'E',
                qtyCol: 'J'
            }];

            const [sources, setSources] = useState(defaultSources);

            // CSV parsing utility
            const parseCSV = (csv) => {
                const rows = [];
                let currentRow = [];
                let currentField = '';
                let inQuotes = false;
                let i = 0;

                while (i < csv.length) {
                    const char = csv[i];
                    const nextChar = csv[i + 1];

                    if (char === '"') {
                        if (inQuotes && nextChar === '"') {
                            currentField += '"';
                            i += 2;
                            continue;
                        }
                        inQuotes = !inQuotes;
                    } else if (char === ',' && !inQuotes) {
                        currentRow.push(currentField.trim());
                        currentField = '';
                    } else if ((char === '\n' || char === '\r') && !inQuotes) {
                        if (char === '\r' && nextChar === '\n') i++;
                        currentRow.push(currentField.trim());
                        if (currentRow.some(field => field.length > 0)) {
                            rows.push(currentRow);
                        }
                        currentRow = [];
                        currentField = '';
                    } else {
                        currentField += char;
                    }
                    i++;
                }

                if (currentField || currentRow.length > 0) {
                    currentRow.push(currentField.trim());
                    if (currentRow.some(field => field.length > 0)) {
                        rows.push(currentRow);
                    }
                }
                return rows;
            };

            // Date parsing utility
            const parseDate = (dateStr) => {
                if (!dateStr) return null;

                if (/^\d{4}-\d{2}-\d{2}$/.test(dateStr)) {
                    const date = new Date(dateStr + 'T00:00:00');
                    return isNaN(date.getTime()) ? null : date;
                }

                const serial = parseFloat(dateStr);
                if (!isNaN(serial) && serial > 25569) {
                    return new Date((serial - 25569) * 86400 * 1000);
                }

                const date = new Date(dateStr);
                return isNaN(date.getTime()) ? null : date;
            };

            // Column letter to index conversion
            const colToIndex = (col) => {
                let index = 0;
                for (let i = 0; i < col.length; i++) {
                    index = index * 26 + (col.charCodeAt(i) - 65 + 1);
                }
                return index - 1;
            };

            // Fetch data from Google Sheets
            const fetchSheetData = async (source) => {
                if (!source.sheetId) return [];
                try {
                    const sheetParam = source.sheetName ? `&sheet=${encodeURIComponent(source.sheetName)}` : '';
                    const url = `https://docs.google.com/spreadsheets/d/${source.sheetId}/gviz/tq?${sheetParam}&range=A${source.headerRow}:Z&tqx=out:csv`;
                    const response = await fetch(url, { cache: 'no-store' });
                    
                    if (!response.ok) {
                        throw new Error(`HTTP ${response.status}`);
                    }
                    
                    const csvText = await response.text();
                    const rows = parseCSV(csvText);
                    const nameIdx = colToIndex(source.nameCol);
                    const expiryIdx = colToIndex(source.expiryCol);
                    const qtyIdx = colToIndex(source.qtyCol);
                    const items = [];

                    for (const row of rows) {
                        const name = row[nameIdx]?.trim();
                        const expiryStr = row[expiryIdx]?.trim();
                        const qtyStr = row[qtyIdx]?.trim();

                        if (!name || !expiryStr) continue;

                        const expiry = parseDate(expiryStr);
                        const qty = parseInt(qtyStr) || 0;

                        if (expiry && !isNaN(qty)) {
                            items.push({ name, expiry, qty });
                        }
                    }
                    return items;
                } catch (error) {
                    console.error(`[${source.name}] Error fetching data:`, error);
                    alert(`[${source.name}] HTTP Error: ${error.message}`);
                    return [];
                }
            };

            // Fetch all data and aggregate
            const fetchAllData = async () => {
                setLoading(true);
                try {
                    const results = await Promise.all(sources.map(fetchSheetData));
                    const productMap = new Map();

                    results.forEach((items, sourceIndex) => {
                        const sourceName = sources[sourceIndex].name;
                        items.forEach(item => {
                            const existing = productMap.get(item.name);
                            if (existing) {
                                if (item.expiry < existing.expiry) {
                                    existing.expiry = item.expiry;
                                }
                                if (sourceName === 'TPE') existing.qty_TPE += item.qty;
                                else if (sourceName === 'SC') existing.qty_SC += item.qty;
                                else if (sourceName === 'MOMO') existing.qty_MOMO += item.qty;
                            } else {
                                const newItem = {
                                    name: item.name,
                                    expiry: item.expiry,
                                    qty_TPE: sourceName === 'TPE' ? item.qty : 0,
                                    qty_SC: sourceName === 'SC' ? item.qty : 0,
                                    qty_MOMO: sourceName === 'MOMO' ? item.qty : 0
                                };
                                productMap.set(item.name, newItem);
                            }
                        });
                    });

                    const today = new Date();
                    today.setHours(0, 0, 0, 0);
                    
                    const aggregatedData = Array.from(productMap.values()).map(item => ({
                        ...item,
                        qty_TTQ: item.qty_TPE + item.qty_SC + item.qty_MOMO,
                        dte: Math.floor((item.expiry.getTime() - today.getTime()) / (1000 * 60 * 60 * 24))
                    }));

                    setData(aggregatedData);
                    setLastFetch(new Date());
                } catch (error) {
                    console.error('Error fetching data:', error);
                } finally {
                    setLoading(false);
                }
            };

            // Initial data load
            useEffect(() => {
                fetchAllData();
            }, []);

            // Filter and sort data
            const filteredAndSortedData = useMemo(() => {
                let filtered = data.slice();

                if (searchTerm) {
                    filtered = filtered.filter(item => 
                        item.name.toLowerCase().includes(searchTerm.toLowerCase())
                    );
                }

                if (!locationFilter.includes('ALL')) {
                    filtered = filtered.filter(item => {
                        if (locationFilter.includes('TAIPEI') && item.qty_TPE > 0) return true;
                        if (locationFilter.includes('SANCHONG') && item.qty_SC > 0) return true;
                        if (locationFilter.includes('MOMO') && item.qty_MOMO > 0) return true;
                        return false;
                    });
                }

                if (dteFilter === '≤90') {
                    filtered = filtered.filter(item => item.dte <= 90);
                } else if (dteFilter === '≤180') {
                    filtered = filtered.filter(item => item.dte <= 180);
                } else if (dteFilter === '≤365') {
                    filtered = filtered.filter(item => item.dte <= 365);
                } else if (dteFilter === '>365') {
                    filtered = filtered.filter(item => item.dte > 365);
                } else if (dteFilter === '≥548') {
                    filtered = filtered.filter(item => item.dte >= 548);
                } else if (dteFilter === '≥730') {
                    filtered = filtered.filter(item => item.dte >= 730);
                } else if (dteFilter === '≥913') {
                    filtered = filtered.filter(item => item.dte >= 913);
                } else if (dteFilter === 'custom') {
                    const min = customDteMin ? parseInt(customDteMin) : -Infinity;
                    const max = customDteMax ? parseInt(customDteMax) : Infinity;
                    filtered = filtered.filter(item => item.dte >= min && item.dte <= max);
                }

                filtered.sort((a, b) => {
                    let aVal = a[sortField];
                    let bVal = b[sortField];
                    if (sortField === 'expiry') {
                        aVal = a.expiry.getTime();
                        bVal = b.expiry.getTime();
                    }
                    if (typeof aVal === 'string' && typeof bVal === 'string') {
                        aVal = aVal.toLowerCase();
                        bVal = bVal.toLowerCase();
                    }
                    if (aVal < bVal) return sortDirection === 'asc' ? -1 : 1;
                    if (aVal > bVal) return sortDirection === 'asc' ? 1 : -1;
                    return 0;
                });
                return filtered;
            }, [data, searchTerm, locationFilter, dteFilter, customDteMin, customDteMax, sortField, sortDirection]);

            // Get selected location columns for dynamic display
            const selectedLocationColumns = useMemo(() => {
                if (locationFilter.includes('ALL')) {
                    return [
                        { key: 'qty_TPE', label: 'TPE', filterKey: 'TAIPEI' },
                        { key: 'qty_SC', label: 'SC', filterKey: 'SANCHONG' },
                        { key: 'qty_MOMO', label: 'MOMO', filterKey: 'MOMO' }
                    ];
                }
                
                const columns = [];
                if (locationFilter.includes('TAIPEI')) {
                    columns.push({ key: 'qty_TPE', label: 'TPE', filterKey: 'TAIPEI' });
                }
                if (locationFilter.includes('SANCHONG')) {
                    columns.push({ key: 'qty_SC', label: 'SC', filterKey: 'SANCHONG' });
                }
                if (locationFilter.includes('MOMO')) {
                    columns.push({ key: 'qty_MOMO', label: 'MOMO', filterKey: 'MOMO' });
                }
                
                return columns;
            }, [locationFilter]);

            // Calculate stats
            const stats = useMemo(() => {
                const sku = filteredAndSortedData.length;
                
                const qty = filteredAndSortedData.reduce((sum, item) => {
                    if (locationFilter.includes('ALL')) return sum + item.qty_TTQ;
                    let total = 0;
                    if (locationFilter.includes('TAIPEI')) total += item.qty_TPE;
                    if (locationFilter.includes('SANCHONG')) total += item.qty_SC;
                    if (locationFilter.includes('MOMO')) total += item.qty_MOMO;
                    return sum + total;
                }, 0);
                
                return { sku, qty };
            }, [filteredAndSortedData, locationFilter]);

            // Handle sorting
            const handleSort = (field) => {
                if (sortField === field) {
                    setSortDirection(sortDirection === 'asc' ? 'desc' : 'asc');
                } else {
                    setSortField(field);
                    setSortDirection('asc');
                }
            };

            // Get DTE status class
            const getDTEStatusClass = (dte) => {
                if (dte < 0) return 'status-expired';
                if (dte <= 60) return 'status-warning';
                return '';
            };

            return (
                <div className="min-h-screen bg-gray-50 p-4">
                    <div className="max-w-7xl mx-auto space-y-6">
                        {/* Header */}
                        <div className="flex items-center justify-between">
                            <h1 className="text-3xl font-bold">庫存水位儀表板</h1>
                            <div className="flex items-center gap-2">
                                {lastFetch && (
                                    <span className="text-sm opacity-60">
                                        Last updated: {lastFetch.toLocaleTimeString()}
                                    </span>
                                )}
                                <button className="btn btn-outline" onClick={fetchAllData} disabled={loading}>
                                    <RefreshCw className={`h-4 w-4 ${loading ? 'animate-spin' : ''}`} />
                                </button>
                                <button className="btn btn-outline" onClick={() => setShowSettings(!showSettings)}>
                                    <Settings className="h-4 w-4" />
                                </button>
                            </div>
                        </div>

                        {/* Settings Panel */}
                        {showSettings && (
                            <div className="card rounded-lg p-6 space-y-6">
                                <h2 className="text-xl font-semibold">Data Source Settings</h2>
                                {sources.map((source, index) => (
                                    <div key={source.name} className="space-y-4 p-4 border rounded-lg">
                                        <h3 className="font-semibold">{source.name}</h3>
                                        <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                                            <div>
                                                <label className="block text-sm font-medium mb-1">Sheet ID/URL</label>
                                                <input
                                                    className="input"
                                                    value={source.sheetId}
                                                    onChange={(e) => {
                                                        const newSources = [...sources];
                                                        let value = e.target.value;
                                                        const match = value.match(/\/d\/([a-zA-Z0-9-_]+)/);
                                                        if (match) value = match[1];
                                                        newSources[index].sheetId = value;
                                                        setSources(newSources);
                                                    }}
                                                    placeholder="Sheet ID or full URL"
                                                />
                                            </div>
                                            <div>
                                                <label className="block text-sm font-medium mb-1">Sheet Name</label>
                                                <input
                                                    className="input"
                                                    value={source.sheetName}
                                                    onChange={(e) => {
                                                        const newSources = [...sources];
                                                        newSources[index].sheetName = e.target.value;
                                                        setSources(newSources);
                                                    }}
                                                    placeholder="Leave blank for first tab"
                                                />
                                            </div>
                                            <div>
                                                <label className="block text-sm font-medium mb-1">Header Row</label>
                                                <input
                                                    className="input"
                                                    type="number"
                                                    value={source.headerRow}
                                                    onChange={(e) => {
                                                        const newSources = [...sources];
                                                        newSources[index].headerRow = parseInt(e.target.value) || 1;
                                                        setSources(newSources);
                                                    }}
                                                />
                                            </div>
                                            <div>
                                                <label className="block text-sm font-medium mb-1">Name Column</label>
                                                <input
                                                    className="input"
                                                    value={source.nameCol}
                                                    onChange={(e) => {
                                                        const newSources = [...sources];
                                                        newSources[index].nameCol = e.target.value.toUpperCase();
                                                        setSources(newSources);
                                                    }}
                                                    placeholder="D"
                                                />
                                            </div>
                                            <div>
                                                <label className="block text-sm font-medium mb-1">Expiry Column</label>
                                                <input
                                                    className="input"
                                                    value={source.expiryCol}
                                                    onChange={(e) => {
                                                        const newSources = [...sources];
                                                        newSources[index].expiryCol = e.target.value.toUpperCase();
                                                        setSources(newSources);
                                                    }}
                                                    placeholder="E"
                                                />
                                            </div>
                                            <div>
                                                <label className="block text-sm font-medium mb-1">Quantity Column</label>
                                                <input
                                                    className="input"
                                                    value={source.qtyCol}
                                                    onChange={(e) => {
                                                        const newSources = [...sources];
                                                        newSources[index].qtyCol = e.target.value.toUpperCase();
                                                        setSources(newSources);
                                                    }}
                                                    placeholder="J"
                                                />
                                            </div>
                                        </div>
                                    </div>
                                ))}
                                <button className="btn btn-outline w-full py-2" onClick={() => { setShowSettings(false); fetchAllData(); }}>
                                    Save All Sources (Reload Now)
                                </button>
                            </div>
                        )}

                        {/* Toolbar */}
                        <div className="card rounded-lg p-4">
                            <div className="flex flex-col lg:flex-row gap-4 items-start lg:items-center">
                                <div className="flex-1 relative">
                                    <Search className="absolute left-3 top-1/2 transform -translate-y-1/2 h-4 w-4 opacity-50" />
                                    <input
                                        className="input pl-10"
                                        placeholder="Search products..."
                                        value={searchTerm}
                                        onChange={(e) => setSearchTerm(e.target.value)}
                                    />
                                </div>
                                
                                <div className="flex gap-2">
                                    <LocationMultiSelect 
                                        locationFilter={locationFilter}
                                        setLocationFilter={setLocationFilter}
                                    />
                                    
                                    <select
                                        className="select-trigger w-32"
                                        value={dteFilter}
                                        onChange={(e) => setDteFilter(e.target.value)}
                                    >
                                        <option value="≤90">≤90天</option>
                                        <option value="≤180">≤180天</option>
                                        <option value="≤365">≤365天</option>
                                        <option value=">365">>365天</option>
                                        <option value="≥548">≥548天</option>
                                        <option value="≥730">≥730天</option>
                                        <option value="≥913">≥913天</option>
                                        <option value="custom">自訂義區間</option>
                                    </select>
                                </div>
                            </div>
                        </div>

                        {/* Stats */}
                        <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
                            <div className="card rounded-lg p-4">
                                <div className="text-2xl font-bold">{stats.sku.toLocaleString()}</div>
                                <div className="text-sm opacity-60">SKU Count</div>
                            </div>
                            <div className="card rounded-lg p-4">
                                <div className="text-2xl font-bold">{stats.qty.toLocaleString()}</div>
                                <div className="text-sm opacity-60">Total Quantity (TTQ)</div>
                            </div>
                            <div className="card rounded-lg p-4">
                                <EarliestExpiryCollapsible data={filteredAndSortedData} />
                                <div className="text-sm opacity-60 mt-2">Earliest Expiry</div>
                            </div>
                        </div>

                        {/* Data Table */}
                        <div className="card rounded-lg">
                            <div className="overflow-x-auto">
                                <table className="w-full data-table">
                                    <thead>
                                        <tr>
                                            <th className="p-3 text-left font-medium">
                                                <button onClick={() => handleSort('name')} className="hover:text-blue-600">
                                                    # Item {sortField === 'name' && (sortDirection === 'asc' ? '↑' : '↓')}
                                                </button>
                                            </th>
                                            {selectedLocationColumns.map(column => (
                                                <th key={column.key} className="p-3 text-right font-medium">
                                                    <button onClick={() => handleSort(column.key)} className="hover:text-blue-600">
                                                        {column.label} {sortField === column.key && (sortDirection === 'asc' ? '↑' : '↓')}
                                                    </button>
                                                </th>
                                            ))}
                                            {selectedLocationColumns.length > 1 && (
                                                <th className="p-3 text-right font-medium">
                                                    <button onClick={() => handleSort('qty_TTQ')} className="hover:text-blue-600">
                                                        TTQ {sortField === 'qty_TTQ' && (sortDirection === 'asc' ? '↑' : '↓')}
                                                    </button>
                                                </th>
                                            )}
                                            <th className="p-3 text-right font-medium">
                                                <button onClick={() => handleSort('dte')} className="hover:text-blue-600">
                                                    DTE {sortField === 'dte' && (sortDirection === 'asc' ? '↑' : '↓')}
                                                </button>
                                            </th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {loading ? (
                                            <tr>
                                                <td colSpan={2 + selectedLocationColumns.length + (selectedLocationColumns.length > 1 ? 1 : 0)} className="p-8 text-center">
                                                    <div className="flex items-center justify-center gap-2">
                                                        <RefreshCw className="h-4 w-4 animate-spin" />
                                                        Loading data...
                                                    </div>
                                                </td>
                                            </tr>
                                        ) : filteredAndSortedData.length === 0 ? (
                                            <tr>
                                                <td colSpan={2 + selectedLocationColumns.length + (selectedLocationColumns.length > 1 ? 1 : 0)} className="p-8 text-center opacity-60">
                                                    No data available
                                                </td>
                                            </tr>
                                        ) : (
                                            filteredAndSortedData.map((item, index) => (
                                                <tr key={`${item.name}-${index}`} className="border-t hover:bg-gray-50">
                                                    <td className="p-3">
                                                        <div className="font-medium">{item.name}</div>
                                                    </td>
                                                    {selectedLocationColumns.map(column => (
                                                        <td key={column.key} className="p-3 text-right font-medium">
                                                            {item[column.key].toLocaleString()}
                                                        </td>
                                                    ))}
                                                    {selectedLocationColumns.length > 1 && (
                                                        <td className="p-3 text-right font-bold text-blue-600">
                                                            {locationFilter.includes('ALL') 
                                                                ? item.qty_TTQ.toLocaleString()
                                                                : selectedLocationColumns.reduce((sum, col) => 
                                                                    sum + item[col.key], 0
                                                                  ).toLocaleString()
                                                            }
                                                        </td>
                                                    )}
                                                    <td className="p-3 text-right">
                                                        <span className={`px-2 py-1 rounded text-xs font-medium ${getDTEStatusClass(item.dte)}`}>
                                                            {item.dte < 0 && <AlertTriangle className="inline h-3 w-3 mr-1" />}
                                                            {item.dte}
                                                        </span>
                                                    </td>
                                                </tr>
                                            ))
                                        )}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            );
        };

        ReactDOM.render(<PMInventoryDashboard />, document.getElementById('root'));
    </script>
</body>
</html>
